<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>UBMAX - Painel ADM Frota</title>
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
  
  <script>
    // ========================================
    // NOVA CORRIDA MANUAL
    // ========================================
    async function criarCorridaManual(e) {
      e.preventDefault();
      const dados = {
        cliente_telefone: document.getElementById('nc-telefone').value,
        cliente_nome: document.getElementById('nc-nome').value,
        origem_endereco: document.getElementById('nc-origem').value,
        destino_endereco: document.getElementById('nc-destino').value,
        observacoes: document.getElementById('nc-obs').value
      };
      
      try {
        const resp = await fetch('/api/admin/corrida-manual', {
          method: 'POST',
          headers: { 
            'Content-Type': 'application/json',
            'Authorization': 'Bearer ' + localStorage.getItem('token')
          },
          body: JSON.stringify(dados)
        });
        if (resp.ok) {
          alert('âœ… Corrida criada com sucesso!');
          document.getElementById('form-nova-corrida').reset();
        } else {
          alert('âŒ Erro ao criar corrida');
        }
      } catch(err) {
        alert('âŒ Erro: ' + err.message);
      }
    }

    // ========================================
    // CHAT DA FROTA (ADM)
    // ========================================
    async function carregarChatADM() {
      try {
        const resp = await fetch('/api/admin/chat?limite=50', {
          headers: { 'Authorization': 'Bearer ' + localStorage.getItem('token') }
        });
        const data = await resp.json();
        const container = document.getElementById('chat-mensagens');
        if (data.mensagens && data.mensagens.length > 0) {
          container.innerHTML = data.mensagens.map(m => 
            '<div style="padding: 8px; margin-bottom: 8px; background: ' + (m.remetente_tipo === 'admin' ? '#e0f2fe' : '#f0fdf4') + '; border-radius: 8px;">' +
            '<strong>' + (m.remetente_nome || 'ADM') + '</strong>: ' + m.mensagem +
            '<br><small style="color: #64748b;">' + new Date(m.created_at).toLocaleString() + '</small></div>'
          ).join('');
        } else {
          container.innerHTML = '<p style="text-align: center; color: #64748b;">Nenhuma mensagem ainda</p>';
        }
      } catch(err) {
        console.error('Erro ao carregar chat:', err);
      }
    }

    async function enviarMensagemChatADM() {
      const input = document.getElementById('chat-input');
      const mensagem = input.value.trim();
      if (!mensagem) return;

      try {
        await fetch('/api/admin/chat', {
          method: 'POST',
          headers: { 
            'Content-Type': 'application/json',
            'Authorization': 'Bearer ' + localStorage.getItem('token')
          },
          body: JSON.stringify({ mensagem })
        });
        input.value = '';
        carregarChatADM();
      } catch(err) {
        alert('Erro ao enviar: ' + err.message);
      }
    }

    async function enviarBroadcast() {
      const mensagem = prompt('Digite a mensagem para TODOS os motoristas:');
      if (!mensagem) return;

      try {
        await fetch('/api/admin/chat/broadcast', {
          method: 'POST',
          headers: { 
            'Content-Type': 'application/json',
            'Authorization': 'Bearer ' + localStorage.getItem('token')
          },
          body: JSON.stringify({ mensagem })
        });
        alert('âœ… Broadcast enviado!');
        carregarChatADM();
      } catch(err) {
        alert('Erro: ' + err.message);
      }
    }

    // ========================================
    // ASSISTÃŠNCIA 24H
    // ========================================
    async function carregarAssistencia() {
      try {
        const resp = await fetch('/api/admin/assistencia', {
          headers: { 'Authorization': 'Bearer ' + localStorage.getItem('token') }
        });
        const data = await resp.json();
        const tbody = document.getElementById('tabela-assistencia');
        if (data.contatos && data.contatos.length > 0) {
          tbody.innerHTML = data.contatos.map(c => 
            '<tr>' +
            '<td>' + c.tipo + '</td>' +
            '<td>' + c.nome + '</td>' +
            '<td>' + c.telefone + '</td>' +
            '<td><button class="btn btn-sm btn-danger" onclick="excluirContato(' + c.id + ')">ğŸ—‘ï¸</button></td>' +
            '</tr>'
          ).join('');
        } else {
          tbody.innerHTML = '<tr><td colspan="4" style="text-align: center;">Nenhum contato cadastrado</td></tr>';
        }
      } catch(err) {
        console.error('Erro ao carregar assistÃªncia:', err);
      }
    }

    function abrirModalNovoContato() {
      const tipo = prompt('Tipo (guincho/mecanico/borracheiro/eletricista/seguro):');
      const nome = prompt('Nome do contato:');
      const telefone = prompt('Telefone:');
      if (tipo && nome && telefone) {
        fetch('/api/admin/assistencia', {
          method: 'POST',
          headers: { 
            'Content-Type': 'application/json',
            'Authorization': 'Bearer ' + localStorage.getItem('token')
          },
          body: JSON.stringify({ tipo, nome, telefone })
        }).then(() => {
          alert('âœ… Contato adicionado!');
          carregarAssistencia();
        });
      }
    }

    async function excluirContato(id) {
      if (!confirm('Excluir este contato?')) return;
      await fetch('/api/admin/assistencia/' + id, {
        method: 'DELETE',
        headers: { 'Authorization': 'Bearer ' + localStorage.getItem('token') }
      });
      carregarAssistencia();
    }

    // ========================================
    // AVARIAS
    // ========================================
    async function carregarAvarias() {
      try {
        const resp = await fetch('/api/admin/avarias', {
          headers: { 'Authorization': 'Bearer ' + localStorage.getItem('token') }
        });
        const data = await resp.json();
        const tbody = document.getElementById('tabela-avarias');
        if (data.avarias && data.avarias.length > 0) {
          tbody.innerHTML = data.avarias.map(a => 
            '<tr>' +
            '<td>' + new Date(a.data_ocorrencia).toLocaleDateString() + '</td>' +
            '<td>' + (a.motorista_nome || '-') + '</td>' +
            '<td>' + a.tipo + '</td>' +
            '<td>' + (a.descricao || '-').substring(0, 50) + '</td>' +
            '<td>R$ ' + (a.valor_prejuizo || 0).toFixed(2) + '</td>' +
            '<td><span class="badge badge-' + (a.status === 'resolvido' ? 'success' : 'warning') + '">' + a.status + '</span></td>' +
            '</tr>'
          ).join('');
        } else {
          tbody.innerHTML = '<tr><td colspan="6" style="text-align: center;">Nenhuma avaria registrada</td></tr>';
        }
      } catch(err) {
        console.error('Erro ao carregar avarias:', err);
      }
    }

    // Modificar mostrarPagina para carregar dados
    var mostrarPaginaBase = mostrarPagina;
    mostrarPagina = function(pagina, elemento) {
      mostrarPaginaBase(pagina, elemento);
      if (pagina === 'chat') carregarChatADM();
      if (pagina === 'assistencia') carregarAssistencia();
      if (pagina === 'avarias') carregarAvarias();
    };
  </script>

  <style>
    :root {
      --primary: #6366f1;
      --primary-dark: #4f46e5;
      --success: #10b981;
      --warning: #f59e0b;
      --danger: #ef4444;
      --info: #3b82f6;
      --bg-body: #f8fafc;
      --bg-card: #ffffff;
      --bg-sidebar: #1e293b;
      --text-primary: #1e293b;
      --text-muted: #64748b;
      --border: #e2e8f0;
      --radius: 12px;
    }
    * { margin: 0; padding: 0; box-sizing: border-box; }
    body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif; background: var(--bg-body); color: var(--text-primary); display: flex; min-height: 100vh; }
    
    /* SIDEBAR */
    .sidebar { width: 260px; height: 100vh; background: var(--bg-sidebar); position: fixed; left: 0; top: 0; display: flex; flex-direction: column; z-index: 100; }
    .sidebar-header { padding: 24px; border-bottom: 1px solid rgba(255,255,255,0.1); }
    .logo-text { font-size: 24px; font-weight: 700; color: white; }
    .logo-subtitle { font-size: 12px; color: #94a3b8; margin-top: 4px; }
    .sidebar-nav { flex: 1; padding: 16px 12px; overflow-y: auto; }
    .nav-item { display: flex; align-items: center; gap: 12px; padding: 14px 16px; color: #94a3b8; border-radius: 8px; margin-bottom: 4px; cursor: pointer; transition: all 0.2s; }
    .nav-item:hover { background: rgba(255,255,255,0.1); color: #fff; }
    .nav-item.active { background: var(--primary); color: white; }
    .nav-badge { margin-left: auto; background: var(--danger); color: white; padding: 2px 8px; border-radius: 10px; font-size: 11px; }
    .sidebar-footer { padding: 16px 24px; border-top: 1px solid rgba(255,255,255,0.1); }
    .status-online { display: flex; align-items: center; gap: 8px; font-size: 13px; color: var(--success); }
    .status-dot { width: 8px; height: 8px; border-radius: 50%; background: var(--success); }
    
    /* MAIN */
    .main { flex: 1; margin-left: 260px; }
    .header { height: 70px; background: var(--bg-card); border-bottom: 1px solid var(--border); display: flex; align-items: center; justify-content: space-between; padding: 0 32px; position: sticky; top: 0; z-index: 50; }
    .header h1 { font-size: 24px; font-weight: 600; }
    .header-actions { display: flex; gap: 12px; }
    .btn { padding: 10px 20px; border-radius: 8px; font-size: 14px; font-weight: 500; cursor: pointer; border: none; transition: all 0.2s; display: inline-flex; align-items: center; gap: 8px; }
    .btn-primary { background: var(--primary); color: white; }
    .btn-primary:hover { background: var(--primary-dark); }
    .btn-outline { background: white; border: 1px solid var(--border); color: var(--text-primary); }
    .btn-success { background: var(--success); color: white; }
    .btn-danger { background: var(--danger); color: white; }
    .btn-sm { padding: 6px 12px; font-size: 12px; }
    
    .content { padding: 32px; }
    .page { display: none; }
    .page.active { display: block; }
    
    /* STATS */
    .stats-grid { display: grid; grid-template-columns: repeat(4, 1fr); gap: 20px; margin-bottom: 24px; }
    .stat-card { background: var(--bg-card); border-radius: var(--radius); padding: 24px; border: 1px solid var(--border); }
    .stat-icon { width: 48px; height: 48px; border-radius: 10px; display: flex; align-items: center; justify-content: center; font-size: 24px; margin-bottom: 12px; }
    .stat-icon.blue { background: rgba(59,130,246,0.1); }
    .stat-icon.green { background: rgba(16,185,129,0.1); }
    .stat-icon.yellow { background: rgba(245,158,11,0.1); }
    .stat-icon.purple { background: rgba(139,92,246,0.1); }
    .stat-value { font-size: 28px; font-weight: 700; }
    .stat-label { font-size: 13px; color: var(--text-muted); margin-top: 4px; }
    
    /* CARDS */
    .card { background: var(--bg-card); border-radius: var(--radius); border: 1px solid var(--border); margin-bottom: 24px; }
    .card-header { padding: 20px 24px; border-bottom: 1px solid var(--border); display: flex; align-items: center; justify-content: space-between; }
    .card-header h2 { font-size: 16px; font-weight: 600; }
    .card-body { padding: 24px; }
    
    /* MAPA */
    #mapa-motoristas { height: 500px; border-radius: var(--radius); }
    .motorista-marker { background: var(--primary); color: white; padding: 8px 12px; border-radius: 20px; font-size: 12px; font-weight: 600; white-space: nowrap; box-shadow: 0 2px 10px rgba(0,0,0,0.2); }
    .motorista-marker.online { background: var(--success); }
    .motorista-marker.em-corrida { background: var(--info); }
    .motorista-marker.offline { background: #64748b; }
    
    /* LISTA MOTORISTAS NO MAPA */
    .mapa-sidebar { position: absolute; top: 10px; right: 10px; width: 280px; background: white; border-radius: var(--radius); box-shadow: 0 4px 20px rgba(0,0,0,0.15); z-index: 1000; max-height: calc(100% - 20px); overflow: hidden; }
    .mapa-sidebar-header { padding: 16px; border-bottom: 1px solid var(--border); font-weight: 600; }
    .mapa-sidebar-body { max-height: 400px; overflow-y: auto; }
    .motorista-item { padding: 12px 16px; border-bottom: 1px solid var(--border); display: flex; align-items: center; gap: 12px; cursor: pointer; transition: background 0.2s; }
    .motorista-item:hover { background: var(--bg-body); }
    .motorista-avatar { width: 36px; height: 36px; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-weight: 600; color: white; font-size: 14px; }
    .motorista-info { flex: 1; }
    .motorista-nome { font-weight: 500; font-size: 14px; }
    .motorista-local { font-size: 12px; color: var(--text-muted); }
    .motorista-status { width: 10px; height: 10px; border-radius: 50%; }
    .motorista-status.online { background: var(--success); }
    .motorista-status.em-corrida { background: var(--info); }
    .motorista-status.offline { background: #cbd5e1; }
    
    /* TABELAS */
    .table { width: 100%; border-collapse: collapse; }
    .table th, .table td { padding: 14px 16px; text-align: left; border-bottom: 1px solid var(--border); }
    .table th { font-size: 12px; font-weight: 600; text-transform: uppercase; color: var(--text-muted); background: var(--bg-body); }
    .table tbody tr:hover { background: var(--bg-body); }
    .status { display: inline-block; padding: 4px 12px; border-radius: 20px; font-size: 12px; font-weight: 500; }
    .status-online { background: rgba(16,185,129,0.1); color: var(--success); }
    .status-offline { background: rgba(100,116,139,0.1); color: var(--text-muted); }
    .status-em-corrida { background: rgba(59,130,246,0.1); color: var(--info); }
    
    /* FORMS */
    .form-group { margin-bottom: 20px; }
    .form-label { display: block; font-size: 13px; font-weight: 500; margin-bottom: 8px; color: var(--text-muted); }
    .form-input { width: 100%; padding: 12px 16px; background: var(--bg-body); border: 1px solid var(--border); border-radius: 8px; font-size: 14px; }
    .form-input:focus { outline: none; border-color: var(--primary); }
    .form-row { display: grid; grid-template-columns: 1fr 1fr; gap: 16px; }
    .form-row-3 { display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 16px; }
    
    /* SWITCH */
    .switch-group { display: flex; align-items: center; justify-content: space-between; padding: 16px; background: var(--bg-body); border-radius: 8px; margin-bottom: 12px; }
    .switch-label { font-size: 14px; font-weight: 500; }
    .switch-desc { font-size: 12px; color: var(--text-muted); }
    .switch { position: relative; width: 48px; height: 26px; }
    .switch input { opacity: 0; width: 0; height: 0; }
    .switch-slider { position: absolute; cursor: pointer; top: 0; left: 0; right: 0; bottom: 0; background: #cbd5e1; border-radius: 26px; transition: 0.3s; }
    .switch-slider:before { position: absolute; content: ""; height: 20px; width: 20px; left: 3px; bottom: 3px; background: white; border-radius: 50%; transition: 0.3s; }
    .switch input:checked + .switch-slider { background: var(--success); }
    .switch input:checked + .switch-slider:before { transform: translateX(22px); }
    
    /* MODAL */
    .modal { display: none; position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.5); z-index: 2000; align-items: center; justify-content: center; }
    .modal.active { display: flex; }
    .modal-content { background: white; border-radius: var(--radius); width: 100%; max-width: 500px; max-height: 90vh; overflow-y: auto; }
    .modal-header { padding: 20px 24px; border-bottom: 1px solid var(--border); display: flex; align-items: center; justify-content: space-between; }
    .modal-header h3 { font-size: 18px; font-weight: 600; }
    .modal-close { background: none; border: none; font-size: 24px; cursor: pointer; color: var(--text-muted); }
    .modal-body { padding: 24px; }
    .modal-footer { padding: 16px 24px; border-top: 1px solid var(--border); display: flex; gap: 12px; justify-content: flex-end; }
    
    /* RESPONSIVE */
    @media (max-width: 1200px) {
      .stats-grid { grid-template-columns: repeat(2, 1fr); }
    }
    @media (max-width: 768px) {
      .sidebar { display: none; }
      .main { margin-left: 0; }
    }
  </style>
</head>
<body>
  <!-- SIDEBAR -->
  <aside class="sidebar">
    <div class="sidebar-header">
      <div class="logo-text" id="sidebar-nome-empresa">ğŸš— UBMAX</div>
      <div class="logo-subtitle">Painel Administrativo</div>
    </div>
    <nav class="sidebar-nav">
      <div class="nav-item active" onclick="mostrarPagina('dashboard', this)">ğŸ“Š Dashboard</div>
      <div class="nav-item" onclick="mostrarPagina('mapa', this)">ğŸ—ºï¸ Mapa em Tempo Real</div>
      <div class="nav-item" onclick="mostrarPagina('motoristas', this)">ğŸš˜ Motoristas <span class="nav-badge">8</span></div>
      <div class="nav-item" onclick="mostrarPagina('mensalidades', this)">ğŸ’° Mensalidades</div>
      <div class="nav-item" onclick="mostrarPagina('corridas', this)">ğŸ“ Corridas</div>
      <div class="nav-item" onclick="mostrarPagina('nova-corrida', this)">â• Nova Corrida</div>
      <div class="nav-item" onclick="mostrarPagina('chat', this)">ğŸ’¬ Chat Frota</div>
      <div class="nav-item" onclick="mostrarPagina('assistencia', this)">ğŸ”§ AssistÃªncia 24h</div>
      <div class="nav-item" onclick="mostrarPagina('avarias', this)">âš ï¸ Avarias</div>
      <div class="nav-item" onclick="mostrarPagina('clientes', this)">ğŸ‘¥ Clientes</div>
      <div class="nav-item" onclick="mostrarPagina('antifraude', this)">ğŸš¨ Anti-Fraude</div>
      <div class="nav-item" onclick="mostrarPagina('financeiro', this)">ğŸ’° Financeiro</div>
      <div class="nav-item" onclick="mostrarPagina('pagamentos', this)">ğŸ’³ Config. Pagamentos</div>
      <div class="nav-item" onclick="mostrarPagina('configuracoes', this)">âš™ï¸ ConfiguraÃ§Ãµes</div>
    </nav>
    <div class="sidebar-footer">
      <div class="status-online">
        <span class="status-dot"></span>
        <span>Sistema Online</span>
      </div>
    </div>
  </aside>

  <!-- MAIN -->
  <main class="main">
    <header class="header">
      <h1 id="page-title">Dashboard</h1>
      <div class="header-actions">
        <button class="btn btn-outline">ğŸ”„ Atualizar</button>
        <button class="btn btn-primary" onclick="abrirModalMotorista()">+ Novo Motorista</button>
      </div>
    </header>

    <div class="content">
      <!-- DASHBOARD -->
      <section id="page-dashboard" class="page active">
        <div class="stats-grid">
          <div class="stat-card">
            <div class="stat-icon blue">ğŸ“</div>
            <div class="stat-value" id="stat-corridas-hoje">0</div>
            <div class="stat-label">Corridas Hoje</div>
          </div>
          <div class="stat-card">
            <div class="stat-icon green">âœ…</div>
            <div class="stat-value" id="stat-finalizadas">0</div>
            <div class="stat-label">Finalizadas</div>
          </div>
          <div class="stat-card">
            <div class="stat-icon yellow">ğŸš˜</div>
            <div class="stat-value" id="stat-motoristas">0/0</div>
            <div class="stat-label">Motoristas Online</div>
          </div>
          <div class="stat-card">
            <div class="stat-icon purple">ğŸ’°</div>
            <div class="stat-value" id="stat-faturamento">R$ 0,00</div>
            <div class="stat-label">Faturamento Hoje</div>
          </div>
        </div>

        <div class="card">
          <div class="card-header">
            <h2>ğŸš— Corridas em Andamento</h2>
            <span id="badge-corridas-ativas" style="background: var(--info); color: white; padding: 4px 12px; border-radius: 20px; font-size: 12px;">0 ativas</span>
          </div>
          <div class="card-body" style="padding: 0;">
            <table class="table">
              <thead>
                <tr>
                  <th>ID</th>
                  <th>Cliente</th>
                  <th>Motorista</th>
                  <th>Origem â†’ Destino</th>
                  <th>Status</th>
                  <th>Valor</th>
                </tr>
              </thead>
              <tbody id="tabela-corridas-andamento">
                <!-- Dados carregados da API -->
                <tr>
                  <td colspan="6" style="text-align: center; padding: 30px; color: #888;">
                    <div>ğŸ”„ Carregando corridas...</div>
                  </td>
                </tr>
              </tbody>
            </table>
          </div>
        </div>
      </section>

      <!-- MAPA EM TEMPO REAL -->
      <section id="page-mapa" class="page">
        <div class="card">
          <div class="card-header">
            <h2>ğŸ—ºï¸ LocalizaÃ§Ã£o dos Motoristas em Tempo Real</h2>
            <span style="background: var(--success); color: white; padding: 4px 12px; border-radius: 20px; font-size: 12px;">Atualizando a cada 5s</span>
          </div>
          <div class="card-body" style="padding: 0; position: relative;">
            <div id="mapa-motoristas"></div>
            
            <!-- Lista de Motoristas no Mapa -->
            <div class="mapa-sidebar">
              <div class="mapa-sidebar-header">ğŸ‘¥ Motoristas (<span id="qtd-motoristas-online">0</span> online)</div>
              <div class="mapa-sidebar-body" id="lista-motoristas-mapa">
                <!-- Carregado da API -->
                <div style="padding: 20px; text-align: center; color: #888;">
                  ğŸ”„ Carregando motoristas...
                </div>
              </div>
            </div>
                </div>
                <div class="motorista-item" onclick="focalizarMotorista(4)">
                  <div class="motorista-avatar" style="background: var(--success);">RC</div>
                  <div class="motorista-info">
                    <div class="motorista-nome">Rafael Costa</div>
                    <div class="motorista-local">ğŸ“ PraÃ§a Central - DisponÃ­vel</div>
                  </div>
                  <div class="motorista-status online"></div>
                </div>
                <div class="motorista-item">
                  <div class="motorista-avatar" style="background: #94a3b8;">CS</div>
                  <div class="motorista-info">
                    <div class="motorista-nome">Carlos Silva</div>
                    <div class="motorista-local">Ãšltima vez: 2h atrÃ¡s</div>
                  </div>
                  <div class="motorista-status offline"></div>
                </div>
              </div>
            </div>
          </div>
        </div>
      </section>

      <!-- MOTORISTAS -->
      <section id="page-motoristas" class="page">
        <div class="card">
          <div class="card-header">
            <h2>ğŸš˜ Motoristas Cadastrados</h2>
            <button class="btn btn-primary btn-sm" onclick="abrirModalMotorista()">+ Novo Motorista</button>
          </div>
          <div class="card-body" style="padding: 0;">
            <table class="table">
              <thead>
                <tr>
                  <th>Motorista</th>
                  <th>Telefone</th>
                  <th>VeÃ­culo</th>
                  <th>Status</th>
                  <th>Corridas</th>
                  <th>AÃ§Ãµes</th>
                </tr>
              </thead>
              <tbody id="tabela-motoristas">
                <!-- Dados carregados da API -->
                <tr id="motoristas-loading">
                  <td colspan="6" style="text-align: center; padding: 40px; color: #888;">
                    <div style="font-size: 24px; margin-bottom: 10px;">ğŸ”„</div>
                    <div>Carregando motoristas...</div>
                    <small>Nenhum motorista cadastrado? Clique em "+ Novo Motorista"</small>
                  </td>
                </tr>
              </tbody>
            </table>
          </div>
        </div>
      </section>

      <!-- MENSALIDADES -->
      <section id="page-mensalidades" class="page">
        <!-- Alerta de Vencimentos Hoje -->
        <div id="alerta-vencimentos-hoje" style="background: linear-gradient(135deg, #fef3c7, #fde68a); border: 2px solid #f59e0b; border-radius: 12px; padding: 20px; margin-bottom: 20px; display: none;">
          <div style="display: flex; align-items: center; gap: 16px;">
            <div style="width: 50px; height: 50px; background: #f59e0b; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 24px;">
              ğŸ””
            </div>
            <div style="flex: 1;">
              <h3 style="margin: 0 0 4px; color: #92400e;">Vencimentos Hoje!</h3>
              <p style="margin: 0; color: #a16207;" id="texto-vencimentos-hoje">
                Carregando vencimentos...
              </p>
            </div>
            <button class="btn btn-sm" style="background: #f59e0b; color: white;" onclick="enviarLembretesHoje()">
              ğŸ“² Notificar Todos
            </button>
          </div>
        </div>

        <!-- Card Rebeca NotificaÃ§Ãµes -->
        <div class="card" style="background: linear-gradient(135deg, #eff6ff, #dbeafe); border: 1px solid #3b82f6; margin-bottom: 20px;">
          <div class="card-body" style="display: flex; align-items: center; gap: 16px;">
            <div style="width: 60px; height: 60px; background: linear-gradient(135deg, #3b82f6, #1d4ed8); border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 28px;">
              ğŸ¤–
            </div>
            <div style="flex: 1;">
              <h4 style="margin: 0 0 4px; color: #1e40af;">Rebeca cuida dos vencimentos!</h4>
              <p style="margin: 0; color: #3b82f6; font-size: 14px;">
                A Rebeca envia automaticamente: lembretes antes do vencimento, aviso ao dono sobre pagamentos do dia, e cobra inadimplentes.
              </p>
            </div>
            <div style="text-align: right;">
              <div style="font-size: 12px; color: #64748b;">PrÃ³xima verificaÃ§Ã£o</div>
              <div style="font-size: 18px; font-weight: 600; color: #1e40af;">08:00</div>
            </div>
          </div>
        </div>

        <!-- Stats -->
        <div class="stats-grid">
          <div class="stat-card" style="border-left: 4px solid #10b981;">
            <div class="stat-icon green">âœ…</div>
            <div class="stat-value" id="stat-mens-pagas">5</div>
            <div class="stat-label">Motoristas em Dia</div>
          </div>
          <div class="stat-card" style="border-left: 4px solid #f59e0b;">
            <div class="stat-icon yellow">â³</div>
            <div class="stat-value" id="stat-mens-pendentes">2</div>
            <div class="stat-label">Pendentes (vence em breve)</div>
          </div>
          <div class="stat-card" style="border-left: 4px solid #ef4444;">
            <div class="stat-icon red">âŒ</div>
            <div class="stat-value" id="stat-mens-atrasadas">1</div>
            <div class="stat-label">Inadimplentes</div>
          </div>
          <div class="stat-card" style="border-left: 4px solid #6366f1;">
            <div class="stat-icon purple">ğŸ’°</div>
            <div class="stat-value" id="stat-mens-total">R$ 1.200</div>
            <div class="stat-label">Total a Receber</div>
          </div>
        </div>

        <!-- AÃ§Ãµes RÃ¡pidas -->
        <div style="display: flex; gap: 12px; margin-bottom: 20px; flex-wrap: wrap;">
          <button class="btn btn-primary" onclick="gerarMensalidadesMes()">ğŸ“… Gerar Mensalidades</button>
          <button class="btn btn-outline" onclick="verificarVencimentosHoje()">ğŸ”” Ver Vencimentos Hoje</button>
          <button class="btn btn-outline" onclick="enviarLembretes()">ğŸ“² Enviar Lembretes</button>
          <button class="btn btn-outline" onclick="exportarMensalidades()">ğŸ“¥ Exportar</button>
        </div>

        <!-- Lista de Mensalidades -->
        <div class="card">
          <div class="card-header">
            <h2>ğŸ’° Mensalidades dos Motoristas</h2>
            <div style="display: flex; gap: 12px;">
              <select class="form-input" id="filtro-tipo-mens" style="width: 130px;" onchange="filtrarMensalidades()">
                <option value="">Todos tipos</option>
                <option value="semanal">ğŸ“† Semanal</option>
                <option value="quinzenal">ğŸ“† Quinzenal</option>
                <option value="mensal">ğŸ“… Mensal</option>
              </select>
              <select class="form-input" id="filtro-status-mens" style="width: 130px;" onchange="filtrarMensalidades()">
                <option value="">Todos</option>
                <option value="pago">âœ… Pagos</option>
                <option value="pendente">â³ Pendentes</option>
                <option value="atrasado">âŒ Atrasados</option>
              </select>
            </div>
          </div>
          <div class="card-body" style="padding: 0;">
            <table class="table">
              <thead>
                <tr>
                  <th>Motorista</th>
                  <th>Valor</th>
                  <th>RecorrÃªncia</th>
                  <th>Vencimento</th>
                  <th>Status</th>
                  <th>AÃ§Ãµes</th>
                </tr>
              </thead>
              <tbody id="lista-mensalidades">
                <tr>
                  <td>
                    <div style="display: flex; align-items: center; gap: 10px;">
                      <div style="width: 36px; height: 36px; background: linear-gradient(135deg, #10b981, #059669); border-radius: 50%; display: flex; align-items: center; justify-content: center; color: white; font-weight: 600;">JS</div>
                      <div>
                        <strong>JoÃ£o Santos</strong>
                        <div style="font-size: 12px; color: var(--text-muted);">(14) 99999-1111</div>
                      </div>
                    </div>
                  </td>
                  <td><strong>R$ 150,00</strong></td>
                  <td><span class="badge" style="background: #dbeafe; color: #1d4ed8;">ğŸ“† Semanal</span></td>
                  <td>
                    <div>Sexta-feira</div>
                    <small style="color: var(--text-muted);">PrÃ³x: 17/01/2026</small>
                  </td>
                  <td><span class="badge badge-success">âœ… Pago</span></td>
                  <td>
                    <button class="btn btn-sm btn-outline" onclick="verHistoricoMens(1)">ğŸ“Š</button>
                    <button class="btn btn-sm btn-outline" onclick="enviarComprovante(1)">ğŸ“§</button>
                  </td>
                </tr>
                <tr>
                  <td>
                    <div style="display: flex; align-items: center; gap: 10px;">
                      <div style="width: 36px; height: 36px; background: linear-gradient(135deg, #f59e0b, #d97706); border-radius: 50%; display: flex; align-items: center; justify-content: center; color: white; font-weight: 600;">PO</div>
                      <div>
                        <strong>Pedro Oliveira</strong>
                        <div style="font-size: 12px; color: var(--text-muted);">(14) 99999-2222</div>
                      </div>
                    </div>
                  </td>
                  <td><strong>R$ 100,00</strong></td>
                  <td><span class="badge" style="background: #fef3c7; color: #92400e;">ğŸ“… Mensal</span></td>
                  <td>
                    <div>Dia 10</div>
                    <small style="color: var(--text-muted);">PrÃ³x: 10/02/2026</small>
                  </td>
                  <td><span class="badge badge-warning">â³ Pendente</span></td>
                  <td>
                    <button class="btn btn-sm btn-success" onclick="registrarPagamento(2)">ğŸ’µ Pagar</button>
                    <button class="btn btn-sm btn-outline" onclick="enviarLembrete(2)">ğŸ“²</button>
                  </td>
                </tr>
                <tr style="background: #fef2f2;">
                  <td>
                    <div style="display: flex; align-items: center; gap: 10px;">
                      <div style="width: 36px; height: 36px; background: linear-gradient(135deg, #ef4444, #dc2626); border-radius: 50%; display: flex; align-items: center; justify-content: center; color: white; font-weight: 600;">LS</div>
                      <div>
                        <strong>Lucas Souza</strong>
                        <div style="font-size: 12px; color: var(--text-muted);">(14) 99999-3333</div>
                      </div>
                    </div>
                  </td>
                  <td><strong>R$ 150,00</strong></td>
                  <td style="color: #ef4444; font-weight: 600;">05/01/2026 (6 dias atraso)</td>
                  <td><span class="badge badge-danger">âŒ Atrasado</span></td>
                  <td>
                    <button class="btn btn-sm btn-success" onclick="registrarPagamento(3)">ğŸ’µ Pagar</button>
                    <button class="btn btn-sm btn-outline" style="color: #ef4444;" onclick="bloquearMotorista(3)">ğŸš« Bloquear</button>
                  </td>
                </tr>
                <tr>
                  <td>
                    <div style="display: flex; align-items: center; gap: 10px;">
                      <div style="width: 36px; height: 36px; background: linear-gradient(135deg, #10b981, #059669); border-radius: 50%; display: flex; align-items: center; justify-content: center; color: white; font-weight: 600;">ML</div>
                      <div>
                        <strong>Marcos Lima</strong>
                        <div style="font-size: 12px; color: var(--text-muted);">(14) 99999-4444</div>
                      </div>
                    </div>
                  </td>
                  <td><strong>R$ 150,00</strong></td>
                  <td>10/01/2026</td>
                  <td><span class="badge badge-success">âœ… Pago</span></td>
                  <td>
                    <button class="btn btn-sm btn-outline" onclick="verHistoricoMens(4)">ğŸ“Š</button>
                    <button class="btn btn-sm btn-outline" onclick="enviarComprovante(4)">ğŸ“§</button>
                  </td>
                </tr>
              </tbody>
            </table>
          </div>
        </div>

        <!-- ConfiguraÃ§Ã£o RÃ¡pida -->
        <div class="card" style="margin-top: 20px;">
          <div class="card-header">
            <h2>âš™ï¸ ConfiguraÃ§Ãµes RÃ¡pidas de Mensalidade</h2>
          </div>
          <div class="card-body">
            <div class="form-row">
              <div class="form-group">
                <label class="form-label">Valor PadrÃ£o</label>
                <div style="position: relative;">
                  <span style="position: absolute; left: 12px; top: 50%; transform: translateY(-50%); color: var(--text-muted);">R$</span>
                  <input type="number" class="form-input" id="mens-valor-padrao" value="150.00" style="padding-left: 40px;">
                </div>
              </div>
              <div class="form-group">
                <label class="form-label">Dia de Vencimento</label>
                <select class="form-input" id="mens-dia-padrao">
                  <option value="5">Dia 5</option>
                  <option value="10" selected>Dia 10</option>
                  <option value="15">Dia 15</option>
                  <option value="20">Dia 20</option>
                </select>
              </div>
              <div class="form-group">
                <label class="form-label">Bloquear apÃ³s (dias)</label>
                <select class="form-input" id="mens-dias-bloqueio">
                  <option value="0">NÃ£o bloquear</option>
                  <option value="5" selected>5 dias</option>
                  <option value="10">10 dias</option>
                </select>
              </div>
            </div>
            <button class="btn btn-success" onclick="salvarConfigMensalidades()">ğŸ’¾ Salvar</button>
          </div>
        </div>
      </section>

      <!-- CORRIDAS -->
      <section id="page-corridas" class="page">
        <div class="card">
          <div class="card-header">
            <h2>ğŸ“ HistÃ³rico de Corridas</h2>
            <input type="date" class="form-input" style="width: 180px;">
          </div>
          <div class="card-body" style="padding: 0;">
            <table class="table">
              <thead>
                <tr>
                  <th>ID</th>
                  <th>Cliente</th>
                  <th>Motorista</th>
                  <th>Origem â†’ Destino</th>
                  <th>Valor</th>
                  <th>Status</th>
                  <th>Data</th>
                </tr>
              </thead>
              <tbody>
                <tr>
                  <td>#127</td>
                  <td>Maria Silva</td>
                  <td>JoÃ£o Santos</td>
                  <td>Rua das Flores â†’ Shopping</td>
                  <td>R$ 24,50</td>
                  <td><span class="status status-em-corrida">Em Andamento</span></td>
                  <td>10/01 14:32</td>
                </tr>
                <tr>
                  <td>#124</td>
                  <td>Roberto Santos</td>
                  <td>Marcos Lima</td>
                  <td>Hospital â†’ Bairro Novo</td>
                  <td>R$ 15,00</td>
                  <td><span class="status status-online">Finalizada</span></td>
                  <td>10/01 13:45</td>
                </tr>
                <tr>
                  <td>#123</td>
                  <td>Fernanda Oliveira</td>
                  <td>Rafael Costa</td>
                  <td>Escola â†’ PraÃ§a</td>
                  <td>R$ 12,00</td>
                  <td><span class="status status-online">Finalizada</span></td>
                  <td>10/01 13:20</td>
                </tr>
              </tbody>
            </table>
          </div>
        </div>
      </section>

      <!-- CLIENTES -->
      <section id="page-clientes" class="page">
        <div class="card">
          <div class="card-header">
            <h2>ğŸ‘¥ Clientes Cadastrados</h2>
            <span style="background: var(--success); color: white; padding: 4px 12px; border-radius: 20px; font-size: 12px;">127 clientes</span>
          </div>
          <div class="card-body" style="padding: 0;">
            <table class="table">
              <thead>
                <tr>
                  <th>Nome</th>
                  <th>Telefone</th>
                  <th>Corridas</th>
                  <th>Ãšltima Corrida</th>
                  <th>Cadastro</th>
                </tr>
              </thead>
              <tbody>
                <tr>
                  <td>Maria Silva</td>
                  <td>(14) 98765-4321</td>
                  <td>12</td>
                  <td>10/01/2026 14:32</td>
                  <td>15/11/2025</td>
                </tr>
                <tr>
                  <td>Carlos Lima</td>
                  <td>(14) 91234-5678</td>
                  <td>8</td>
                  <td>10/01/2026 14:28</td>
                  <td>20/11/2025</td>
                </tr>
                <tr>
                  <td>Ana Costa</td>
                  <td>(14) 99876-5432</td>
                  <td>5</td>
                  <td>10/01/2026 14:15</td>
                  <td>01/12/2025</td>
                </tr>
              </tbody>
            </table>
          </div>
        </div>
      </section>

      <!-- ANTI-FRAUDE -->
      <section id="page-antifraude" class="page">
        <!-- Stats Anti-Fraude -->
        <div class="stats-grid">
          <div class="stat-card" style="border-left: 4px solid #ef4444;">
            <div class="stat-icon" style="background: rgba(239, 68, 68, 0.2); color: #ef4444;">ğŸš¨</div>
            <div class="stat-value" id="af-criticos">0</div>
            <div class="stat-label">Alertas CrÃ­ticos</div>
          </div>
          <div class="stat-card" style="border-left: 4px solid #f59e0b;">
            <div class="stat-icon" style="background: rgba(245, 158, 11, 0.2); color: #f59e0b;">âš ï¸</div>
            <div class="stat-value" id="af-atencao">0</div>
            <div class="stat-label">AtenÃ§Ã£o</div>
          </div>
          <div class="stat-card" style="border-left: 4px solid #10b981;">
            <div class="stat-icon" style="background: rgba(16, 185, 129, 0.2); color: #10b981;">âœ…</div>
            <div class="stat-value" id="af-ok">0</div>
            <div class="stat-label">Motoristas OK</div>
          </div>
          <div class="stat-card" style="border-left: 4px solid #6366f1;">
            <div class="stat-icon" style="background: rgba(99, 102, 241, 0.2); color: #6366f1;">ğŸ‘ï¸</div>
            <div class="stat-value" id="af-total">0</div>
            <div class="stat-label">Total Alertas</div>
          </div>
        </div>

        <!-- Card explicativo -->
        <div class="card" style="border-left: 4px solid #8b5cf6; margin-bottom: 20px;">
          <div class="card-body" style="display: flex; align-items: center; gap: 16px;">
            <div style="font-size: 40px;">ğŸ¤–</div>
            <div>
              <h3 style="margin-bottom: 4px;">Sistema Anti-Fraude da Rebeca</h3>
              <p style="color: var(--text-muted); font-size: 14px; margin: 0;">
                A Rebeca monitora automaticamente o comportamento dos motoristas e alerta sobre atrasos, 
                cancelamentos excessivos, corridas suspeitas, GPS falso e mais. Alertas crÃ­ticos sÃ£o enviados 
                para vocÃª via WhatsApp.
              </p>
            </div>
            <button class="btn btn-primary" onclick="verificarTodosAntiFraude()">ğŸ”„ Verificar Agora</button>
          </div>
        </div>

        <!-- Lista de Motoristas ProblemÃ¡ticos -->
        <div class="card">
          <div class="card-header">
            <h2>ğŸš¨ Motoristas com Alertas</h2>
            <span class="badge" id="af-badge-problemas" style="background: #ef4444; color: white;">0</span>
          </div>
          <div class="card-body" style="padding: 0;">
            <table class="table">
              <thead>
                <tr>
                  <th>Motorista</th>
                  <th>Score</th>
                  <th>Alertas</th>
                  <th>RecomendaÃ§Ã£o</th>
                  <th>AÃ§Ãµes</th>
                </tr>
              </thead>
              <tbody id="lista-antifraude">
                <tr>
                  <td colspan="5" style="text-align: center; padding: 40px; color: var(--text-muted);">
                    <div style="font-size: 48px; margin-bottom: 12px;">âœ…</div>
                    <div>Nenhum motorista com alertas no momento</div>
                    <button class="btn btn-outline" style="margin-top: 16px;" onclick="verificarTodosAntiFraude()">ğŸ”„ Verificar Agora</button>
                  </td>
                </tr>
              </tbody>
            </table>
          </div>
        </div>

        <!-- Tipos de Alertas -->
        <div style="display: grid; grid-template-columns: repeat(4, 1fr); gap: 16px; margin-top: 20px;">
          <div class="card" style="padding: 16px; text-align: center;">
            <div style="font-size: 28px; margin-bottom: 8px;">â°</div>
            <div style="font-size: 24px; font-weight: 700;" id="af-tipo-atrasos">0</div>
            <div style="font-size: 12px; color: var(--text-muted);">Atrasos</div>
          </div>
          <div class="card" style="padding: 16px; text-align: center;">
            <div style="font-size: 28px; margin-bottom: 8px;">âŒ</div>
            <div style="font-size: 24px; font-weight: 700;" id="af-tipo-cancelamentos">0</div>
            <div style="font-size: 12px; color: var(--text-muted);">Cancelamentos</div>
          </div>
          <div class="card" style="padding: 16px; text-align: center;">
            <div style="font-size: 28px; margin-bottom: 8px;">ğŸ“</div>
            <div style="font-size: 24px; font-weight: 700;" id="af-tipo-gps">0</div>
            <div style="font-size: 12px; color: var(--text-muted);">GPS Suspeito</div>
          </div>
          <div class="card" style="padding: 16px; text-align: center;">
            <div style="font-size: 28px; margin-bottom: 8px;">â­</div>
            <div style="font-size: 24px; font-weight: 700;" id="af-tipo-nota">0</div>
            <div style="font-size: 12px; color: var(--text-muted);">Nota Baixa</div>
          </div>
        </div>
      </section>

      <!-- FINANCEIRO -->
      <section id="page-financeiro" class="page">
        <div class="stats-grid">
          <div class="stat-card" style="border-left: 4px solid #10b981;">
            <div class="stat-icon green">ğŸ’°</div>
            <div class="stat-value" id="fin-faturamento">R$ 12.450</div>
            <div class="stat-label">Faturamento Mensal</div>
          </div>
          <div class="stat-card" style="border-left: 4px solid #3b82f6;">
            <div class="stat-icon blue">ğŸ“ˆ</div>
            <div class="stat-value" id="fin-entradas">R$ 15.200</div>
            <div class="stat-label">Total Entradas</div>
          </div>
          <div class="stat-card" style="border-left: 4px solid #ef4444;">
            <div class="stat-icon red">ğŸ“‰</div>
            <div class="stat-value" id="fin-saidas">R$ 3.850</div>
            <div class="stat-label">Total SaÃ­das</div>
          </div>
          <div class="stat-card" style="border-left: 4px solid #8b5cf6;">
            <div class="stat-icon purple">ğŸ’</div>
            <div class="stat-value" id="fin-lucro">R$ 11.350</div>
            <div class="stat-label">Lucro LÃ­quido</div>
          </div>
        </div>

        <!-- AÃ§Ãµes RÃ¡pidas Financeiro -->
        <div style="display: flex; gap: 12px; margin-bottom: 20px; flex-wrap: wrap;">
          <button class="btn btn-success" onclick="abrirModalFinanceiro('entrada')">â• Registrar Entrada</button>
          <button class="btn btn-danger" onclick="abrirModalFinanceiro('saida')">â– Registrar SaÃ­da</button>
          <button class="btn btn-primary" onclick="abrirModalFinanceiro('venda')">ğŸ’µ Registrar Venda</button>
          <button class="btn btn-outline" onclick="exportarFinanceiro()">ğŸ“¥ Exportar RelatÃ³rio</button>
        </div>

        <!-- LanÃ§amentos Recentes -->
        <div class="card">
          <div class="card-header">
            <h2>ğŸ“‹ LanÃ§amentos Financeiros</h2>
            <div style="display: flex; gap: 12px;">
              <select class="form-input" id="filtro-tipo-fin" style="width: 140px;" onchange="filtrarFinanceiro()">
                <option value="">Todos</option>
                <option value="entrada">ğŸ“ˆ Entradas</option>
                <option value="saida">ğŸ“‰ SaÃ­das</option>
                <option value="venda">ğŸ’µ Vendas</option>
              </select>
              <input type="month" class="form-input" id="filtro-mes-fin" style="width: 160px;" onchange="filtrarFinanceiro()">
            </div>
          </div>
          <div class="card-body" style="padding: 0;">
            <table class="table">
              <thead>
                <tr>
                  <th>Data</th>
                  <th>Tipo</th>
                  <th>DescriÃ§Ã£o</th>
                  <th>Categoria</th>
                  <th>Valor</th>
                  <th>AÃ§Ãµes</th>
                </tr>
              </thead>
              <tbody id="lista-financeiro">
                <tr>
                  <td>11/01/2026</td>
                  <td><span class="badge badge-success">ğŸ“ˆ Entrada</span></td>
                  <td>Corridas do dia</td>
                  <td>Corridas</td>
                  <td style="color: #10b981; font-weight: 600;">+ R$ 850,00</td>
                  <td><button class="btn btn-sm btn-outline" onclick="excluirLancamento(1)">ğŸ—‘ï¸</button></td>
                </tr>
                <tr>
                  <td>10/01/2026</td>
                  <td><span class="badge badge-danger">ğŸ“‰ SaÃ­da</span></td>
                  <td>ManutenÃ§Ã£o - JoÃ£o Santos</td>
                  <td>ManutenÃ§Ã£o</td>
                  <td style="color: #ef4444; font-weight: 600;">- R$ 350,00</td>
                  <td><button class="btn btn-sm btn-outline" onclick="excluirLancamento(2)">ğŸ—‘ï¸</button></td>
                </tr>
                <tr>
                  <td>10/01/2026</td>
                  <td><span class="badge badge-primary">ğŸ’µ Venda</span></td>
                  <td>Mensalidade - Pedro Oliveira</td>
                  <td>Mensalidade</td>
                  <td style="color: #10b981; font-weight: 600;">+ R$ 150,00</td>
                  <td><button class="btn btn-sm btn-outline" onclick="excluirLancamento(3)">ğŸ—‘ï¸</button></td>
                </tr>
                <tr>
                  <td>09/01/2026</td>
                  <td><span class="badge badge-danger">ğŸ“‰ SaÃ­da</span></td>
                  <td>CombustÃ­vel frota</td>
                  <td>CombustÃ­vel</td>
                  <td style="color: #ef4444; font-weight: 600;">- R$ 500,00</td>
                  <td><button class="btn btn-sm btn-outline" onclick="excluirLancamento(4)">ğŸ—‘ï¸</button></td>
                </tr>
              </tbody>
            </table>
          </div>
        </div>

        <!-- Faturamento por Motorista -->
        <div class="card" style="margin-top: 20px;">
          <div class="card-header">
            <h2>ğŸ“Š Faturamento por Motorista</h2>
            <button class="btn btn-outline btn-sm" onclick="exportarFaturamento()">ğŸ“¥ Exportar</button>
          </div>
          <div class="card-body" style="padding: 0;">
            <table class="table">
              <thead>
                <tr>
                  <th>Motorista</th>
                  <th>Corridas</th>
                  <th>Faturamento</th>
                  <th>ComissÃ£o</th>
                  <th>A Receber</th>
                </tr>
              </thead>
              <tbody>
                <tr>
                  <td><strong>JoÃ£o Santos</strong></td>
                  <td>156</td>
                  <td>R$ 3.245,00</td>
                  <td>R$ 486,75</td>
                  <td style="color: var(--success); font-weight: 600;">R$ 2.758,25</td>
                </tr>
                <tr>
                  <td><strong>Pedro Oliveira</strong></td>
                  <td>98</td>
                  <td>R$ 2.156,00</td>
                  <td>R$ 323,40</td>
                  <td style="color: var(--success); font-weight: 600;">R$ 1.832,60</td>
                </tr>
                <tr>
                  <td><strong>Lucas Souza</strong></td>
                  <td>203</td>
                  <td>R$ 4.125,00</td>
                  <td>R$ 618,75</td>
                  <td style="color: var(--success); font-weight: 600;">R$ 3.506,25</td>
                </tr>
              </tbody>
            </table>
          </div>
        </div>

        <!-- ManutenÃ§Ãµes Registradas -->
        <div class="card" style="margin-top: 20px;">
          <div class="card-header">
            <h2>ğŸ”§ ManutenÃ§Ãµes Registradas</h2>
            <span class="badge badge-warning" id="manutencoes-pendentes">2 pendentes</span>
          </div>
          <div class="card-body" style="padding: 0;">
            <table class="table">
              <thead>
                <tr>
                  <th>Motorista</th>
                  <th>VeÃ­culo</th>
                  <th>Tipo</th>
                  <th>Empresa</th>
                  <th>Valor</th>
                  <th>Data</th>
                  <th>Status</th>
                </tr>
              </thead>
              <tbody id="lista-manutencoes-adm">
                <tr>
                  <td><strong>JoÃ£o Santos</strong></td>
                  <td>Fiat Uno - ABC-1234</td>
                  <td>Troca de Ã“leo</td>
                  <td>Auto Center Silva</td>
                  <td>R$ 180,00</td>
                  <td>15/01/2026</td>
                  <td><span class="badge badge-warning">â³ Programada</span></td>
                </tr>
                <tr>
                  <td><strong>Pedro Oliveira</strong></td>
                  <td>VW Gol - DEF-5678</td>
                  <td>RevisÃ£o Completa</td>
                  <td>MecÃ¢nica RÃ¡pida</td>
                  <td>R$ 450,00</td>
                  <td>12/01/2026</td>
                  <td><span class="badge badge-danger">ğŸ”§ Em ManutenÃ§Ã£o</span></td>
                </tr>
              </tbody>
            </table>
          </div>
        </div>
      </section>

      <!-- MODAL FINANCEIRO -->
      <div class="modal" id="modal-financeiro">
        <div class="modal-content" style="max-width: 500px;">
          <div class="modal-header">
            <h3 id="titulo-modal-fin">ğŸ’° Novo LanÃ§amento</h3>
            <button class="modal-close" onclick="fecharModalFinanceiro()">Ã—</button>
          </div>
          <div class="modal-body">
            <div class="form-group">
              <label class="form-label">Tipo de LanÃ§amento</label>
              <select class="form-input" id="fin-tipo" onchange="atualizarCategoriasFin()">
                <option value="entrada">ğŸ“ˆ Entrada</option>
                <option value="saida">ğŸ“‰ SaÃ­da</option>
                <option value="venda">ğŸ’µ Venda</option>
              </select>
            </div>
            <div class="form-group">
              <label class="form-label">Categoria</label>
              <select class="form-input" id="fin-categoria">
                <option value="corridas">ğŸš— Corridas</option>
                <option value="mensalidade">ğŸ’³ Mensalidade</option>
                <option value="outros">ğŸ“¦ Outros</option>
              </select>
            </div>
            <div class="form-group">
              <label class="form-label">DescriÃ§Ã£o</label>
              <input type="text" class="form-input" id="fin-descricao" placeholder="Ex: Corridas do dia, Mensalidade JoÃ£o...">
            </div>
            <div class="form-row">
              <div class="form-group">
                <label class="form-label">Valor (R$)</label>
                <input type="number" class="form-input" id="fin-valor" placeholder="0.00" step="0.01">
              </div>
              <div class="form-group">
                <label class="form-label">Data</label>
                <input type="date" class="form-input" id="fin-data">
              </div>
            </div>
            <div class="form-group">
              <label class="form-label">ObservaÃ§Ãµes</label>
              <textarea class="form-input" id="fin-obs" rows="2" placeholder="ObservaÃ§Ãµes adicionais..."></textarea>
            </div>
          </div>
          <div class="modal-footer">
            <button class="btn btn-outline" onclick="fecharModalFinanceiro()">Cancelar</button>
            <button class="btn btn-success" onclick="salvarLancamento()">ğŸ’¾ Salvar</button>
          </div>
        </div>
      </div>

      <!-- CONFIGURAÃ‡Ã•ES DE PAGAMENTO -->
      <section id="page-pagamentos" class="page">
        <div class="card">
          <div class="card-header">
            <h2>ğŸ’³ ConfiguraÃ§Ãµes de Pagamento</h2>
          </div>
          <div class="card-body">
            <h4 style="margin-bottom: 16px;">ğŸ’µ Formas de Pagamento Aceitas</h4>
            
            <div class="switch-group">
              <div>
                <div class="switch-label">ğŸ’µ Dinheiro</div>
                <div class="switch-desc">Pagamento em espÃ©cie ao motorista</div>
              </div>
              <label class="switch">
                <input type="checkbox" checked>
                <span class="switch-slider"></span>
              </label>
            </div>
            
            <div class="switch-group">
              <div>
                <div class="switch-label">ğŸ’³ CartÃ£o de CrÃ©dito</div>
                <div class="switch-desc">Via maquininha do motorista</div>
              </div>
              <label class="switch">
                <input type="checkbox" checked>
                <span class="switch-slider"></span>
              </label>
            </div>
            
            <div class="switch-group">
              <div>
                <div class="switch-label">ğŸ’³ CartÃ£o de DÃ©bito</div>
                <div class="switch-desc">Via maquininha do motorista</div>
              </div>
              <label class="switch">
                <input type="checkbox" checked>
                <span class="switch-slider"></span>
              </label>
            </div>
            
            <div class="switch-group">
              <div>
                <div class="switch-label">ğŸ“± PIX</div>
                <div class="switch-desc">Pagamento instantÃ¢neo</div>
              </div>
              <label class="switch">
                <input type="checkbox" checked>
                <span class="switch-slider"></span>
              </label>
            </div>
            
            <hr style="margin: 24px 0; border: none; border-top: 1px solid var(--border);">
            
            <h4 style="margin-bottom: 16px;">ğŸ“± ConfiguraÃ§Ãµes do PIX</h4>
            <div class="form-row">
              <div class="form-group">
                <label class="form-label">Tipo de Chave PIX</label>
                <select class="form-input">
                  <option>CNPJ</option>
                  <option>CPF</option>
                  <option>E-mail</option>
                  <option>Telefone</option>
                  <option>Chave AleatÃ³ria</option>
                </select>
              </div>
              <div class="form-group">
                <label class="form-label">Chave PIX</label>
                <input type="text" class="form-input" value="12.345.678/0001-90">
              </div>
            </div>
            <div class="form-group">
              <label class="form-label">Nome do BeneficiÃ¡rio</label>
              <input type="text" class="form-input" value="UBMAX TRANSPORTES LTDA">
            </div>
            
            <hr style="margin: 24px 0; border: none; border-top: 1px solid var(--border);">
            
            <h4 style="margin-bottom: 16px;">ğŸ’° Valores e Taxas</h4>
            <div class="form-row-3">
              <div class="form-group">
                <label class="form-label">Valor Fixo da Corrida</label>
                <input type="text" class="form-input" value="R$ 13,00">
              </div>
              <div class="form-group">
                <label class="form-label">Valor por KM (opcional)</label>
                <input type="text" class="form-input" value="R$ 2,50">
              </div>
              <div class="form-group">
                <label class="form-label">Taxa MÃ­nima</label>
                <input type="text" class="form-input" value="R$ 8,00">
              </div>
            </div>
            
            <div class="form-row">
              <div class="form-group">
                <label class="form-label">ComissÃ£o da Empresa (%)</label>
                <input type="number" class="form-input" value="15">
              </div>
              <div class="form-group">
                <label class="form-label">Taxa Adicional Noturna (%)</label>
                <input type="number" class="form-input" value="20">
              </div>
            </div>
            
            <hr style="margin: 24px 0; border: none; border-top: 1px solid var(--border);">
            
            <h4 style="margin-bottom: 16px;">â° HorÃ¡rios</h4>
            <div class="form-row">
              <div class="form-group">
                <label class="form-label">InÃ­cio Taxa Noturna</label>
                <input type="time" class="form-input" value="22:00">
              </div>
              <div class="form-group">
                <label class="form-label">Fim Taxa Noturna</label>
                <input type="time" class="form-input" value="06:00">
              </div>
            </div>
            
            <button class="btn btn-success" style="margin-top: 16px;">ğŸ’¾ Salvar ConfiguraÃ§Ãµes</button>
          </div>
        </div>
      </section>

      <!-- CONFIGURAÃ‡Ã•ES GERAIS -->
      <section id="page-configuracoes" class="page">
        <!-- BOTÃƒO GRANDE FROTA EM TEMPO REAL -->
        <div class="card" style="background: linear-gradient(135deg, #6366f1, #8b5cf6); border: none; cursor: pointer;" onclick="mostrarPagina('mapa', document.querySelector('[onclick*=mapa]'))">
          <div class="card-body" style="display: flex; align-items: center; justify-content: space-between; padding: 24px 32px;">
            <div style="display: flex; align-items: center; gap: 20px;">
              <div style="width: 64px; height: 64px; background: rgba(255,255,255,0.2); border-radius: 16px; display: flex; align-items: center; justify-content: center; font-size: 32px;">
                ğŸ—ºï¸
              </div>
              <div>
                <h3 style="color: white; font-size: 20px; margin-bottom: 4px;">Frota em Tempo Real</h3>
                <p style="color: rgba(255,255,255,0.8); font-size: 14px; margin: 0;">Veja a localizaÃ§Ã£o de todos os motoristas no mapa</p>
              </div>
            </div>
            <div style="display: flex; align-items: center; gap: 12px;">
              <div style="text-align: right;">
                <span style="color: white; font-size: 28px; font-weight: 700;">5</span>
                <span style="color: rgba(255,255,255,0.8); font-size: 13px; display: block;">online agora</span>
              </div>
              <div style="width: 48px; height: 48px; background: rgba(255,255,255,0.2); border-radius: 50%; display: flex; align-items: center; justify-content: center;">
                <span style="color: white; font-size: 24px;">â†’</span>
              </div>
            </div>
          </div>
        </div>

        <div class="card">
          <div class="card-header">
            <h2>âš™ï¸ ConfiguraÃ§Ãµes da Empresa</h2>
          </div>
          <div class="card-body">
            <!-- TELEFONES DO SISTEMA - DESTAQUE -->
            <div style="background: linear-gradient(135deg, #eff6ff, #dbeafe); border: 2px solid #3b82f6; border-radius: 16px; padding: 20px; margin-bottom: 24px;">
              <h4 style="margin: 0 0 16px; color: #1e40af; display: flex; align-items: center; gap: 8px;">
                ğŸ“± Telefones do Sistema
                <span style="background: #3b82f6; color: white; font-size: 10px; padding: 2px 8px; border-radius: 10px;">IMPORTANTE</span>
              </h4>
              
              <div class="form-group" style="margin-bottom: 16px;">
                <label class="form-label" style="color: #1e40af; font-size: 15px;">ğŸ‘¤ WhatsApp do Dono da Frota</label>
                <input type="text" class="form-input" id="config-telefone-adm" placeholder="5514999990001" style="border-color: #3b82f6; font-size: 16px;">
                <small style="color: #3b82f6;">Recebe todas as notificaÃ§Ãµes do sistema (atrasos, fraudes, manutenÃ§Ãµes, relatÃ³rios)</small>
              </div>
              
              <div class="form-group">
                <label class="form-label" style="color: #1e40af; font-size: 15px;">ğŸ¤– WhatsApp da Rebeca (Atendimento)</label>
                <input type="text" class="form-input" id="config-telefone-rebeca" placeholder="5514999990002" style="border-color: #3b82f6; font-size: 16px;">
                <small style="color: #3b82f6;">NÃºmero que os clientes usam para pedir corrida</small>
              </div>
              
              <div style="display: flex; gap: 12px; margin-top: 16px; flex-wrap: wrap;">
                <button class="btn btn-sm" style="background: #3b82f6; color: white;" onclick="salvarTelefonesSistema()">ğŸ’¾ Salvar Telefones</button>
                <button class="btn btn-sm btn-outline" onclick="testarNotificacaoADM()">ğŸ“² Testar NotificaÃ§Ã£o</button>
              </div>
              
              <div style="margin-top: 16px; padding-top: 16px; border-top: 1px solid #93c5fd;">
                <p style="margin: 0; font-size: 13px; color: #1e40af;">
                  <strong>â„¹ï¸ Como funciona:</strong> A Rebeca recebe mensagens no nÃºmero dela e envia notificaÃ§Ãµes 
                  (atrasos, anti-fraude, vencimentos, manutenÃ§Ãµes) para o WhatsApp do Dono da Frota.
                </p>
              </div>
            </div>
            
            <h4 style="margin-bottom: 16px;">ğŸ¢ Dados da Empresa</h4>
            <div class="form-row">
              <div class="form-group">
                <label class="form-label">Nome da Empresa</label>
                <input type="text" class="form-input" id="config-nome-empresa" value="UBMAX Transportes">
              </div>
              <div class="form-group">
                <label class="form-label">CNPJ</label>
                <input type="text" class="form-input" id="config-cnpj" value="12.345.678/0001-90">
              </div>
            </div>
            <div class="form-row">
              <div class="form-group">
                <label class="form-label">Telefone Comercial</label>
                <input type="text" class="form-input" id="config-telefone-comercial" value="(14) 99999-0001">
              </div>
              <div class="form-group">
                <label class="form-label">E-mail</label>
                <input type="email" class="form-input" id="config-email-empresa" value="contato@ubmax.com">
              </div>
            </div>
            <div class="form-group">
              <label class="form-label">Cidade de AtuaÃ§Ã£o</label>
              <input type="text" class="form-input" id="config-cidade" value="Lins - SP">
            </div>
            
            <hr style="margin: 24px 0; border: none; border-top: 1px solid var(--border);">
            
            <h4 style="margin-bottom: 16px;">ğŸ”” PreferÃªncias de NotificaÃ§Ãµes</h4>
            <div style="background: #f0fdf4; border: 1px solid #86efac; border-radius: 8px; padding: 12px; margin-bottom: 16px;">
              <p style="margin: 0; font-size: 14px; color: #166534;">
                âœ… As notificaÃ§Ãµes serÃ£o enviadas para o <strong>WhatsApp do ADM Principal</strong> configurado acima.
              </p>
            </div>
            <div class="form-row">
              <div class="form-group">
                <label class="form-label">ğŸ“§ E-mail para RelatÃ³rios (opcional)</label>
                <input type="email" class="form-input" id="config-email-adm" placeholder="seu@email.com" value="">
              </div>
            </div>
            <div class="form-group">
              <label class="form-label">Receber notificaÃ§Ãµes de:</label>
              <div style="display: flex; flex-wrap: wrap; gap: 16px; margin-top: 8px;">
                <label style="display: flex; align-items: center; gap: 8px; cursor: pointer;">
                  <input type="checkbox" id="notif-atrasos" checked> 
                  <span>â° Atrasos de motoristas</span>
                </label>
                <label style="display: flex; align-items: center; gap: 8px; cursor: pointer;">
                  <input type="checkbox" id="notif-antifraude" checked> 
                  <span>ğŸš¨ Alertas anti-fraude</span>
                </label>
                <label style="display: flex; align-items: center; gap: 8px; cursor: pointer;">
                  <input type="checkbox" id="notif-corridas" checked> 
                  <span>ğŸš— Resumo de corridas</span>
                </label>
                <label style="display: flex; align-items: center; gap: 8px; cursor: pointer;">
                  <input type="checkbox" id="notif-financeiro"> 
                  <span>ğŸ’° RelatÃ³rio financeiro</span>
                </label>
              </div>
            </div>
            <div class="form-group">
              <label class="form-label">FrequÃªncia de relatÃ³rios:</label>
              <div style="display: flex; gap: 12px; margin-top: 8px;">
                <label style="display: flex; align-items: center; gap: 8px; cursor: pointer;">
                  <input type="radio" name="freq-relatorio" value="diario" checked> 
                  <span>DiÃ¡rio</span>
                </label>
                <label style="display: flex; align-items: center; gap: 8px; cursor: pointer;">
                  <input type="radio" name="freq-relatorio" value="semanal"> 
                  <span>Semanal</span>
                </label>
                <label style="display: flex; align-items: center; gap: 8px; cursor: pointer;">
                  <input type="radio" name="freq-relatorio" value="nunca"> 
                  <span>Nunca</span>
                </label>
              </div>
            </div>
            <button class="btn btn-primary" onclick="salvarConfigNotificacoes()" style="margin-top: 12px;">
              ğŸ’¾ Salvar ConfiguraÃ§Ãµes de NotificaÃ§Ã£o
            </button>
            <button class="btn btn-outline" onclick="testarNotificacao()" style="margin-top: 12px; margin-left: 8px;">
              ğŸ§ª Testar NotificaÃ§Ã£o
            </button>
            
            <hr style="margin: 24px 0; border: none; border-top: 1px solid var(--border);">
            
            <!-- CONFIGURAÃ‡Ã•ES DE MENSALIDADE -->
            <h4 style="margin-bottom: 16px; display: flex; align-items: center; gap: 8px;">
              ğŸ’° Mensalidade dos Motoristas
              <span style="background: #f59e0b; color: white; font-size: 10px; padding: 2px 8px; border-radius: 10px;">IMPORTANTE</span>
            </h4>
            
            <div style="background: linear-gradient(135deg, #fefce8, #fef9c3); border: 1px solid #fde047; border-radius: 12px; padding: 16px; margin-bottom: 16px;">
              <p style="margin: 0; font-size: 14px; color: #854d0e;">
                ğŸ’¡ Configure o valor padrÃ£o da mensalidade. Ao cadastrar um novo motorista, esses valores serÃ£o usados automaticamente (podendo ser alterados individualmente).
              </p>
            </div>
            
            <div class="form-row">
              <div class="form-group">
                <label class="form-label">ğŸ’µ Valor PadrÃ£o da Mensalidade</label>
                <div style="position: relative;">
                  <span style="position: absolute; left: 12px; top: 50%; transform: translateY(-50%); color: var(--text-muted); font-weight: 600;">R$</span>
                  <input type="number" class="form-input" id="config-valor-mensalidade" placeholder="150.00" step="0.01" min="0" style="padding-left: 40px;" value="150.00">
                </div>
              </div>
              <div class="form-group">
                <label class="form-label">ğŸ“… Dia PadrÃ£o de Vencimento</label>
                <select class="form-input" id="config-dia-vencimento">
                  <option value="5">Todo dia 5</option>
                  <option value="10" selected>Todo dia 10</option>
                  <option value="15">Todo dia 15</option>
                  <option value="20">Todo dia 20</option>
                  <option value="25">Todo dia 25</option>
                </select>
              </div>
            </div>
            
            <div class="form-row">
              <div class="form-group">
                <label class="form-label">ğŸ”’ Bloquear motorista inadimplente apÃ³s</label>
                <select class="form-input" id="config-dias-bloqueio">
                  <option value="0">NÃ£o bloquear automaticamente</option>
                  <option value="3">3 dias de atraso</option>
                  <option value="5" selected>5 dias de atraso</option>
                  <option value="10">10 dias de atraso</option>
                  <option value="15">15 dias de atraso</option>
                </select>
              </div>
              <div class="form-group">
                <label class="form-label">ğŸ“± Lembrete de vencimento</label>
                <select class="form-input" id="config-lembrete-vencimento">
                  <option value="0">NÃ£o enviar lembrete</option>
                  <option value="1">1 dia antes</option>
                  <option value="3" selected>3 dias antes</option>
                  <option value="5">5 dias antes</option>
                  <option value="7">7 dias antes</option>
                </select>
              </div>
            </div>
            
            <div style="background: #f1f5f9; border-radius: 8px; padding: 16px; margin-top: 12px;">
              <h5 style="margin: 0 0 12px; font-size: 14px;">ğŸ“‹ Resumo de Mensalidades</h5>
              <div style="display: grid; grid-template-columns: repeat(4, 1fr); gap: 12px; text-align: center;">
                <div style="background: white; padding: 12px; border-radius: 8px;">
                  <div style="font-size: 24px; font-weight: 700; color: #10b981;" id="mens-pagas">0</div>
                  <div style="font-size: 12px; color: var(--text-muted);">Em dia</div>
                </div>
                <div style="background: white; padding: 12px; border-radius: 8px;">
                  <div style="font-size: 24px; font-weight: 700; color: #f59e0b;" id="mens-pendentes">0</div>
                  <div style="font-size: 12px; color: var(--text-muted);">Pendentes</div>
                </div>
                <div style="background: white; padding: 12px; border-radius: 8px;">
                  <div style="font-size: 24px; font-weight: 700; color: #ef4444;" id="mens-atrasadas">0</div>
                  <div style="font-size: 12px; color: var(--text-muted);">Atrasadas</div>
                </div>
                <div style="background: white; padding: 12px; border-radius: 8px;">
                  <div style="font-size: 24px; font-weight: 700; color: #6366f1;" id="mens-total">R$ 0</div>
                  <div style="font-size: 12px; color: var(--text-muted);">A receber</div>
                </div>
              </div>
              <button class="btn btn-outline btn-sm" style="margin-top: 12px;" onclick="mostrarPagina('mensalidades', null)">ğŸ“Š Ver Detalhes</button>
            </div>
            
            <hr style="margin: 24px 0; border: none; border-top: 1px solid var(--border);">
            
            <h4 style="margin-bottom: 16px;">ğŸ¤– ConfiguraÃ§Ãµes do Bot (Rebeca)</h4>
            <div class="form-group">
              <label class="form-label">Mensagem de Boas-Vindas</label>
              <textarea class="form-input" rows="3">Oi! ğŸš— Precisa de um carro? Me fala o endereÃ§o ou manda sua localizaÃ§Ã£o!</textarea>
            </div>
            <div class="form-row">
              <div class="form-group">
                <label class="form-label">HorÃ¡rio de Funcionamento - InÃ­cio</label>
                <input type="time" class="form-input" value="06:00">
              </div>
              <div class="form-group">
                <label class="form-label">HorÃ¡rio de Funcionamento - Fim</label>
                <input type="time" class="form-input" value="23:00">
              </div>
            </div>
            <div class="form-group">
              <label class="form-label">Mensagem Fora do HorÃ¡rio</label>
              <textarea class="form-input" rows="2">Nosso horÃ¡rio de atendimento Ã© das 06h Ã s 23h. Deixe sua mensagem que retornaremos assim que possÃ­vel! ğŸ™</textarea>
            </div>
            
            <hr style="margin: 24px 0; border: none; border-top: 1px solid var(--border);">
            
            <!-- NOTIFICAÃ‡Ã•ES DA REBECA -->
            <h4 style="margin-bottom: 16px; display: flex; align-items: center; gap: 8px;">
              ğŸ“¢ NotificaÃ§Ãµes da Rebeca
              <span style="background: #10b981; color: white; font-size: 10px; padding: 2px 8px; border-radius: 10px;">NOVO</span>
            </h4>
            
            <div style="background: linear-gradient(135deg, #f0fdf4, #dcfce7); border: 1px solid #86efac; border-radius: 12px; padding: 16px; margin-bottom: 16px;">
              <p style="margin: 0; font-size: 14px; color: #166534;">
                ğŸ¤– A Rebeca pode enviar alertas importantes diretamente no seu WhatsApp: atrasos de motoristas, alertas anti-fraude, corridas canceladas e relatÃ³rios diÃ¡rios.
              </p>
            </div>
            
            <div class="form-row">
              <div class="form-group">
                <label class="form-label">ğŸ“± WhatsApp do Dono da Frota</label>
                <input type="text" class="form-input" id="config-telefone-adm" placeholder="5514999990001" value="">
                <small style="color: var(--text-muted);">Formato: 5511999999999 (com DDI e DDD, sem sÃ­mbolos)</small>
              </div>
              <div class="form-group">
                <label class="form-label">ğŸ“§ E-mail para RelatÃ³rios</label>
                <input type="email" class="form-input" id="config-email-adm" placeholder="dono@frota.com" value="">
              </div>
            </div>
            
            <h5 style="margin: 16px 0 12px; font-size: 14px;">Quais notificaÃ§Ãµes deseja receber?</h5>
            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 12px;">
              <label style="display: flex; align-items: center; gap: 10px; padding: 12px; background: var(--bg-body); border-radius: 8px; cursor: pointer;">
                <input type="checkbox" id="notif-atrasos" checked style="width: 18px; height: 18px;">
                <div>
                  <span style="font-weight: 500;">â° Atrasos de Motoristas</span>
                  <small style="display: block; color: var(--text-muted);">Quando motorista nÃ£o chega no tempo</small>
                </div>
              </label>
              <label style="display: flex; align-items: center; gap: 10px; padding: 12px; background: var(--bg-body); border-radius: 8px; cursor: pointer;">
                <input type="checkbox" id="notif-antifraude" checked style="width: 18px; height: 18px;">
                <div>
                  <span style="font-weight: 500;">ğŸš¨ Alertas Anti-Fraude</span>
                  <small style="display: block; color: var(--text-muted);">Comportamentos suspeitos</small>
                </div>
              </label>
              <label style="display: flex; align-items: center; gap: 10px; padding: 12px; background: var(--bg-body); border-radius: 8px; cursor: pointer;">
                <input type="checkbox" id="notif-cancelamentos" checked style="width: 18px; height: 18px;">
                <div>
                  <span style="font-weight: 500;">âŒ Cancelamentos</span>
                  <small style="display: block; color: var(--text-muted);">Corridas canceladas pelo motorista</small>
                </div>
              </label>
              <label style="display: flex; align-items: center; gap: 10px; padding: 12px; background: var(--bg-body); border-radius: 8px; cursor: pointer;">
                <input type="checkbox" id="notif-relatorio" style="width: 18px; height: 18px;">
                <div>
                  <span style="font-weight: 500;">ğŸ“Š RelatÃ³rio DiÃ¡rio</span>
                  <small style="display: block; color: var(--text-muted);">Resumo Ã s 22h todo dia</small>
                </div>
              </label>
            </div>
            
            <div style="margin-top: 16px;">
              <button class="btn btn-outline" onclick="testarNotificacaoRebeca()">ğŸ“² Testar NotificaÃ§Ã£o</button>
            </div>
            
            <button class="btn btn-success" style="margin-top: 16px;" onclick="salvarConfiguracoes()">ğŸ’¾ Salvar ConfiguraÃ§Ãµes</button>
          </div>
        </div>
      </section>
    </div>
  </main>

  <!-- PÃGINA NOVA CORRIDA -->
  <div id="pagina-nova-corrida" class="pagina" style="display: none;">
    <div class="page-header">
      <h1>â• Nova Corrida Manual</h1>
      <p class="text-muted">Criar corrida manualmente para enviar Ã  Rebeca</p>
    </div>
    <div class="card">
      <div class="card-body">
        <form id="form-nova-corrida" onsubmit="criarCorridaManual(event)">
          <div class="form-group">
            <label>ğŸ“ Telefone do Cliente</label>
            <input type="tel" id="nc-telefone" class="form-input" placeholder="(14) 99999-9999" required>
          </div>
          <div class="form-group">
            <label>ğŸ‘¤ Nome do Cliente</label>
            <input type="text" id="nc-nome" class="form-input" placeholder="Nome do cliente" required>
          </div>
          <div class="form-group">
            <label>ğŸ“ EndereÃ§o de Origem</label>
            <input type="text" id="nc-origem" class="form-input" placeholder="Rua, nÃºmero, bairro" required>
          </div>
          <div class="form-group">
            <label>ğŸ EndereÃ§o de Destino</label>
            <input type="text" id="nc-destino" class="form-input" placeholder="Rua, nÃºmero, bairro" required>
          </div>
          <div class="form-group">
            <label>ğŸ’¬ ObservaÃ§Ãµes</label>
            <textarea id="nc-obs" class="form-input" rows="2" placeholder="ObservaÃ§Ãµes..."></textarea>
          </div>
          <button type="submit" class="btn btn-primary" style="width: 100%;">ğŸš— Criar Corrida</button>
        </form>
      </div>
    </div>
  </div>

  <!-- PÃGINA CHAT FROTA -->
  <div id="pagina-chat" class="pagina" style="display: none;">
    <div class="page-header">
      <h1>ğŸ’¬ Chat da Frota</h1>
      <p class="text-muted">ComunicaÃ§Ã£o com motoristas em tempo real</p>
    </div>
    <div class="card">
      <div class="card-body">
        <div id="chat-mensagens" style="height: 400px; overflow-y: auto; border: 1px solid var(--border); border-radius: 8px; padding: 16px; margin-bottom: 16px; background: #f8fafc;"></div>
        <div style="display: flex; gap: 12px;">
          <input type="text" id="chat-input" class="form-input" placeholder="Digite sua mensagem..." style="flex: 1;">
          <button class="btn btn-primary" onclick="enviarMensagemChatADM()">ğŸ“¤ Enviar</button>
          <button class="btn btn-success" onclick="enviarBroadcast()">ğŸ“¢ Broadcast</button>
        </div>
      </div>
    </div>
  </div>

  <!-- PÃGINA ASSISTÃŠNCIA 24H -->
  <div id="pagina-assistencia" class="pagina" style="display: none;">
    <div class="page-header">
      <div style="display: flex; justify-content: space-between; align-items: center;">
        <div>
          <h1>ğŸ”§ AssistÃªncia 24h</h1>
          <p class="text-muted">Contatos de emergÃªncia para motoristas</p>
        </div>
        <button class="btn btn-primary" onclick="abrirModalNovoContato()">â• Novo Contato</button>
      </div>
    </div>
    <div class="card">
      <div class="card-body">
        <table class="table">
          <thead>
            <tr><th>Tipo</th><th>Nome</th><th>Telefone</th><th>AÃ§Ãµes</th></tr>
          </thead>
          <tbody id="tabela-assistencia"></tbody>
        </table>
      </div>
    </div>
  </div>

  <!-- PÃGINA AVARIAS -->
  <div id="pagina-avarias" class="pagina" style="display: none;">
    <div class="page-header">
      <h1>âš ï¸ Registro de Avarias</h1>
      <p class="text-muted">HistÃ³rico de acidentes e avarias dos motoristas</p>
    </div>
    <div class="card">
      <div class="card-body">
        <table class="table">
          <thead>
            <tr><th>Data</th><th>Motorista</th><th>Tipo</th><th>DescriÃ§Ã£o</th><th>Valor PrejuÃ­zo</th><th>Status</th></tr>
          </thead>
          <tbody id="tabela-avarias"></tbody>
        </table>
      </div>
    </div>
  </div>


  <!-- MODAL NOVO MOTORISTA -->
  <!-- MODAL: NOVO MOTORISTA COM MENSALIDADE -->
  <div class="modal" id="modal-motorista">
    <div class="modal-content" style="max-width: 600px;">
      <div class="modal-header">
        <h3>â• Cadastrar Novo Motorista</h3>
        <button class="modal-close" onclick="fecharModalMotorista()">Ã—</button>
      </div>
      <div class="modal-body">
        <!-- Aviso -->
        <div style="background: linear-gradient(135deg, #dbeafe, #eff6ff); border: 1px solid #3b82f6; border-radius: 8px; padding: 12px; margin-bottom: 20px;">
          <p style="margin: 0; font-size: 14px; color: #1e40af;">
            ğŸš€ Ao cadastrar, o motorista receberÃ¡ um <strong>link de primeiro acesso</strong> via WhatsApp para configurar sua senha e comeÃ§ar a trabalhar imediatamente!
          </p>
        </div>

        <!-- Dados Pessoais -->
        <h4 style="margin-bottom: 12px; color: var(--text-muted); font-size: 13px; text-transform: uppercase;">ğŸ‘¤ Dados do Motorista</h4>
        
        <div class="form-group">
          <label class="form-label">Nome Completo *</label>
          <input type="text" class="form-input" id="mot-nome" placeholder="Ex: JoÃ£o da Silva Santos">
        </div>
        
        <div class="form-row">
          <div class="form-group">
            <label class="form-label">WhatsApp *</label>
            <input type="tel" class="form-input" id="mot-telefone" placeholder="14999990000">
            <small style="color: var(--text-muted);">Apenas nÃºmeros com DDD</small>
          </div>
        </div>
        
        <div class="form-row">
          <div class="form-group">
            <label class="form-label">CPF</label>
            <input type="text" class="form-input" id="mot-cpf" placeholder="000.000.000-00">
          </div>
          <div class="form-group">
            <label class="form-label">CNH</label>
            <input type="text" class="form-input" id="mot-cnh" placeholder="00000000000">
            <small style="color: var(--text-muted);">NÃºmero da habilitaÃ§Ã£o</small>
          </div>
        </div>

        <!-- VeÃ­culo -->
        <h4 style="margin: 20px 0 12px; color: var(--text-muted); font-size: 13px; text-transform: uppercase;">ğŸš— VeÃ­culo</h4>
        
        <div class="form-row">
          <div class="form-group">
            <label class="form-label">Modelo *</label>
            <input type="text" class="form-input" id="mot-veiculo" placeholder="Ex: Fiat Uno">
          </div>
          <div class="form-group">
            <label class="form-label">Cor *</label>
            <input type="text" class="form-input" id="mot-cor" placeholder="Ex: Branco">
          </div>
        </div>
        
        <div class="form-row">
          <div class="form-group">
            <label class="form-label">Placa *</label>
            <input type="text" class="form-input" id="mot-placa" placeholder="ABC-1234" style="text-transform: uppercase;">
          </div>
          <div class="form-group">
            <label class="form-label">Ano</label>
            <input type="number" class="form-input" id="mot-ano" placeholder="2020" min="1990" max="2030">
          </div>
        </div>

        <!-- Mensalidade -->
        <h4 style="margin: 20px 0 12px; color: var(--text-muted); font-size: 13px; text-transform: uppercase;">ğŸ’° Mensalidade</h4>
        
        <div style="background: #fef3c7; border: 1px solid #fcd34d; border-radius: 8px; padding: 12px; margin-bottom: 16px;">
          <p style="margin: 0; font-size: 13px; color: #92400e;">
            ğŸ’¡ A mensalidade serÃ¡ cobrada automaticamente. O motorista sÃ³ poderÃ¡ trabalhar com pagamento em dia.
          </p>
        </div>
        
        <div class="form-row">
          <div class="form-group">
            <label class="form-label">Valor da Mensalidade *</label>
            <div style="position: relative;">
              <span style="position: absolute; left: 12px; top: 50%; transform: translateY(-50%); color: var(--text-muted);">R$</span>
              <input type="number" class="form-input" id="mot-valor-mensalidade" placeholder="150.00" step="0.01" min="0" style="padding-left: 40px;">
            </div>
          </div>
          <div class="form-group">
            <label class="form-label">Tipo de CobranÃ§a *</label>
            <select class="form-input" id="mot-tipo-recorrencia" onchange="alternarTipoRecorrencia()">
              <option value="mensal">ğŸ“… Mensal</option>
              <option value="semanal">ğŸ“† Semanal</option>
              <option value="quinzenal">ğŸ“† Quinzenal</option>
            </select>
          </div>
        </div>
        
        <div class="form-row">
          <div class="form-group" id="grupo-dia-mes">
            <label class="form-label">Dia do Vencimento (MÃªs) *</label>
            <select class="form-input" id="mot-dia-vencimento">
              <option value="5">Dia 5</option>
              <option value="10" selected>Dia 10</option>
              <option value="15">Dia 15</option>
              <option value="20">Dia 20</option>
              <option value="25">Dia 25</option>
            </select>
          </div>
          <div class="form-group" id="grupo-dia-semana" style="display: none;">
            <label class="form-label">Dia da Semana *</label>
            <select class="form-input" id="mot-dia-semana">
              <option value="1">Segunda-feira</option>
              <option value="2">TerÃ§a-feira</option>
              <option value="3">Quarta-feira</option>
              <option value="4">Quinta-feira</option>
              <option value="5" selected>Sexta-feira</option>
              <option value="6">SÃ¡bado</option>
              <option value="0">Domingo</option>
            </select>
          </div>
          <div class="form-group">
            <label class="form-label">Primeiro Vencimento</label>
            <input type="date" class="form-input" id="mot-primeiro-vencimento">
          </div>
        </div>

        <!-- SituaÃ§Ã£o Inicial -->
        <h4 style="margin: 20px 0 12px; color: var(--text-muted); font-size: 13px; text-transform: uppercase;">âš™ï¸ ConfiguraÃ§Ãµes</h4>
        
        <div class="form-row">
          <div class="form-group">
            <label class="form-label">Status Inicial</label>
            <select class="form-input" id="mot-status-inicial">
              <option value="ativo">âœ… Ativo (pode trabalhar)</option>
              <option value="pendente">â³ Pendente (aguardando documentos)</option>
            </select>
          </div>
          <div class="form-group">
            <label style="display: flex; align-items: center; gap: 8px; margin-bottom: 8px;">
              <input type="checkbox" id="mot-tem-comissao" onchange="toggleComissao()">
              <span class="form-label" style="margin: 0;">Cobrar ComissÃ£o</span>
            </label>
            <div id="campo-comissao" style="display: none;">
              <input type="number" class="form-input" id="mot-comissao" placeholder="15" value="15" min="0" max="100">
              <small style="color: var(--text-muted);">% que fica com a empresa por corrida</small>
            </div>
          </div>
        </div>
        
        <div class="form-group">
          <label style="display: flex; align-items: center; gap: 8px; cursor: pointer;">
            <input type="checkbox" id="mot-enviar-whatsapp" checked>
            <span>ğŸ“± Enviar link de acesso via WhatsApp automaticamente</span>
          </label>
        </div>
      </div>
      
      <div class="modal-footer">
        <button class="btn btn-outline" onclick="fecharModalMotorista()">Cancelar</button>
        <button class="btn btn-success" onclick="cadastrarMotorista()">âœ“ Cadastrar e Enviar Acesso</button>
      </div>
    </div>
  </div>

  <!-- MODAL: SUCESSO CADASTRO -->
  <div class="modal" id="modal-sucesso-motorista">
    <div class="modal-content" style="max-width: 500px; text-align: center;">
      <div class="modal-body" style="padding: 40px;">
        <div style="width: 80px; height: 80px; background: linear-gradient(135deg, #10b981, #059669); border-radius: 50%; display: flex; align-items: center; justify-content: center; margin: 0 auto 20px; font-size: 40px;">
          âœ…
        </div>
        <h2 style="margin-bottom: 12px;">Motorista Cadastrado!</h2>
        <p style="color: var(--text-muted); margin-bottom: 24px;" id="msg-sucesso-motorista">
          O link de primeiro acesso foi enviado via WhatsApp.
        </p>
        
        <div style="background: #f1f5f9; border-radius: 8px; padding: 16px; text-align: left; margin-bottom: 20px;">
          <p style="margin: 0 0 8px; font-size: 13px; color: var(--text-muted);">Link de acesso (caso precise reenviar):</p>
          <div style="display: flex; gap: 8px;">
            <input type="text" class="form-input" id="link-acesso-motorista" readonly style="font-family: monospace; font-size: 12px;">
            <button class="btn btn-outline btn-sm" onclick="copiarLinkAcesso()">ğŸ“‹</button>
          </div>
        </div>
        
        <div style="display: flex; gap: 12px; justify-content: center;">
          <button class="btn btn-outline" onclick="fecharModalSucesso()">Fechar</button>
          <button class="btn btn-primary" onclick="fecharModalSucesso(); abrirModalMotorista();">+ Cadastrar Outro</button>
        </div>
      </div>
    </div>
  </div>

  <script>
    // ==========================================
    // WHITE LABEL - NOME PERSONALIZADO
    // ==========================================
    
    // FunÃ§Ã£o para carregar nome da empresa (White Label)
    async function carregarNomeEmpresaAdmin() {
      // PadrÃ£o Ã© UBMAX
      var nomePadrao = 'UBMAX';
      var nomeExibido = nomePadrao;
      
      try {
        // Tentar carregar do servidor
        const response = await fetch('/api/admin/empresa/nome', {
          headers: { 
            'Authorization': 'Bearer ' + localStorage.getItem('admin_token')
          }
        });
        
        if (response.ok) {
          const data = await response.json();
          if (data.success && data.nome) {
            nomeExibido = data.nome;
            localStorage.setItem('nome_empresa', data.nome);
          }
        }
      } catch (error) {
        // Fallback para localStorage
        var nomeLocal = localStorage.getItem('nome_empresa');
        if (nomeLocal) {
          nomeExibido = nomeLocal;
        } else {
          // Verificar config antiga
          var empresaId = localStorage.getItem('empresa_id') || 'UBMAX';
          var empresasConfig = JSON.parse(localStorage.getItem('empresas_config') || '{}');
          var config = empresasConfig[empresaId];
          
          if (config && config.whiteLabel && config.nomeExibido) {
            nomeExibido = config.nomeExibido;
          }
        }
      }
      
      // Atualizar sidebar
      var logoText = document.getElementById('sidebar-nome-empresa');
      if (logoText) logoText.textContent = 'ğŸš— ' + nomeExibido;
      
      // Atualizar title da pÃ¡gina
      document.title = nomeExibido + ' - Painel ADM Frota';
      
      // Atualizar campo de configuraÃ§Ãµes
      var inputNome = document.getElementById('config-nome-empresa');
      if (inputNome && nomeExibido !== 'UBMAX') {
        inputNome.value = nomeExibido;
      }
      
      return nomeExibido;
    }
    
    // Carregar nome ao iniciar (apÃ³s DOM carregado)
    document.addEventListener('DOMContentLoaded', function() {
      carregarNomeEmpresaAdmin();
    });
    
    // ==========================================
    // SISTEMA GPS INTEGRADO - UBMAX
    // ==========================================
    
    // NavegaÃ§Ã£o entre pÃ¡ginas
    function mostrarPagina(pagina, elemento) {
      document.querySelectorAll('.nav-item').forEach(item => item.classList.remove('active'));
      document.querySelectorAll('.page').forEach(page => page.classList.remove('active'));
      
      if (elemento) elemento.classList.add('active');
      document.getElementById('page-' + pagina).classList.add('active');
// TambÃ©m verificar pÃ¡ginas com prefixo 'pagina-'
      var paginaExtra = document.getElementById('pagina-' + pagina);
      if (paginaExtra) {
        document.querySelectorAll('.pagina').forEach(function(p) { p.style.display = 'none'; });
        paginaExtra.style.display = 'block';
      }
      
      var titulos = {
        'dashboard': 'Dashboard',
        'mapa': 'Mapa em Tempo Real',
        'motoristas': 'Motoristas',
        'mensalidades': 'ğŸ’° Mensalidades',
        'corridas': 'Corridas',
        'clientes': 'Clientes',
        'antifraude': 'ğŸš¨ Anti-Fraude',
        'financeiro': 'Financeiro',
        'pagamentos': 'ConfiguraÃ§Ãµes de Pagamento',
        'configuracoes': 'ConfiguraÃ§Ãµes',
        'nova-corrida': 'â• Nova Corrida',
        'chat': 'ğŸ’¬ Chat Frota',
        'assistencia': 'ğŸ”§ AssistÃªncia 24h',
        'avarias': 'âš ï¸ Avarias'
      };
      document.getElementById('page-title').textContent = titulos[pagina] || pagina;
      
      if (pagina === 'mapa' && !mapaIniciado) {
        setTimeout(inicializarMapa, 100);
      }
      
      // Carregar dados de anti-fraude quando acessar a pÃ¡gina
      if (pagina === 'antifraude') {
        carregarAntiFraude();
      }
    }
    
    // ==========================================
    // BANCO DE DADOS LOCAL (LocalStorage)
    // Simula servidor - dados compartilhados
    // ==========================================
    
    var DB_KEY = 'zapcorridas_motoristas';
    
    // Inicializar banco com motoristas padrÃ£o
    function inicializarBanco() {
      // Inicializar banco vazio - dados vÃªm da API
      var dados = localStorage.getItem(DB_KEY);
      if (!dados) {
        // Banco vazio - motoristas vÃªm da API do servidor
        localStorage.setItem(DB_KEY, JSON.stringify([]));
      }
    }
    
    // Carregar motoristas do banco
    function carregarMotoristas() {
      var dados = localStorage.getItem(DB_KEY);
      return dados ? JSON.parse(dados) : [];
    }
    
    // Salvar motoristas no banco
    function salvarMotoristas(motoristas) {
      localStorage.setItem(DB_KEY, JSON.stringify(motoristas));
    }
    
    // Atualizar posiÃ§Ã£o de um motorista (chamado pelo app do motorista)
    function atualizarPosicaoMotorista(motoristaId, lat, lng, local) {
      var motoristas = carregarMotoristas();
      var index = motoristas.findIndex(m => m.id === motoristaId);
      if (index !== -1) {
        motoristas[index].lat = lat;
        motoristas[index].lng = lng;
        motoristas[index].local = local || motoristas[index].local;
        motoristas[index].ultimaAtualizacao = Date.now();
        salvarMotoristas(motoristas);
      }
    }
    
    // ==========================================
    // MAPA EM TEMPO REAL
    // ==========================================
    
    var mapa;
    var mapaIniciado = false;
    var marcadores = {};
    var motoristas = [];
    
    // ==========================================
    // MAPA V2 - USA API DO SERVIDOR
    // ==========================================
    var usarAPIReal = true; // Flag para usar API real
    async function inicializarMapa() {
      // Tentar usar API real primeiro
      var centroLat = null;
      var centroLng = null;
      var cidadeEmpresa = null;
      
      try {
        const response = await fetch("/api/admin/motoristas/mapa/tempo-real", {
          headers: { "Authorization": "Bearer " + localStorage.getItem("admin_token") }
        });
        const data = await response.json();
        
        if (data.success) {
          // Salvar cidade da empresa
          cidadeEmpresa = data.empresa?.cidade;
          
          if (data.motoristas && data.motoristas.length > 0) {
            console.log("ğŸ—ºï¸ Usando dados do servidor");
            motoristas = data.motoristas.map(m => ({
              id: m.id,
              nome: m.nome,
              lat: parseFloat(m.latitude) || 0,
              lng: parseFloat(m.longitude) || 0,
              status: m.status || "offline",
              veiculo: (m.veiculo_modelo || "") + " " + (m.veiculo_cor || "")
            })).filter(m => m.lat && m.lng);
            
            // Centro no primeiro motorista online
            var motoristaOnline = motoristas.find(m => m.status !== 'offline');
            if (motoristaOnline) {
              centroLat = motoristaOnline.lat;
              centroLng = motoristaOnline.lng;
            } else if (motoristas.length > 0) {
              // Se nenhum online, usar primeiro motorista
              centroLat = motoristas[0].lat;
              centroLng = motoristas[0].lng;
            }
          }
          
          if (data.empresa && data.empresa.nome) {
            var header = document.querySelector(".mapa-sidebar-header");
            if (header) header.textContent = "ğŸ‘¥ " + data.empresa.nome;
          }
        }
      } catch (e) { console.log("Usando dados locais"); }
      
      // Se nÃ£o tem centro ainda, geocodificar cidade da empresa
      if (!centroLat && cidadeEmpresa) {
        console.log("ğŸ™ï¸ Centralizando na cidade:", cidadeEmpresa);
        try {
          const geoResponse = await fetch('https://nominatim.openstreetmap.org/search?format=json&q=' + encodeURIComponent(cidadeEmpresa + ', SP, Brazil') + '&limit=1');
          const geoData = await geoResponse.json();
          if (geoData && geoData[0]) {
            centroLat = parseFloat(geoData[0].lat);
            centroLng = parseFloat(geoData[0].lon);
            console.log("ğŸ“ Centro encontrado:", centroLat, centroLng);
          }
        } catch (geoError) {
          console.log("Erro geocoding cidade:", geoError);
        }
      }
      
      // Se ainda nÃ£o tem centro, usar cidade do config ou padrÃ£o
      if (!centroLat) {
        var cidadeConfig = document.getElementById('config-cidade')?.value;
        if (cidadeConfig) {
          console.log("ğŸ™ï¸ Usando cidade do config:", cidadeConfig);
          // Geocodificar
          try {
            const geoResponse = await fetch('https://nominatim.openstreetmap.org/search?format=json&q=' + encodeURIComponent(cidadeConfig + ', Brazil') + '&limit=1');
            const geoData = await geoResponse.json();
            if (geoData && geoData[0]) {
              centroLat = parseFloat(geoData[0].lat);
              centroLng = parseFloat(geoData[0].lon);
            }
          } catch (e) {}
        }
      }
      
      // Fallback final - Brasil central
      if (!centroLat) {
        centroLat = -15.7801;
        centroLng = -47.9292;
      }
      
      if (mapaIniciado) return;
      
      mapa = L.map('mapa-motoristas').setView([centroLat, centroLng], 14);
      
      L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
        attribution: 'Â© OpenStreetMap'
      }).addTo(mapa);
      
      // Criar marcadores
      motoristas.forEach(function(mot) {
        criarMarcador(mot);
      });
      
      mapaIniciado = true;
      
      // Atualizar lista lateral
      atualizarListaMotoristas();
      
      // Atualizar posiÃ§Ãµes a cada 3 segundos
      setInterval(atualizarMapaTempoReal, 3000);
    }
    }
    
    function criarMarcador(mot) {
      if (mot.status === 'offline') return;
      
      var cor = mot.status === 'em-corrida' ? '#3b82f6' : '#10b981';
      var statusTexto = mot.status === 'em-corrida' ? 'ğŸš— Em Corrida' : 'âœ… DisponÃ­vel';
      
      var icone = L.divIcon({
        className: 'custom-marker',
        html: `
          <div style="background: ${cor}; color: white; padding: 8px 14px; border-radius: 25px; font-size: 12px; font-weight: 600; white-space: nowrap; box-shadow: 0 4px 15px rgba(0,0,0,0.3); display: flex; align-items: center; gap: 6px;">
            <span style="font-size: 16px;">ğŸš—</span>
            <span>${mot.nome}</span>
          </div>
        `,
        iconSize: [150, 35],
        iconAnchor: [75, 17]
      });
      
      var marker = L.marker([mot.lat, mot.lng], { icon: icone }).addTo(mapa);
      
      var popupContent = `
        <div style="min-width: 200px;">
          <strong style="font-size: 15px;">${mot.nome}</strong><br>
          <span style="color: #64748b; font-size: 12px;">${mot.veiculo}</span>
          <hr style="margin: 8px 0; border: none; border-top: 1px solid #e2e8f0;">
          <div style="display: flex; align-items: center; gap: 6px; margin-bottom: 4px;">
            <span style="background: ${cor}; color: white; padding: 2px 8px; border-radius: 10px; font-size: 11px;">${statusTexto}</span>
          </div>
          <div style="font-size: 12px; color: #64748b;">
            ğŸ“ ${mot.local}<br>
            ${mot.corrida ? 'ğŸ« Corrida: ' + mot.corrida : ''}
          </div>
          <div style="margin-top: 8px; font-size: 11px; color: #94a3b8;">
            Atualizado: ${formatarTempo(mot.ultimaAtualizacao)}
          </div>
          <div style="margin-top: 10px; display: flex; gap: 6px;">
            <a href="tel:+55${mot.telefone}" style="flex: 1; background: #10b981; color: white; padding: 6px; border-radius: 6px; text-align: center; text-decoration: none; font-size: 12px;">ğŸ“ Ligar</a>
            <a href="https://wa.me/55${mot.telefone}" target="_blank" style="flex: 1; background: #25d366; color: white; padding: 6px; border-radius: 6px; text-align: center; text-decoration: none; font-size: 12px;">ğŸ’¬ WhatsApp</a>
          </div>
        </div>
      `;
      
      marker.bindPopup(popupContent);
      marcadores[mot.id] = marker;
    }
    
    function formatarTempo(timestamp) {
      var agora = Date.now();
      var diff = Math.floor((agora - timestamp) / 1000);
      
      if (diff < 60) return 'Agora';
      if (diff < 3600) return Math.floor(diff / 60) + ' min atrÃ¡s';
      if (diff < 86400) return Math.floor(diff / 3600) + 'h atrÃ¡s';
      return 'Mais de 1 dia';
    }
    
    function atualizarMapaTempoReal() {
      // Recarregar dados do banco (simula receber do servidor)
      motoristas = carregarMotoristas();
      
      motoristas.forEach(function(mot) {
        if (marcadores[mot.id]) {
          // Atualizar posiÃ§Ã£o do marcador existente
          marcadores[mot.id].setLatLng([mot.lat, mot.lng]);
        } else if (mot.status !== 'offline') {
          // Criar novo marcador se motorista ficou online
          criarMarcador(mot);
        }
        
        // Remover marcador se motorista ficou offline
        if (mot.status === 'offline' && marcadores[mot.id]) {
          mapa.removeLayer(marcadores[mot.id]);
          delete marcadores[mot.id];
        }
      });
      
      // Atualizar lista lateral
      atualizarListaMotoristas();
      
      // Atualizar contador no botÃ£o de configuraÃ§Ãµes
      atualizarContadorOnline();
    }
    
    function atualizarListaMotoristas() {
      var container = document.querySelector('.mapa-sidebar-body');
      if (!container) return;
      
      var onlineCount = motoristas.filter(m => m.status !== 'offline').length;
      document.querySelector('.mapa-sidebar-header').innerHTML = 'ğŸ‘¥ Motoristas (' + onlineCount + ' online)';
      
      var html = '';
      motoristas.forEach(function(mot, index) {
        var statusClass = mot.status === 'offline' ? 'offline' : (mot.status === 'em-corrida' ? 'em-corrida' : 'online');
        var avatarBg = mot.status === 'offline' ? '#94a3b8' : (mot.status === 'em-corrida' ? 'var(--info)' : 'var(--success)');
        var localTexto = mot.status === 'em-corrida' ? 'ğŸ“ ' + mot.local + ' - Corrida ' + mot.corrida : (mot.status === 'online' ? 'ğŸ“ ' + mot.local + ' - DisponÃ­vel' : 'Ãšltima vez: ' + formatarTempo(mot.ultimaAtualizacao));
        
        html += `
          <div class="motorista-item" onclick="focalizarMotorista(${mot.id})">
            <div class="motorista-avatar" style="background: ${avatarBg};">${mot.iniciais}</div>
            <div class="motorista-info">
              <div class="motorista-nome">${mot.nome}</div>
              <div class="motorista-local">${localTexto}</div>
            </div>
            <div class="motorista-status ${statusClass}"></div>
          </div>
        `;
      });
      
      container.innerHTML = html;
    }
    
    function atualizarContadorOnline() {
      var onlineCount = motoristas.filter(m => m.status !== 'offline').length;
      var contador = document.querySelector('[onclick*="mapa"] .stat-value, .card[onclick*="mapa"] span');
      // Atualiza se existir
    }
    
    function focalizarMotorista(motoristaId) {
      var mot = motoristas.find(m => m.id === motoristaId);
      if (mapa && mot && mot.status !== 'offline') {
        mapa.setView([mot.lat, mot.lng], 17);
        if (marcadores[motoristaId]) {
          marcadores[motoristaId].openPopup();
        }
      } else if (mot && mot.status === 'offline') {
        alert('Este motorista estÃ¡ offline.\nÃšltima localizaÃ§Ã£o conhecida: ' + mot.local);
      }
    }
    
    // ==========================================
    // SIMULAÃ‡ÃƒO DE MOVIMENTO (para demo)
    // Em produÃ§Ã£o, isso viria do app do motorista
    // ==========================================
    
    function simularMovimento() {
      var motoristas = carregarMotoristas();
      
      motoristas.forEach(function(mot) {
        if (mot.status !== 'offline') {
          // Pequeno movimento aleatÃ³rio
          mot.lat += (Math.random() - 0.5) * 0.001;
          mot.lng += (Math.random() - 0.5) * 0.001;
          mot.ultimaAtualizacao = Date.now();
        }
      });
      
      salvarMotoristas(motoristas);
    }
    
    // Simular movimento a cada 5 segundos
    setInterval(simularMovimento, 5000);
    
    // ==========================================
    // API PARA APP DO MOTORISTA
    // FunÃ§Ãµes que seriam chamadas pelo app
    // ==========================================
    
    // Motorista envia sua localizaÃ§Ã£o
    window.ZapCorridasAPI = {
      // Atualizar localizaÃ§Ã£o do motorista
      enviarLocalizacao: function(motoristaId, lat, lng) {
        var motoristas = carregarMotoristas();
        var mot = motoristas.find(m => m.id === motoristaId);
        if (mot) {
          mot.lat = lat;
          mot.lng = lng;
          mot.ultimaAtualizacao = Date.now();
          
          // Buscar nome da cidade via geocoding
          fetch('https://nominatim.openstreetmap.org/reverse?format=json&lat=' + lat + '&lon=' + lng)
            .then(r => r.json())
            .then(data => {
              if (data.address) {
                mot.local = data.address.suburb || data.address.neighbourhood || data.address.city_district || 'LocalizaÃ§Ã£o atual';
                salvarMotoristas(motoristas);
              }
            })
            .catch(() => {
              salvarMotoristas(motoristas);
            });
          
          salvarMotoristas(motoristas);
          console.log('ğŸ“ LocalizaÃ§Ã£o atualizada:', mot.nome, lat, lng);
        }
      },
      
      // Motorista fica online
      ficarOnline: function(motoristaId) {
        var motoristas = carregarMotoristas();
        var mot = motoristas.find(m => m.id === motoristaId);
        if (mot) {
          mot.status = 'online';
          mot.ultimaAtualizacao = Date.now();
          salvarMotoristas(motoristas);
          console.log('ğŸŸ¢ Motorista online:', mot.nome);
        }
      },
      
      // Motorista fica offline
      ficarOffline: function(motoristaId) {
        var motoristas = carregarMotoristas();
        var mot = motoristas.find(m => m.id === motoristaId);
        if (mot) {
          mot.status = 'offline';
          mot.ultimaAtualizacao = Date.now();
          salvarMotoristas(motoristas);
          console.log('ğŸ”´ Motorista offline:', mot.nome);
        }
      },
      
      // Motorista aceita corrida
      aceitarCorrida: function(motoristaId, corridaId) {
        var motoristas = carregarMotoristas();
        var mot = motoristas.find(m => m.id === motoristaId);
        if (mot) {
          mot.status = 'em-corrida';
          mot.corrida = corridaId;
          mot.ultimaAtualizacao = Date.now();
          salvarMotoristas(motoristas);
          console.log('ğŸš— Corrida aceita:', mot.nome, corridaId);
        }
      },
      
      // Motorista finaliza corrida
      finalizarCorrida: function(motoristaId) {
        var motoristas = carregarMotoristas();
        var mot = motoristas.find(m => m.id === motoristaId);
        if (mot) {
          mot.status = 'online';
          mot.corrida = null;
          mot.ultimaAtualizacao = Date.now();
          salvarMotoristas(motoristas);
          console.log('âœ… Corrida finalizada:', mot.nome);
        }
      }
    };
    
    // ==========================================
    // CONFIGURAÃ‡Ã•ES DE NOTIFICAÃ‡Ã•ES
    // ==========================================
    
    async function salvarConfigNotificacoes() {

    // ========================================
    // SALVAR CONFIGURAÃ‡Ã•ES (NOME DA EMPRESA)
    // ========================================
    async function salvarConfiguracoes() {
      var nomeEmpresa = document.getElementById('config-nome-empresa').value.trim();
      var telefoneADM = document.getElementById('config-telefone-adm')?.value.replace(/\D/g, '') || '';
      var emailADM = document.getElementById('config-email-adm')?.value || '';
      
      var notificacoes = {
        atrasos: document.getElementById('notif-atrasos')?.checked || false,
        antifraude: document.getElementById('notif-antifraude')?.checked || false,
        cancelamentos: document.getElementById('notif-cancelamentos')?.checked || false,
        relatorio: document.getElementById('notif-relatorio')?.checked || false,
      };
      
      // Validar nome
      if (!nomeEmpresa || nomeEmpresa.length < 2) {
        alert('âŒ Por favor, informe o nome da empresa/frota!');
        return;
      }
      
      try {
        // 1. Salvar NOME DA EMPRESA
        await fetch('/api/admin/empresa/nome', {
          method: 'PUT',
          headers: { 
            'Content-Type': 'application/json',
            'Authorization': 'Bearer ' + localStorage.getItem('admin_token')
          },
          body: JSON.stringify({ nome: nomeEmpresa })
        });
        
        // Atualizar UI
        var logoText = document.getElementById('sidebar-nome-empresa');
        if (logoText) logoText.textContent = 'ğŸš— ' + nomeEmpresa;
        document.title = nomeEmpresa + ' - Painel ADM Frota';
        localStorage.setItem('nome_empresa', nomeEmpresa);
        
        // 2. Salvar outras configuraÃ§Ãµes
        if (telefoneADM) {
          await fetch('/api/admin/configuracoes/telefone_adm', {
            method: 'PUT',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ valor: telefoneADM })
          });
        }
        
        if (emailADM) {
          await fetch('/api/admin/configuracoes/email_adm', {
            method: 'PUT',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ valor: emailADM })
          });
        }
        
        await fetch('/api/admin/configuracoes/notificacoes', {
          method: 'PUT',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ valor: JSON.stringify(notificacoes) })
        });
        
        alert('âœ… ConfiguraÃ§Ãµes salvas com sucesso!');
        
      } catch (error) {
        // Fallback local
        localStorage.setItem('nome_empresa', nomeEmpresa);
        localStorage.setItem('config_telefone_adm', telefoneADM);
        localStorage.setItem('config_email_adm', emailADM);
        
        var logoText = document.getElementById('sidebar-nome-empresa');
        if (logoText) logoText.textContent = 'ğŸš— ' + nomeEmpresa;
        document.title = nomeEmpresa + ' - Painel ADM Frota';
        
        alert('âœ… ConfiguraÃ§Ãµes salvas localmente!');
      }
    }

      var telefone = document.getElementById('config-telefone-adm').value.replace(/\D/g, '');
      var email = document.getElementById('config-email-adm').value;
      
      if (!telefone) {
        alert('âš ï¸ Por favor, informe o telefone para receber notificaÃ§Ãµes.');
        return;
      }
      
      // Coletar preferÃªncias
      var config = {
        telefone_adm: telefone,
        email_adm: email,
        notificacoes: {
          atrasos: document.getElementById('notif-atrasos').checked,
          antifraude: document.getElementById('notif-antifraude').checked,
          corridas: document.getElementById('notif-corridas').checked,
          financeiro: document.getElementById('notif-financeiro').checked,
        },
        frequencia_relatorio: document.querySelector('input[name="freq-relatorio"]:checked')?.value || 'diario'
      };
      
      try {
        // Salvar no servidor
        const response = await fetch('/api/admin/configuracoes/notificacoes', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(config)
        });
        
        if (response.ok) {
          alert('âœ… ConfiguraÃ§Ãµes salvas com sucesso!\n\nA Rebeca vai te notificar pelo WhatsApp: ' + telefone);
        }
      } catch (error) {
        // Salvar localmente se nÃ£o tiver servidor
        localStorage.setItem('config_notificacoes', JSON.stringify(config));
        alert('âœ… ConfiguraÃ§Ãµes salvas!\n\nğŸ“± Telefone: ' + telefone + '\n\nA Rebeca vai te enviar alertas importantes.');
      }
    }
    
    async function testarNotificacao() {
      var telefone = document.getElementById('config-telefone-adm').value.replace(/\D/g, '');
      
      if (!telefone) {
        alert('âš ï¸ Por favor, informe o telefone primeiro.');
        return;
      }
      
      // Mostrar preview da mensagem
      var msgTeste = `ğŸ§ª *TESTE DE NOTIFICAÃ‡ÃƒO - REBECA*

OlÃ¡! Esta Ã© uma mensagem de teste do sistema de notificaÃ§Ãµes.

Se vocÃª recebeu esta mensagem, as notificaÃ§Ãµes estÃ£o configuradas corretamente! âœ…

ğŸ“Š VocÃª receberÃ¡:
â€¢ Alertas de atrasos de motoristas
â€¢ Alertas anti-fraude
â€¢ Resumos de corridas
â€¢ RelatÃ³rios financeiros

_Sistema UBMAX - Rebeca_`;

      try {
        const response = await fetch('/api/admin/notificacoes/teste', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ telefone, mensagem: msgTeste })
        });
        
        if (response.ok) {
          alert('âœ… Mensagem de teste enviada!\n\nVerifique seu WhatsApp: ' + telefone);
        } else {
          throw new Error('Servidor indisponÃ­vel');
        }
      } catch (error) {
        // Abrir WhatsApp Web como fallback
        var msgEncoded = encodeURIComponent(msgTeste);
        window.open('https://wa.me/' + telefone + '?text=' + msgEncoded, '_blank');
        alert('ğŸ“± Abrindo WhatsApp para enviar teste...\n\nQuando o servidor estiver rodando, o envio serÃ¡ automÃ¡tico.');
      }
    }
    
    // Carregar configuraÃ§Ãµes salvas
    function carregarConfigNotificacoes() {
      try {
        var config = JSON.parse(localStorage.getItem('config_notificacoes') || '{}');
        if (config.telefone_adm) {
          document.getElementById('config-telefone-adm').value = config.telefone_adm;
        }
        if (config.email_adm) {
          document.getElementById('config-email-adm').value = config.email_adm;
        }
        if (config.notificacoes) {
          document.getElementById('notif-atrasos').checked = config.notificacoes.atrasos !== false;
          document.getElementById('notif-antifraude').checked = config.notificacoes.antifraude !== false;
          document.getElementById('notif-corridas').checked = config.notificacoes.corridas !== false;
          document.getElementById('notif-financeiro').checked = config.notificacoes.financeiro || false;
        }
      } catch (e) {}
    }
    
    // Carregar ao iniciar
    setTimeout(carregarConfigNotificacoes, 500);

    // ==========================================
    // SISTEMA ANTI-FRAUDE
    // ==========================================
    
    var dadosAntiFraude = null;
    
    async function carregarAntiFraude() {
      try {
        // Buscar resumo do servidor
        const response = await fetch('/api/admin/antifraude/resumo');
        const data = await response.json();
        
        if (data.success) {
          dadosAntiFraude = data.data;
          atualizarUIAntiFraude(data.data);
        } else {
          // Usar dados de demonstraÃ§Ã£o se nÃ£o houver servidor
          usarDadosDemoAntiFraude();
        }
      } catch (error) {
        console.log('Usando dados demo de anti-fraude');
        usarDadosDemoAntiFraude();
      }
    }
    
    function usarDadosDemoAntiFraude() {
      // Dados de demonstraÃ§Ã£o
      var motoristas = carregarMotoristas();
      var demoData = {
        total_alertas: 7,
        criticos: 2,
        atencao: 3,
        info: 2,
        motoristas_problematicos: [
          {
            id: 1,
            nome: 'Carlos Ferreira',
            telefone: '14999998888',
            score: 35,
            alertas: 4,
            recomendacao: { acao: 'MONITORAR', cor: 'laranja', texto: 'Comportamento suspeito' }
          },
          {
            id: 2,
            nome: 'Roberto Alves',
            telefone: '14999997777',
            score: 52,
            alertas: 3,
            recomendacao: { acao: 'ATENÃ‡ÃƒO', cor: 'amarelo', texto: 'Alguns alertas detectados' }
          }
        ],
        alertas_por_tipo: {
          atraso: 3,
          cancelamento: 2,
          gps_suspeito: 1,
          nota_baixa: 1
        }
      };
      
      dadosAntiFraude = demoData;
      atualizarUIAntiFraude(demoData);
    }
    
    function atualizarUIAntiFraude(data) {
      // Atualizar cards de stats
      document.getElementById('af-criticos').textContent = data.criticos || 0;
      document.getElementById('af-atencao').textContent = data.atencao || 0;
      
      var motoristas = carregarMotoristas();
      var totalOk = motoristas.length - (data.motoristas_problematicos?.length || 0);
      document.getElementById('af-ok').textContent = Math.max(0, totalOk);
      document.getElementById('af-total').textContent = data.total_alertas || 0;
      
      // Atualizar tipos de alertas
      var tipos = data.alertas_por_tipo || {};
      document.getElementById('af-tipo-atrasos').textContent = tipos.atraso || 0;
      document.getElementById('af-tipo-cancelamentos').textContent = tipos.cancelamento || 0;
      document.getElementById('af-tipo-gps').textContent = tipos.gps_suspeito || 0;
      document.getElementById('af-tipo-nota').textContent = tipos.nota_baixa || 0;
      
      // Atualizar badge
      document.getElementById('af-badge-problemas').textContent = data.motoristas_problematicos?.length || 0;
      
      // Atualizar tabela de motoristas problemÃ¡ticos
      var tbody = document.getElementById('lista-antifraude');
      
      if (!data.motoristas_problematicos || data.motoristas_problematicos.length === 0) {
        tbody.innerHTML = `
          <tr>
            <td colspan="5" style="text-align: center; padding: 40px; color: var(--text-muted);">
              <div style="font-size: 48px; margin-bottom: 12px;">âœ…</div>
              <div>Nenhum motorista com alertas no momento</div>
              <button class="btn btn-outline" style="margin-top: 16px;" onclick="verificarTodosAntiFraude()">ğŸ”„ Verificar Agora</button>
            </td>
          </tr>`;
        return;
      }
      
      var html = '';
      data.motoristas_problematicos.forEach(function(mot) {
        var corScore = mot.score < 30 ? '#ef4444' : mot.score < 60 ? '#f59e0b' : '#10b981';
        var corRecomendacao = mot.recomendacao.cor === 'vermelho' ? '#ef4444' : 
                              mot.recomendacao.cor === 'laranja' ? '#f97316' :
                              mot.recomendacao.cor === 'amarelo' ? '#f59e0b' : '#10b981';
        
        html += `
          <tr>
            <td>
              <div style="display: flex; align-items: center; gap: 12px;">
                <div style="width: 40px; height: 40px; border-radius: 50%; background: linear-gradient(135deg, ${corScore}, ${corScore}88); display: flex; align-items: center; justify-content: center; color: white; font-weight: 600;">
                  ${mot.nome.split(' ').map(n => n[0]).join('').substring(0,2)}
                </div>
                <div>
                  <div style="font-weight: 600;">${mot.nome}</div>
                  <div style="font-size: 12px; color: var(--text-muted);">${mot.telefone}</div>
                </div>
              </div>
            </td>
            <td>
              <div style="display: flex; align-items: center; gap: 8px;">
                <div style="width: 60px; height: 8px; background: #e2e8f0; border-radius: 4px; overflow: hidden;">
                  <div style="width: ${mot.score}%; height: 100%; background: ${corScore};"></div>
                </div>
                <span style="font-weight: 600; color: ${corScore};">${mot.score}</span>
              </div>
            </td>
            <td>
              <span style="background: ${corScore}20; color: ${corScore}; padding: 4px 12px; border-radius: 20px; font-weight: 600;">
                ${mot.alertas} alertas
              </span>
            </td>
            <td>
              <span style="color: ${corRecomendacao}; font-weight: 500;">
                ${mot.recomendacao.acao}
              </span>
            </td>
            <td>
              <button class="btn btn-outline btn-sm" onclick="verDetalhesAntiFraude(${mot.id})">ğŸ‘ï¸ Ver</button>
              ${mot.score < 30 ? '<button class="btn btn-sm" style="background: #ef4444; color: white; margin-left: 8px;" onclick="bloquearMotoristaFraude(' + mot.id + ')">ğŸš« Bloquear</button>' : ''}
            </td>
          </tr>`;
      });
      
      tbody.innerHTML = html;
    }
    
    async function verificarTodosAntiFraude() {
      var btn = event.target;
      btn.disabled = true;
      btn.innerHTML = 'â³ Verificando...';
      
      try {
        const response = await fetch('/api/admin/antifraude/verificar-todos', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' }
        });
        const data = await response.json();
        
        if (data.success) {
          alert('âœ… ' + data.message + '\n\nAlertas crÃ­ticos: ' + data.data.alertas_criticos);
          carregarAntiFraude();
        }
      } catch (error) {
        // Simular verificaÃ§Ã£o
        setTimeout(function() {
          usarDadosDemoAntiFraude();
          alert('âœ… VerificaÃ§Ã£o concluÃ­da!\n\n2 motoristas com alertas detectados.');
        }, 1500);
      }
      
      btn.disabled = false;
      btn.innerHTML = 'ğŸ”„ Verificar Agora';
    }
    
    async function verDetalhesAntiFraude(motoristaId) {
      try {
        const response = await fetch('/api/admin/antifraude/motorista/' + motoristaId);
        const data = await response.json();
        
        if (data.success) {
          exibirModalAntiFraude(data.data);
        }
      } catch (error) {
        // Mostrar dados demo
        exibirModalAntiFraude({
          motorista: { id: motoristaId, nome: 'Carlos Ferreira', telefone: '14999998888' },
          score: 35,
          alertas: [
            { tipo: 'atraso', severidade: 'vermelho', titulo: 'â° Muitos atrasos', descricao: '5 atrasos nos Ãºltimos 30 dias' },
            { tipo: 'cancelamento', severidade: 'amarelo', titulo: 'âŒ Cancelamentos', descricao: '8 cancelamentos apÃ³s aceitar corridas' },
            { tipo: 'corrida_curta', severidade: 'amarelo', titulo: 'ğŸ” Corridas curtas', descricao: '6 corridas com menos de 300m' }
          ],
          recomendacao: { acao: 'MONITORAR', cor: 'laranja', texto: 'Comportamento suspeito. Monitorar de perto.' }
        });
      }
    }
    
    function exibirModalAntiFraude(analise) {
      var alertasHtml = analise.alertas.map(function(a) {
        var cor = a.severidade === 'vermelho' ? '#ef4444' : a.severidade === 'amarelo' ? '#f59e0b' : '#3b82f6';
        return `
          <div style="padding: 12px; border-left: 4px solid ${cor}; background: ${cor}10; margin-bottom: 8px; border-radius: 0 8px 8px 0;">
            <div style="font-weight: 600;">${a.titulo}</div>
            <div style="font-size: 13px; color: var(--text-muted);">${a.descricao}</div>
          </div>`;
      }).join('');
      
      var corScore = analise.score < 30 ? '#ef4444' : analise.score < 60 ? '#f59e0b' : '#10b981';
      
      var html = `
        <div style="position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.5); display: flex; align-items: center; justify-content: center; z-index: 9999;" onclick="if(event.target === this) this.remove();">
          <div style="background: white; border-radius: 16px; width: 500px; max-width: 90%; max-height: 80vh; overflow: auto;">
            <div style="padding: 20px; border-bottom: 1px solid var(--border);">
              <h3 style="margin: 0;">ğŸš¨ AnÃ¡lise Anti-Fraude</h3>
            </div>
            <div style="padding: 20px;">
              <div style="display: flex; align-items: center; gap: 16px; margin-bottom: 20px;">
                <div style="width: 60px; height: 60px; border-radius: 50%; background: linear-gradient(135deg, ${corScore}, ${corScore}88); display: flex; align-items: center; justify-content: center; color: white; font-size: 24px; font-weight: 600;">
                  ${analise.motorista.nome.split(' ').map(n => n[0]).join('').substring(0,2)}
                </div>
                <div>
                  <div style="font-size: 18px; font-weight: 600;">${analise.motorista.nome}</div>
                  <div style="color: var(--text-muted);">${analise.motorista.telefone}</div>
                </div>
                <div style="margin-left: auto; text-align: center;">
                  <div style="font-size: 32px; font-weight: 700; color: ${corScore};">${analise.score}</div>
                  <div style="font-size: 12px; color: var(--text-muted);">Score</div>
                </div>
              </div>
              
              <div style="background: ${analise.recomendacao.cor === 'vermelho' ? '#fef2f2' : analise.recomendacao.cor === 'laranja' ? '#fff7ed' : '#fefce8'}; border-radius: 8px; padding: 12px; margin-bottom: 20px;">
                <strong>RecomendaÃ§Ã£o: ${analise.recomendacao.acao}</strong><br>
                <span style="font-size: 13px;">${analise.recomendacao.texto}</span>
              </div>
              
              <h4 style="margin-bottom: 12px;">Alertas Detectados:</h4>
              ${alertasHtml}
            </div>
            <div style="padding: 16px 20px; border-top: 1px solid var(--border); display: flex; gap: 12px; justify-content: flex-end;">
              <button class="btn btn-outline" onclick="this.closest('div[style*=fixed]').remove()">Fechar</button>
              ${analise.score < 30 ? '<button class="btn" style="background: #ef4444; color: white;" onclick="bloquearMotoristaFraude(' + analise.motorista.id + ')">ğŸš« Bloquear Motorista</button>' : ''}
            </div>
          </div>
        </div>`;
      
      document.body.insertAdjacentHTML('beforeend', html);
    }
    
    async function bloquearMotoristaFraude(motoristaId) {
      if (!confirm('âš ï¸ Tem certeza que deseja BLOQUEAR este motorista por suspeita de fraude?\n\nEsta aÃ§Ã£o pode ser revertida nas configuraÃ§Ãµes.')) {
        return;
      }
      
      try {
        await fetch('/api/admin/antifraude/bloquear/' + motoristaId, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ motivo: 'Bloqueado pelo sistema anti-fraude' })
        });
      } catch (error) {
        console.log('Bloqueio local');
      }
      
      alert('ğŸš« Motorista bloqueado com sucesso!\n\nEle nÃ£o receberÃ¡ mais corridas atÃ© ser desbloqueado.');
      
      // Fechar modal se existir
      var modal = document.querySelector('div[style*="position: fixed"]');
      if (modal) modal.remove();
      
      carregarAntiFraude();
    }
    
    // ==========================================
    // CONFIGURAÃ‡Ã•ES E NOTIFICAÃ‡Ã•ES
    // ==========================================
    
    
    async function testarNotificacaoRebeca() {
      var telefone = document.getElementById('config-telefone-adm').value.replace(/\D/g, '');
      
      if (!telefone || telefone.length < 10) {
        alert('âŒ Digite um nÃºmero de WhatsApp vÃ¡lido primeiro!');
        return;
      }
      
      var btn = event.target;
      btn.disabled = true;
      btn.innerHTML = 'â³ Enviando...';
      
      var mensagemTeste = `ğŸ¤– *TESTE DE NOTIFICAÃ‡ÃƒO - REBECA*

OlÃ¡! Esta Ã© uma mensagem de teste do sistema de notificaÃ§Ãµes.

Se vocÃª recebeu esta mensagem, significa que as notificaÃ§Ãµes estÃ£o configuradas corretamente! âœ…

VocÃª receberÃ¡ alertas sobre:
â€¢ â° Atrasos de motoristas
â€¢ ğŸš¨ Alertas anti-fraude
â€¢ âŒ Cancelamentos
â€¢ ğŸ“Š RelatÃ³rios diÃ¡rios

_Sistema UBMAX_`;
      
      try {
        // Tentar enviar via servidor
        const response = await fetch('/api/admin/notificacao/teste', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ telefone, mensagem: mensagemTeste })
        });
        
        if (response.ok) {
          alert('âœ… Mensagem de teste enviada!\n\nVerifique seu WhatsApp.');
        } else {
          throw new Error('Servidor offline');
        }
      } catch (error) {
        // Abrir WhatsApp Web como fallback
        var url = `https://wa.me/${telefone}?text=${encodeURIComponent(mensagemTeste)}`;
        window.open(url, '_blank');
        
        alert('ğŸ“± Abrindo WhatsApp...\n\nComo o servidor nÃ£o estÃ¡ online, estamos abrindo o WhatsApp Web. Clique em "Enviar" para testar.');
      }
      
      btn.disabled = false;
      btn.innerHTML = 'ğŸ“² Testar NotificaÃ§Ã£o';
    }
    
    function carregarConfiguracoes() {
      // Carregar do localStorage como fallback
      var telefone = localStorage.getItem('config_telefone_adm') || '';
      var email = localStorage.getItem('config_email_adm') || '';
      var notifs = JSON.parse(localStorage.getItem('config_notificacoes') || '{}');
      
      if (document.getElementById('config-telefone-adm')) {
        document.getElementById('config-telefone-adm').value = telefone;
      }
      if (document.getElementById('config-email-adm')) {
        document.getElementById('config-email-adm').value = email;
      }
      
      if (notifs.atrasos !== undefined) {
        document.getElementById('notif-atrasos').checked = notifs.atrasos;
      }
      if (notifs.antifraude !== undefined) {
        document.getElementById('notif-antifraude').checked = notifs.antifraude;
      }
      if (notifs.cancelamentos !== undefined) {
        document.getElementById('notif-cancelamentos').checked = notifs.cancelamentos;
      }
      if (notifs.relatorio !== undefined) {
        document.getElementById('notif-relatorio').checked = notifs.relatorio;
      }
    }
    
    // Carregar configuraÃ§Ãµes ao iniciar
    setTimeout(carregarConfiguracoes, 500);
    
    // ==========================================
    // CADASTRO DE MOTORISTA COM MENSALIDADE
    // ==========================================
    
    var diasSemana = ['Domingo', 'Segunda-feira', 'TerÃ§a-feira', 'Quarta-feira', 'Quinta-feira', 'Sexta-feira', 'SÃ¡bado'];
    
    function abrirModalMotorista() {
      document.getElementById('modal-motorista').classList.add('active');
      
      // Carregar valores padrÃ£o de mensalidade
      var valorPadrao = localStorage.getItem('config_valor_mensalidade') || '150.00';
      var diaPadrao = localStorage.getItem('config_dia_vencimento') || '10';
      var tipoPadrao = localStorage.getItem('config_tipo_recorrencia') || 'mensal';
      var diaSemanaPadrao = localStorage.getItem('config_dia_semana') || '5';
      
      document.getElementById('mot-valor-mensalidade').value = valorPadrao;
      document.getElementById('mot-dia-vencimento').value = diaPadrao;
      document.getElementById('mot-tipo-recorrencia').value = tipoPadrao;
      document.getElementById('mot-dia-semana').value = diaSemanaPadrao;
      
      // Atualizar visibilidade dos campos
      alternarTipoRecorrencia();
      
      // Limpar campos
      document.getElementById('mot-nome').value = '';
      document.getElementById('mot-telefone').value = '';
      document.getElementById('mot-cpf').value = '';
      document.getElementById('mot-cnh').value = '';
      document.getElementById('mot-veiculo').value = '';
      document.getElementById('mot-cor').value = '';
      document.getElementById('mot-placa').value = '';
      
      // Reset comissÃ£o
      document.getElementById('mot-tem-comissao').checked = false;
      document.getElementById('campo-comissao').style.display = 'none';
      document.getElementById('mot-comissao').value = '0';
    }
    
    function alternarTipoRecorrencia() {
      var tipo = document.getElementById('mot-tipo-recorrencia').value;
      var grupoDiaMes = document.getElementById('grupo-dia-mes');
      var grupoDiaSemana = document.getElementById('grupo-dia-semana');
      
      if (tipo === 'semanal' || tipo === 'quinzenal') {
        grupoDiaMes.style.display = 'none';
        grupoDiaSemana.style.display = 'block';
      } else {
        grupoDiaMes.style.display = 'block';
        grupoDiaSemana.style.display = 'none';
      }
    }
    
    // Toggle comissÃ£o
    function toggleComissao() {
      var checkbox = document.getElementById('mot-tem-comissao');
      var campo = document.getElementById('campo-comissao');
      
      if (checkbox.checked) {
        campo.style.display = 'block';
      } else {
        campo.style.display = 'none';
        document.getElementById('mot-comissao').value = '0';
      }
    }
    
    // Salvar telefones do sistema
    function salvarTelefonesSistema() {
      var telefoneRebeca = document.getElementById('config-telefone-rebeca').value.replace(/\D/g, '');
      var telefoneADM = document.getElementById('config-telefone-adm').value.replace(/\D/g, '');
      
      if (!telefoneRebeca || telefoneRebeca.length < 10) {
        alert('âš ï¸ Por favor, informe o WhatsApp da Rebeca (com DDD).');
        return;
      }
      
      if (!telefoneADM || telefoneADM.length < 10) {
        alert('âš ï¸ Por favor, informe o WhatsApp do ADM Principal (com DDD).');
        return;
      }
      
      // Adicionar 55 se nÃ£o tiver
      if (!telefoneRebeca.startsWith('55')) telefoneRebeca = '55' + telefoneRebeca;
      if (!telefoneADM.startsWith('55')) telefoneADM = '55' + telefoneADM;
      
      // Salvar no localStorage
      localStorage.setItem('config_telefone_rebeca', telefoneRebeca);
      localStorage.setItem('config_telefone_adm', telefoneADM);
      
      // Tentar salvar no servidor
      fetch('/api/admin/configuracoes/telefones', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ telefone_rebeca: telefoneRebeca, telefone_adm: telefoneADM })
      }).catch(function() {});
      
      alert('âœ… Telefones do sistema salvos!\n\nğŸ¤– Rebeca: ' + telefoneRebeca + '\nğŸ‘¤ ADM: ' + telefoneADM);
    }
    
    // Testar notificaÃ§Ã£o para ADM
    async function testarNotificacaoADM() {
      var telefoneADM = document.getElementById('config-telefone-adm').value.replace(/\D/g, '');
      
      if (!telefoneADM || telefoneADM.length < 10) {
        alert('âš ï¸ Configure o WhatsApp do ADM Principal primeiro.');
        return;
      }
      
      if (!telefoneADM.startsWith('55')) telefoneADM = '55' + telefoneADM;
      
      var msgTeste = `ğŸ§ª *TESTE DE NOTIFICAÃ‡ÃƒO - REBECA*

OlÃ¡! Esta Ã© uma mensagem de teste do sistema.

Se vocÃª recebeu esta mensagem, o WhatsApp do ADM estÃ¡ configurado corretamente! âœ…

VocÃª receberÃ¡ notificaÃ§Ãµes de:
â€¢ â° Atrasos de motoristas
â€¢ ğŸš¨ Alertas anti-fraude
â€¢ ğŸ’° Vencimentos de mensalidades
â€¢ ğŸ“Š RelatÃ³rios diÃ¡rios

_Sistema REBECA - Assistente de Transporte_`;
      
      try {
        var response = await fetch('/api/admin/notificacoes/teste', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ telefone: telefoneADM, mensagem: msgTeste })
        });
        
        if (response.ok) {
          alert('âœ… Mensagem de teste enviada!\n\nVerifique seu WhatsApp.');
        } else {
          throw new Error('Servidor indisponÃ­vel');
        }
      } catch (error) {
        // Fallback - abrir WhatsApp Web
        window.open('https://wa.me/' + telefoneADM + '?text=' + encodeURIComponent(msgTeste), '_blank');
        alert('ğŸ“± Abrindo WhatsApp para enviar teste...');
      }
    }
    
    // Carregar telefones salvos ao iniciar
    function carregarTelefonesSistema() {
      var telefoneRebeca = localStorage.getItem('config_telefone_rebeca') || '';
      var telefoneADM = localStorage.getItem('config_telefone_adm') || '';
      
      if (document.getElementById('config-telefone-rebeca')) {
        document.getElementById('config-telefone-rebeca').value = telefoneRebeca;
      }
      if (document.getElementById('config-telefone-adm')) {
        document.getElementById('config-telefone-adm').value = telefoneADM;
      }
    }
    
    // Carregar ao iniciar
    setTimeout(carregarTelefonesSistema, 600);
    
    function fecharModalMotorista() {
      document.getElementById('modal-motorista').classList.remove('active');
    }
    
    function fecharModalSucesso() {
      document.getElementById('modal-sucesso-motorista').classList.remove('active');
    }
    
    // Gerar token Ãºnico
    function gerarToken() {
      return 'MOT-' + Date.now().toString(36).toUpperCase() + '-' + Math.random().toString(36).substring(2, 8).toUpperCase();
    }
    
    // Calcular prÃ³ximo vencimento
    function calcularProximoVencimento(tipoRecorrencia, diaVencimento, diaSemana) {
      var hoje = new Date();
      var proximo = new Date();
      
      if (tipoRecorrencia === 'semanal') {
        // PrÃ³xima ocorrÃªncia do dia da semana
        var diasAte = (parseInt(diaSemana) - hoje.getDay() + 7) % 7;
        if (diasAte === 0) diasAte = 7; // Se hoje Ã© o dia, prÃ³xima semana
        proximo.setDate(hoje.getDate() + diasAte);
      } else if (tipoRecorrencia === 'quinzenal') {
        var diasAte = (parseInt(diaSemana) - hoje.getDay() + 7) % 7;
        if (diasAte === 0) diasAte = 14;
        proximo.setDate(hoje.getDate() + diasAte);
      } else {
        // Mensal - prÃ³ximo dia do mÃªs
        proximo.setDate(parseInt(diaVencimento));
        if (proximo <= hoje) {
          proximo.setMonth(proximo.getMonth() + 1);
        }
      }
      
      return proximo;
    }
    
    // Cadastrar motorista
    async function cadastrarMotorista() {
      // Validar campos obrigatÃ³rios
      var nome = document.getElementById('mot-nome').value.trim();
      var telefone = document.getElementById('mot-telefone').value.replace(/\D/g, '');
      var veiculo = document.getElementById('mot-veiculo').value.trim();
      var cor = document.getElementById('mot-cor').value.trim();
      var placa = document.getElementById('mot-placa').value.trim().toUpperCase();
      var valorMensalidade = parseFloat(document.getElementById('mot-valor-mensalidade').value) || 150;
      var tipoRecorrencia = document.getElementById('mot-tipo-recorrencia').value;
      var diaVencimento = parseInt(document.getElementById('mot-dia-vencimento').value) || 10;
      var diaSemana = parseInt(document.getElementById('mot-dia-semana').value) || 5;
      var enviarWhatsApp = document.getElementById('mot-enviar-whatsapp').checked;
      
      // ComissÃ£o opcional
      var temComissao = document.getElementById('mot-tem-comissao').checked;
      var comissao = temComissao ? (parseInt(document.getElementById('mot-comissao').value) || 15) : 0;
      
      if (!nome) {
        alert('âš ï¸ Por favor, informe o nome do motorista.');
        return;
      }
      if (!telefone || telefone.length < 10) {
        alert('âš ï¸ Por favor, informe um telefone vÃ¡lido com DDD.');
        return;
      }
      if (!veiculo || !cor || !placa) {
        alert('âš ï¸ Por favor, preencha os dados do veÃ­culo.');
        return;
      }
      
      // Gerar token de primeiro acesso
      var token = gerarToken();
      var baseUrl = window.location.origin;
      var linkAcesso = baseUrl + '/motorista/primeiro-acesso?token=' + token;
      
      // Criar objeto motorista
      var motorista = {
        id: Date.now(),
        nome: nome,
        telefone: telefone,
        telefoneFormatado: '(' + telefone.substring(0, 2) + ') ' + telefone.substring(2, 7) + '-' + telefone.substring(7),
        cpf: document.getElementById('mot-cpf').value,
        cnh: document.getElementById('mot-cnh').value,
        veiculo: veiculo,
        cor: cor,
        placa: placa,
        ano: document.getElementById('mot-ano').value,
        status: document.getElementById('mot-status-inicial').value,
        temComissao: temComissao,
        comissao: comissao,
        valorMensalidade: valorMensalidade,
        tipoRecorrencia: tipoRecorrencia,
        diaVencimento: diaVencimento,
        diaSemana: diaSemana,
        token: token,
        primeiroAcesso: true,
        criadoEm: new Date().toISOString(),
        mensalidadeStatus: 'pendente'
      };
      
      // Salvar no localStorage (simulaÃ§Ã£o)
      var motoristas = carregarMotoristas();
      motoristas.push(motorista);
      salvarMotoristas(motoristas);
      
      // Calcular prÃ³ximo vencimento
      var vencimento = calcularProximoVencimento(tipoRecorrencia, diaVencimento, diaSemana);
      
      // Salvar mensalidade
      var mensalidades = JSON.parse(localStorage.getItem('mensalidades') || '[]');
      
      mensalidades.push({
        id: Date.now(),
        motoristaId: motorista.id,
        motoristaNome: nome,
        motoristaTelefone: telefone,
        valor: valorMensalidade,
        tipoRecorrencia: tipoRecorrencia,
        diaVencimento: diaVencimento,
        diaSemana: diaSemana,
        vencimento: vencimento.toISOString().split('T')[0],
        status: 'pendente',
        criadoEm: new Date().toISOString()
      });
      localStorage.setItem('mensalidades', JSON.stringify(mensalidades));
      
      // Tentar cadastrar no servidor
      try {
        var response = await fetch('/api/admin/motoristas', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(motorista)
        });
        
        if (response.ok) {
          console.log('âœ… Motorista salvo no servidor');
        }
      } catch (error) {
        console.log('âš ï¸ Servidor offline, salvo localmente');
      }
      
      // Montar texto de vencimento
      var textoVencimento = '';
      if (tipoRecorrencia === 'semanal') {
        textoVencimento = 'Toda ' + diasSemana[diaSemana];
      } else if (tipoRecorrencia === 'quinzenal') {
        textoVencimento = 'Quinzenal - ' + diasSemana[diaSemana];
      } else {
        textoVencimento = 'Todo dia ' + diaVencimento;
      }
      
      // Enviar WhatsApp
      if (enviarWhatsApp) {
        // Garantir que o link seja completo e clicÃ¡vel
        var linkCompleto = linkAcesso;
        if (!linkCompleto.startsWith('http')) {
          linkCompleto = 'https://' + window.location.host + '/motorista/primeiro-acesso?token=' + token;
        }
        
        var msgWhatsApp = `ğŸš— *BEM-VINDO Ã€ EQUIPE!*

OlÃ¡ *${nome.split(' ')[0]}*! ğŸ‘‹

VocÃª foi cadastrado como motorista parceiro.

â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
ğŸ“² *ACESSE SEU PAINEL:*
â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”

ğŸ‘‡ *Clique no link abaixo:*

${linkCompleto}

â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”

ApÃ³s acessar, configure sua senha e comece a receber corridas! ğŸš€

ğŸ’° *Mensalidade:* R$ ${valorMensalidade.toFixed(2)}
ğŸ“… *Vencimento:* ${textoVencimento}

ğŸ’¡ *Dica:* Adicione o link Ã  tela inicial do celular para acesso rÃ¡pido!

_Qualquer dÃºvida, Ã© sÃ³ chamar!_ ğŸ™Œ`;
        
        try {
          await fetch('/api/admin/notificacoes/teste', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ telefone: '55' + telefone, mensagem: msgWhatsApp })
          });
        } catch (e) {
          // Abrir WhatsApp Web como fallback
          window.open('https://wa.me/55' + telefone + '?text=' + encodeURIComponent(msgWhatsApp), '_blank');
        }
      }
      
      // Fechar modal e mostrar sucesso
      fecharModalMotorista();
      document.getElementById('link-acesso-motorista').value = linkAcesso;
      document.getElementById('msg-sucesso-motorista').innerHTML = enviarWhatsApp 
        ? 'O link de primeiro acesso foi enviado via WhatsApp para <strong>' + motorista.telefoneFormatado + '</strong>.'
        : 'Motorista cadastrado! Envie o link de acesso manualmente.';
      document.getElementById('modal-sucesso-motorista').classList.add('active');
      
      // Atualizar lista de motoristas na pÃ¡gina
      atualizarListaMotoristas();
      
      console.log('âœ… Motorista cadastrado:', motorista.nome);
    }
    
    function copiarLinkAcesso() {
      var input = document.getElementById('link-acesso-motorista');
      input.select();
      document.execCommand('copy');
      alert('âœ… Link copiado!');
    }
    
    // ==========================================
    // FUNÃ‡Ã•ES DE MENSALIDADES
    // ==========================================
    
    function carregarMensalidades() {
      return JSON.parse(localStorage.getItem('mensalidades') || '[]');
    }
    
    function salvarMensalidadesDB(mens) {
      localStorage.setItem('mensalidades', JSON.stringify(mens));
    }
    
    function registrarPagamento(motoristaId) {
      var obs = prompt('ğŸ’µ Confirmar pagamento?\n\nObservaÃ§Ã£o (opcional):');
      if (obs === null) return;
      
      var mensalidades = carregarMensalidades();
      var mens = mensalidades.find(m => m.motoristaId === motoristaId && m.status !== 'pago');
      
      if (mens) {
        mens.status = 'pago';
        mens.pagoEm = new Date().toISOString();
        mens.observacao = obs;
        salvarMensalidadesDB(mensalidades);
        
        alert('âœ… Pagamento registrado com sucesso!');
        atualizarTabelaMensalidades();
      }
    }
    
    function enviarLembrete(motoristaId) {
      var motoristas = carregarMotoristas();
      var mot = motoristas.find(m => m.id === motoristaId);
      
      if (!mot) return;
      
      var msg = `âš ï¸ *LEMBRETE DE MENSALIDADE*

OlÃ¡ ${mot.nome.split(' ')[0]}!

Sua mensalidade de R$ ${mot.valorMensalidade?.toFixed(2) || '150.00'} vence em breve (dia ${mot.diaVencimento || 10}).

Por favor, efetue o pagamento para continuar trabalhando normalmente.

Qualquer dÃºvida, estamos Ã  disposiÃ§Ã£o! ğŸ™Œ`;
      
      window.open('https://wa.me/55' + mot.telefone + '?text=' + encodeURIComponent(msg), '_blank');
    }
    
    function bloquearMotoristaInadimplente(motoristaId) {
      if (!confirm('ğŸš« Tem certeza que deseja BLOQUEAR este motorista por inadimplÃªncia?\n\nEle nÃ£o poderÃ¡ receber corridas atÃ© regularizar.')) {
        return;
      }
      
      var motoristas = carregarMotoristas();
      var mot = motoristas.find(m => m.id === motoristaId);
      
      if (mot) {
        mot.status = 'bloqueado';
        mot.bloqueadoPor = 'inadimplencia';
        mot.bloqueadoEm = new Date().toISOString();
        salvarMotoristas(motoristas);
        
        alert('ğŸš« Motorista bloqueado por inadimplÃªncia.\n\nEle serÃ¡ notificado automaticamente.');
        atualizarTabelaMensalidades();
      }
    }
    
    function gerarMensalidadesMes() {
      var motoristas = carregarMotoristas();
      var mensalidades = carregarMensalidades();
      var hoje = new Date();
      var mesAtual = hoje.toISOString().substring(0, 7);
      
      var geradas = 0;
      
      motoristas.forEach(function(mot) {
        // Verificar se jÃ¡ existe mensalidade deste mÃªs
        var existe = mensalidades.find(m => m.motoristaId === mot.id && m.mesReferencia === mesAtual);
        
        if (!existe && mot.status !== 'bloqueado') {
          var vencimento = new Date(hoje.getFullYear(), hoje.getMonth(), mot.diaVencimento || 10);
          
          mensalidades.push({
            id: Date.now() + Math.random(),
            motoristaId: mot.id,
            motoristaNome: mot.nome,
            motoristaTelefone: mot.telefone,
            valor: mot.valorMensalidade || 150,
            vencimento: vencimento.toISOString().split('T')[0],
            mesReferencia: mesAtual,
            status: 'pendente',
            criadoEm: new Date().toISOString()
          });
          geradas++;
        }
      });
      
      salvarMensalidadesDB(mensalidades);
      alert('âœ… ' + geradas + ' mensalidades geradas para ' + mesAtual);
      atualizarTabelaMensalidades();
    }
    
    function enviarLembretes() {
      var mensalidades = carregarMensalidades();
      var pendentes = mensalidades.filter(m => m.status === 'pendente' || m.status === 'atrasado');
      
      if (pendentes.length === 0) {
        alert('âœ… Todos os motoristas estÃ£o em dia!');
        return;
      }
      
      if (!confirm('ğŸ“² Enviar lembretes para ' + pendentes.length + ' motoristas?')) {
        return;
      }
      
      pendentes.forEach(function(mens) {
        enviarLembrete(mens.motoristaId);
      });
      
      alert('âœ… Lembretes enviados!');
    }
    
    // Verificar vencimentos do dia
    function verificarVencimentosHoje() {
      var mensalidades = carregarMensalidades();
      var motoristas = carregarMotoristas();
      var hoje = new Date();
      var hojeStr = hoje.toISOString().split('T')[0];
      var diaSemanaHoje = hoje.getDay();
      
      var vencimentosHoje = [];
      
      mensalidades.forEach(function(m) {
        if (m.status !== 'pago') {
          var venceHoje = false;
          
          // Verificar se vence hoje
          if (m.vencimento === hojeStr) {
            venceHoje = true;
          } else if (m.tipoRecorrencia === 'semanal' && m.diaSemana === diaSemanaHoje) {
            venceHoje = true;
          }
          
          if (venceHoje) {
            vencimentosHoje.push(m);
          }
        }
      });
      
      if (vencimentosHoje.length > 0) {
        // Mostrar alerta
        var nomes = vencimentosHoje.map(v => v.motoristaNome).join(', ');
        document.getElementById('texto-vencimentos-hoje').textContent = 
          vencimentosHoje.length === 1 
            ? nomes + ' tem pagamento vencendo hoje!'
            : nomes + ' tÃªm pagamentos vencendo hoje!';
        document.getElementById('alerta-vencimentos-hoje').style.display = 'block';
        
        // Notificar dono via Rebeca
        notificarDonoVencimentos(vencimentosHoje);
      } else {
        document.getElementById('alerta-vencimentos-hoje').style.display = 'none';
        alert('âœ… Nenhum vencimento para hoje!');
      }
      
      return vencimentosHoje;
    }
    
    // Notificar dono sobre vencimentos
    async function notificarDonoVencimentos(vencimentos) {
      var telefoneDono = localStorage.getItem('config_telefone_adm');
      if (!telefoneDono) {
        console.log('Telefone do dono nÃ£o configurado');
        return;
      }
      
      var hoje = new Date();
      var dataFormatada = hoje.toLocaleDateString('pt-BR');
      
      var listaMotoristas = vencimentos.map(function(v) {
        var tipoTexto = v.tipoRecorrencia === 'semanal' ? '(Semanal)' : 
                        v.tipoRecorrencia === 'quinzenal' ? '(Quinzenal)' : '(Mensal)';
        return `â€¢ ${v.motoristaNome} - R$ ${v.valor.toFixed(2)} ${tipoTexto}`;
      }).join('\n');
      
      var msgRebeca = `ğŸ”” *REBECA - VENCIMENTOS HOJE*

ğŸ“… Data: ${dataFormatada}

Os seguintes motoristas tÃªm pagamento vencendo hoje:

${listaMotoristas}

ğŸ’° Total: R$ ${vencimentos.reduce((s, v) => s + v.valor, 0).toFixed(2)}

Acesse o painel para registrar os pagamentos.`;
      
      try {
        await fetch('/api/admin/notificacoes/teste', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ telefone: telefoneDono, mensagem: msgRebeca })
        });
        console.log('âœ… Dono notificado sobre vencimentos');
      } catch (e) {
        console.log('WhatsApp offline - notificaÃ§Ã£o pendente');
      }
    }
    
    // Enviar lembretes para vencimentos de hoje
    function enviarLembretesHoje() {
      var vencimentos = verificarVencimentosHoje();
      
      vencimentos.forEach(function(v) {
        enviarLembrete(v.motoristaId);
      });
      
      alert('âœ… Lembretes enviados para ' + vencimentos.length + ' motorista(s)!');
    }
    
    function atualizarTabelaMensalidades() {
      var mensalidades = carregarMensalidades();
      var motoristas = carregarMotoristas();
      var hoje = new Date();
      var hojeStr = hoje.toISOString().split('T')[0];
      var diaSemanaHoje = hoje.getDay();
      
      // Atualizar status de atrasados e verificar vencimentos do dia
      var vencimentosHoje = [];
      
      mensalidades.forEach(function(m) {
        if (m.status === 'pendente') {
          var venc = new Date(m.vencimento);
          if (hoje > venc) {
            m.status = 'atrasado';
          }
        }
        
        // Verificar vencimentos de hoje
        if (m.status !== 'pago') {
          if (m.vencimento === hojeStr || 
              (m.tipoRecorrencia === 'semanal' && m.diaSemana === diaSemanaHoje)) {
            vencimentosHoje.push(m);
          }
        }
      });
      salvarMensalidadesDB(mensalidades);
      
      // Mostrar alerta de vencimentos do dia
      if (vencimentosHoje.length > 0) {
        var nomes = vencimentosHoje.map(v => v.motoristaNome).join(', ');
        document.getElementById('texto-vencimentos-hoje').textContent = 
          vencimentosHoje.length === 1 
            ? nomes + ' tem pagamento vencendo hoje!'
            : nomes + ' tÃªm pagamentos vencendo hoje!';
        document.getElementById('alerta-vencimentos-hoje').style.display = 'block';
      } else {
        document.getElementById('alerta-vencimentos-hoje').style.display = 'none';
      }
      
      // Contar stats
      var pagas = mensalidades.filter(m => m.status === 'pago').length;
      var pendentes = mensalidades.filter(m => m.status === 'pendente').length;
      var atrasadas = mensalidades.filter(m => m.status === 'atrasado').length;
      var total = mensalidades.filter(m => m.status !== 'pago').reduce((s, m) => s + m.valor, 0);
      
      // Atualizar stats na pÃ¡gina
      if (document.getElementById('stat-mens-pagas')) {
        document.getElementById('stat-mens-pagas').textContent = pagas;
        document.getElementById('stat-mens-pendentes').textContent = pendentes;
        document.getElementById('stat-mens-atrasadas').textContent = atrasadas;
        document.getElementById('stat-mens-total').textContent = 'R$ ' + total.toFixed(0);
      }
      
      // Atualizar resumo nas configuraÃ§Ãµes
      if (document.getElementById('mens-pagas')) {
        document.getElementById('mens-pagas').textContent = pagas;
        document.getElementById('mens-pendentes').textContent = pendentes;
        document.getElementById('mens-atrasadas').textContent = atrasadas;
        document.getElementById('mens-total').textContent = 'R$ ' + total.toFixed(0);
      }
    }
    
    function atualizarListaMotoristas() {
      // Atualizar badge no menu
      var motoristas = carregarMotoristas();
      var badge = document.querySelector('.nav-item .nav-badge');
      if (badge) {
        badge.textContent = motoristas.length;
      }
    }
    
    function salvarConfigMensalidades() {
      var valor = document.getElementById('mens-valor-padrao').value;
      var dia = document.getElementById('mens-dia-padrao').value;
      var diasBloqueio = document.getElementById('mens-dias-bloqueio').value;
      
      localStorage.setItem('config_valor_mensalidade', valor);
      localStorage.setItem('config_dia_vencimento', dia);
      localStorage.setItem('config_dias_bloqueio', diasBloqueio);
      
      alert('âœ… ConfiguraÃ§Ãµes de mensalidade salvas!');
    }
    
    // Atualizar ao carregar pÃ¡gina de mensalidades
    function mostrarPaginaMensalidades() {
      atualizarTabelaMensalidades();
    }
    
    // Modificar mostrarPagina para incluir mensalidades
    var mostrarPaginaOriginal = mostrarPagina;
    mostrarPagina = function(pagina, elemento) {
      mostrarPaginaOriginal.call(this, pagina, elemento);
      
      if (pagina === 'mensalidades') {
        atualizarTabelaMensalidades();
      }
    };
    
    // Verificar vencimentos automaticamente ao carregar
    setTimeout(function() {
      var mensalidades = carregarMensalidades();
      if (mensalidades.length > 0) {
        atualizarTabelaMensalidades();
      }
    }, 2000);
    
    // Inicializar banco ao carregar
    inicializarBanco();
    
    // Atualizar mensalidades
    setTimeout(atualizarTabelaMensalidades, 1000);
    
    // ==========================================
    // FUNÃ‡Ã•ES FINANCEIRO
    // ==========================================
    
    function abrirModalFinanceiro(tipo) {
      document.getElementById('modal-financeiro').classList.add('active');
      document.getElementById('fin-tipo').value = tipo || 'entrada';
      document.getElementById('fin-data').value = new Date().toISOString().split('T')[0];
      document.getElementById('fin-descricao').value = '';
      document.getElementById('fin-valor').value = '';
      document.getElementById('fin-obs').value = '';
      
      atualizarCategoriasFin();
      
      var titulos = {
        'entrada': 'ğŸ“ˆ Registrar Entrada',
        'saida': 'ğŸ“‰ Registrar SaÃ­da',
        'venda': 'ğŸ’µ Registrar Venda'
      };
      document.getElementById('titulo-modal-fin').textContent = titulos[tipo] || 'ğŸ’° Novo LanÃ§amento';
    }
    
    function fecharModalFinanceiro() {
      document.getElementById('modal-financeiro').classList.remove('active');
    }
    
    function atualizarCategoriasFin() {
      var tipo = document.getElementById('fin-tipo').value;
      var categoriaSelect = document.getElementById('fin-categoria');
      
      var categorias = {
        'entrada': [
          { value: 'corridas', label: 'ğŸš— Corridas' },
          { value: 'mensalidade', label: 'ğŸ’³ Mensalidade' },
          { value: 'outros', label: 'ğŸ“¦ Outros' }
        ],
        'saida': [
          { value: 'manutencao', label: 'ğŸ”§ ManutenÃ§Ã£o' },
          { value: 'combustivel', label: 'â›½ CombustÃ­vel' },
          { value: 'salario', label: 'ğŸ’µ SalÃ¡rio/Pagamento' },
          { value: 'impostos', label: 'ğŸ“‹ Impostos/Taxas' },
          { value: 'outros', label: 'ğŸ“¦ Outros' }
        ],
        'venda': [
          { value: 'mensalidade', label: 'ğŸ’³ Mensalidade' },
          { value: 'adesao', label: 'âœ¨ Taxa de AdesÃ£o' },
          { value: 'outros', label: 'ğŸ“¦ Outros' }
        ]
      };
      
      categoriaSelect.innerHTML = categorias[tipo].map(function(c) {
        return '<option value="' + c.value + '">' + c.label + '</option>';
      }).join('');
    }
    
    function salvarLancamento() {
      var tipo = document.getElementById('fin-tipo').value;
      var categoria = document.getElementById('fin-categoria').value;
      var descricao = document.getElementById('fin-descricao').value.trim();
      var valor = parseFloat(document.getElementById('fin-valor').value) || 0;
      var data = document.getElementById('fin-data').value;
      var obs = document.getElementById('fin-obs').value;
      
      if (!descricao) {
        alert('âš ï¸ Informe uma descriÃ§Ã£o');
        return;
      }
      if (valor <= 0) {
        alert('âš ï¸ Informe um valor vÃ¡lido');
        return;
      }
      
      var lancamentos = JSON.parse(localStorage.getItem('lancamentos_financeiros') || '[]');
      lancamentos.push({
        id: Date.now(),
        tipo: tipo,
        categoria: categoria,
        descricao: descricao,
        valor: valor,
        data: data,
        observacao: obs,
        criadoEm: new Date().toISOString()
      });
      localStorage.setItem('lancamentos_financeiros', JSON.stringify(lancamentos));
      
      fecharModalFinanceiro();
      alert('âœ… LanÃ§amento registrado com sucesso!');
      
      // Atualizar totais
      atualizarTotaisFinanceiro();
    }
    
    function atualizarTotaisFinanceiro() {
      var lancamentos = JSON.parse(localStorage.getItem('lancamentos_financeiros') || '[]');
      var entradas = lancamentos.filter(l => l.tipo === 'entrada' || l.tipo === 'venda').reduce((s, l) => s + l.valor, 0);
      var saidas = lancamentos.filter(l => l.tipo === 'saida').reduce((s, l) => s + l.valor, 0);
      
      if (document.getElementById('fin-entradas')) {
        document.getElementById('fin-entradas').textContent = 'R$ ' + entradas.toFixed(0).replace(/\B(?=(\d{3})+(?!\d))/g, '.');
        document.getElementById('fin-saidas').textContent = 'R$ ' + saidas.toFixed(0).replace(/\B(?=(\d{3})+(?!\d))/g, '.');
        document.getElementById('fin-lucro').textContent = 'R$ ' + (entradas - saidas).toFixed(0).replace(/\B(?=(\d{3})+(?!\d))/g, '.');
      }
    }
    
    function excluirLancamento(id) {
      if (!confirm('ğŸ—‘ï¸ Excluir este lanÃ§amento?')) return;
      
      var lancamentos = JSON.parse(localStorage.getItem('lancamentos_financeiros') || '[]');
      lancamentos = lancamentos.filter(l => l.id !== id);
      localStorage.setItem('lancamentos_financeiros', JSON.stringify(lancamentos));
      
      alert('âœ… LanÃ§amento excluÃ­do!');
      atualizarTotaisFinanceiro();
    }
    
    // ==========================================
    // FUNÃ‡Ã•ES MOTORISTA
    // ==========================================
    
    function excluirMotorista(id, nome) {
      if (!confirm('ğŸ—‘ï¸ ATENÃ‡ÃƒO!\n\nTem certeza que deseja EXCLUIR o motorista "' + nome + '"?\n\nEsta aÃ§Ã£o nÃ£o pode ser desfeita!')) {
        return;
      }
      
      if (!confirm('âš ï¸ CONFIRMAÃ‡ÃƒO FINAL\n\nDigite SIM para confirmar a exclusÃ£o de "' + nome + '"')) {
        return;
      }
      
      var motoristas = carregarMotoristas();
      motoristas = motoristas.filter(m => m.id !== id);
      salvarMotoristas(motoristas);
      
      // Remover mensalidades
      var mensalidades = carregarMensalidades();
      mensalidades = mensalidades.filter(m => m.motoristaId !== id);
      localStorage.setItem('mensalidades', JSON.stringify(mensalidades));
      
      alert('âœ… Motorista "' + nome + '" excluÃ­do com sucesso!');
      location.reload();
    }
    
    function editarMotorista(id) {
      var motoristas = carregarMotoristas();
      var mot = motoristas.find(m => m.id === id);
      
      if (!mot) {
        alert('âš ï¸ Motorista nÃ£o encontrado');
        return;
      }
      
      alert('ğŸ“ EdiÃ§Ã£o de motorista\n\nEm desenvolvimento...\n\nMotorista: ' + mot.nome);
    }
    
    function localizarMotorista(id) {
      mostrarPagina('mapa', document.querySelector('[onclick*="mapa"]'));
      alert('ğŸ“ Localizando motorista no mapa...');
    }
    
    async function reenviarAcesso(id) {
      var motoristas = carregarMotoristas();
      var mot = motoristas.find(m => m.id === id);
      
      if (!mot) {
        alert('âš ï¸ Motorista nÃ£o encontrado');
        return;
      }
      
      // Gerar novo token
      var token = 'MOT-' + Date.now().toString(36).toUpperCase() + '-' + Math.random().toString(36).substring(2, 8).toUpperCase();
      mot.token = token;
      mot.primeiroAcesso = true;
      salvarMotoristas(motoristas);
      
      // Garantir link completo com https
      var linkAcesso = window.location.origin + '/motorista/primeiro-acesso?token=' + token;
      if (!linkAcesso.startsWith('http')) {
        linkAcesso = 'https://' + window.location.host + '/motorista/primeiro-acesso?token=' + token;
      }
      
      var msg = `ğŸ”— *NOVO LINK DE ACESSO*

OlÃ¡ *${mot.nome.split(' ')[0]}*! ğŸ‘‹

Seu link de acesso foi renovado.

â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
ğŸ“² *ACESSE SEU PAINEL:*
â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”

ğŸ‘‡ *Clique aqui:*

${linkAcesso}

â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”

Configure sua senha e comece a receber corridas! ğŸš—

_Sistema REBECA_`;
      
      // Tentar enviar via WhatsApp
      try {
        await fetch('/api/admin/notificacoes/teste', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ telefone: '55' + mot.telefone, mensagem: msg })
        });
        alert('âœ… Link reenviado para ' + mot.nome + '!\n\nğŸ“± WhatsApp: ' + mot.telefone);
      } catch (e) {
        // Fallback - abrir WhatsApp Web
        window.open('https://wa.me/55' + mot.telefone + '?text=' + encodeURIComponent(msg), '_blank');
      }
    }
    
    // ==========================================
    // CARREGAR MANUTENÃ‡Ã•ES
    // ==========================================
    
    function carregarManutencoes() {
      return JSON.parse(localStorage.getItem('manutencoes') || '[]');
    }
    
    function atualizarListaManutencoes() {
      var manutencoes = carregarManutencoes();
      var tbody = document.getElementById('lista-manutencoes-adm');
      if (!tbody) return;
      
      var pendentes = manutencoes.filter(m => m.status === 'programada' || m.status === 'em_manutencao');
      document.getElementById('manutencoes-pendentes').textContent = pendentes.length + ' pendente(s)';
      
      // Ordenar por data
      manutencoes.sort((a, b) => new Date(b.data) - new Date(a.data));
      
      tbody.innerHTML = manutencoes.slice(0, 10).map(function(m) {
        var statusBadge = m.status === 'em_manutencao' 
          ? '<span class="badge badge-danger">ğŸ”§ Em ManutenÃ§Ã£o</span>'
          : m.status === 'programada'
            ? '<span class="badge badge-warning">â³ Programada</span>'
            : '<span class="badge badge-success">âœ… ConcluÃ­da</span>';
            
        return `<tr>
          <td><strong>${m.motoristaNome}</strong></td>
          <td>${m.veiculo || '-'}</td>
          <td>${m.tipo}</td>
          <td>${m.empresa || '-'}</td>
          <td>R$ ${m.valor?.toFixed(2) || '0.00'}</td>
          <td>${new Date(m.data).toLocaleDateString('pt-BR')}</td>
          <td>${statusBadge}</td>
        </tr>`;
      }).join('') || '<tr><td colspan="7" style="text-align: center; color: var(--text-muted);">Nenhuma manutenÃ§Ã£o registrada</td></tr>';
    }
    
    // Carregar manutenÃ§Ãµes ao acessar financeiro
    var mostrarPaginaAnterior = mostrarPagina;
    mostrarPagina = function(pagina, elemento) {
      mostrarPaginaAnterior.call(this, pagina, elemento);
      
      if (pagina === 'financeiro') {
        atualizarListaManutencoes();
        atualizarTotaisFinanceiro();
      }
    };
    
    console.log('ğŸš€ Sistema GPS UBMAX inicializado!');
    console.log('ğŸ“¡ Use ZapCorridasAPI para integrar com o app do motorista');
  </script>

</body>
</html>
