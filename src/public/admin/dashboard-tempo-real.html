<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Dashboard Tempo Real - Painel ADM</title>
  
  <!-- Leaflet CSS -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
  <!-- Socket.io -->
  <script src="https://cdn.socket.io/4.7.2/socket.io.min.js"></script>
  
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }
    
    :root {
      --primary: #6366f1;
      --success: #10b981;
      --warning: #f59e0b;
      --danger: #ef4444;
      --bg: #0f172a;
      --card: #1e293b;
      --text: #f8fafc;
      --text-muted: #94a3b8;
      --border: #334155;
    }
    
    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
      background: var(--bg);
      color: var(--text);
      min-height: 100vh;
    }
    
    /* Header */
    .header {
      background: var(--card);
      border-bottom: 1px solid var(--border);
      padding: 16px 24px;
      display: flex;
      justify-content: space-between;
      align-items: center;
      position: sticky;
      top: 0;
      z-index: 100;
    }
    
    .header-left {
      display: flex;
      align-items: center;
      gap: 16px;
    }
    
    .logo {
      font-size: 20px;
      font-weight: 700;
      color: var(--primary);
    }
    
    .empresa-nome {
      font-size: 14px;
      color: var(--text-muted);
      padding: 6px 12px;
      background: var(--bg);
      border-radius: 6px;
    }
    
    .status-conexao {
      display: flex;
      align-items: center;
      gap: 8px;
      font-size: 13px;
    }
    
    .status-dot {
      width: 10px;
      height: 10px;
      border-radius: 50%;
      background: var(--danger);
    }
    
    .status-dot.conectado {
      background: var(--success);
      animation: pulse 2s infinite;
    }
    
    @keyframes pulse {
      0%, 100% { opacity: 1; }
      50% { opacity: 0.5; }
    }
    
    /* Layout principal */
    .main-container {
      display: grid;
      grid-template-columns: 1fr 400px;
      height: calc(100vh - 73px);
    }
    
    /* Mapa */
    .mapa-container {
      position: relative;
    }
    
    #mapa {
      width: 100%;
      height: 100%;
    }
    
    /* Cards de m√©tricas no mapa */
    .metricas-overlay {
      position: absolute;
      top: 16px;
      left: 16px;
      z-index: 1000;
      display: flex;
      gap: 12px;
    }
    
    .metrica-card {
      background: rgba(30, 41, 59, 0.95);
      backdrop-filter: blur(10px);
      border-radius: 12px;
      padding: 16px 20px;
      min-width: 140px;
      border: 1px solid var(--border);
    }
    
    .metrica-valor {
      font-size: 32px;
      font-weight: 700;
      line-height: 1;
    }
    
    .metrica-label {
      font-size: 12px;
      color: var(--text-muted);
      margin-top: 4px;
    }
    
    .metrica-card.online .metrica-valor { color: var(--success); }
    .metrica-card.corridas .metrica-valor { color: var(--primary); }
    .metrica-card.faturamento .metrica-valor { color: var(--warning); }
    
    /* Painel lateral */
    .painel-lateral {
      background: var(--card);
      border-left: 1px solid var(--border);
      display: flex;
      flex-direction: column;
      overflow: hidden;
    }
    
    .painel-header {
      padding: 16px;
      border-bottom: 1px solid var(--border);
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
    
    .painel-titulo {
      font-size: 16px;
      font-weight: 600;
    }
    
    .tabs {
      display: flex;
      border-bottom: 1px solid var(--border);
    }
    
    .tab {
      flex: 1;
      padding: 12px;
      text-align: center;
      font-size: 13px;
      font-weight: 500;
      cursor: pointer;
      border-bottom: 2px solid transparent;
      transition: all 0.2s;
    }
    
    .tab:hover { background: rgba(99, 102, 241, 0.1); }
    .tab.active {
      color: var(--primary);
      border-bottom-color: var(--primary);
    }
    
    .tab-content {
      flex: 1;
      overflow-y: auto;
      padding: 16px;
    }
    
    .tab-panel { display: none; }
    .tab-panel.active { display: block; }
    
    /* Lista de corridas */
    .corrida-item {
      background: var(--bg);
      border-radius: 12px;
      padding: 14px;
      margin-bottom: 12px;
      border-left: 4px solid var(--primary);
      cursor: pointer;
      transition: all 0.2s;
    }
    
    .corrida-item:hover {
      transform: translateX(4px);
    }
    
    .corrida-item.pendente { border-left-color: var(--warning); }
    .corrida-item.em-andamento { border-left-color: var(--success); }
    .corrida-item.finalizada { border-left-color: var(--text-muted); }
    
    .corrida-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 8px;
    }
    
    .corrida-id {
      font-weight: 600;
      font-size: 14px;
    }
    
    .corrida-status {
      font-size: 11px;
      padding: 4px 8px;
      border-radius: 4px;
      font-weight: 600;
      text-transform: uppercase;
    }
    
    .corrida-status.pendente { background: rgba(245, 158, 11, 0.2); color: var(--warning); }
    .corrida-status.aceita { background: rgba(99, 102, 241, 0.2); color: var(--primary); }
    .corrida-status.em-andamento { background: rgba(16, 185, 129, 0.2); color: var(--success); }
    
    .corrida-info {
      font-size: 13px;
      color: var(--text-muted);
      margin-bottom: 4px;
    }
    
    .corrida-info strong { color: var(--text); }
    
    .corrida-valor {
      font-size: 18px;
      font-weight: 700;
      color: var(--success);
      margin-top: 8px;
    }
    
    /* Lista de motoristas */
    .motorista-item {
      display: flex;
      align-items: center;
      gap: 12px;
      padding: 12px;
      background: var(--bg);
      border-radius: 10px;
      margin-bottom: 10px;
    }
    
    .motorista-avatar {
      width: 44px;
      height: 44px;
      border-radius: 50%;
      background: linear-gradient(135deg, var(--primary), #a855f7);
      display: flex;
      align-items: center;
      justify-content: center;
      font-weight: 600;
      font-size: 16px;
    }
    
    .motorista-info { flex: 1; }
    
    .motorista-nome {
      font-weight: 600;
      font-size: 14px;
      margin-bottom: 2px;
    }
    
    .motorista-veiculo {
      font-size: 12px;
      color: var(--text-muted);
    }
    
    .motorista-status {
      width: 12px;
      height: 12px;
      border-radius: 50%;
      background: var(--text-muted);
    }
    
    .motorista-status.online { background: var(--success); }
    .motorista-status.ocupado { background: var(--warning); }
    .motorista-status.offline { background: var(--danger); }
    
    /* Alertas */
    .alerta-item {
      padding: 12px;
      background: rgba(239, 68, 68, 0.1);
      border: 1px solid rgba(239, 68, 68, 0.3);
      border-radius: 8px;
      margin-bottom: 10px;
    }
    
    .alerta-item.warning {
      background: rgba(245, 158, 11, 0.1);
      border-color: rgba(245, 158, 11, 0.3);
    }
    
    .alerta-titulo {
      font-weight: 600;
      font-size: 13px;
      margin-bottom: 4px;
    }
    
    .alerta-descricao {
      font-size: 12px;
      color: var(--text-muted);
    }
    
    /* Footer do painel */
    .painel-footer {
      padding: 12px 16px;
      border-top: 1px solid var(--border);
      font-size: 12px;
      color: var(--text-muted);
      text-align: center;
    }
    
    /* Marcadores do mapa */
    .marcador-motorista {
      background: var(--success);
      width: 36px;
      height: 36px;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 18px;
      border: 3px solid white;
      box-shadow: 0 2px 10px rgba(0,0,0,0.3);
    }
    
    .marcador-motorista.ocupado { background: var(--warning); }
    .marcador-motorista.offline { background: var(--text-muted); }
    
    .marcador-corrida {
      background: var(--primary);
      width: 32px;
      height: 32px;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 16px;
      border: 3px solid white;
      box-shadow: 0 2px 10px rgba(0,0,0,0.3);
    }
    
    /* Sem dados */
    .sem-dados {
      text-align: center;
      padding: 40px 20px;
      color: var(--text-muted);
    }
    
    .sem-dados-icon {
      font-size: 48px;
      margin-bottom: 12px;
    }
    
    /* Responsivo */
    @media (max-width: 900px) {
      .main-container {
        grid-template-columns: 1fr;
        grid-template-rows: 50vh 1fr;
      }
      
      .painel-lateral {
        border-left: none;
        border-top: 1px solid var(--border);
      }
      
      .metricas-overlay {
        flex-wrap: wrap;
      }
      
      .metrica-card {
        min-width: 100px;
        padding: 12px;
      }
      
      .metrica-valor {
        font-size: 24px;
      }
    }
  </style>
</head>
<body>
  <!-- Header -->
  <header class="header">
    <div class="header-left">
      <div class="logo">üöó Dashboard</div>
      <div class="empresa-nome" id="empresa-nome">Carregando...</div>
    </div>
    <div class="status-conexao">
      <div class="status-dot" id="status-dot"></div>
      <span id="status-texto">Conectando...</span>
    </div>
  </header>
  
  <!-- Container principal -->
  <div class="main-container">
    <!-- Mapa -->
    <div class="mapa-container">
      <div id="mapa"></div>
      
      <!-- M√©tricas overlay -->
      <div class="metricas-overlay">
        <div class="metrica-card online">
          <div class="metrica-valor" id="total-online">0</div>
          <div class="metrica-label">Motoristas Online</div>
        </div>
        <div class="metrica-card corridas">
          <div class="metrica-valor" id="total-corridas-hoje">0</div>
          <div class="metrica-label">Corridas Hoje</div>
        </div>
        <div class="metrica-card faturamento">
          <div class="metrica-valor" id="faturamento-hoje">R$ 0</div>
          <div class="metrica-label">Faturamento Hoje</div>
        </div>
      </div>
    </div>
    
    <!-- Painel lateral -->
    <div class="painel-lateral">
      <div class="painel-header">
        <div class="painel-titulo">üìä Tempo Real</div>
        <span id="ultima-atualizacao" style="font-size: 11px; color: var(--text-muted);">--:--:--</span>
      </div>
      
      <!-- Tabs -->
      <div class="tabs">
        <div class="tab active" data-tab="corridas">üöó Corridas</div>
        <div class="tab" data-tab="motoristas">üë§ Motoristas</div>
        <div class="tab" data-tab="alertas">‚ö†Ô∏è Alertas</div>
      </div>
      
      <!-- Conte√∫do das tabs -->
      <div class="tab-content">
        <!-- Tab Corridas -->
        <div class="tab-panel active" id="panel-corridas">
          <div id="lista-corridas">
            <div class="sem-dados">
              <div class="sem-dados-icon">üöó</div>
              <div>Nenhuma corrida ativa</div>
            </div>
          </div>
        </div>
        
        <!-- Tab Motoristas -->
        <div class="tab-panel" id="panel-motoristas">
          <div id="lista-motoristas">
            <div class="sem-dados">
              <div class="sem-dados-icon">üë§</div>
              <div>Nenhum motorista cadastrado</div>
            </div>
          </div>
        </div>
        
        <!-- Tab Alertas -->
        <div class="tab-panel" id="panel-alertas">
          <div id="lista-alertas">
            <div class="sem-dados">
              <div class="sem-dados-icon">‚úÖ</div>
              <div>Nenhum alerta no momento</div>
            </div>
          </div>
        </div>
      </div>
      
      <div class="painel-footer">
        Atualiza√ß√£o autom√°tica a cada 5 segundos
      </div>
    </div>
  </div>
  
  <!-- Leaflet JS -->
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
  
  <script>
    // ==========================================
    // CONFIGURA√á√ÉO
    // ==========================================
    const CONFIG = {
      empresa_id: new URLSearchParams(window.location.search).get('empresa_id') || localStorage.getItem('empresa_id') || 1,
      intervalo_atualizacao: 5000, // 5 segundos
      centro_mapa: [-22.3285, -49.0715], // Bauru como padr√£o
      zoom_padrao: 13
    };
    
    // Estado global
    let mapa = null;
    let socket = null;
    let marcadoresMotoristas = {};
    let marcadoresCorridas = {};
    let dadosEmpresa = {};
    let motoristas = [];
    let corridasAtivas = [];
    let alertas = [];
    
    // ==========================================
    // INICIALIZA√á√ÉO
    // ==========================================
    document.addEventListener('DOMContentLoaded', async () => {
      inicializarTabs();
      inicializarMapa();
      await carregarDadosIniciais();
      conectarWebSocket();
      iniciarAtualizacaoAutomatica();
    });
    
    // ==========================================
    // TABS
    // ==========================================
    function inicializarTabs() {
      document.querySelectorAll('.tab').forEach(tab => {
        tab.addEventListener('click', () => {
          document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
          document.querySelectorAll('.tab-panel').forEach(p => p.classList.remove('active'));
          
          tab.classList.add('active');
          document.getElementById(`panel-${tab.dataset.tab}`).classList.add('active');
        });
      });
    }
    
    // ==========================================
    // MAPA
    // ==========================================
    function inicializarMapa() {
      mapa = L.map('mapa', {
        zoomControl: true,
        attributionControl: false
      }).setView(CONFIG.centro_mapa, CONFIG.zoom_padrao);
      
      // Tile layer escuro
      L.tileLayer('https://{s}.basemaps.cartocdn.com/dark_all/{z}/{x}/{y}{r}.png', {
        maxZoom: 19
      }).addTo(mapa);
    }
    
    // ==========================================
    // WEBSOCKET
    // ==========================================
    function conectarWebSocket() {
      const wsUrl = window.location.origin;
      socket = io(wsUrl, {
        transports: ['websocket', 'polling']
      });
      
      socket.on('connect', () => {
        console.log('‚úÖ WebSocket conectado');
        atualizarStatusConexao(true);
        
        // Entrar na sala da empresa
        socket.emit('entrar:empresa', { empresa_id: CONFIG.empresa_id });
      });
      
      socket.on('disconnect', () => {
        console.log('‚ùå WebSocket desconectado');
        atualizarStatusConexao(false);
      });
      
      // Eventos em tempo real
      socket.on('motorista:localizacao', (data) => {
        if (data.empresa_id == CONFIG.empresa_id) {
          atualizarMarcadorMotorista(data);
        }
      });
      
      socket.on('corrida:nova', (data) => {
        if (data.empresa_id == CONFIG.empresa_id) {
          adicionarCorrida(data);
        }
      });
      
      socket.on('corrida:atualizada', (data) => {
        if (data.empresa_id == CONFIG.empresa_id) {
          atualizarCorrida(data);
        }
      });
      
      socket.on('motorista:status', (data) => {
        if (data.empresa_id == CONFIG.empresa_id) {
          atualizarStatusMotorista(data);
        }
      });
      
      socket.on('alerta:novo', (data) => {
        if (data.empresa_id == CONFIG.empresa_id) {
          adicionarAlerta(data);
        }
      });
    }
    
    function atualizarStatusConexao(conectado) {
      const dot = document.getElementById('status-dot');
      const texto = document.getElementById('status-texto');
      
      if (conectado) {
        dot.classList.add('conectado');
        texto.textContent = 'Conectado';
      } else {
        dot.classList.remove('conectado');
        texto.textContent = 'Desconectado';
      }
    }
    
    // ==========================================
    // CARREGAR DADOS
    // ==========================================
    async function carregarDadosIniciais() {
      try {
        // Carregar empresa
        const resEmpresa = await fetch(`/api/admin/empresa/config?empresa_id=${CONFIG.empresa_id}`);
        const dataEmpresa = await resEmpresa.json();
        if (dataEmpresa.success) {
          dadosEmpresa = dataEmpresa.empresa;
          document.getElementById('empresa-nome').textContent = dadosEmpresa.nome || 'Minha Frota';
          
          // Centralizar mapa na cidade da empresa
          if (dadosEmpresa.latitude && dadosEmpresa.longitude) {
            mapa.setView([dadosEmpresa.latitude, dadosEmpresa.longitude], CONFIG.zoom_padrao);
          }
        }
        
        // Carregar motoristas
        await carregarMotoristas();
        
        // Carregar corridas ativas
        await carregarCorridasAtivas();
        
        // Carregar m√©tricas
        await carregarMetricas();
        
      } catch (error) {
        console.error('Erro ao carregar dados:', error);
      }
    }
    
    async function carregarMotoristas() {
      try {
        const res = await fetch(`/api/admin/motoristas?empresa_id=${CONFIG.empresa_id}`);
        const data = await res.json();
        
        if (data.success || data.motoristas) {
          motoristas = data.motoristas || data;
          renderizarMotoristas();
          atualizarMarcadoresMotoristas();
        }
      } catch (error) {
        console.error('Erro ao carregar motoristas:', error);
      }
    }
    
    async function carregarCorridasAtivas() {
      try {
        const res = await fetch(`/api/admin/corridas/hoje?empresa_id=${CONFIG.empresa_id}`);
        const data = await res.json();
        
        if (data.success || data.corridas) {
          corridasAtivas = (data.corridas || data).filter(c => 
            ['pendente', 'aceita', 'a_caminho', 'aguardando_cliente', 'em_andamento'].includes(c.status)
          );
          renderizarCorridas();
          atualizarMarcadoresCorridas();
        }
      } catch (error) {
        console.error('Erro ao carregar corridas:', error);
      }
    }
    
    async function carregarMetricas() {
      try {
        const res = await fetch(`/api/admin/dashboard?empresa_id=${CONFIG.empresa_id}`);
        const data = await res.json();
        
        if (data.success || data.motoristas_online !== undefined) {
          document.getElementById('total-online').textContent = data.motoristas_online || 0;
          document.getElementById('total-corridas-hoje').textContent = data.corridas_hoje || 0;
          document.getElementById('faturamento-hoje').textContent = `R$ ${(data.faturamento_hoje || 0).toFixed(0)}`;
        }
      } catch (error) {
        console.error('Erro ao carregar m√©tricas:', error);
      }
      
      // Atualizar timestamp
      document.getElementById('ultima-atualizacao').textContent = new Date().toLocaleTimeString('pt-BR');
    }
    
    // ==========================================
    // RENDERIZA√á√ÉO
    // ==========================================
    function renderizarMotoristas() {
      const lista = document.getElementById('lista-motoristas');
      
      if (!motoristas || motoristas.length === 0) {
        lista.innerHTML = `
          <div class="sem-dados">
            <div class="sem-dados-icon">üë§</div>
            <div>Nenhum motorista cadastrado</div>
          </div>
        `;
        return;
      }
      
      // Ordenar: online primeiro
      const ordenados = [...motoristas].sort((a, b) => {
        if (a.status === 'online' && b.status !== 'online') return -1;
        if (a.status !== 'online' && b.status === 'online') return 1;
        return 0;
      });
      
      lista.innerHTML = ordenados.map(m => {
        const inicial = m.nome ? m.nome.charAt(0).toUpperCase() : '?';
        const statusClass = m.status === 'online' ? (m.disponivel ? 'online' : 'ocupado') : 'offline';
        
        return `
          <div class="motorista-item" onclick="focarMotorista(${m.id})">
            <div class="motorista-avatar">${inicial}</div>
            <div class="motorista-info">
              <div class="motorista-nome">${m.nome || 'Sem nome'}</div>
              <div class="motorista-veiculo">${m.veiculo_modelo || ''} ${m.veiculo_cor || ''} ‚Ä¢ ${m.veiculo_placa || ''}</div>
            </div>
            <div class="motorista-status ${statusClass}" title="${statusClass}"></div>
          </div>
        `;
      }).join('');
    }
    
    function renderizarCorridas() {
      const lista = document.getElementById('lista-corridas');
      
      if (!corridasAtivas || corridasAtivas.length === 0) {
        lista.innerHTML = `
          <div class="sem-dados">
            <div class="sem-dados-icon">üöó</div>
            <div>Nenhuma corrida ativa</div>
          </div>
        `;
        return;
      }
      
      lista.innerHTML = corridasAtivas.map(c => {
        const statusClass = c.status === 'pendente' ? 'pendente' : 
                           c.status === 'em_andamento' ? 'em-andamento' : 'aceita';
        const statusTexto = {
          pendente: 'Pendente',
          aceita: 'Aceita',
          a_caminho: 'A Caminho',
          aguardando_cliente: 'Aguardando',
          em_andamento: 'Em Andamento'
        }[c.status] || c.status;
        
        return `
          <div class="corrida-item ${statusClass}" onclick="focarCorrida(${c.id})">
            <div class="corrida-header">
              <span class="corrida-id">#${c.id}</span>
              <span class="corrida-status ${statusClass}">${statusTexto}</span>
            </div>
            <div class="corrida-info">
              <strong>üìç Origem:</strong> ${c.origem_endereco?.substring(0, 40) || 'N/A'}...
            </div>
            <div class="corrida-info">
              <strong>üèÅ Destino:</strong> ${c.destino_endereco?.substring(0, 40) || 'A informar'}
            </div>
            <div class="corrida-info">
              <strong>üë§ Cliente:</strong> ${c.nome_cliente || c.telefone_cliente || 'N/A'}
            </div>
            ${c.motorista_nome ? `<div class="corrida-info"><strong>üöó Motorista:</strong> ${c.motorista_nome}</div>` : ''}
            <div class="corrida-valor">R$ ${(c.valor || 0).toFixed(2)}</div>
          </div>
        `;
      }).join('');
    }
    
    function renderizarAlertas() {
      const lista = document.getElementById('lista-alertas');
      
      if (!alertas || alertas.length === 0) {
        lista.innerHTML = `
          <div class="sem-dados">
            <div class="sem-dados-icon">‚úÖ</div>
            <div>Nenhum alerta no momento</div>
          </div>
        `;
        return;
      }
      
      lista.innerHTML = alertas.map(a => `
        <div class="alerta-item ${a.tipo === 'warning' ? 'warning' : ''}">
          <div class="alerta-titulo">${a.titulo}</div>
          <div class="alerta-descricao">${a.descricao}</div>
        </div>
      `).join('');
    }
    
    // ==========================================
    // MARCADORES DO MAPA
    // ==========================================
    function atualizarMarcadoresMotoristas() {
      motoristas.forEach(m => {
        if (m.latitude && m.longitude) {
          atualizarMarcadorMotorista({
            motorista_id: m.id,
            nome: m.nome,
            lat: m.latitude,
            lng: m.longitude,
            status: m.status,
            disponivel: m.disponivel,
            veiculo: `${m.veiculo_modelo || ''} ${m.veiculo_cor || ''}`
          });
        }
      });
    }
    
    function atualizarMarcadorMotorista(data) {
      const { motorista_id, nome, lat, lng, status, disponivel, veiculo } = data;
      
      if (!lat || !lng) return;
      
      const statusClass = status === 'online' ? (disponivel ? '' : 'ocupado') : 'offline';
      
      const icone = L.divIcon({
        className: 'marcador-container',
        html: `<div class="marcador-motorista ${statusClass}">üöó</div>`,
        iconSize: [36, 36],
        iconAnchor: [18, 18]
      });
      
      if (marcadoresMotoristas[motorista_id]) {
        // Atualizar posi√ß√£o
        marcadoresMotoristas[motorista_id].setLatLng([lat, lng]);
        marcadoresMotoristas[motorista_id].setIcon(icone);
      } else {
        // Criar novo marcador
        marcadoresMotoristas[motorista_id] = L.marker([lat, lng], { icon: icone })
          .addTo(mapa)
          .bindPopup(`<b>${nome || 'Motorista'}</b><br>${veiculo || ''}<br><small>${status}</small>`);
      }
    }
    
    function atualizarMarcadoresCorridas() {
      // Limpar marcadores antigos
      Object.values(marcadoresCorridas).forEach(m => mapa.removeLayer(m));
      marcadoresCorridas = {};
      
      corridasAtivas.forEach(c => {
        if (c.origem_lat && c.origem_lng) {
          const icone = L.divIcon({
            className: 'marcador-container',
            html: `<div class="marcador-corrida">üìç</div>`,
            iconSize: [32, 32],
            iconAnchor: [16, 16]
          });
          
          marcadoresCorridas[c.id] = L.marker([c.origem_lat, c.origem_lng], { icon: icone })
            .addTo(mapa)
            .bindPopup(`<b>Corrida #${c.id}</b><br>${c.origem_endereco?.substring(0, 30) || 'N/A'}`);
        }
      });
    }
    
    // ==========================================
    // A√á√ïES
    // ==========================================
    function focarMotorista(id) {
      const motorista = motoristas.find(m => m.id === id);
      if (motorista && motorista.latitude && motorista.longitude) {
        mapa.setView([motorista.latitude, motorista.longitude], 16);
        if (marcadoresMotoristas[id]) {
          marcadoresMotoristas[id].openPopup();
        }
      }
    }
    
    function focarCorrida(id) {
      const corrida = corridasAtivas.find(c => c.id === id);
      if (corrida && corrida.origem_lat && corrida.origem_lng) {
        mapa.setView([corrida.origem_lat, corrida.origem_lng], 16);
        if (marcadoresCorridas[id]) {
          marcadoresCorridas[id].openPopup();
        }
      }
    }
    
    // ==========================================
    // EVENTOS EM TEMPO REAL
    // ==========================================
    function adicionarCorrida(corrida) {
      corridasAtivas.unshift(corrida);
      renderizarCorridas();
      atualizarMarcadoresCorridas();
      carregarMetricas();
      
      // Notifica√ß√£o visual
      mostrarNotificacao('üöó Nova corrida!', `#${corrida.id} - ${corrida.origem_endereco?.substring(0, 30)}`);
    }
    
    function atualizarCorrida(corrida) {
      const index = corridasAtivas.findIndex(c => c.id === corrida.id);
      if (index >= 0) {
        if (['finalizada', 'cancelada'].includes(corrida.status)) {
          corridasAtivas.splice(index, 1);
        } else {
          corridasAtivas[index] = { ...corridasAtivas[index], ...corrida };
        }
        renderizarCorridas();
        atualizarMarcadoresCorridas();
      }
      carregarMetricas();
    }
    
    function atualizarStatusMotorista(data) {
      const motorista = motoristas.find(m => m.id === data.motorista_id);
      if (motorista) {
        motorista.status = data.status;
        motorista.disponivel = data.disponivel;
        renderizarMotoristas();
        atualizarMarcadorMotorista(data);
      }
      carregarMetricas();
    }
    
    function adicionarAlerta(alerta) {
      alertas.unshift(alerta);
      renderizarAlertas();
      
      // Atualizar badge da tab
      document.querySelector('[data-tab="alertas"]').textContent = `‚ö†Ô∏è Alertas (${alertas.length})`;
    }
    
    // ==========================================
    // NOTIFICA√á√ïES
    // ==========================================
    function mostrarNotificacao(titulo, mensagem) {
      if (Notification.permission === 'granted') {
        new Notification(titulo, { body: mensagem });
      }
    }
    
    // Pedir permiss√£o para notifica√ß√µes
    if ('Notification' in window && Notification.permission === 'default') {
      Notification.requestPermission();
    }
    
    // ==========================================
    // ATUALIZA√á√ÉO AUTOM√ÅTICA
    // ==========================================
    function iniciarAtualizacaoAutomatica() {
      setInterval(async () => {
        await carregarMotoristas();
        await carregarCorridasAtivas();
        await carregarMetricas();
      }, CONFIG.intervalo_atualizacao);
    }
  </script>
</body>
</html>
