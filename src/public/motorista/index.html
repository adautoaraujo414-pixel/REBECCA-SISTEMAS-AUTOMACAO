<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <title>Painel Motorista - UBMAX</title>
  
  <!-- PWA Meta Tags -->
  <meta name="mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
  <meta name="apple-mobile-web-app-title" content="Motorista">
  <meta name="application-name" content="Motorista UBMAX">
  <meta name="theme-color" content="#6366f1">
  <meta name="msapplication-TileColor" content="#6366f1">
  <meta name="msapplication-navbutton-color" content="#6366f1">
  
  <!-- PWA Manifest -->
  <link rel="manifest" href="data:application/json;base64,ewogICJuYW1lIjogIlBhaW5lbCBNb3RvcmlzdGEgLSBVQk1BWCIsCiAgInNob3J0X25hbWUiOiAiTW90b3Jpc3RhIiwKICAiZGVzY3JpcHRpb24iOiAiUGFpbmVsIGRvIG1vdG9yaXN0YSBwYXJhIHJlY2ViZXIgY29ycmlkYXMiLAogICJzdGFydF91cmwiOiAiL21vdG9yaXN0YS8iLAogICJkaXNwbGF5IjogInN0YW5kYWxvbmUiLAogICJiYWNrZ3JvdW5kX2NvbG9yIjogIiNmOGZhZmMiLAogICJ0aGVtZV9jb2xvciI6ICIjNjM2NmYxIiwKICAib3JpZW50YXRpb24iOiAicG9ydHJhaXQiLAogICJpY29ucyI6IFsKICAgIHsKICAgICAgInNyYyI6ICJkYXRhOmltYWdlL3N2Zyt4bWw7YmFzZTY0LFBITjJaeUI0Yld4dWN6MGlhSFIwY0RvdkwzZDNkeTUzTXk1dmNtY3ZNakF3TUM5emRtY2lJSFpwWlhkQ2IzZzlJakFnTUNBeE9USWdNVGt5SWo0OFpHVm1jejQ4YkdsdVpXRnlSM0poWkdsbGJuUWdhV1E5SW1jaUlIZ3hQU0l4TURBbElpQjVNVDBpTUNVaUlIZ3lQU0l4TURBbElpQjVNajBpTVRBd0pTSStQSE4wYjNBZ2IyWm1jMlYwUFNJd0pTSWdjM1J2Y0MxamIyeHZjajBpSXpZek5qWm1NU0l2UGp4emRHOXdJRzltWm5ObGREMGlNVEF3SlNJZ2MzUnZjQzFqYjJ4dmNqMGlJelJtTkRabE5TSXZQand2YkdsdVpXRnlSM0poWkdsbGJuUStQQzlrWldaelBqeGphWEpqYkdVZ1ptbHNiRDBpZFhKc0tDTm5LU0lnWTNnOUlqazJJaUJqZVQwaU9UWWlJSEk5SWprMklpOCtQSFJsZUhRZ2VEMGlPVFlpSUhrOUlqRXdOQ0lnWm05dWRDMXphWHBsUFNJME9DSWdabWxzYkQwaWQyaHBkR1VpSUhSbGVIUXRZVzVqYUc5eVBTSnRhV1JrYkdVaUlHWnZiblF0ZDJWcFoyaDBQU0kzTURBaVBzT0tQQzkwWlhoMFBqd3ZjM1puUGc9PSIsCiAgICAgICJzaXplcyI6ICIxOTJ4MTkyIiwKICAgICAgInR5cGUiOiAiaW1hZ2Uvc3ZnK3htbCIsCiAgICAgICJwdXJwb3NlIjogImFueSBtYXNrYWJsZSIKICAgIH0KICBdCn0=">
  
  <!-- Apple Touch Icon -->
  <link rel="apple-touch-icon" href="data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHZpZXdCb3g9IjAgMCAxOTIgMTkyIj48ZGVmcz48bGluZWFyR3JhZGllbnQgaWQ9ImciIHgxPSIxMDAlIiB5MT0iMCUiIHgyPSIxMDAlIiB5Mj0iMTAwJSI+PHN0b3Agb2Zmc2V0PSIwJSIgc3RvcC1jb2xvcj0iIzYzNjZmMSIvPjxzdG9wIG9mZnNldD0iMTAwJSIgc3RvcC1jb2xvcj0iIzRmNDZlNSIvPjwvbGluZWFyR3JhZGllbnQ+PC9kZWZzPjxjaXJjbGUgZmlsbD0idXJsKCNnKSIgY3g9Ijk2IiBjeT0iOTYiIHI9Ijk2Ii8+PHRleHQgeD0iOTYiIHk9IjEwNCIgZm9udC1zaXplPSI0OCIgZmlsbD0id2hpdGUiIHRleHQtYW5jaG9yPSJtaWRkbGUiIGZvbnQtd2VpZ2h0PSI3MDAiPsOKPC90ZXh0Pjwvc3ZnPg==">
  
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@400;500;600;700&display=swap" rel="stylesheet">
  <!-- Leaflet CSS para o mapa -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
  <style>
    /* Ocultar modais de manuten√ß√£o e avaria (desativados temporariamente) */
    #modal-manutencao, #modal-avaria { display: none !important; }
    :root {
      --primary: #6366f1;
      --primary-dark: #4f46e5;
      --success: #10b981;
      --warning: #f59e0b;
      --danger: #ef4444;
      --bg-body: #f8fafc;
      --bg-card: #ffffff;
      --text-primary: #1e293b;
      --text-secondary: #475569;
      --text-muted: #94a3b8;
      --border: #e2e8f0;
      --radius: 16px;
      --radius-sm: 12px;
      --shadow: 0 1px 3px rgba(0,0,0,0.1);
      --shadow-lg: 0 10px 25px rgba(0,0,0,0.1);
    }
    * { margin: 0; padding: 0; box-sizing: border-box; }
    body { 
      font-family: 'Plus Jakarta Sans', sans-serif; 
      background: var(--bg-body); 
      color: var(--text-primary); 
      min-height: 100vh; 
      max-width: 480px; 
      margin: 0 auto;
      padding-bottom: 40px;
    }
    .hidden { display: none !important; }

    /* TELA DE LOGIN */
    #tela-login {
      min-height: 100vh;
      display: flex;
      flex-direction: column;
      justify-content: center;
      padding: 40px 24px;
      background: var(--bg-body);
    }
    #tela-principal { display: none; }

    .login-header { text-align: center; margin-bottom: 40px; }
    .logo-icon { font-size: 64px; display: block; margin-bottom: 16px; }
    .login-header h1 { 
      font-size: 32px; 
      font-weight: 700; 
      background: linear-gradient(135deg, #818cf8, var(--primary)); 
      -webkit-background-clip: text; 
      -webkit-text-fill-color: transparent; 
    }
    .login-header p { color: var(--text-muted); margin-top: 8px; }

    .form-group { margin-bottom: 20px; }
    .form-group label { 
      display: block; 
      font-size: 14px; 
      font-weight: 500; 
      margin-bottom: 8px; 
      color: var(--text-secondary); 
    }
    .form-group input, .form-control {
      width: 100%;
      padding: 16px;
      background: var(--bg-card);
      border: 1px solid var(--border);
      border-radius: var(--radius-sm);
      font-size: 16px;
      color: var(--text-primary);
    }

    /* HEADER */
    .header {
      padding: 20px;
      display: flex;
      justify-content: space-between;
      align-items: center;
      background: var(--bg-card);
      border-bottom: 1px solid var(--border);
      box-shadow: var(--shadow);
    }
    .header-greeting { font-size: 14px; color: var(--text-muted); display: block; }
    .header-nome { font-size: 20px; font-weight: 600; }
    .btn-logout {
      padding: 10px 16px;
      background: var(--bg-body);
      border: 1px solid var(--border);
      border-radius: var(--radius-sm);
      font-size: 14px;
      cursor: pointer;
    }
    .btn-mudo {
      width: 40px;
      height: 40px;
      background: var(--bg-body);
      border: 1px solid var(--border);
      border-radius: var(--radius-sm);
      font-size: 18px;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
    }
    .btn-mudo:hover {
      background: var(--border);
    }
    .gps-indicator {
      font-size: 12px;
      color: var(--text-muted);
      padding: 6px 10px;
      background: var(--bg-body);
      border-radius: var(--radius-sm);
      border: 1px solid var(--border);
    }
    .btn-logout:hover { background: var(--danger); color: white; border-color: var(--danger); }

    /* BOT√ïES */
    .btn {
      padding: 14px 24px;
      border-radius: var(--radius-sm);
      font-size: 16px;
      font-weight: 600;
      cursor: pointer;
      border: none;
      transition: all 0.2s;
      display: inline-flex;
      align-items: center;
      justify-content: center;
      gap: 8px;
    }
    .btn-primary { background: var(--primary); color: white; }
    .btn-primary:hover { background: var(--primary-dark); }
    .btn-success { background: var(--success); color: white; }
    .btn-danger { background: var(--danger); color: white; }
    .btn-secondary { background: var(--bg-body); color: var(--text-primary); border: 1px solid var(--border); }
    .btn-block { width: 100%; }
    .btn-sm { padding: 10px 16px; font-size: 14px; }
    .btn-entrada { background: var(--success); color: white; }
    .btn-saida { background: var(--danger); color: white; }
    .btn-navegacao { background: #3b82f6; color: white; }

    /* STATUS TOGGLE */
    .status-section { padding: 20px; }
    .status-card {
      background: var(--bg-card);
      border-radius: var(--radius);
      padding: 24px;
      display: flex;
      justify-content: space-between;
      align-items: center;
      border: 1px solid var(--border);
      box-shadow: var(--shadow);
    }
    .status-label { font-size: 14px; color: var(--text-muted); display: block; }
    .status-value { font-size: 24px; font-weight: 700; }
    .status-value.online { color: var(--success); }
    .status-value.offline { color: var(--text-muted); }

    .toggle { position: relative; width: 60px; height: 32px; }
    .toggle input { opacity: 0; width: 0; height: 0; }
    .toggle-slider {
      position: absolute;
      cursor: pointer;
      top: 0; left: 0; right: 0; bottom: 0;
      background: var(--border);
      border-radius: 32px;
      transition: 0.3s;
    }
    .toggle-slider:before {
      position: absolute;
      content: "";
      height: 24px;
      width: 24px;
      left: 4px;
      bottom: 4px;
      background: white;
      border-radius: 50%;
      transition: 0.3s;
      box-shadow: var(--shadow);
    }
    .toggle input:checked + .toggle-slider { background: var(--success); }
    .toggle input:checked + .toggle-slider:before { transform: translateX(28px); }

    /* CONFIGURA√á√ïES */
    .config-section { padding: 0 20px 20px; }
    .config-card {
      background: var(--bg-card);
      border-radius: var(--radius-sm);
      padding: 16px;
      border: 1px solid var(--border);
      box-shadow: var(--shadow);
    }
    .config-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 12px;
      font-size: 14px;
      font-weight: 500;
    }
    .btn-config { background: none; border: none; font-size: 18px; cursor: pointer; }
    .select-modo {
      width: 100%;
      padding: 12px;
      border: 1px solid var(--border);
      border-radius: var(--radius-sm);
      background: var(--bg-body);
      font-size: 14px;
    }
    .input-endereco {
      width: 100%;
      padding: 12px;
      border: 1px solid var(--border);
      border-radius: var(--radius-sm);
      background: var(--bg-body);
      font-size: 14px;
      margin-top: 12px;
      margin-bottom: 8px;
    }
    .endereco-base-texto {
      font-size: 13px;
      color: var(--text-muted);
      margin-top: 8px;
      padding: 8px;
      background: var(--bg-body);
      border-radius: var(--radius-sm);
    }

    /* FILA */
    .fila-section { padding: 0 20px 20px; }
    .fila-card {
      background: linear-gradient(135deg, #f59e0b 0%, #d97706 100%);
      border-radius: var(--radius);
      padding: 20px;
      box-shadow: var(--shadow-lg);
      color: white;
      animation: pulse-fila 2s infinite;
    }
    @keyframes pulse-fila {
      0%, 100% { transform: scale(1); }
      50% { transform: scale(1.01); }
    }
    .fila-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 12px; }
    .fila-badge { background: rgba(255,255,255,0.2); padding: 4px 12px; border-radius: 20px; font-size: 12px; font-weight: 600; }
    .fila-distancia { font-size: 14px; font-weight: 600; }
    .fila-cliente { margin-bottom: 16px; }
    .fila-cliente-nome { font-size: 18px; font-weight: 600; }
    .fila-detalhes { margin-bottom: 16px; }
    .fila-local { display: flex; align-items: center; gap: 8px; padding: 8px 0; font-size: 14px; }
    .fila-acoes { display: flex; gap: 12px; }
    .fila-acoes .btn { flex: 1; }

    /* MAPA */
    .mapa-section { padding: 0 20px 20px; }
    .mapa-container {
      background: var(--bg-card);
      border-radius: var(--radius);
      overflow: hidden;
      border: 1px solid var(--border);
      box-shadow: var(--shadow-lg);
    }
    .mapa-header {
      padding: 16px;
      background: linear-gradient(135deg, #3b82f6 0%, #1d4ed8 100%);
      color: white;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
    .mapa-header-info h4 { font-size: 14px; font-weight: 600; margin-bottom: 4px; }
    .mapa-header-info span { font-size: 12px; opacity: 0.9; }
    .mapa-tempo {
      background: rgba(255,255,255,0.2);
      padding: 8px 16px;
      border-radius: 20px;
      font-size: 14px;
      font-weight: 600;
    }
    #mapa {
      width: 100%;
      height: 250px;
    }
    .mapa-endereco {
      padding: 16px;
      background: var(--bg-body);
      border-top: 1px solid var(--border);
    }
    .mapa-endereco-label {
      font-size: 12px;
      color: var(--text-muted);
      margin-bottom: 4px;
      display: flex;
      align-items: center;
      gap: 6px;
    }
    .mapa-endereco-texto {
      font-size: 14px;
      font-weight: 500;
      color: var(--text-primary);
    }
    .btn-abrir-navegacao {
      margin-top: 12px;
      width: 100%;
    }
    .btns-navegacao {
      display: flex;
      gap: 12px;
      margin-top: 12px;
    }
    .btn-waze {
      flex: 1;
      background: #33ccff;
      color: #000;
      font-weight: 600;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 8px;
    }
    .btn-maps {
      flex: 1;
      background: #4285f4;
      color: white;
      font-weight: 600;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 8px;
    }

    /* Se√ß√£o Rota at√© o cliente */
    .rota-section {
      padding: 16px;
      background: #f0f9ff;
      border-bottom: 1px solid var(--border);
    }
    .rota-info {
      margin-bottom: 12px;
    }
    .rota-label {
      display: block;
      font-size: 14px;
      font-weight: 600;
      color: var(--text-primary);
      margin-bottom: 4px;
    }
    .rota-distancia {
      font-size: 13px;
      color: var(--text-secondary);
    }
    .rota-botoes {
      display: flex;
      gap: 12px;
    }
    .btn-nav {
      flex: 1;
      padding: 12px 16px;
      border: none;
      border-radius: 10px;
      font-size: 15px;
      font-weight: 600;
      cursor: pointer;
    }
    .btn-waze {
      background: #33ccff;
      color: #000;
    }
    .btn-maps {
      background: #4285f4;
      color: white;
    }

    /* Bot√µes mini Waze/Maps no header */
    .header-direita {
      display: flex;
      align-items: center;
      gap: 12px;
    }
    .btns-nav-mini {
      display: flex;
      gap: 6px;
    }
    .btn-nav-mini {
      width: 36px;
      height: 36px;
      border-radius: 8px;
      border: none;
      font-weight: 700;
      font-size: 14px;
      cursor: pointer;
    }
    .btn-waze-mini {
      background: #33ccff;
      color: #000;
    }
    .btn-maps-mini {
      background: #4285f4;
      color: white;
    }

    /* CORRIDA */
    .corrida-section { padding: 0 20px 20px; }
    .corrida-card {
      background: var(--bg-card);
      border-radius: var(--radius);
      padding: 24px;
      border: 2px solid var(--primary);
      box-shadow: var(--shadow-lg);
      animation: pulse-corrida 2s infinite;
    }
    @keyframes pulse-corrida {
      0%, 100% { border-color: var(--primary); }
      50% { border-color: var(--primary-dark); }
    }
    .corrida-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 16px; }
    .corrida-badge { background: var(--primary); color: white; padding: 6px 12px; border-radius: 20px; font-size: 12px; font-weight: 600; }
    .corrida-badge.aceita { background: var(--success); }
    .corrida-badge.aguardando { background: var(--warning); }
    .corrida-badge.andamento { background: #7c3aed; }
    
    /* PRIORIDADE - Corrida reatribu√≠da por atraso */
    .corrida-badge.prioridade { 
      background: linear-gradient(135deg, #ef4444, #dc2626); 
      animation: pulse-prioridade 0.5s infinite;
    }
    @keyframes pulse-prioridade {
      0%, 100% { transform: scale(1); }
      50% { transform: scale(1.05); }
    }
    .corrida-card.prioridade {
      border: 3px solid #ef4444;
      background: linear-gradient(135deg, rgba(239, 68, 68, 0.1), rgba(220, 38, 38, 0.05));
      animation: pulse-urgente 1s infinite;
    }
    @keyframes pulse-urgente {
      0%, 100% { border-color: #ef4444; box-shadow: 0 0 0 0 rgba(239, 68, 68, 0.4); }
      50% { border-color: #dc2626; box-shadow: 0 0 20px 5px rgba(239, 68, 68, 0.3); }
    }
    .prioridade-alerta {
      background: linear-gradient(135deg, #fef2f2, #fee2e2);
      border: 1px solid #fca5a5;
      border-radius: 12px;
      padding: 12px 16px;
      margin-bottom: 16px;
      display: flex;
      align-items: center;
      gap: 10px;
    }
    .prioridade-alerta-icon { font-size: 24px; }
    .prioridade-alerta-texto { font-size: 13px; color: #991b1b; font-weight: 500; }
    
    /* Tempo da Corrida */
    .tempo-corrida {
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 8px;
      padding: 12px;
      background: #fef3c7;
      border-bottom: 1px solid var(--border);
    }
    .tempo-label {
      font-size: 14px;
      color: var(--text-secondary);
    }
    .tempo-valor {
      font-size: 20px;
      font-weight: 700;
      color: #d97706;
      font-family: monospace;
    }
    .corrida-valor { font-size: 18px; font-weight: 700; color: var(--success); }
    .corrida-cliente { margin-bottom: 20px; }
    .corrida-cliente-nome { font-size: 20px; font-weight: 600; }
    .corrida-local { display: flex; gap: 12px; padding: 12px 0; border-bottom: 1px solid var(--border); }
    .corrida-local:last-child { border-bottom: none; }
    .local-icon { font-size: 20px; width: 24px; }
    .local-label { font-size: 12px; color: var(--text-muted); display: block; }
    .local-endereco { font-size: 14px; }
    .corrida-acoes { display: flex; gap: 12px; margin-top: 24px; }
    .corrida-acoes .btn { flex: 1; }
    .finalizar-direto-container { margin-top: 16px; padding-top: 16px; border-top: 1px solid var(--border); }
    .checkbox-finalizar, .checkbox-label { display: flex; align-items: center; gap: 8px; font-size: 14px; cursor: pointer; }
    .checkbox-finalizar input, .checkbox-label input { width: 18px; height: 18px; }

    /* SEM CORRIDA */
    .sem-corrida { text-align: center; padding: 60px 20px; }
    .sem-corrida-icon { font-size: 64px; margin-bottom: 16px; opacity: 0.3; }
    .sem-corrida h2 { font-size: 20px; margin-bottom: 8px; }
    .sem-corrida p { color: var(--text-muted); }

    /* GANHOS */
    .ganhos-section { padding: 20px; }
    .ganhos-section h3 { font-size: 16px; margin-bottom: 16px; color: var(--text-secondary); }
    .saldo-card {
      background: linear-gradient(135deg, var(--primary) 0%, var(--primary-dark) 100%);
      border-radius: var(--radius);
      padding: 24px;
      text-align: center;
      margin-bottom: 16px;
      box-shadow: var(--shadow-lg);
    }
    .saldo-label { font-size: 14px; color: rgba(255,255,255,0.8); display: block; margin-bottom: 8px; }
    .saldo-valor { font-size: 36px; font-weight: 700; color: white; }
    .ganhos-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 16px; }
    .ganho-card { background: var(--bg-card); border-radius: var(--radius-sm); padding: 20px; text-align: center; border: 1px solid var(--border); }
    .ganho-label { font-size: 12px; color: var(--text-muted); display: block; margin-bottom: 8px; }
    .ganho-valor { font-size: 24px; font-weight: 700; display: block; }
    .ganho-valor.entrada { color: var(--success); }
    .ganho-corridas { font-size: 12px; color: var(--text-muted); margin-top: 4px; }

    /* PAGAMENTOS */
    .pagamentos-section { padding: 0 20px 20px; }
    .pagamentos-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 16px; }
    .pagamentos-header h3 { font-size: 16px; color: var(--text-secondary); }
    .pagamentos-btns { display: flex; gap: 8px; }
    .pagamentos-lista { background: var(--bg-card); border-radius: var(--radius-sm); border: 1px solid var(--border); overflow: hidden; }
    .pagamento-item { display: flex; justify-content: space-between; align-items: center; padding: 16px; border-bottom: 1px solid var(--border); }
    .pagamento-item:last-child { border-bottom: none; }
    .pagamento-info { flex: 1; }
    .pagamento-desc { font-size: 14px; font-weight: 500; }
    .pagamento-data { font-size: 12px; color: var(--text-muted); }
    .pagamento-valor { font-size: 16px; font-weight: 600; }
    .pagamento-valor.entrada { color: var(--success); }
    .pagamento-valor.saida { color: var(--danger); }

    /* HIST√ìRICO */
    .historico-section { padding: 0 20px 20px; }
    .historico-section h3 { font-size: 16px; margin-bottom: 16px; color: var(--text-secondary); }
    .historico-lista { background: var(--bg-card); border-radius: var(--radius-sm); border: 1px solid var(--border); overflow: hidden; }
    .historico-item { display: flex; justify-content: space-between; padding: 16px; border-bottom: 1px solid var(--border); }
    .historico-item:last-child { border-bottom: none; }
    .historico-destino { font-size: 14px; font-weight: 500; }
    .historico-data { font-size: 12px; color: var(--text-muted); }
    .historico-valor { font-size: 16px; font-weight: 600; color: var(--success); }

    /* CVS - Central de Atendimento */
    .cvs-section {
      background: #fef3c7;
      border-radius: var(--radius-sm);
      padding: 14px;
      margin: 16px 0;
      text-align: center;
    }
    .cvs-label {
      font-size: 13px;
      color: #92400e;
      margin-bottom: 10px;
    }
    .btn-cvs {
      width: 100%;
      padding: 12px;
      background: #f59e0b;
      color: white;
      border: none;
      border-radius: var(--radius-sm);
      font-size: 15px;
      font-weight: 600;
      cursor: pointer;
    }
    .btn-cvs:hover { background: #d97706; }
    .cvs-aviso {
      font-size: 11px;
      color: #b45309;
      margin-top: 8px;
    }
    .cvs-section.disabled {
      background: #f1f5f9;
      opacity: 0.6;
    }
    .cvs-section.disabled .btn-cvs {
      background: #94a3b8;
      cursor: not-allowed;
    }
    .cvs-section.disabled .cvs-label,
    .cvs-section.disabled .cvs-aviso {
      color: #64748b;
    }

    /* BOT√ïES FLUTUANTES - DOIS SEPARADOS */
    .fab-container {
      position: fixed;
      bottom: 24px;
      right: 24px;
      display: none;
      flex-direction: row;
      align-items: flex-end;
      gap: 12px;
      z-index: 100;
    }
    
    /* Bot√£o Chat Separado */
    .fab-chat-btn {
      width: 60px;
      height: 60px;
      border-radius: 50%;
      background: linear-gradient(135deg, #10b981, #059669);
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 26px;
      color: white;
      cursor: pointer;
      box-shadow: 0 4px 20px rgba(16, 185, 129, 0.5);
      transition: transform 0.2s;
      position: relative;
    }
    .fab-chat-btn:hover { transform: scale(1.1); }
    
    /* Bot√£o Menu */
    .fab-menu-btn {
      width: 56px;
      height: 56px;
      border-radius: 50%;
      background: linear-gradient(135deg, #6366f1, #4f46e5);
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 24px;
      color: white;
      cursor: pointer;
      box-shadow: 0 4px 15px rgba(99, 102, 241, 0.4);
      transition: transform 0.3s;
    }
    .fab-menu-btn:hover { transform: scale(1.1); }
    .fab-menu-btn.open { transform: rotate(45deg); }
    
    /* Submenu (escondido por padr√£o) */
    .fab-submenu {
      display: flex;
      flex-direction: column;
      align-items: flex-end;
      gap: 10px;
      max-height: 0;
      overflow: hidden;
      transition: max-height 0.3s ease, opacity 0.3s;
      opacity: 0;
    }
    .fab-submenu.open {
      max-height: 400px;
      opacity: 1;
    }
    
    /* Itens do submenu */
    .fab-item {
      display: flex;
      align-items: center;
      gap: 10px;
      cursor: pointer;
    }
    .fab-item-label {
      background: white;
      padding: 8px 14px;
      border-radius: 20px;
      font-size: 13px;
      font-weight: 500;
      color: #1e293b;
      box-shadow: 0 2px 10px rgba(0,0,0,0.1);
      white-space: nowrap;
    }
    .fab-item-icon {
      width: 44px;
      height: 44px;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 20px;
      color: white;
      box-shadow: 0 3px 10px rgba(0,0,0,0.2);
      transition: transform 0.2s;
      position: relative;
    }
    .fab-item:hover .fab-item-icon { transform: scale(1.1); }
    
    /* Cores dos itens */
    .fab-pwa { background: linear-gradient(135deg, #8b5cf6, #6366f1); }
    .fab-assistencia { background: linear-gradient(135deg, #ec4899, #f43f5e); }
    .fab-suporte { background: linear-gradient(135deg, #6366f1, #4f46e5); }
    
    /* Badge de notifica√ß√£o */
    .fab-badge {
      position: absolute;
      top: -4px;
      right: -4px;
      background: #ef4444;
      color: white;
      min-width: 20px;
      height: 20px;
      border-radius: 50%;
      font-size: 11px;
      font-weight: 600;
      display: flex;
      align-items: center;
      justify-content: center;
    }

    /* MODAL SUPORTE */
    .suporte-opcoes {
      display: flex;
      flex-direction: column;
      gap: 10px;
    }
    .suporte-opcao {
      display: flex;
      align-items: center;
      gap: 12px;
      padding: 14px 16px;
      background: var(--bg-body);
      border: 1px solid var(--border);
      border-radius: var(--radius-sm);
      cursor: pointer;
      transition: all 0.2s;
    }
    .suporte-opcao:hover {
      border-color: var(--primary);
      background: #f0f0ff;
    }
    .suporte-opcao.selected {
      border-color: var(--primary);
      background: #ede9fe;
    }
    .suporte-opcao-icon {
      font-size: 20px;
    }
    .suporte-opcao-text {
      font-size: 14px;
      font-weight: 500;
      color: var(--text-primary);
    }

    /* CHAT DA FROTA */
    /* Motoristas Online */
    .motoristas-online {
      padding: 12px 16px;
      background: var(--bg-body);
      border-bottom: 1px solid var(--border);
    }
    .motoristas-online-label {
      font-size: 12px;
      color: var(--text-muted);
      display: block;
      margin-bottom: 8px;
    }
    .motoristas-lista {
      display: flex;
      flex-wrap: wrap;
      gap: 8px;
    }
    .motorista-chip {
      padding: 6px 12px;
      background: #d1fae5;
      color: #065f46;
      border-radius: 20px;
      font-size: 12px;
      font-weight: 500;
      cursor: pointer;
      transition: all 0.2s;
    }
    .motorista-chip:hover {
      background: #10b981;
      color: white;
    }
    .motorista-chip.offline {
      background: #f1f5f9;
      color: #94a3b8;
      cursor: default;
    }

    /* Mensagens */
    .chat-mensagens {
      height: 250px;
      overflow-y: auto;
      padding: 12px 16px;
      display: flex;
      flex-direction: column;
      gap: 10px;
    }
    .chat-msg {
      max-width: 85%;
      padding: 10px 14px;
      border-radius: 12px;
      position: relative;
    }
    .chat-msg.recebida {
      background: var(--bg-body);
      align-self: flex-start;
      border-bottom-left-radius: 4px;
    }
    .chat-msg.enviada {
      background: var(--primary);
      color: white;
      align-self: flex-end;
      border-bottom-right-radius: 4px;
    }
    .chat-msg-nome {
      display: block;
      font-size: 11px;
      font-weight: 600;
      margin-bottom: 4px;
      color: var(--primary);
    }
    .chat-msg.enviada .chat-msg-nome {
      color: rgba(255,255,255,0.8);
    }
    .chat-msg-texto {
      font-size: 14px;
      display: block;
    }
    .chat-msg-hora {
      font-size: 10px;
      color: var(--text-muted);
      display: block;
      text-align: right;
      margin-top: 4px;
    }
    .chat-msg.enviada .chat-msg-hora {
      color: rgba(255,255,255,0.6);
    }

    /* Input */
    .chat-input-container {
      display: flex;
      gap: 10px;
      padding: 12px 16px;
      border-top: 1px solid var(--border);
      background: var(--bg-card);
    }
    .chat-input {
      flex: 1;
      padding: 12px 16px;
      border: 1px solid var(--border);
      border-radius: 24px;
      font-size: 14px;
      outline: none;
    }
    .chat-input:focus {
      border-color: var(--primary);
    }
    .chat-enviar {
      width: 44px;
      height: 44px;
      background: var(--primary);
      color: white;
      border: none;
      border-radius: 50%;
      font-size: 18px;
      cursor: pointer;
    }
    .chat-enviar:hover {
      background: var(--primary-dark);
    }

    /* MODAL */
    .modal { display: none; position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.5); z-index: 1000; align-items: center; justify-content: center; padding: 20px; }
    .modal.active { display: flex; }
    .modal-content { background: var(--bg-card); border-radius: var(--radius); width: 100%; max-width: 400px; max-height: 90vh; overflow-y: auto; }
    .modal-header { padding: 20px; border-bottom: 1px solid var(--border); display: flex; align-items: center; justify-content: space-between; }
    .modal-header h3 { font-size: 18px; font-weight: 600; }
    .modal-close { background: none; border: none; font-size: 24px; color: var(--text-muted); cursor: pointer; }
    .modal-body { padding: 20px; }
    .modal-body .form-group { margin-bottom: 16px; }
    .modal-actions { display: flex; gap: 12px; margin-top: 20px; }
    .modal-actions .btn { flex: 1; }

    /* TOAST */
    .toast { position: fixed; bottom: 20px; left: 50%; transform: translateX(-50%); padding: 16px 24px; border-radius: 12px; font-size: 14px; font-weight: 500; color: white; z-index: 2000; }
    .toast.success { background: var(--success); }
    .toast.error { background: var(--danger); }
    .toast.info { background: var(--primary); }
    /* EFEITO BLUR NA TRANSI√á√ÉO */
    .blur-transition {
      filter: blur(3px);
      transition: filter 0.3s ease-out;
    }
    .blur-transition-out {
      filter: blur(0);
      transition: filter 0.2s ease-in;
    }
  </style>
</head>
<body>
  <!-- TELA DE LOGIN -->
  <div id="tela-login">
    <div class="login-header">
      <span class="logo-icon">üöó</span>
      <h1 id="login-empresa-nome">UBMAX</h1>
      <p>Painel do Motorista</p>
    </div>
    
    <!-- Aviso sobre link de acesso -->
    <div style="background: #fef3c7; border: 1px solid #f59e0b; border-radius: var(--radius-sm); padding: 16px; margin-bottom: 24px;">
      <p style="font-size: 13px; color: #92400e;">
        <strong>üì± Primeiro acesso?</strong><br>
        Solicite o link de acesso ao administrador da sua frota.
      </p>
    </div>
    
    <p style="text-align: center; margin-bottom: 16px; font-weight: 500; color: var(--text-secondary);">Fa√ßa login:</p>
    
    <div class="form-group">
      <label>Telefone</label>
      <input type="tel" id="login-telefone" placeholder="Ex: 14999991234">
    </div>
    <div class="form-group">
      <label>Senha</label>
      <input type="password" id="login-senha" placeholder="Sua senha">
    </div>
    <button type="button" class="btn btn-primary btn-block" onclick="fazerLogin()">Entrar</button>
    <p style="text-align: center; margin-top: 24px; color: var(--text-muted); font-size: 13px;">Sistema exclusivo para motoristas cadastrados</p>
  </div>

  <!-- TELA PRINCIPAL -->
  <div id="tela-principal">
    <header class="header">
      <div><span class="header-greeting">Ol√°,</span><span class="header-nome" id="motorista-nome">Motorista</span></div>
      <div style="display: flex; gap: 10px; align-items: center;">
        <span id="gps-status" class="gps-indicator" onclick="ativarGPS()" style="cursor: pointer;" title="Clique para ativar GPS">üìç GPS <span id="gps-dot" style="color:#94a3b8;">‚óè</span></span>
        <button id="btn-mudo" class="btn-mudo" onclick="toggleMudo()" title="Som ativado">üîä</button>
        <button class="btn-logout" onclick="fazerLogout()">Sair</button>
      </div>
    </header>

    <!-- Card da Empresa - TOPO -->
    <div class="empresa-card-topo" style="background: linear-gradient(135deg, #1a1a1a, #2d2d2d); padding: 20px; color: white;">
      <div style="display: flex; align-items: center; gap: 16px; margin-bottom: 12px;">
        <div style="width: 56px; height: 56px; background: rgba(255,255,255,0.2); border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 26px;">üöó</div>
        <div>
          <h3 id="empresa-nome-topo" style="font-size: 22px; font-weight: 700; margin: 0;">UBMAX</h3>
          <p style="opacity: 0.9; font-size: 13px; margin: 2px 0 0 0;">Empresa de Transporte</p>
        </div>
      </div>
      <!-- Localiza√ß√£o em tempo real -->
      <div onclick="atualizarMinhaLocalizacao()" style="background: rgba(255,255,255,0.15); border-radius: 12px; padding: 14px; cursor: pointer;">
        <div style="display: flex; align-items: center; justify-content: space-between;">
          <div style="flex: 1;">
            <span style="opacity: 0.8; font-size: 11px; display: block;">üìç Sua Localiza√ß√£o Atual</span>
            <span id="minha-cidade" style="font-weight: 600; font-size: 16px;">Toque para obter</span>
            <div id="minha-coords" style="opacity: 0.7; font-size: 11px; margin-top: 4px;">Clique para ativar GPS</div>
          </div>
          <div style="background: rgba(255,255,255,0.2); padding: 10px 14px; border-radius: 20px; font-size: 13px; font-weight: 500;">
            üîÑ Atualizar
          </div>
        </div>
      </div>
    </div>

    <div class="status-section">
      <div class="status-card">
        <div><span class="status-label">Seu status</span><span class="status-value" id="status-texto">Offline</span></div>
        <label class="toggle"><input type="checkbox" id="toggle-status" onchange="alternarStatus()"><span class="toggle-slider"></span></label>
      </div>
    </div>

    <!-- ALERTA DE MENSALIDADE -->
    <div id="alerta-mensalidade" class="hidden" style="padding: 0 20px; margin-bottom: 16px;">
      <div id="card-mensalidade" style="border-radius: 16px; padding: 16px; display: flex; align-items: center; gap: 14px;">
        <div style="width: 48px; height: 48px; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 24px;" id="icon-mensalidade">üí∞</div>
        <div style="flex: 1;">
          <div style="font-weight: 600; font-size: 15px;" id="titulo-mensalidade">Mensalidade</div>
          <div style="font-size: 13px; opacity: 0.9;" id="texto-mensalidade">Sua mensalidade vence em breve</div>
        </div>
        <div style="text-align: right;">
          <div style="font-size: 18px; font-weight: 700;" id="valor-mensalidade">R$ 150</div>
          <div style="font-size: 12px; opacity: 0.8;" id="data-mensalidade">Dia 10</div>
        </div>
      </div>
    </div>

    <div class="config-section">
      <div class="config-card">
        <div class="config-header"><span>üìç Modo de Endere√ßo</span><button class="btn-config" onclick="abrirConfiguracoes()">‚öôÔ∏è</button></div>
        <select id="modo-endereco" class="select-modo" onchange="alternarModoEndereco()">
          <option value="automatico">üõ∞Ô∏è GPS Autom√°tico</option>
          <option value="manual">‚úçÔ∏è Digitar Endere√ßo</option>
          <option value="base">üè† Usar Endere√ßo Base</option>
        </select>
        <div id="endereco-manual-container" class="hidden">
          <input type="text" class="input-endereco" placeholder="Digite seu endere√ßo atual...">
          <button class="btn btn-sm btn-primary" onclick="mostrarToast('Endere√ßo definido!','success')">Confirmar</button>
        </div>
        <div id="endereco-base-info" class="hidden">
          <p class="endereco-base-texto">üìç Rua das Flores, 123 - Centro</p>
        </div>
      </div>
    </div>

    <!-- Pr√≥xima Corrida na Fila -->
    <div id="fila-section" class="fila-section hidden">
      <div class="fila-card">
        <div class="fila-header"><span class="fila-badge">üì• Pr√≥xima Corrida</span><span class="fila-distancia">2.3 km</span></div>
        <div class="fila-cliente"><span class="fila-cliente-nome">Ana Costa</span></div>
        <div class="fila-detalhes">
          <div class="fila-local"><span>üìç</span><span>Shopping Center - Entrada</span></div>
          <div class="fila-local"><span>üèÅ</span><span>Rua Principal, 789</span></div>
        </div>
        <div class="fila-acoes">
          <button class="btn btn-success" onclick="aceitarFila()">‚úì Aceitar</button>
          <button class="btn btn-danger" onclick="recusarFila()">‚úï Recusar</button>
        </div>
      </div>
    </div>

    <!-- Corrida Atual -->
    <div id="corrida-section" class="corrida-section hidden">
      <div class="corrida-card" id="corrida-card">
        <!-- Alerta de PRIORIDADE (escondido por padr√£o) -->
        <div class="prioridade-alerta hidden" id="prioridade-alerta">
          <span class="prioridade-alerta-icon">üö®</span>
          <span class="prioridade-alerta-texto">PRIORIDADE! O motorista anterior n√£o chegou a tempo. Este cliente est√° esperando!</span>
        </div>
        
        <div class="corrida-header">
          <span class="corrida-badge" id="corrida-badge">Nova Corrida</span>
          <span class="corrida-valor" id="corrida-valor">R$ 24,50</span>
        </div>
        
        <!-- TIMER 30 SEGUNDOS PARA ACEITAR -->
        <div id="timer-aceitar" class="hidden" style="background: linear-gradient(135deg, #fef3c7, #fde68a); border: 2px solid #f59e0b; border-radius: 12px; padding: 12px 16px; margin-bottom: 16px;">
          <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px;">
            <span style="font-weight: 700; color: #92400e; font-size: 14px;">‚è±Ô∏è Tempo para aceitar</span>
            <span id="timer-texto" style="font-weight: 800; color: #b45309; font-size: 20px;">30s</span>
          </div>
          <div style="background: rgba(0,0,0,0.1); border-radius: 6px; height: 8px; overflow: hidden;">
            <div id="timer-barra-progresso" style="height: 100%; width: 100%; background: #10b981; transition: width 1s linear, background 0.3s;"></div>
          </div>
        </div>
        
        <!-- Rota at√© o cliente - aparece ap√≥s aceitar -->
        <div class="rota-section hidden" id="rota-section">
          <div class="rota-info">
            <span class="rota-label" id="rota-label">üìç Rota at√© o cliente</span>
            <span class="rota-distancia" id="rota-distancia">2.3 km ‚Ä¢ ~5 min</span>
          </div>
          <div class="rota-botoes">
            <button class="btn-nav btn-waze" onclick="abrirWaze()">Waze</button>
            <button class="btn-nav btn-maps" onclick="abrirGoogleMaps()">Maps</button>
          </div>
        </div>
        <div class="corrida-cliente"><span class="corrida-cliente-nome" id="corrida-cliente">Maria Silva</span></div>
        
        <!-- Tempo da Corrida -->
        <div class="tempo-corrida hidden" id="tempo-corrida">
          <span class="tempo-label">‚è±Ô∏è Tempo</span>
          <span class="tempo-valor" id="tempo-valor">00:00</span>
        </div>
        <div class="corrida-detalhes">
          <div class="corrida-local"><span class="local-icon">üìç</span><div><span class="local-label">Origem</span><span class="local-endereco" id="corrida-origem">Rua das Flores, 123</span></div></div>
          <div class="corrida-local" id="corrida-referencia-container" style="display: none; margin-top: 8px;"><span class="local-icon">üìå</span><div><span class="local-label">Refer√™ncia</span><span class="local-endereco" id="corrida-referencia" style="color: #f59e0b; font-weight: 600;">-</span></div></div>
          <div class="corrida-local"><span class="local-icon">üèÅ</span><div><span class="local-label">Destino</span><span class="local-endereco" id="corrida-destino">Shopping Center</span></div></div>
        </div>
        
        <!-- CVS - Central de Atendimento -->
        <div class="cvs-section" id="cvs-section">
          <p class="cvs-label">Precisa falar com o cliente?</p>
          <button class="btn-cvs" id="btn-cvs" onclick="abrirCVS()">üìû Ligar via Central</button>
          <p class="cvs-aviso" id="cvs-aviso">‚ö†Ô∏è Dispon√≠vel at√© iniciar a corrida</p>
        </div>
        
        <div class="corrida-acoes" id="acoes-container"></div>
        <div id="opcao-finalizar-direto" class="finalizar-direto-container hidden">
          <label class="checkbox-finalizar"><input type="checkbox" id="check-finalizar-direto" onchange="toggleFinalizarDireto()"><span>Conhe√ßo a localidade - Finalizar direto</span></label>
        </div>
      </div>
    </div>

    <!-- Sem Corrida -->
    <div id="sem-corrida" class="sem-corrida">
      <div class="sem-corrida-icon">üöó</div>
      <h2 id="sem-corrida-titulo">Voc√™ est√° offline</h2>
      <p id="sem-corrida-texto">Fique online para receber corridas</p>
    </div>

    <!-- Minhas Corridas Hoje -->
    <div style="padding: 16px 20px;">
      <div class="card" style="background: var(--bg-card); border-radius: var(--radius); padding: 20px; margin-bottom: 16px; border: 1px solid var(--border);">
        <h4 style="font-size: 16px; font-weight: 600; margin-bottom: 16px; display: flex; align-items: center; gap: 8px;">üìä Hoje</h4>
        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 12px;">
          <div style="background: var(--bg-body); border-radius: var(--radius-sm); padding: 16px; text-align: center;">
            <div style="font-size: 28px; font-weight: 700; color: var(--primary);" id="total-corridas-hoje">8</div>
            <div style="font-size: 12px; color: var(--text-muted);">Corridas</div>
          </div>
          <div style="background: var(--bg-body); border-radius: var(--radius-sm); padding: 16px; text-align: center;">
            <div style="font-size: 28px; font-weight: 700; color: var(--success);" id="tempo-online-hoje">4h 32m</div>
            <div style="font-size: 12px; color: var(--text-muted);">Online</div>
          </div>
        </div>
      </div>

      <!-- Extrato - Entradas e Sa√≠das -->
      <div class="card" style="background: var(--bg-card); border-radius: var(--radius); padding: 20px; margin-bottom: 16px; border: 1px solid var(--border);">
        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 16px;">
          <h4 style="font-size: 16px; font-weight: 600; display: flex; align-items: center; gap: 8px;">üìã Extrato</h4>
        </div>
        
        <!-- Lista de movimenta√ß√µes -->
        <div id="lista-extrato" style="display: flex; flex-direction: column; gap: 10px;">
          <div style="display: flex; justify-content: space-between; align-items: center; padding: 12px; background: var(--bg-body); border-radius: var(--radius-sm);">
            <div>
              <div style="font-weight: 500; font-size: 14px;">Corrida #127</div>
              <div style="font-size: 12px; color: var(--text-muted);">Hoje, 14:32</div>
            </div>
            <span style="color: #16a34a; font-weight: 600;">+ R$ 24,50</span>
          </div>
          <div style="display: flex; justify-content: space-between; align-items: center; padding: 12px; background: var(--bg-body); border-radius: var(--radius-sm);">
            <div>
              <div style="font-weight: 500; font-size: 14px;">Gorjeta</div>
              <div style="font-size: 12px; color: var(--text-muted);">Hoje, 13:45</div>
            </div>
            <span style="color: #16a34a; font-weight: 600;">+ R$ 5,00</span>
          </div>
          <div style="display: flex; justify-content: space-between; align-items: center; padding: 12px; background: var(--bg-body); border-radius: var(--radius-sm);">
            <div>
              <div style="font-weight: 500; font-size: 14px;">Combust√≠vel</div>
              <div style="font-size: 12px; color: var(--text-muted);">Hoje, 10:00</div>
            </div>
            <span style="color: #dc2626; font-weight: 600;">- R$ 50,00</span>
          </div>
          <div style="display: flex; justify-content: space-between; align-items: center; padding: 12px; background: var(--bg-body); border-radius: var(--radius-sm);">
            <div>
              <div style="font-weight: 500; font-size: 14px;">Corrida #126</div>
              <div style="font-size: 12px; color: var(--text-muted);">Hoje, 09:15</div>
            </div>
            <span style="color: #16a34a; font-weight: 600;">+ R$ 18,00</span>
          </div>
        </div>
        
        <!-- Saldo do dia -->
        <div style="margin-top: 16px; padding: 14px; background: linear-gradient(135deg, #6366f1, #8b5cf6); border-radius: var(--radius-sm); color: white; display: flex; justify-content: space-between; align-items: center;">
          <span style="font-size: 14px; opacity: 0.9;">Saldo do Dia</span>
          <span style="font-size: 20px; font-weight: 700;">R$ -2,50</span>
        </div>
      </div>
      
      <!-- SE√á√ÉO MANUTEN√á√ÉO - S√ì HIST√ìRICO -->
      <div class="card" style="background: var(--bg-card); border-radius: var(--radius); padding: 20px; margin-bottom: 16px; border: 1px solid var(--border);">
        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 16px;">
          <h4 style="font-size: 16px; font-weight: 600; display: flex; align-items: center; gap: 8px;">üîß Manuten√ß√£o & Ve√≠culo</h4>
          <button onclick="abrirSuporte()" style="background: linear-gradient(135deg, #6366f1, #8b5cf6); color: white; border: none; padding: 8px 14px; border-radius: 20px; font-size: 12px; font-weight: 600; cursor: pointer;">üõ†Ô∏è Central</button>
        </div>
        
        <!-- Status do Ve√≠culo -->
        <div id="status-veiculo-card" style="background: linear-gradient(135deg, #dcfce7, #bbf7d0); border: 2px solid #10b981; border-radius: 12px; padding: 14px; margin-bottom: 16px; display: flex; align-items: center; gap: 12px;">
          <div style="width: 44px; height: 44px; background: #10b981; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 22px;">‚úÖ</div>
          <div>
            <div style="font-weight: 600; color: #166534;">Ve√≠culo OK</div>
            <div style="font-size: 13px; color: #15803d;">Pronto para trabalhar</div>
          </div>
        </div>
        
        <!-- Hist√≥rico de Manuten√ß√µes -->
        <div>
          <div style="font-size: 14px; font-weight: 600; color: var(--text-secondary); margin-bottom: 10px;">üìã √öltimos Registros</div>
          <div id="historico-manutencoes" style="display: flex; flex-direction: column; gap: 8px;">
            <div style="text-align: center; color: var(--text-muted); padding: 20px;">Nenhum registro ainda</div>
          </div>
        </div>
      </div>
    </div>

    <!-- BOT√ïES ENTRADA / SA√çDA DE CAIXA -->
    <div style="padding: 16px 20px;">
      <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 12px;">
        <!-- Bot√£o Entrada -->
        <button onclick="abrirModalPagamento('entrada')" style="display: flex; align-items: center; justify-content: center; gap: 10px; padding: 18px 16px; background: linear-gradient(135deg, #dcfce7, #bbf7d0); border: 2px solid #22c55e; border-radius: 16px; cursor: pointer; font-size: 16px; font-weight: 700; color: #166534;">
          <span style="font-size: 22px;">üì•</span>
          <span>+ Entrada</span>
        </button>
        
        <!-- Bot√£o Sa√≠da -->
        <button onclick="abrirModalPagamento('saida')" style="display: flex; align-items: center; justify-content: center; gap: 10px; padding: 18px 16px; background: linear-gradient(135deg, #fef2f2, #fecaca); border: 2px solid #f87171; border-radius: 16px; cursor: pointer; font-size: 16px; font-weight: 700; color: #991b1b;">
          <span style="font-size: 22px;">üì§</span>
          <span>- Sa√≠da</span>
        </button>
      </div>
    </div>

    <!-- Hist√≥rico -->
    <div class="historico-section">
      <h3>üöó √öltimas Corridas</h3>
      <div class="historico-lista">
        <div class="historico-item"><div><div class="historico-destino">Shopping Center</div><div class="historico-data">Hoje, 14:32</div></div><span class="historico-valor">‚úÖ Finalizada</span></div>
        <div class="historico-item"><div><div class="historico-destino">Av. Brasil, 456</div><div class="historico-data">Hoje, 12:15</div></div><span class="historico-valor">‚úÖ Finalizada</span></div>
      </div>
    </div>
  </div>

  <!-- BOT√ïES FLUTUANTES - DOIS SEPARADOS -->
  <div class="fab-container" id="fab-container">
    <!-- MENU EXPANS√çVEL -->
    <div class="fab-group" style="display: flex; flex-direction: column; align-items: flex-end; gap: 10px;">
      <!-- Submenu -->
      <div class="fab-submenu" id="fab-submenu">
        <!-- PWA - Instalar App -->
        <div class="fab-item" onclick="instalarPWA()" id="fab-pwa-item">
          <span class="fab-item-label">Instalar App</span>
          <div class="fab-item-icon fab-pwa">üì≤</div>
        </div>
        
        <!-- Registrar Avaria -->
        <div class="fab-item" onclick="abrirRegistroAvaria()">
          <span class="fab-item-label">Registrar Avaria</span>
          <div class="fab-item-icon" style="background: linear-gradient(135deg, #f97316, #ef4444);">‚ö†Ô∏è</div>
        </div>
        
        <!-- Assist√™ncia -->
        <div class="fab-item" onclick="abrirAssistencia()">
          <span class="fab-item-label">Assist√™ncia</span>
          <div class="fab-item-icon fab-assistencia">üõü</div>
        </div>
        
        <!-- Suporte / Central de Ajuda (tem Manuten√ß√£o, Avaria, Entrada, Sa√≠da) -->
        <div class="fab-item" onclick="abrirSuporte()">
          <span class="fab-item-label">Central de Ajuda</span>
          <div class="fab-item-icon fab-suporte">üõ†Ô∏è</div>
        </div>
      </div>
      
      <!-- Bot√£o Menu -->
      <div class="fab-menu-btn" id="fab-menu-btn" onclick="toggleFabMenu()">‚ûï</div>
    </div>
    
    <!-- BOT√ÉO CHAT SEPARADO -->
    <div class="fab-chat-btn" onclick="abrirChatFrota()">
      üë•
      <span class="fab-badge" id="chat-badge">3</span>
    </div>
  </div>

  <!-- MODAL ASSIST√äNCIA (CARREGA DO BANCO) -->
  <div class="modal" id="modal-assistencia">
    <div class="modal-content" style="border-radius: 24px; overflow: hidden; max-height: 85vh;">
      <div class="modal-header" style="background: white; border: none; padding: 24px 24px 16px;">
        <h3 style="display: flex; align-items: center; gap: 10px; font-size: 20px;">üõü Assist√™ncia 24h</h3>
        <button class="modal-close" onclick="fecharAssistencia()" style="font-size: 28px;">√ó</button>
      </div>
      <div class="modal-body" style="padding: 0 24px 24px; overflow-y: auto; max-height: 65vh;">
        <div id="assistencia-lista">
          <div style="text-align: center; padding: 20px; color: #64748b;">
            <div class="spinner" style="margin: 0 auto 10px;"></div>
            Carregando contatos...
          </div>
        </div>
        
        <!-- SOS -->
        <button onclick="abrirSuporteRapido(); fecharAssistencia();" style="display: flex; align-items: center; gap: 16px; padding: 16px; background: #fef3c7; border-radius: 16px; text-decoration: none; color: var(--text-primary); border: none; width: 100%; cursor: pointer; text-align: left; margin-top: 12px;">
          <div style="width: 52px; height: 52px; background: #fde047; border-radius: 50%; display: flex; align-items: center; justify-content: center;">
            <span style="font-size: 20px; background: #f43f5e; color: white; padding: 6px 10px; border-radius: 8px; font-weight: 700;">SOS</span>
          </div>
          <div>
            <div style="font-weight: 600; font-size: 16px; color: #1e293b;">Solicitar Ajuda Urgente</div>
            <div style="color: #64748b; font-size: 14px;">Envia direto para o ADM</div>
          </div>
        </button>
      </div>
    </div>
  </div>

  <!-- MODAL REGISTRO DE AVARIA -->
  <div class="modal" id="modal-registro-avaria">
    <div class="modal-content" style="border-radius: 24px; overflow: hidden; max-height: 90vh;">
      <div class="modal-header" style="background: linear-gradient(135deg, #f97316, #ef4444); padding: 24px;">
        <h3 style="display: flex; align-items: center; gap: 10px; font-size: 20px; color: white;">‚ö†Ô∏è Registrar Avaria</h3>
        <button class="modal-close" onclick="fecharRegistroAvaria()" style="font-size: 28px; color: white;">√ó</button>
      </div>
      <div class="modal-body" style="padding: 24px; overflow-y: auto; max-height: 70vh;">
        <form id="form-avaria" onsubmit="enviarAvaria(event)">
          <!-- Tipo de Avaria -->
          <div style="margin-bottom: 16px;">
            <label style="display: block; font-weight: 600; margin-bottom: 8px; color: #374151;">Tipo de Ocorr√™ncia *</label>
            <select id="avaria-tipo" required style="width: 100%; padding: 14px; border: 2px solid #e5e7eb; border-radius: 12px; font-size: 16px; background: white;">
              <option value="">Selecione...</option>
              <option value="colisao">üöó Colis√£o / Batida</option>
              <option value="furto">üîì Furto / Roubo</option>
              <option value="vandalismo">üí• Vandalismo</option>
              <option value="mecanico">üîß Problema Mec√¢nico</option>
              <option value="pneu">üõû Pneu Furado</option>
              <option value="outros">üìã Outros</option>
            </select>
          </div>
          
          <!-- Descri√ß√£o -->
          <div style="margin-bottom: 16px;">
            <label style="display: block; font-weight: 600; margin-bottom: 8px; color: #374151;">Descri√ß√£o *</label>
            <textarea id="avaria-descricao" required rows="3" placeholder="Descreva o que aconteceu..." style="width: 100%; padding: 14px; border: 2px solid #e5e7eb; border-radius: 12px; font-size: 16px; resize: none;"></textarea>
          </div>
          
          <!-- Data e Local -->
          <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 12px; margin-bottom: 16px;">
            <div>
              <label style="display: block; font-weight: 600; margin-bottom: 8px; color: #374151;">Data</label>
              <input type="datetime-local" id="avaria-data" style="width: 100%; padding: 12px; border: 2px solid #e5e7eb; border-radius: 12px; font-size: 14px;">
            </div>
            <div>
              <label style="display: block; font-weight: 600; margin-bottom: 8px; color: #374151;">Local</label>
              <button type="button" onclick="capturarLocalizacaoAvaria()" style="width: 100%; padding: 12px; border: 2px solid #e5e7eb; border-radius: 12px; font-size: 14px; background: #f0f9ff; cursor: pointer;">
                üìç Usar GPS
              </button>
            </div>
          </div>
          <input type="hidden" id="avaria-lat">
          <input type="hidden" id="avaria-lng">
          <div id="avaria-endereco" style="font-size: 13px; color: #64748b; margin-bottom: 16px;"></div>
          
          <!-- Dados dos Envolvidos -->
          <div style="background: #f8fafc; padding: 16px; border-radius: 12px; margin-bottom: 16px;">
            <h4 style="font-size: 14px; font-weight: 600; color: #374151; margin-bottom: 12px;">üë• Dados dos Envolvidos (se houver)</h4>
            <div style="margin-bottom: 12px;">
              <input type="text" id="avaria-envolvido-nome" placeholder="Nome do envolvido" style="width: 100%; padding: 12px; border: 2px solid #e5e7eb; border-radius: 10px; font-size: 14px;">
            </div>
            <div style="margin-bottom: 12px;">
              <input type="tel" id="avaria-envolvido-telefone" placeholder="Telefone" style="width: 100%; padding: 12px; border: 2px solid #e5e7eb; border-radius: 10px; font-size: 14px;">
            </div>
            <div style="margin-bottom: 12px;">
              <input type="text" id="avaria-envolvido-placa" placeholder="Placa do ve√≠culo" style="width: 100%; padding: 12px; border: 2px solid #e5e7eb; border-radius: 10px; font-size: 14px;">
            </div>
            <div>
              <input type="text" id="avaria-envolvido-seguro" placeholder="Seguradora (se souber)" style="width: 100%; padding: 12px; border: 2px solid #e5e7eb; border-radius: 10px; font-size: 14px;">
            </div>
          </div>
          
          <!-- Fotos -->
          <div style="margin-bottom: 20px;">
            <label style="display: block; font-weight: 600; margin-bottom: 8px; color: #374151;">üì∑ Fotos</label>
            <div style="display: flex; gap: 10px; flex-wrap: wrap;" id="avaria-fotos-preview"></div>
            <input type="file" id="avaria-fotos" accept="image/*" multiple capture="environment" style="display: none;" onchange="previewFotosAvaria(this)">
            <button type="button" onclick="document.getElementById('avaria-fotos').click()" style="width: 100%; padding: 14px; background: #f3f4f6; border: 2px dashed #d1d5db; border-radius: 12px; font-size: 14px; cursor: pointer; margin-top: 10px;">
              üì∏ Tirar Foto / Escolher da Galeria
            </button>
          </div>
          
          <!-- Bot√£o Enviar -->
          <button type="submit" style="width: 100%; padding: 16px; background: linear-gradient(135deg, #f97316, #ef4444); color: white; border: none; border-radius: 12px; font-size: 16px; font-weight: 600; cursor: pointer;">
            üì§ Registrar Avaria
          </button>
        </form>
      </div>
    </div>
  </div>

  <!-- MODAL CHAT FROTA -->
  <div class="modal" id="modal-chat-frota">
    <div class="modal-content" style="border-radius: 24px; overflow: hidden; height: 85vh; display: flex; flex-direction: column;">
      <div class="modal-header" style="background: linear-gradient(135deg, #6366f1, #4f46e5); padding: 20px 24px;">
        <h3 style="display: flex; align-items: center; gap: 10px; font-size: 18px; color: white;">üí¨ Chat com a Frota</h3>
        <button class="modal-close" onclick="fecharChatFrota()" style="font-size: 28px; color: white;">√ó</button>
      </div>
      <div class="modal-body" style="flex: 1; padding: 0; display: flex; flex-direction: column; overflow: hidden;">
        <div id="chat-mensagens" style="flex: 1; overflow-y: auto; padding: 16px; background: #f8fafc;">
          <div style="text-align: center; color: #64748b; padding: 20px;">
            Carregando mensagens...
          </div>
        </div>
        <div style="padding: 16px; background: white; border-top: 1px solid #e5e7eb;">
          <div style="display: flex; gap: 10px;">
            <input type="text" id="chat-input" placeholder="Digite sua mensagem..." style="flex: 1; padding: 14px; border: 2px solid #e5e7eb; border-radius: 12px; font-size: 14px;" onkeypress="if(event.key==='Enter')enviarMensagemChat()">
            <button onclick="enviarMensagemChat()" style="padding: 14px 20px; background: linear-gradient(135deg, #6366f1, #4f46e5); color: white; border: none; border-radius: 12px; font-weight: 600; cursor: pointer;">
              üì§
            </button>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- MODAL PAGAMENTO -->
  <div class="modal" id="modal-pagamento">
    <div class="modal-content">
      <div class="modal-header"><h3 id="modal-pagamento-titulo">Registrar</h3><button class="modal-close" onclick="fecharModalPagamento()">√ó</button></div>
      <div class="modal-body">
        <input type="hidden" id="pagamento-tipo">
        <div class="form-group"><label>Valor (R$)</label><input type="number" id="pagamento-valor" step="0.01" placeholder="0,00"></div>
        <div class="form-group"><label>Descri√ß√£o</label><input type="text" id="pagamento-descricao" placeholder="Ex: Gorjeta"></div>
        <div class="modal-actions"><button class="btn btn-secondary" onclick="fecharModalPagamento()">Cancelar</button><button class="btn btn-primary" onclick="salvarPagamento()">Salvar</button></div>
      </div>
    </div>
  </div>

  <!-- MODAL CONFIGURA√á√ïES -->
  <div class="modal" id="modal-configuracoes">
    <div class="modal-content">
      <div class="modal-header"><h3>‚öôÔ∏è Configura√ß√µes</h3><button class="modal-close" onclick="fecharModalConfiguracoes()">√ó</button></div>
      <div class="modal-body">
        <div class="form-group"><label>Modo de Endere√ßo</label><select id="config-modo-endereco" class="form-control"><option value="automatico">üõ∞Ô∏è GPS Autom√°tico</option><option value="manual">‚úçÔ∏è Digitar</option><option value="base">üè† Endere√ßo Base</option></select></div>
        <div class="form-group"><label>Endere√ßo Base</label><input type="text" id="config-endereco-base" class="form-control" value="Rua das Flores, 123"></div>
        <div class="form-group"><label>Raio M√°ximo (km)</label><input type="number" id="config-raio-maximo" class="form-control" value="10"></div>
        <div class="form-group"><label class="checkbox-label"><input type="checkbox" id="config-aceitar-auto"><span>Aceitar fila automaticamente</span></label></div>
        <div class="modal-actions"><button class="btn btn-secondary" onclick="fecharModalConfiguracoes()">Cancelar</button><button class="btn btn-primary" onclick="salvarConfiguracoesModal()">Salvar</button></div>
      </div>
    </div>
  </div>

  <!-- MODAL CVS -->
  <div class="modal" id="modal-cvs">
    <div class="modal-content">
      <div class="modal-header"><h3>üìû Central de Atendimento</h3><button class="modal-close" onclick="fecharCVS()">√ó</button></div>
      <div class="modal-body" style="text-align: center;">
        <p style="color: var(--text-muted); margin-bottom: 20px;">A central vai conectar voc√™ com o cliente.<br>Seu n√∫mero n√£o ser√° exposto.</p>
        <div style="background: var(--bg-body); border-radius: var(--radius-sm); padding: 16px; margin-bottom: 20px;">
          <div style="display: flex; align-items: center; gap: 10px; margin-bottom: 10px;">
            <span>üë§</span>
            <span id="cvs-cliente-nome">Cliente: Maria S.</span>
          </div>
          <div style="display: flex; align-items: center; gap: 10px;">
            <span>üìç</span>
            <span id="cvs-cliente-endereco">Av Rio de Janeiro, 2981</span>
          </div>
        </div>
        <button class="btn btn-success" onclick="ligarCVS()" style="width: 100%;">üìû Ligar Agora</button>
        <p style="color: var(--text-muted); font-size: 11px; margin-top: 12px;">Liga√ß√£o via central ‚Ä¢ Privacidade garantida</p>
      </div>
    </div>
  </div>

  <!-- MODAL SUPORTE -->
  <div class="modal" id="modal-suporte">
    <div class="modal-content" style="max-width: 420px;">
      <div class="modal-header" style="background: linear-gradient(135deg, #6366f1, #8b5cf6); color: white;">
        <h3>üõ†Ô∏è Central de Ajuda</h3>
        <button class="modal-close" onclick="fecharSuporte()" style="color: white;">√ó</button>
      </div>
      <div class="modal-body" style="padding: 16px;">
        
        <!-- OP√á√ïES PRINCIPAIS -->
        <div style="display: flex; flex-direction: column; gap: 12px;">
          
          <!-- Entrada Financeira -->
          <button type="button" onclick="fecharSuporte(); setTimeout(function(){abrirModalPagamento('entrada')}, 200);" style="display: flex; align-items: center; gap: 14px; padding: 16px; background: linear-gradient(135deg, #dcfce7, #bbf7d0); border: 2px solid #22c55e; border-radius: 14px; cursor: pointer; text-align: left;">
            <div style="width: 50px; height: 50px; background: #22c55e; border-radius: 12px; display: flex; align-items: center; justify-content: center; font-size: 24px;">üí∞</div>
            <div>
              <div style="font-weight: 700; color: #166534; font-size: 15px;">+ Entrada</div>
              <div style="font-size: 13px; color: #15803d;">Registrar recebimento</div>
            </div>
          </button>
          
          <!-- Sa√≠da Financeira -->
          <button type="button" onclick="fecharSuporte(); setTimeout(function(){abrirModalPagamento('saida')}, 200);" style="display: flex; align-items: center; gap: 14px; padding: 16px; background: linear-gradient(135deg, #fef2f2, #fecaca); border: 2px solid #f87171; border-radius: 14px; cursor: pointer; text-align: left;">
            <div style="width: 50px; height: 50px; background: #f87171; border-radius: 12px; display: flex; align-items: center; justify-content: center; font-size: 24px;">üì§</div>
            <div>
              <div style="font-weight: 700; color: #991b1b; font-size: 15px;">- Sa√≠da</div>
              <div style="font-size: 13px; color: #b91c1c;">Registrar despesa</div>
            </div>
          </button>
          
          <!-- Falar com Suporte -->
          <button type="button" onclick="mostrarFormSuporte()" style="display: flex; align-items: center; gap: 14px; padding: 16px; background: linear-gradient(135deg, #e0e7ff, #c7d2fe); border: 2px solid #6366f1; border-radius: 14px; cursor: pointer; text-align: left;">
            <div style="width: 50px; height: 50px; background: #6366f1; border-radius: 12px; display: flex; align-items: center; justify-content: center; font-size: 24px;">üí¨</div>
            <div>
              <div style="font-weight: 700; color: #3730a3; font-size: 15px;">Falar com Suporte</div>
              <div style="font-size: 13px; color: #4f46e5;">Enviar mensagem para ADM</div>
            </div>
          </button>
          
        </div>
        
        <!-- FORMUL√ÅRIO DE SUPORTE (escondido) -->
        <div id="form-suporte-container" style="display: none; margin-top: 16px;">
          <div style="border-top: 1px solid var(--border); padding-top: 16px;">
            <div style="display: flex; align-items: center; gap: 8px; margin-bottom: 12px;">
              <button onclick="voltarOpcoesSuporte()" style="background: none; border: none; font-size: 20px; cursor: pointer;">‚Üê</button>
              <span style="font-weight: 600;">Enviar mensagem para <span id="suporte-empresa-nome">Suporte</span></span>
            </div>
            <textarea id="suporte-mensagem" class="form-control" rows="4" placeholder="Descreva seu problema..." style="resize: none; width: 100%; padding: 12px; border-radius: 10px; border: 1px solid var(--border);"></textarea>
            <button class="btn" onclick="enviarSuporte()" style="width: 100%; margin-top: 12px; background: linear-gradient(135deg, #6366f1, #4f46e5); color: white; padding: 14px; border-radius: 10px; font-weight: 600;">üì§ Enviar Mensagem</button>
          </div>
        </div>
        
      </div>
    </div>
  </div>

  <!-- MODAL CHAT PRIVADO -->
  <div class="modal" id="modal-chat-privado">
    <div class="modal-content" style="height: 500px; display: flex; flex-direction: column;">
      <div class="modal-header" style="background: linear-gradient(135deg, #6366f1, #8b5cf6); color: white;">
        <h3 id="chat-privado-nome">üí¨ Carlos S.</h3>
        <button class="modal-close" onclick="fecharChatPrivado()" style="color: white;">√ó</button>
      </div>
      <div class="chat-mensagens" id="chat-privado-mensagens" style="flex: 1; height: auto;">
        <div class="chat-msg recebida">
          <span class="chat-msg-nome">Carlos S.</span>
          <span class="chat-msg-texto">E a√≠, tudo certo?</span>
          <span class="chat-msg-hora">14:20</span>
        </div>
        <div class="chat-msg enviada">
          <span class="chat-msg-nome">Voc√™</span>
          <span class="chat-msg-texto">Tudo bem! E voc√™?</span>
          <span class="chat-msg-hora">14:21</span>
        </div>
      </div>
      <div class="chat-input-container">
        <input type="text" id="chat-privado-input" class="chat-input" placeholder="Mensagem...">
        <button class="chat-enviar" onclick="enviarMsgPrivada()">‚û§</button>
      </div>
    </div>
  </div>

  <!-- MODAL CHAT DA FROTA -->
  <div class="modal" id="modal-chat-frota">
    <div class="modal-content" style="height: 80vh; max-height: 600px; display: flex; flex-direction: column;">
      <div class="modal-header" style="background: linear-gradient(135deg, #10b981, #059669); color: white;">
        <h3>üë• Chat da Frota</h3>
        <button class="modal-close" onclick="fecharChatFrota()" style="color: white;">√ó</button>
      </div>
      
      <!-- Lista de Motoristas Online -->
      <div class="motoristas-online">
        <span class="motoristas-online-label">üü¢ Online agora:</span>
        <div class="motoristas-lista">
          <div class="motorista-chip" onclick="abrirChatPrivado('Carlos')">Carlos S.</div>
          <div class="motorista-chip" onclick="abrirChatPrivado('Maria')">Maria P.</div>
          <div class="motorista-chip" onclick="abrirChatPrivado('Pedro')">Pedro L.</div>
          <div class="motorista-chip offline">Roberto M.</div>
        </div>
      </div>
      
      <!-- Mensagens do Grupo -->
      <div class="chat-mensagens" id="chat-mensagens" style="flex: 1;">
        <div class="chat-msg recebida">
          <span class="chat-msg-nome">Carlos S.</span>
          <span class="chat-msg-texto">Algu√©m na regi√£o do centro?</span>
          <span class="chat-msg-hora">14:25</span>
        </div>
        <div class="chat-msg recebida">
          <span class="chat-msg-nome">Maria P.</span>
          <span class="chat-msg-texto">To aqui perto do shopping</span>
          <span class="chat-msg-hora">14:26</span>
        </div>
        <div class="chat-msg enviada">
          <span class="chat-msg-nome">Voc√™</span>
          <span class="chat-msg-texto">To indo pro centro agora</span>
          <span class="chat-msg-hora">14:28</span>
        </div>
        <div class="chat-msg recebida">
          <span class="chat-msg-nome">Pedro L.</span>
          <span class="chat-msg-texto">Cuidado na Av. Brasil, tr√¢nsito parado</span>
          <span class="chat-msg-hora">14:30</span>
        </div>
      </div>
      
      <!-- Input de Mensagem -->
      <div class="chat-input-container">
        <input type="text" id="chat-input" class="chat-input" placeholder="Mensagem para a frota...">
        <button class="chat-enviar" onclick="enviarMsgFrota()">‚û§</button>
      </div>
    </div>
  </div>

  <!-- MODAL MANUTEN√á√ÉO -->
  <div class="modal" id="modal-manutencao">
    <div class="modal-content" style="max-width: 400px;">
      <div class="modal-header" style="background: linear-gradient(135deg, #f59e0b, #d97706); color: white;">
        <h3>üîß Programar Manuten√ß√£o</h3>
        <button class="modal-close" onclick="fecharModalManutencao()" style="color: white;">√ó</button>
      </div>
      <div class="modal-body">
        <div style="background: #fef3c7; border-radius: var(--radius-sm); padding: 12px; margin-bottom: 16px;">
          <p style="color: #92400e; font-size: 13px; margin: 0;">‚ö†Ô∏è Ao registrar manuten√ß√£o, seu status ficar√° <strong>OFFLINE</strong> e voc√™ n√£o receber√° corridas.</p>
        </div>
        
        <div class="form-group">
          <label style="font-weight: 600;">Tipo de Manuten√ß√£o *</label>
          <select id="manut-tipo" class="form-control" style="width: 100%; padding: 12px; border-radius: 8px; border: 1px solid var(--border); margin-top: 6px;">
            <option value="">Selecione...</option>
            <option value="troca_oleo">üõ¢Ô∏è Troca de √ìleo</option>
            <option value="revisao">üîç Revis√£o Completa</option>
            <option value="freios">üõë Revis√£o de Freios</option>
            <option value="pneus">üõû Troca/Rod√≠zio de Pneus</option>
            <option value="suspensao">üîß Suspens√£o</option>
            <option value="eletrica">‚ö° Parte El√©trica</option>
            <option value="ar_condicionado">‚ùÑÔ∏è Ar Condicionado</option>
            <option value="alinhamento">‚ÜîÔ∏è Alinhamento/Balanceamento</option>
            <option value="embreagem">‚öôÔ∏è Embreagem</option>
            <option value="motor">üöó Motor</option>
            <option value="funilaria">üî® Funilaria/Pintura</option>
            <option value="outros">üìù Outros</option>
          </select>
        </div>
        
        <div class="form-group" style="margin-top: 14px;">
          <label style="font-weight: 600;">Empresa/Oficina *</label>
          <input type="text" id="manut-empresa" class="form-control" placeholder="Ex: Auto Center Silva" style="width: 100%; padding: 12px; border-radius: 8px; border: 1px solid var(--border); margin-top: 6px;">
        </div>
        
        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 12px; margin-top: 14px;">
          <div class="form-group">
            <label style="font-weight: 600;">Valor (R$)</label>
            <input type="number" id="manut-valor" class="form-control" placeholder="0.00" step="0.01" style="width: 100%; padding: 12px; border-radius: 8px; border: 1px solid var(--border); margin-top: 6px;">
          </div>
          <div class="form-group">
            <label style="font-weight: 600;">Dias de Manuten√ß√£o</label>
            <select id="manut-dias" class="form-control" style="width: 100%; padding: 12px; border-radius: 8px; border: 1px solid var(--border); margin-top: 6px;">
              <option value="1">1 dia</option>
              <option value="2">2 dias</option>
              <option value="3">3 dias</option>
              <option value="5">5 dias</option>
              <option value="7">1 semana</option>
              <option value="14">2 semanas</option>
            </select>
          </div>
        </div>
        
        <div class="form-group" style="margin-top: 14px;">
          <label style="font-weight: 600;">Data Programada *</label>
          <input type="date" id="manut-data" class="form-control" style="width: 100%; padding: 12px; border-radius: 8px; border: 1px solid var(--border); margin-top: 6px;">
        </div>
        
        <div class="form-group" style="margin-top: 14px;">
          <label style="font-weight: 600;">Descri√ß√£o/Observa√ß√µes</label>
          <textarea id="manut-descricao" class="form-control" rows="2" placeholder="Detalhes adicionais..." style="width: 100%; padding: 12px; border-radius: 8px; border: 1px solid var(--border); margin-top: 6px; resize: none;"></textarea>
        </div>
        
        <div class="form-group" style="margin-top: 14px;">
          <label style="display: flex; align-items: center; gap: 10px; cursor: pointer;">
            <input type="checkbox" id="manut-iniciar-agora">
            <span style="font-size: 14px;">üîß Iniciar manuten√ß√£o AGORA (ficar offline)</span>
          </label>
        </div>
        
        <div style="display: flex; gap: 12px; margin-top: 20px;">
          <button class="btn" style="flex: 1; background: var(--border); color: var(--text-primary);" onclick="fecharModalManutencao()">Cancelar</button>
          <button class="btn" style="flex: 1; background: linear-gradient(135deg, #f59e0b, #d97706); color: white;" onclick="salvarManutencao()">üìÖ Programar</button>
        </div>
      </div>
    </div>
  </div>

  <!-- MODAL AVARIA -->
  <div class="modal" id="modal-avaria">
    <div class="modal-content" style="max-width: 400px;">
      <div class="modal-header" style="background: linear-gradient(135deg, #ef4444, #dc2626); color: white;">
        <h3>‚ö†Ô∏è Registrar Avaria</h3>
        <button class="modal-close" onclick="fecharModalAvaria()" style="color: white;">√ó</button>
      </div>
      <div class="modal-body">
        <div style="background: #fee2e2; border-radius: var(--radius-sm); padding: 12px; margin-bottom: 16px;">
          <p style="color: #991b1b; font-size: 13px; margin: 0;">üö® Registre qualquer dano ou problema no ve√≠culo. O ADM ser√° notificado imediatamente.</p>
        </div>
        
        <div class="form-group">
          <label style="font-weight: 600;">Tipo de Avaria *</label>
          <select id="avaria-tipo" class="form-control" style="width: 100%; padding: 12px; border-radius: 8px; border: 1px solid var(--border); margin-top: 6px;">
            <option value="">Selecione...</option>
            <option value="amassado">üî® Amassado</option>
            <option value="arranhao">‚úèÔ∏è Arranh√£o</option>
            <option value="vidro">ü™ü Vidro Quebrado/Trincado</option>
            <option value="retrovisor">üî≤ Retrovisor Danificado</option>
            <option value="farol">üí° Farol/Lanterna</option>
            <option value="pneu">üõû Pneu Furado</option>
            <option value="mecanica">üîß Problema Mec√¢nico</option>
            <option value="eletrica">‚ö° Problema El√©trico</option>
            <option value="acidente">üöó Acidente</option>
            <option value="outros">üìù Outros</option>
          </select>
        </div>
        
        <div class="form-group" style="margin-top: 14px;">
          <label style="font-weight: 600;">Local da Avaria</label>
          <select id="avaria-local" class="form-control" style="width: 100%; padding: 12px; border-radius: 8px; border: 1px solid var(--border); margin-top: 6px;">
            <option value="frente">Frente</option>
            <option value="traseira">Traseira</option>
            <option value="lateral_esq">Lateral Esquerda</option>
            <option value="lateral_dir">Lateral Direita</option>
            <option value="teto">Teto</option>
            <option value="interior">Interior</option>
            <option value="motor">Motor</option>
          </select>
        </div>
        
        <div class="form-group" style="margin-top: 14px;">
          <label style="font-weight: 600;">Gravidade</label>
          <div style="display: flex; gap: 10px; margin-top: 8px;">
            <label style="flex: 1; display: flex; align-items: center; justify-content: center; gap: 6px; padding: 12px; background: #dcfce7; border: 2px solid transparent; border-radius: 8px; cursor: pointer;" onclick="selecionarGravidade('leve')">
              <input type="radio" name="gravidade" value="leve" style="display: none;">
              <span>üü¢</span>
              <span style="font-size: 13px;">Leve</span>
            </label>
            <label style="flex: 1; display: flex; align-items: center; justify-content: center; gap: 6px; padding: 12px; background: #fef3c7; border: 2px solid transparent; border-radius: 8px; cursor: pointer;" onclick="selecionarGravidade('media')">
              <input type="radio" name="gravidade" value="media" style="display: none;">
              <span>üü°</span>
              <span style="font-size: 13px;">M√©dia</span>
            </label>
            <label style="flex: 1; display: flex; align-items: center; justify-content: center; gap: 6px; padding: 12px; background: #fee2e2; border: 2px solid transparent; border-radius: 8px; cursor: pointer;" onclick="selecionarGravidade('grave')">
              <input type="radio" name="gravidade" value="grave" style="display: none;">
              <span>üî¥</span>
              <span style="font-size: 13px;">Grave</span>
            </label>
          </div>
        </div>
        
        <div class="form-group" style="margin-top: 14px;">
          <label style="font-weight: 600;">Descri√ß√£o Detalhada *</label>
          <textarea id="avaria-descricao" class="form-control" rows="3" placeholder="Descreva o que aconteceu..." style="width: 100%; padding: 12px; border-radius: 8px; border: 1px solid var(--border); margin-top: 6px; resize: none;"></textarea>
        </div>
        
        <div class="form-group" style="margin-top: 14px;">
          <label style="display: flex; align-items: center; gap: 10px; cursor: pointer;">
            <input type="checkbox" id="avaria-impede">
            <span style="font-size: 14px;">üö´ Impede trabalhar (ficar offline)</span>
          </label>
        </div>
        
        <div style="display: flex; gap: 12px; margin-top: 20px;">
          <button class="btn" style="flex: 1; background: var(--border); color: var(--text-primary);" onclick="fecharModalAvaria()">Cancelar</button>
          <button class="btn" style="flex: 1; background: linear-gradient(135deg, #ef4444, #dc2626); color: white;" onclick="salvarAvaria()">‚ö†Ô∏è Registrar</button>
        </div>
      </div>
    </div>
  </div>

  <!-- Leaflet JS -->
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
  <!-- Socket.IO para tempo real -->
  <script src="https://cdn.socket.io/4.7.2/socket.io.min.js"></script>
  <!-- Push Notifications -->
  <script src="https://cdn.onesignal.com/sdks/web/v16/OneSignalSDK.page.js" defer></script>
  
  <script>
    console.log('üöó Script motorista carregando...');
    
    var online = false;
    var estadoCorrida = 'nenhuma';
    var mapa = null;
    var rotaLayer = null;
    var somMudo = false;
    
    // ========================================
    // SISTEMA GPS - N√öCLEO DO SISTEMA
    // VERS√ÉO ULTRA PRECISA - FILTRO KALMAN
    // ========================================
    var gpsAtivo = false;
    var gpsWatchId = null;
    var minhaLocalizacao = { lat: null, lng: null, precisao: null, timestamp: null };
    var historicoLocalizacao = [];
    var intervaloEnvioGPS = null;
    var gpsWatchdog = null;
    var tentativasReconexao = 0;
    var MAX_TENTATIVAS_RECONEXAO = 5;
    
    // ========================================
    // FILTRO KALMAN SIMPLIFICADO
    // Suaviza posi√ß√µes e remove ru√≠do
    // ========================================
    var kalmanFilter = {
      lat: null,
      lng: null,
      variance: 1,
      
      // Atualizar com nova medi√ß√£o
      update: function(lat, lng, accuracy) {
        if (this.lat === null) {
          this.lat = lat;
          this.lng = lng;
          this.variance = accuracy * accuracy;
          return { lat: lat, lng: lng };
        }
        
        // Calcular ganho de Kalman
        var kalmanGain = this.variance / (this.variance + accuracy * accuracy);
        
        // Atualizar estimativa
        this.lat = this.lat + kalmanGain * (lat - this.lat);
        this.lng = this.lng + kalmanGain * (lng - this.lng);
        
        // Atualizar vari√¢ncia
        this.variance = (1 - kalmanGain) * this.variance;
        
        return { lat: this.lat, lng: this.lng };
      },
      
      // Reset do filtro
      reset: function() {
        this.lat = null;
        this.lng = null;
        this.variance = 1;
      }
    };
    
    // ========================================
    // M√âDIA M√ìVEL DAS √öLTIMAS POSI√á√ïES
    // ========================================
    var posicoesSuavizacao = [];
    var TAMANHO_JANELA_SUAVIZACAO = 5;
    
    function calcularMediaMovel(lat, lng) {
      posicoesSuavizacao.push({ lat: lat, lng: lng });
      
      // Manter apenas as √∫ltimas N posi√ß√µes
      if (posicoesSuavizacao.length > TAMANHO_JANELA_SUAVIZACAO) {
        posicoesSuavizacao.shift();
      }
      
      // Calcular m√©dia
      var somaLat = 0, somaLng = 0;
      for (var i = 0; i < posicoesSuavizacao.length; i++) {
        somaLat += posicoesSuavizacao[i].lat;
        somaLng += posicoesSuavizacao[i].lng;
      }
      
      return {
        lat: somaLat / posicoesSuavizacao.length,
        lng: somaLng / posicoesSuavizacao.length
      };
    }
    
    // Configura√ß√µes GPS ULTRA PRECISAS
    var GPS_CONFIG = {
      enableHighAccuracy: true,   // SEMPRE alta precis√£o (usa GPS real)
      timeout: 20000,             // 20 segundos (mais tempo para sat√©lites)
      maximumAge: 0               // NUNCA usar cache - SEMPRE posi√ß√£o atual
    };
    
    // Configura√ß√£o alternativa
    var GPS_CONFIG_FALLBACK = {
      enableHighAccuracy: true,   // Ainda tentar alta precis√£o
      timeout: 10000,
      maximumAge: 1000            // Cache de 1 segundo m√°ximo
    };
    
    // ========================================
    // LIMITES DE QUALIDADE (RIGOROSOS)
    // ========================================
    var GPS_LIMITES = {
      PRECISAO_MAXIMA: 100,        // M√°ximo 100m de imprecis√£o (era 500)
      PRECISAO_IDEAL: 30,          // Ideal: menos de 30m
      VELOCIDADE_MAXIMA_KMH: 150,  // M√°ximo 150km/h (era 200)
      ACELERACAO_MAXIMA: 15,       // 15 m/s¬≤ (evita saltos)
      DISTANCIA_MINIMA_METROS: 3,  // M√≠nimo 3m para considerar movimento
      INTERVALO_MINIMO_MS: 500     // M√≠nimo 0.5s entre atualiza√ß√µes
    };
    
    // Estado do GPS
    var ultimaVelocidade = 0;
    var ultimoTimestamp = 0;
    var contagemPosicoesBoas = 0;
    var contagemPosicoesFiltradas = 0;
    
    // ========================================
    // AUTO-INICIALIZA√á√ÉO DO GPS
    // Uma vez permitido, fica sempre ativo
    // ========================================
    function autoIniciarGPS() {
      // Verificar se j√° foi permitido antes
      var gpsPermitido = localStorage.getItem('gps_permitido');
      
      if (gpsPermitido === 'true') {
        console.log('üîÑ GPS j√° foi permitido anteriormente - iniciando automaticamente...');
        iniciarGPS();
      } else {
        console.log('üìç GPS aguardando primeira permiss√£o do usu√°rio');
        atualizarStatusGPS('aguardando');
      }
    }
    
    // Inicializar GPS com persist√™ncia
    function iniciarGPS() {
      if (!navigator.geolocation) {
        mostrarToast('GPS n√£o suportado neste dispositivo', 'error');
        return false;
      }
      
      // Reset do filtro Kalman
      kalmanFilter.reset();
      posicoesSuavizacao = [];
      contagemPosicoesBoas = 0;
      contagemPosicoesFiltradas = 0;
      
      // Marcar como permitido (persiste para sempre)
      localStorage.setItem('gps_permitido', 'true');
      localStorage.setItem('gps_ultima_ativacao', new Date().toISOString());
      
      // Limpar watch anterior se existir
      if (gpsWatchId) {
        navigator.geolocation.clearWatch(gpsWatchId);
      }
      
      // Solicitar permiss√£o e iniciar rastreamento cont√≠nuo
      gpsWatchId = navigator.geolocation.watchPosition(
        onGPSSuccess,
        onGPSError,
        GPS_CONFIG
      );
      
      gpsAtivo = true;
      tentativasReconexao = 0;
      atualizarStatusGPS('ativo');
      mostrarToast('üìç GPS ativado com ULTRA precis√£o', 'success');
      
      // Enviar localiza√ß√£o para servidor a cada 2 segundos (mais frequente)
      if (intervaloEnvioGPS) clearInterval(intervaloEnvioGPS);
      intervaloEnvioGPS = setInterval(enviarLocalizacaoServidor, 2000);
      
      // Iniciar watchdog para garantir que GPS nunca pare
      iniciarWatchdogGPS();
      
      console.log('‚úÖ GPS ULTRA PRECISO iniciado - Filtro Kalman ativo');
      return true;
    }
    
    // Watchdog: garante que GPS nunca pare
    function iniciarWatchdogGPS() {
      if (gpsWatchdog) clearInterval(gpsWatchdog);
      
      gpsWatchdog = setInterval(function() {
        // Verificar se GPS est√° funcionando
        if (!gpsAtivo || !minhaLocalizacao.timestamp) {
          console.log('‚ö†Ô∏è Watchdog: GPS parado, reconectando...');
          reconectarGPS();
          return;
        }
        
        // Verificar se √∫ltima atualiza√ß√£o foi h√° mais de 15 segundos (mais rigoroso)
        var ultimaAtualizacao = new Date(minhaLocalizacao.timestamp);
        var agora = new Date();
        var diferencaSegundos = (agora - ultimaAtualizacao) / 1000;
        
        if (diferencaSegundos > 15) {
          console.log('‚ö†Ô∏è Watchdog: GPS sem atualiza√ß√£o h√° ' + diferencaSegundos.toFixed(0) + 's, reconectando...');
          reconectarGPS();
        }
        
        // Log de estat√≠sticas a cada minuto
        if (contagemPosicoesBoas + contagemPosicoesFiltradas > 0) {
          var taxa = (contagemPosicoesBoas / (contagemPosicoesBoas + contagemPosicoesFiltradas) * 100).toFixed(1);
          console.log('üìä GPS Stats: ' + contagemPosicoesBoas + ' boas, ' + contagemPosicoesFiltradas + ' filtradas (' + taxa + '% aproveitamento)');
        }
      }, 10000); // Verificar a cada 10 segundos
    }
    
    // Reconectar GPS automaticamente
    function reconectarGPS() {
      tentativasReconexao++;
      
      if (tentativasReconexao > MAX_TENTATIVAS_RECONEXAO) {
        console.log('‚ùå Muitas tentativas de reconex√£o, usando fallback');
        // Tentar com configura√ß√£o de fallback
        if (gpsWatchId) navigator.geolocation.clearWatch(gpsWatchId);
        gpsWatchId = navigator.geolocation.watchPosition(
          onGPSSuccess,
          onGPSError,
          GPS_CONFIG_FALLBACK
        );
        tentativasReconexao = 0;
        return;
      }
      
      console.log('üîÑ Tentativa de reconex√£o GPS #' + tentativasReconexao);
      
      // Parar e reiniciar
      if (gpsWatchId) {
        navigator.geolocation.clearWatch(gpsWatchId);
        gpsWatchId = null;
      }
      
      // Reset dos filtros
      kalmanFilter.reset();
      posicoesSuavizacao = [];
      
      // Tentar obter posi√ß√£o √∫nica primeiro
      navigator.geolocation.getCurrentPosition(
        function(position) {
          console.log('‚úÖ Reconex√£o bem sucedida');
          onGPSSuccess(position);
          // Reiniciar watch
          gpsWatchId = navigator.geolocation.watchPosition(
            onGPSSuccess,
            onGPSError,
            GPS_CONFIG
          );
          tentativasReconexao = 0;
          atualizarStatusGPS('ativo');
        },
        function(error) {
          console.log('‚ö†Ô∏è Erro na reconex√£o:', error.message);
          atualizarStatusGPS('reconectando');
        },
        GPS_CONFIG
      );
    }
    
    // Ativar GPS ao clicar no indicador (primeira vez)
    function ativarGPS() {
      if (gpsAtivo) {
        mostrarToast('üìç GPS j√° est√° ativo', 'info');
        return;
      }
      
      mostrarToast('üîÑ Ativando GPS com ULTRA precis√£o...', 'info');
      
      // Solicitar permiss√£o do navegador
      if (navigator.geolocation) {
        navigator.geolocation.getCurrentPosition(
          function(position) {
            // Permiss√£o concedida - iniciar GPS
            // A partir de agora, vai ficar sempre ativo
            iniciarGPS();
          },
          function(error) {
            if (error.code === error.PERMISSION_DENIED) {
              mostrarToast('‚ö†Ô∏è Permita o acesso ao GPS nas configura√ß√µes do navegador', 'error');
              // Limpar flag se usu√°rio negou
              localStorage.removeItem('gps_permitido');
            } else {
              mostrarToast('‚ö†Ô∏è Erro ao ativar GPS: ' + error.message, 'error');
            }
            atualizarStatusGPS('erro');
          },
          GPS_CONFIG
        );
      } else {
        mostrarToast('‚ùå GPS n√£o suportado neste dispositivo', 'error');
      }
    }
    
    // Parar GPS (usado apenas em casos espec√≠ficos)
    function pararGPS() {
      if (gpsWatchId) {
        navigator.geolocation.clearWatch(gpsWatchId);
        gpsWatchId = null;
      }
      if (intervaloEnvioGPS) {
        clearInterval(intervaloEnvioGPS);
        intervaloEnvioGPS = null;
      }
      if (gpsWatchdog) {
        clearInterval(gpsWatchdog);
        gpsWatchdog = null;
      }
      gpsAtivo = false;
      atualizarStatusGPS('inativo');
      // N√ÉO remove gps_permitido - para auto-iniciar na pr√≥xima vez
    }
    
    // Callback de sucesso do GPS (ULTRA PRECISO)
    function onGPSSuccess(position) {
      var timestamp = Date.now();
      
      // Validar intervalo m√≠nimo entre atualiza√ß√µes
      if (ultimoTimestamp && (timestamp - ultimoTimestamp) < GPS_LIMITES.INTERVALO_MINIMO_MS) {
        return; // Muito r√°pido, ignorar
      }
      
      var latRaw = position.coords.latitude;
      var lngRaw = position.coords.longitude;
      var precisao = position.coords.accuracy;
      var altitude = position.coords.altitude;
      var velocidade = position.coords.speed; // m/s
      var direcao = position.coords.heading;
      
      // ========================================
      // VALIDA√á√ÉO 1: Precis√£o m√≠nima
      // ========================================
      if (precisao > GPS_LIMITES.PRECISAO_MAXIMA) {
        console.log('‚ö†Ô∏è GPS: Precis√£o muito baixa (' + precisao.toFixed(0) + 'm > ' + GPS_LIMITES.PRECISAO_MAXIMA + 'm), descartando...');
        contagemPosicoesFiltradas++;
        return;
      }
      
      // Avisar se precis√£o n√£o √© ideal (mas ainda usar)
      if (precisao > GPS_LIMITES.PRECISAO_IDEAL) {
        console.log('üìç GPS: Precis√£o m√©dia (' + precisao.toFixed(0) + 'm), aplicando filtro Kalman...');
      }
      
      // ========================================
      // VALIDA√á√ÉO 2: Movimento imposs√≠vel
      // ========================================
      if (minhaLocalizacao.lat && minhaLocalizacao.lng) {
        var distanciaMetros = calcularDistanciaMetros(
          minhaLocalizacao.lat, minhaLocalizacao.lng,
          latRaw, lngRaw
        );
        var tempoSegundos = (timestamp - ultimoTimestamp) / 1000;
        
        if (tempoSegundos > 0) {
          // Validar velocidade
          var velocidadeCalculada = distanciaMetros / tempoSegundos; // m/s
          var velocidadeKmh = velocidadeCalculada * 3.6;
          
          if (velocidadeKmh > GPS_LIMITES.VELOCIDADE_MAXIMA_KMH) {
            console.log('‚ö†Ô∏è GPS: Velocidade imposs√≠vel (' + velocidadeKmh.toFixed(0) + 'km/h), descartando...');
            contagemPosicoesFiltradas++;
            return;
          }
          
          // Validar acelera√ß√£o (evita saltos)
          var aceleracao = Math.abs(velocidadeCalculada - ultimaVelocidade) / tempoSegundos;
          if (aceleracao > GPS_LIMITES.ACELERACAO_MAXIMA && ultimaVelocidade > 0) {
            console.log('‚ö†Ô∏è GPS: Acelera√ß√£o imposs√≠vel (' + aceleracao.toFixed(1) + 'm/s¬≤), descartando...');
            contagemPosicoesFiltradas++;
            return;
          }
          
          // Atualizar velocidade para pr√≥xima valida√ß√£o
          ultimaVelocidade = velocidadeCalculada;
          
          // Ignorar micro-movimentos (ru√≠do)
          if (distanciaMetros < GPS_LIMITES.DISTANCIA_MINIMA_METROS && precisao > 20) {
            // Posi√ß√£o praticamente igual, manter a anterior
            ultimoTimestamp = timestamp;
            return;
          }
        }
      }
      
      // ========================================
      // APLICAR FILTRO KALMAN
      // ========================================
      var posicaoKalman = kalmanFilter.update(latRaw, lngRaw, precisao);
      
      // ========================================
      // APLICAR M√âDIA M√ìVEL
      // ========================================
      var posicaoFinal = calcularMediaMovel(posicaoKalman.lat, posicaoKalman.lng);
      
      // ========================================
      // CRIAR OBJETO DE LOCALIZA√á√ÉO FINAL
      // ========================================
      var novaLocalizacao = {
        lat: posicaoFinal.lat,
        lng: posicaoFinal.lng,
        latRaw: latRaw,          // Posi√ß√£o bruta (para debug)
        lngRaw: lngRaw,
        precisao: precisao,
        precisaoEstimada: Math.min(precisao, kalmanFilter.variance), // Precis√£o melhorada
        altitude: altitude,
        velocidade: velocidade,
        velocidadeKmh: velocidade ? (velocidade * 3.6) : null,
        direcao: direcao,
        timestamp: new Date().toISOString(),
        filtrada: true           // Flag indicando que passou pelo filtro
      };
      
      // Atualizar localiza√ß√£o
      minhaLocalizacao = novaLocalizacao;
      ultimoTimestamp = timestamp;
      contagemPosicoesBoas++;
      
      // Salvar no hist√≥rico (com posi√ß√£o filtrada)
      historicoLocalizacao.push({...minhaLocalizacao});
      if (historicoLocalizacao.length > 100) {
        historicoLocalizacao.shift(); // Manter √∫ltimas 100 posi√ß√µes
      }
      
      // Persistir √∫ltima localiza√ß√£o v√°lida
      localStorage.setItem('gps_ultima_localizacao', JSON.stringify(minhaLocalizacao));
      
      // Atualizar coordenadas do motorista
      coordMotorista.lat = minhaLocalizacao.lat;
      coordMotorista.lng = minhaLocalizacao.lng;
      
      // Atualizar UI
      atualizarInfoGPS();
      atualizarStatusGPS('ativo');
      
      // Atualizar mapa se estiver vis√≠vel
      if (mapa && marcadorMotorista) {
        marcadorMotorista.setLatLng([minhaLocalizacao.lat, minhaLocalizacao.lng]);
      }
      
      // Calcular dist√¢ncia at√© cliente se em corrida
      if (estadoCorrida === 'aceita' || estadoCorrida === 'em_andamento') {
        calcularDistanciaTempoReal();
      }
      
      // ==========================================
      // INTEGRA√á√ÉO GPS COM ADM DA FROTA
      // Envia localiza√ß√£o para o painel ADM ver
      // ==========================================
      enviarLocalizacaoParaADM();
      
      // Log com precis√£o melhorada
      console.log('üìç GPS [' + contagemPosicoesBoas + ']: ' + 
                  minhaLocalizacao.lat.toFixed(7) + ', ' + 
                  minhaLocalizacao.lng.toFixed(7) + 
                  ' (¬±' + precisao.toFixed(0) + 'm)');
    }
    
    // Enviar localiza√ß√£o para o ADM da Frota (via LocalStorage)
    function enviarLocalizacaoParaADM() {
      if (!minhaLocalizacao.lat) return;
      
      var DB_KEY = 'zapcorridas_motoristas';
      var MOTORISTA_ID = 1; // Jo√£o Santos
      
      try {
        var dados = localStorage.getItem(DB_KEY);
        if (dados) {
          var motoristas = JSON.parse(dados);
          var index = motoristas.findIndex(function(m) { return m.id === MOTORISTA_ID; });
          
          if (index !== -1) {
            motoristas[index].lat = minhaLocalizacao.lat;
            motoristas[index].lng = minhaLocalizacao.lng;
            motoristas[index].ultimaAtualizacao = Date.now();
            motoristas[index].status = online ? (estadoCorrida !== 'nenhuma' ? 'em-corrida' : 'online') : 'offline';
            
            // Buscar nome do local
            if (cidadeAtual) {
              motoristas[index].local = cidadeAtual;
            }
            
            // Adicionar info da corrida se estiver em uma
            if (estadoCorrida !== 'nenhuma') {
              motoristas[index].corrida = '#' + (historicoCount - 1);
            } else {
              motoristas[index].corrida = null;
            }
            
            localStorage.setItem(DB_KEY, JSON.stringify(motoristas));
            console.log('üì° Localiza√ß√£o enviada para ADM');
          }
        }
      } catch (e) {
        console.log('Erro ao enviar para ADM:', e);
      }
    }
    
    // Vari√°vel para guardar cidade atual
    var cidadeAtual = 'Localiza√ß√£o atual';
    
    // Callback de erro do GPS
    function onGPSError(error) {
      var mensagem = '';
      switch(error.code) {
        case error.PERMISSION_DENIED:
          mensagem = 'Permiss√£o de GPS negada';
          localStorage.removeItem('gps_permitido'); // Limpar flag
          break;
        case error.POSITION_UNAVAILABLE:
          mensagem = 'Localiza√ß√£o indispon√≠vel';
          // Tentar reconectar
          setTimeout(reconectarGPS, 3000);
          break;
        case error.TIMEOUT:
          mensagem = 'Tempo esgotado ao obter GPS';
          // Tentar reconectar
          setTimeout(reconectarGPS, 2000);
          break;
        default:
          mensagem = 'Erro ao obter localiza√ß√£o';
      }
      console.log('‚ö†Ô∏è GPS Error:', mensagem);
      
      // S√≥ mostrar toast se for erro grave
      if (error.code === error.PERMISSION_DENIED) {
        mostrarToast('‚ö†Ô∏è ' + mensagem, 'error');
        atualizarStatusGPS('erro');
      } else {
        atualizarStatusGPS('reconectando');
      }
    }
    
    // Calcular dist√¢ncia em metros entre dois pontos
    function calcularDistanciaMetros(lat1, lng1, lat2, lng2) {
      var R = 6371000; // Raio da Terra em metros
      var dLat = (lat2 - lat1) * Math.PI / 180;
      var dLng = (lng2 - lng1) * Math.PI / 180;
      var a = Math.sin(dLat/2) * Math.sin(dLat/2) +
              Math.cos(lat1 * Math.PI / 180) * Math.cos(lat2 * Math.PI / 180) *
              Math.sin(dLng/2) * Math.sin(dLng/2);
      var c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
      return R * c;
    }
    
    // Atualizar status GPS na UI (melhorado)
    function atualizarStatusGPS(status) {
      var elemento = document.getElementById('gps-status');
      if (!elemento) return;
      
      var precisaoTexto = minhaLocalizacao.precisao ? minhaLocalizacao.precisao.toFixed(0) + 'm' : '--';
      
      switch(status) {
        case 'ativo':
          elemento.innerHTML = 'üìç GPS <span style="color:#10b981;">‚óè</span>';
          elemento.title = 'GPS ativo - Precis√£o: ' + precisaoTexto;
          elemento.style.cursor = 'default';
          break;
        case 'reconectando':
          elemento.innerHTML = 'üìç GPS <span style="color:#f59e0b;">‚óè</span>';
          elemento.title = 'Reconectando GPS...';
          elemento.style.cursor = 'wait';
          break;
        case 'aguardando':
          elemento.innerHTML = 'üìç GPS <span style="color:#3b82f6;">‚óè</span>';
          elemento.title = 'Clique para ativar GPS';
          elemento.style.cursor = 'pointer';
          break;
        case 'erro':
          elemento.innerHTML = 'üìç GPS <span style="color:#ef4444;">‚óè</span>';
          elemento.title = 'GPS com erro - Clique para tentar novamente';
          elemento.style.cursor = 'pointer';
          break;
        default:
          elemento.innerHTML = 'üìç GPS <span style="color:#94a3b8;">‚óè</span>';
          elemento.title = 'GPS inativo - Clique para ativar';
          elemento.style.cursor = 'pointer';
      }
    }
    
    // Atualizar informa√ß√µes do GPS na tela
    function atualizarInfoGPS() {
      var infoEl = document.getElementById('gps-info');
      if (infoEl && minhaLocalizacao.lat) {
        infoEl.textContent = minhaLocalizacao.lat.toFixed(4) + ', ' + minhaLocalizacao.lng.toFixed(4);
      }
      
      // Atualizar tamb√©m no card da empresa
      if (minhaLocalizacao.lat) {
        document.getElementById('minha-coords').textContent = 
          'Lat: ' + minhaLocalizacao.lat.toFixed(6) + ' | Lng: ' + minhaLocalizacao.lng.toFixed(6);
        
        // Buscar nome da cidade via Geocoding
        buscarNomeCidade(minhaLocalizacao.lat, minhaLocalizacao.lng);
      }
    }
    
    // Atualizar minha localiza√ß√£o ao clicar
    function atualizarMinhaLocalizacao() {
      document.getElementById('minha-cidade').textContent = 'üîÑ Buscando...';
      document.getElementById('minha-coords').textContent = 'Obtendo localiza√ß√£o...';
      
      if (!navigator.geolocation) {
        document.getElementById('minha-cidade').textContent = '‚ùå GPS n√£o suportado';
        document.getElementById('minha-coords').textContent = 'Use um navegador com suporte a GPS';
        return;
      }
      
      // Configura√ß√£o para m√°xima precis√£o (funciona em WiFi e 4G)
      var opcoes = {
        enableHighAccuracy: true,  // Usar GPS do dispositivo
        timeout: 30000,            // 30 segundos para obter
        maximumAge: 0              // Sempre buscar posi√ß√£o nova
      };
      
      navigator.geolocation.getCurrentPosition(
        function(position) {
          minhaLocalizacao.lat = position.coords.latitude;
          minhaLocalizacao.lng = position.coords.longitude;
          minhaLocalizacao.precisao = position.coords.accuracy;
          minhaLocalizacao.velocidade = position.coords.speed;
          minhaLocalizacao.timestamp = new Date().toISOString();
          
          // Mostrar precis√£o
          var precisao = minhaLocalizacao.precisao;
          var precisaoTexto = precisao < 1000 ? precisao.toFixed(0) + 'm' : (precisao/1000).toFixed(1) + 'km';
          
          document.getElementById('minha-coords').textContent = 
            'üìç Precis√£o: ' + precisaoTexto;
          
          // Buscar nome da cidade via API
          buscarNomeCidade(minhaLocalizacao.lat, minhaLocalizacao.lng);
          
          // Ativar rastreamento cont√≠nuo
          if (!gpsAtivo) {
            iniciarGPS();
          }
          
          mostrarToast('üìç Localiza√ß√£o obtida!', 'success');
          console.log('üìç GPS:', minhaLocalizacao.lat, minhaLocalizacao.lng, 'Precis√£o:', precisao + 'm');
        },
        function(error) {
          var mensagem = '';
          switch(error.code) {
            case error.PERMISSION_DENIED:
              mensagem = 'Permita o acesso √† localiza√ß√£o';
              document.getElementById('minha-cidade').textContent = 'üîí Acesso negado';
              break;
            case error.POSITION_UNAVAILABLE:
              mensagem = 'Localiza√ß√£o indispon√≠vel';
              document.getElementById('minha-cidade').textContent = '‚ö†Ô∏è Indispon√≠vel';
              break;
            case error.TIMEOUT:
              mensagem = 'Tempo esgotado';
              document.getElementById('minha-cidade').textContent = '‚è±Ô∏è Tempo esgotado';
              break;
            default:
              mensagem = 'Erro desconhecido';
              document.getElementById('minha-cidade').textContent = '‚ùå Erro';
          }
          document.getElementById('minha-coords').textContent = mensagem;
          mostrarToast('‚ö†Ô∏è ' + mensagem, 'error');
        },
        opcoes
      );
    }
    
    // Buscar nome da cidade via Nominatim (OpenStreetMap)
    function buscarNomeCidade(lat, lng) {
      fetch('https://nominatim.openstreetmap.org/reverse?format=json&lat=' + lat + '&lon=' + lng + '&zoom=10&addressdetails=1')
        .then(function(response) { return response.json(); })
        .then(function(data) {
          if (data && data.address) {
            var cidade = data.address.city || data.address.town || data.address.village || data.address.municipality || 'Desconhecida';
            var estado = data.address.state || '';
            var bairro = data.address.suburb || data.address.neighbourhood || '';
            
            // Mostrar cidade + estado
            var localCompleto = cidade;
            if (estado) {
              // Pegar sigla do estado
              var siglaEstado = estado.replace('State of ', '').substring(0, 2).toUpperCase();
              if (estado.toLowerCase().includes('paulo')) siglaEstado = 'SP';
              if (estado.toLowerCase().includes('janeiro')) siglaEstado = 'RJ';
              if (estado.toLowerCase().includes('minas')) siglaEstado = 'MG';
              localCompleto = cidade + ' - ' + siglaEstado;
            }
            
            document.getElementById('minha-cidade').textContent = localCompleto;
            
            // SALVAR CIDADE ATUAL PARA INTEGRA√á√ÉO COM ADM
            cidadeAtual = bairro || cidade;
            
            // Adicionar bairro nas coordenadas se tiver
            if (bairro) {
              var coords = document.getElementById('minha-coords').textContent;
              document.getElementById('minha-coords').textContent = bairro + ' | ' + coords.split('|')[0].trim();
            }
            
            // ENVIAR PARA ADM COM NOME DO LOCAL
            enviarLocalizacaoParaADM();
            
            console.log('üìç Localiza√ß√£o:', localCompleto, bairro);
          }
        })
        .catch(function(error) {
          console.error('Erro ao buscar cidade:', error);
          document.getElementById('minha-cidade').textContent = 'Lat: ' + lat.toFixed(4);
        });
    }
    
    // Enviar localiza√ß√£o para o servidor (API)
    function enviarLocalizacaoServidor() {
      if (!gpsAtivo || !minhaLocalizacao.lat) return;
      
      var dados = {
        motoristaId: 'motorista_001', // ID do motorista logado
        lat: minhaLocalizacao.lat,
        lng: minhaLocalizacao.lng,
        precisao: minhaLocalizacao.precisao,
        velocidade: minhaLocalizacao.velocidade,
        direcao: minhaLocalizacao.direcao,
        timestamp: minhaLocalizacao.timestamp,
        estadoCorrida: estadoCorrida,
        online: online
      };
      
      // Simular envio para API (substituir por fetch real)
      console.log('üì§ Enviando GPS para servidor:', dados);
      
      /* INTEGRA√á√ÉO REAL COM API:
      fetch('/api/motorista/localizacao', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(dados)
      })
      .then(response => response.json())
      .then(data => {
        // Processar resposta (nova corrida, etc)
        if (data.novaCorrida) {
          receberNovaCorrida(data.corrida);
        }
      })
      .catch(error => console.error('Erro ao enviar GPS:', error));
      */
    }
    
    // Calcular dist√¢ncia em tempo real at√© o cliente
    function calcularDistanciaTempoReal() {
      if (!minhaLocalizacao.lat || !coordCliente.lat) return;
      
      var distancia = calcularDistancia(
        minhaLocalizacao.lat, 
        minhaLocalizacao.lng, 
        coordCliente.lat, 
        coordCliente.lng
      );
      
      var tempo = Math.ceil(distancia * 2); // ~2 min por km
      
      // Atualizar UI
      var rotaEl = document.getElementById('rota-distancia');
      if (rotaEl) {
        rotaEl.textContent = distancia.toFixed(1) + ' km ‚Ä¢ ~' + tempo + ' min';
      }
      
      // Verificar se chegou perto do cliente (< 50m)
      if (distancia < 0.05 && estadoCorrida === 'aceita') {
        mostrarToast('üìç Voc√™ est√° pr√≥ximo do cliente!', 'info');
      }
    }
    
    // Obter endere√ßo a partir das coordenadas (Geocoding Reverso)
    function obterEndereco(lat, lng, callback) {
      // Usando API gratuita Nominatim (OpenStreetMap)
      var url = 'https://nominatim.openstreetmap.org/reverse?format=json&lat=' + lat + '&lon=' + lng + '&zoom=18&addressdetails=1';
      
      fetch(url)
        .then(response => response.json())
        .then(data => {
          var endereco = data.display_name || 'Endere√ßo n√£o encontrado';
          if (callback) callback(endereco, data);
        })
        .catch(error => {
          console.error('Erro ao obter endere√ßo:', error);
          if (callback) callback('Erro ao obter endere√ßo', null);
        });
    }
    
    // Obter coordenadas a partir do endere√ßo (Geocoding)
    function obterCoordenadas(endereco, callback) {
      var url = 'https://nominatim.openstreetmap.org/search?format=json&q=' + encodeURIComponent(endereco) + '&limit=1';
      
      fetch(url)
        .then(response => response.json())
        .then(data => {
          if (data && data.length > 0) {
            var coords = {
              lat: parseFloat(data[0].lat),
              lng: parseFloat(data[0].lon),
              endereco: data[0].display_name
            };
            if (callback) callback(coords);
          } else {
            if (callback) callback(null);
          }
        })
        .catch(error => {
          console.error('Erro ao obter coordenadas:', error);
          if (callback) callback(null);
        });
    }

    // ========================================
    // API DE ROTAS - OSRM (Open Source)
    // ========================================
    function calcularRotaReal(origem, destino, callback) {
      // OSRM - Open Source Routing Machine (gratuito)
      var url = 'https://router.project-osrm.org/route/v1/driving/' +
                origem.lng + ',' + origem.lat + ';' +
                destino.lng + ',' + destino.lat +
                '?overview=full&geometries=geojson&steps=true';
      
      fetch(url)
        .then(response => response.json())
        .then(data => {
          if (data.code === 'Ok' && data.routes && data.routes.length > 0) {
            var rota = data.routes[0];
            var resultado = {
              distancia: (rota.distance / 1000).toFixed(1), // km
              duracao: Math.ceil(rota.duration / 60), // minutos
              geometria: rota.geometry.coordinates, // pontos da rota
              passos: rota.legs[0].steps // instru√ß√µes
            };
            if (callback) callback(resultado);
          } else {
            if (callback) callback(null);
          }
        })
        .catch(error => {
          console.error('Erro ao calcular rota:', error);
          if (callback) callback(null);
        });
    }

    // Desenhar rota real no mapa
    function desenharRotaReal(geometria) {
      if (!mapa) return;
      
      // Converter coordenadas [lng, lat] para [lat, lng]
      var pontos = geometria.map(function(coord) {
        return [coord[1], coord[0]];
      });
      
      // Remover rota anterior
      if (rotaLayer) {
        mapa.removeLayer(rotaLayer);
      }
      
      // Desenhar nova rota
      rotaLayer = L.polyline(pontos, {
        color: '#3b82f6',
        weight: 5,
        opacity: 0.8
      }).addTo(mapa);
      
      // Ajustar zoom
      mapa.fitBounds(rotaLayer.getBounds(), { padding: [50, 50] });
    }

    // ========================================
    // WEBSOCKET - TEMPO REAL
    // ========================================
    var socket = null;
    var socketConectado = false;

    function iniciarWebSocket() {
      // Conectar ao servidor WebSocket
      try {
        socket = io('wss://seu-servidor.com', {
          transports: ['websocket'],
          reconnection: true,
          reconnectionDelay: 1000,
          reconnectionAttempts: 5
        });

        socket.on('connect', function() {
          socketConectado = true;
          console.log('üîå WebSocket conectado');
          
          // Registrar motorista
          socket.emit('motorista:registrar', {
            id: 'motorista_001',
            nome: 'Jo√£o Santos',
            veiculo: 'Onix Branco - ABC-1234'
          });
        });

        socket.on('disconnect', function() {
          socketConectado = false;
          console.log('üîå WebSocket desconectado');
        });

        // Receber nova corrida
        socket.on('corrida:nova', function(data) {
          console.log('üöó Nova corrida recebida:', data);
          coordCliente = { lat: data.origem.lat, lng: data.origem.lng };
          coordDestino = { lat: data.destino.lat, lng: data.destino.lng };
          document.getElementById('corrida-cliente').textContent = data.cliente.nome;
          document.getElementById('corrida-origem').textContent = data.origem.endereco;
          document.getElementById('corrida-destino').textContent = data.destino.endereco;
          
          // Exibir refer√™ncia se houver
          var refContainer = document.getElementById('corrida-referencia-container');
          var refTexto = document.getElementById('corrida-referencia');
          if (data.origem.referencia || data.referencia || data.origem_referencia) {
            refTexto.textContent = data.origem.referencia || data.referencia || data.origem_referencia;
            refContainer.style.display = 'flex';
          } else {
            refContainer.style.display = 'none';
          }
          document.getElementById('corrida-valor').textContent = 'R$ ' + data.valor.toFixed(2).replace('.', ',');
          
          // Verificar se √© PRIORIDADE (reatribu√≠da por atraso)
          var corridaCard = document.getElementById('corrida-card');
          var prioridadeAlerta = document.getElementById('prioridade-alerta');
          var corridaBadge = document.getElementById('corrida-badge');
          
          if (data.prioridade) {
            // Mostrar alerta de prioridade
            corridaCard.classList.add('prioridade');
            prioridadeAlerta.classList.remove('hidden');
            corridaBadge.textContent = 'üö® PRIORIDADE';
            corridaBadge.classList.add('prioridade');
            
            // Tocar som especial de urg√™ncia
            tocarSom('urgente');
            
            // Vibrar mais intenso
            if (navigator.vibrate) {
              navigator.vibrate([500, 200, 500, 200, 500]);
            }
            
            // Mostrar toast especial
            mostrarToast('üö® CORRIDA PRIORIDADE! Cliente aguardando!', 'warning');
          } else {
            // Corrida normal
            corridaCard.classList.remove('prioridade');
            prioridadeAlerta.classList.add('hidden');
            corridaBadge.textContent = 'Nova Corrida';
            corridaBadge.classList.remove('prioridade');
          }
          
          receberNovaCorrida();
        });

        // Atualiza√ß√£o de localiza√ß√£o de outros motoristas
        socket.on('motoristas:localizacao', function(data) {
          // Atualizar no chat da frota quem est√° online
          console.log('üìç Motoristas online:', data);
        });

        // Mensagem do chat
        socket.on('chat:mensagem', function(data) {
          receberMensagemChat(data);
        });

        // Mensagem do suporte
        socket.on('suporte:resposta', function(data) {
          mostrarToast('üì© Resposta do suporte: ' + data.mensagem, 'info');
        });

      } catch (error) {
        console.log('WebSocket n√£o dispon√≠vel, usando polling');
        iniciarPolling();
      }
    }

    // Enviar localiza√ß√£o via WebSocket
    function enviarLocalizacaoWebSocket() {
      if (socket && socketConectado && minhaLocalizacao.lat) {
        socket.emit('motorista:localizacao', {
          id: 'motorista_001',
          lat: minhaLocalizacao.lat,
          lng: minhaLocalizacao.lng,
          velocidade: minhaLocalizacao.velocidade,
          estadoCorrida: estadoCorrida,
          online: online
        });
      }
    }

    // Receber mensagem no chat
    function receberMensagemChat(data) {
      var container = document.getElementById('chat-mensagens');
      if (!container) return;
      
      var msgEl = document.createElement('div');
      msgEl.className = 'chat-msg recebida';
      msgEl.innerHTML = '<span class="chat-msg-nome">' + data.nome + '</span>' +
                        '<span class="chat-msg-texto">' + data.mensagem + '</span>' +
                        '<span class="chat-msg-hora">' + data.hora + '</span>';
      
      container.appendChild(msgEl);
      container.scrollTop = container.scrollHeight;
      
      // Mostrar badge de novas mensagens
      var badge = document.getElementById('chat-badge');
      if (badge) {
        var count = parseInt(badge.textContent) || 0;
        badge.textContent = count + 1;
        badge.style.display = 'flex';
      }
      
      // Tocar som se n√£o estiver mudo
      if (!somMudo) {
        tocarSom('mensagem');
      }
    }

    // ========================================
    // POLLING (fallback se WebSocket n√£o funcionar)
    // ========================================
    var pollingInterval = null;

    function iniciarPolling() {
      // Verificar novas corridas a cada 3 segundos
      pollingInterval = setInterval(function() {
        if (!online) return;
        
        verificarNovasCorridas();
        verificarMensagens();
      }, 3000);
    }

    function verificarNovasCorridas() {
      /* 
      fetch('/api/motorista/corridas/pendentes?motoristaId=motorista_001')
        .then(response => response.json())
        .then(data => {
          if (data.corrida) {
            // Processar nova corrida
          }
        });
      */
    }

    function verificarMensagens() {
      /*
      fetch('/api/chat/mensagens?ultimaId=' + ultimaMensagemId)
        .then(response => response.json())
        .then(data => {
          data.mensagens.forEach(receberMensagemChat);
        });
      */
    }

    // ========================================
    // SISTEMA DE NOTIFICA√á√ïES EM SEGUNDO PLANO
    // ULTRA PRECISO - Funciona mesmo minimizado
    // ========================================
    var serviceWorkerRegistration = null;
    var audioNovaCorrida = null;
    var intervalSom = null;
    var notificacaoAtiva = null;
    
    // Inicializar sistema de notifica√ß√µes
    function iniciarPushNotifications() {
      console.log('üîî Iniciando sistema de notifica√ß√µes em segundo plano...');
      
      // 1. Registrar Service Worker
      registrarServiceWorker();
      
      // 2. Solicitar permiss√£o de notifica√ß√£o
      solicitarPermissaoNotificacao();
      
      // 3. Preparar √°udio de alerta
      prepararAudioAlerta();
      
      // 4. Configurar listener para mensagens do SW
      configurarListenerSW();
    }
    
    // Registrar Service Worker
    function registrarServiceWorker() {
      if ('serviceWorker' in navigator) {
        navigator.serviceWorker.register('/motorista/sw.js')
          .then(function(registration) {
            serviceWorkerRegistration = registration;
            console.log('‚úÖ Service Worker registrado com sucesso!');
            
            // Verificar atualiza√ß√µes
            registration.update();
            
            // Listener para atualiza√ß√µes
            registration.addEventListener('updatefound', function() {
              console.log('üîÑ Nova vers√£o do Service Worker dispon√≠vel');
            });
          })
          .catch(function(error) {
            console.log('‚ùå Erro ao registrar Service Worker:', error);
            // Tentar caminho alternativo
            navigator.serviceWorker.register('/sw.js').catch(function() {
              console.log('‚ö†Ô∏è Service Worker n√£o dispon√≠vel');
            });
          });
        
        // Listener para mensagens do Service Worker
        navigator.serviceWorker.addEventListener('message', function(event) {
          console.log('üì© Mensagem do SW:', event.data);
          
          if (event.data.tipo === 'NOTIFICACAO_CLICADA') {
            // Usu√°rio clicou na notifica√ß√£o - focar na corrida
            window.focus();
            pararAlerta();
            if (event.data.acao === 'aceitar' && estadoCorrida === 'enviada') {
              aceitarCorrida();
            }
          }
          
          // Recebeu comando para ficar offline
          if (event.data.tipo === 'FICAR_OFFLINE') {
            console.log('üî¥ Comando recebido: Ficar offline');
            // Desmarcar toggle e ficar offline
            document.getElementById('toggle-status').checked = false;
            alternarStatus();
            mostrarToast('Voc√™ foi colocado offline', 'info');
          }
        });
      } else {
        console.log('‚ö†Ô∏è Service Worker n√£o suportado');
      }
    }
    
    // Solicitar permiss√£o de notifica√ß√£o
    function solicitarPermissaoNotificacao() {
      if (!('Notification' in window)) {
        console.log('‚ö†Ô∏è Notifica√ß√µes n√£o suportadas');
        return;
      }
      
      if (Notification.permission === 'default') {
        // Mostrar modal pedindo permiss√£o
        mostrarModalPermissao();
      } else if (Notification.permission === 'granted') {
        console.log('‚úÖ Permiss√£o de notifica√ß√£o j√° concedida');
      } else {
        console.log('‚ö†Ô∏è Permiss√£o de notifica√ß√£o negada');
      }
    }
    
    // Modal pedindo permiss√£o
    function mostrarModalPermissao() {
      var modal = document.createElement('div');
      modal.id = 'modal-permissao';
      modal.innerHTML = [
        '<div style="position:fixed;top:0;left:0;right:0;bottom:0;background:rgba(0,0,0,0.7);z-index:9999;display:flex;align-items:center;justify-content:center;padding:20px;">',
        '  <div style="background:white;border-radius:16px;padding:24px;max-width:340px;text-align:center;">',
        '    <div style="font-size:48px;margin-bottom:16px;">üîî</div>',
        '    <h3 style="font-size:18px;margin-bottom:12px;color:#1e293b;">Ativar Notifica√ß√µes</h3>',
        '    <p style="color:#64748b;font-size:14px;margin-bottom:20px;">',
        '      Para receber alertas de <strong>novas corridas</strong> mesmo com o app minimizado, precisamos da sua permiss√£o.',
        '    </p>',
        '    <button onclick="confirmarPermissaoNotificacao()" style="width:100%;padding:14px;background:#6366f1;color:white;border:none;border-radius:10px;font-weight:600;font-size:16px;cursor:pointer;">',
        '      ‚úÖ Permitir Notifica√ß√µes',
        '    </button>',
        '    <button onclick="fecharModalPermissao()" style="width:100%;padding:12px;background:transparent;color:#64748b;border:none;margin-top:10px;cursor:pointer;">',
        '      Agora n√£o',
        '    </button>',
        '  </div>',
        '</div>'
      ].join('');
      document.body.appendChild(modal);
    }
    
    function confirmarPermissaoNotificacao() {
      fecharModalPermissao();
      Notification.requestPermission().then(function(permission) {
        if (permission === 'granted') {
          mostrarToast('‚úÖ Notifica√ß√µes ativadas!', 'success');
          console.log('‚úÖ Permiss√£o de notifica√ß√£o concedida');
        } else {
          mostrarToast('‚ö†Ô∏è Notifica√ß√µes n√£o ativadas', 'warning');
        }
      });
    }
    
    function fecharModalPermissao() {
      var modal = document.getElementById('modal-permissao');
      if (modal) modal.remove();
    }
    
    // Preparar √°udio de alerta
    function prepararAudioAlerta() {
      // Criar √°udio usando Web Audio API (funciona em segundo plano)
      try {
        audioNovaCorrida = new Audio('data:audio/wav;base64,UklGRnoGAABXQVZFZm10IBAAAAABAAEAQB8AAEAfAAABAAgAZGF0YQoGAACBhYqFbF1fdJivrJBhNjVgodDbq2EcBj+a2teleisRPprV5qp7MRgrjNXmqncsEDGLz+WqfTMRNonP5ap3LREzi8/lqnszEDiM0+SqeTIQO4vT5ap5MhA9jdPkqnowEECO0+SqdTAQQ47T5ap3LxBEj9PlqnYuEESQ0+WqdS0QRY/U5ap1LRBGj9TlqnUtEEeP1OSqdS0QR5DU5Kp1LBBIkNTkqnUsEEmQ1OSqdSwQSpDU5Kp0KxBLkNTkqnQrEEuR1OSqdCsQTJHU5Kp0KxBMkdTkqnQrEE2R1OSqdCsQTZHU5Kp0KhBOkdTkqnQqEE6R1OSqcyoQT5HU46pzKhBPkdTjqnMqEFCR1OOqcyoQUJHU46pzKhBQkdTjqnMqEFGR1OOqcyoQUZHU46pzKhBRkdTjqnIpEFKR1OOqcikQUpHU46pyKRBSkdTjqnIpEFOR1OOqcikQU5HU46pyKRBTkdPjqnIpEFSR0+OqcikQVJHT46pyKRBUkdPjqnIpEFSR0+OqcikQVJHT46pyKRBVkdPjqnIpEFWR0+OqcikQVZHT46pyKRBVkdPjqnIoEFaR0+OqcigQVpHT46pyKBBWkdPjqnIoEFaR0+OqcigQVpHT46pyKBBWkdPjqnIoEFeR0+OqcigQV5HT46pyKBBXkdPjqnIoEFeR0+OqcigQV5HT46pyKBBXkdPjqnIoEFeR0+OqcScQWJHT4qpxJxBYkdPiqnEnEFiR0+KqcScQWJHT4qpxJxBYkdPiqnEnEFiR0+KqcScQWJHT4qpxJxBYkdPiqnEnEFmR0+KqcScQWZHT4qpxJxBZkdPiqnEmEFmR0+KqcSYQWZHT4qpxJhBZkdPiqnEmEFqR0+KqcSYQWpHT4qpxJhBakdPiqnEmEFqR0+KqcSYQWpHT4qpwJhBbkdPiqnAmEFuR0+KqcCYQW5HT4apwJhBbkdPhqnAmEFuR0+GqcCYQW5HT4apwJhBbkdPhqnAmEFyR0+GqcCYQXJHT4apwJhBckdPhqnAmEFyR0+GqcCYQXJHT4apwJhBckdPhqnAmEFyR0+GqcCYQXJHT4apwJhBdkdPhqnAmEF2R0+GqcCYQXZHT4apwJRBdkdPhqnAlEF2R0+GqcCUQXZHT4apwJRBdkdPhqnAlEF6R0+GqcCUQXpHT4apwJRBekdPhqnAlEF6R0+GqcCUQXpHT4apwJRBekdPhqnAlEF6R0+GqcCUQXpHT4apwJRBekdPhqnAlEF6R0+GpcCUQX5HT4apwJRBfkdPhqXAlEF+R0+GpcCUQX5HT4alwJRBfkdPhqXAlEF+R0+GpcCUQX5HT4alwJRBfkdPhqXAlEGCR0+GpcCQQYJHT4alwJBBgkdPhqXAkEGCR0+GpcCQQYJHT4alwJBBgkdPhqXAkEGCR0+GpcCQQYJHT4alwJBBgkdLhqXAkEGCR0uGpcCQQYJHS4alwJBBgkdLhqXAkEGGR0uGpcCQQYZHS4alwJBBhkdLhqXAkEGGR0uGpcCQQYZHS4alwJBBhkdLhqW8kEGGR0uGpbyQQYZHS4alvJBBhkdLhqW8kEGGR0uGpbyQQYZHS4alvJBBikdLhqW8kEGKR0uGpbyQQYpHS4alvJBBikdLhqW8jEGKR0uGpbyMQYpHS4alvIxBikdLhqW8jEGKR0uGpbyMQYpHS4alvIxBikdLhqW8jEGKR0uGpbyMQY5HS4alvIxBjkdLhqW8jEGOR0uGpbyMQY5HS4alvIxBjkdLhqW8jEGOR0uGpbyMQY5HS4alvIxBjkdLhqW8jEGOR0uGpbyIQZJHS4alvIhBkkdLhqW8iEGSR0uGpbyIQZJHS4alvIhBkkdLhqW8iEGSR0uGpbyIQZJHS4alvIhBkkdLhqW8iEGSR0uGpbyIQZJHS4alvIhBkkdLhqW8iEGSR0uGpbx8=');
        audioNovaCorrida.loop = false;
        audioNovaCorrida.volume = 1.0;
        console.log('‚úÖ √Åudio de alerta preparado');
      } catch (e) {
        console.log('‚ö†Ô∏è Erro ao preparar √°udio:', e);
      }
    }
    
    // Configurar listener do Service Worker
    function configurarListenerSW() {
      if ('serviceWorker' in navigator && navigator.serviceWorker.controller) {
        navigator.serviceWorker.addEventListener('message', function(event) {
          if (event.data.tipo === 'NOTIFICACAO_CLICADA') {
            window.focus();
            pararAlerta();
          }
        });
      }
    }
    
    // ========================================
    // ENVIAR NOTIFICA√á√ÉO DE NOVA CORRIDA
    // Funciona em SEGUNDO PLANO
    // ========================================
    function enviarNotificacaoNovaCorrida(corrida) {
      console.log('üîî Enviando notifica√ß√£o de nova corrida...');
      
      // 1. Tocar som de alerta (em loop)
      tocarAlertaCorrida();
      
      // 2. Vibrar dispositivo
      vibrarDispositivo();
      
      // 3. Mostrar notifica√ß√£o via Service Worker (funciona em background)
      if (serviceWorkerRegistration && serviceWorkerRegistration.active) {
        serviceWorkerRegistration.active.postMessage({
          tipo: 'NOVA_CORRIDA',
          corrida: {
            id: corrida.id || Date.now(),
            origem: corrida.origem_endereco || corrida.origem || 'Endere√ßo n√£o informado',
            destino: corrida.destino_endereco || corrida.destino,
            valor: corrida.valor || 0,
            distancia: corrida.distancia_km ? corrida.distancia_km.toFixed(1) + ' km' : null,
            cliente: corrida.nome_cliente || 'Cliente'
            referencia: corrida.origem_referencia || corrida.referencia || null
          }
        });
        console.log('‚úÖ Notifica√ß√£o enviada ao Service Worker');
      } else {
        // Fallback: notifica√ß√£o direta
        enviarNotificacaoLocal(
          'üöó NOVA CORRIDA!',
          'üìç ' + (corrida.origem_endereco || 'Nova solicita√ß√£o de corrida'),
          'üöó'
        );
      }
    }
    
    // Tocar alerta de corrida (em loop at√© intera√ß√£o)
    function tocarAlertaCorrida() {
      pararAlerta(); // Parar qualquer alerta anterior
      
      // Tocar imediatamente
      tocarSom('corrida');
      
      // Repetir a cada 3 segundos at√© o motorista interagir
      intervalSom = setInterval(function() {
        tocarSom('corrida');
        vibrarDispositivo();
      }, 3000);
      
      // Parar automaticamente ap√≥s 60 segundos
      setTimeout(function() {
        pararAlerta();
      }, 60000);
    }
    
    // Parar alerta
    function pararAlerta() {
      if (intervalSom) {
        clearInterval(intervalSom);
        intervalSom = null;
      }
      // Parar vibra√ß√£o
      if (navigator.vibrate) {
        navigator.vibrate(0);
      }
    }
    
    // Vibrar dispositivo
    function vibrarDispositivo() {
      if (navigator.vibrate) {
        navigator.vibrate([300, 100, 300, 100, 300]);
      }
    }
    
    // Enviar notifica√ß√£o local (quando SW n√£o dispon√≠vel)
    function enviarNotificacaoLocal(titulo, corpo, icone) {
      if ('Notification' in window && Notification.permission === 'granted') {
        var notificacao = new Notification(titulo, {
          body: corpo,
          icon: icone || 'üöó',
          badge: 'üöó',
          vibrate: [300, 100, 300, 100, 300],
          tag: 'corrida-' + Date.now(),
          renotify: true,
          requireInteraction: true, // N√ÉO desaparece sozinha
          silent: false
        });

        notificacaoAtiva = notificacao;

        notificacao.onclick = function() {
          window.focus();
          pararAlerta();
          notificacao.close();
        };
      }
    }

    // ========================================
    // API WHATSAPP (via servidor)
    // ========================================
    function enviarWhatsApp(telefone, mensagem) {
      /*
      fetch('/api/whatsapp/enviar', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({
          telefone: telefone,
          mensagem: mensagem
        })
      })
      .then(response => response.json())
      .then(data => {
        console.log('WhatsApp enviado:', data);
      });
      */
      
      // Fallback: Abrir WhatsApp Web
      var url = 'https://wa.me/' + telefone.replace(/\D/g, '') + '?text=' + encodeURIComponent(mensagem);
      window.open(url, '_blank');
    }

    // ========================================
    // API DE PAGAMENTOS
    // ========================================
    function registrarPagamento(valor, tipo, descricao) {
      var pagamento = {
        motoristaId: 'motorista_001',
        valor: valor,
        tipo: tipo, // 'entrada' ou 'saida'
        descricao: descricao,
        corridaId: estadoCorrida !== 'nenhuma' ? 'corrida_atual' : null,
        timestamp: new Date().toISOString(),
        localizacao: minhaLocalizacao
      };

      /*
      fetch('/api/pagamentos', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(pagamento)
      })
      .then(response => response.json())
      .then(data => {
        mostrarToast('Pagamento registrado!', 'success');
      });
      */

      console.log('üí∞ Pagamento registrado:', pagamento);
      return pagamento;
    }

    // ========================================
    // API CVS - CENTRAL DE ATENDIMENTO
    // ========================================
    function ligarViaCVS(destinoTipo) {
      // destinoTipo: 'cliente' ou 'motorista'
      var dados = {
        motoristaId: 'motorista_001',
        corridaId: 'corrida_atual',
        tipo: destinoTipo,
        timestamp: new Date().toISOString()
      };

      /*
      // Integra√ß√£o com Twilio ou similar
      fetch('/api/cvs/ligar', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(dados)
      })
      .then(response => response.json())
      .then(data => {
        if (data.success) {
          // Iniciar chamada
          window.location.href = 'tel:' + data.numeroMascarado;
        }
      });
      */

      mostrarToast('üìû Conectando via Central...', 'info');
      console.log('üìû CVS:', dados);
    }

    // ========================================
    // STORAGE LOCAL (offline first)
    // ========================================
    var DB_NAME = 'ubmax_motorista';

    function salvarLocal(chave, dados) {
      try {
        localStorage.setItem(DB_NAME + '_' + chave, JSON.stringify(dados));
      } catch (e) {
        console.error('Erro ao salvar local:', e);
      }
    }

    function carregarLocal(chave) {
      try {
        var dados = localStorage.getItem(DB_NAME + '_' + chave);
        return dados ? JSON.parse(dados) : null;
      } catch (e) {
        console.error('Erro ao carregar local:', e);
        return null;
      }
    }

    function removerLocal(chave) {
      try {
        localStorage.removeItem(DB_NAME + '_' + chave);
      } catch (e) {
        console.error('Erro ao remover local:', e);
      }
    }

    // Salvar corrida offline
    function salvarCorridaOffline(corrida) {
      var corridas = carregarLocal('corridas_pendentes') || [];
      corridas.push(corrida);
      salvarLocal('corridas_pendentes', corridas);
    }

    // Sincronizar dados quando voltar online
    function sincronizarDados() {
      var corridasPendentes = carregarLocal('corridas_pendentes') || [];
      
      if (corridasPendentes.length > 0) {
        /*
        fetch('/api/sync/corridas', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ corridas: corridasPendentes })
        })
        .then(response => response.json())
        .then(data => {
          if (data.success) {
            salvarLocal('corridas_pendentes', []);
            mostrarToast('Dados sincronizados!', 'success');
          }
        });
        */
        console.log('üì§ Sincronizando', corridasPendentes.length, 'corridas');
      }
    }

    // Verificar conex√£o
    window.addEventListener('online', function() {
      mostrarToast('üåê Conex√£o restaurada', 'success');
      sincronizarDados();
    });

    window.addEventListener('offline', function() {
      mostrarToast('üì¥ Sem conex√£o - Modo offline', 'warning');
    });

    // ========================================
    // INICIALIZA√á√ÉO COMPLETA
    // ========================================
    async function inicializarSistema() {
      console.log('üöÄ Inicializando UBMAX...');
      
      // PRIMEIRO: Verificar token na URL ou sess√£o salva
      var logado = await verificarTokenURL();
      
      if (!logado) {
        console.log('üìã Aguardando login...');
        // Mostrar tela de login
        document.getElementById('tela-login').style.display = 'flex';
        document.getElementById('tela-principal').style.display = 'none';
      } else {
        // Logado com sucesso - auto-iniciar GPS
        console.log('üìç Verificando GPS...');
        setTimeout(autoIniciarGPS, 1000); // Aguardar 1 segundo para UI carregar
      }
      
      console.log('‚úÖ Sistema pronto!');
    }

    // Inicializar ao carregar p√°gina
    document.addEventListener('DOMContentLoaded', inicializarSistema);
    
    // Tamb√©m auto-iniciar GPS quando fizer login manualmente
    function onLoginSucesso() {
      console.log('‚úÖ Login realizado - iniciando GPS automaticamente');
      setTimeout(autoIniciarGPS, 500);
    }
    
    // Abrir navega√ß√£o no Waze com GPS real
    function abrirWaze() {
      var destLat, destLng;
      
      if (estadoCorrida === 'aceita') {
        destLat = coordCliente.lat;
        destLng = coordCliente.lng;
      } else {
        destLat = coordDestino.lat;
        destLng = coordDestino.lng;
      }
      
      var url = 'https://waze.com/ul?ll=' + destLat + ',' + destLng + '&navigate=yes';
      window.open(url, '_blank');
    }
    
    // Abrir navega√ß√£o no Google Maps com GPS real
    function abrirGoogleMaps() {
      var destLat, destLng;
      
      if (estadoCorrida === 'aceita') {
        destLat = coordCliente.lat;
        destLng = coordCliente.lng;
      } else {
        destLat = coordDestino.lat;
        destLng = coordDestino.lng;
      }
      
      var url = 'https://www.google.com/maps/dir/?api=1';
      if (minhaLocalizacao.lat) {
        url += '&origin=' + minhaLocalizacao.lat + ',' + minhaLocalizacao.lng;
      }
      url += '&destination=' + destLat + ',' + destLng;
      url += '&travelmode=driving';
      
      window.open(url, '_blank');
    }
    
    // Vari√°veis do mapa
    var marcadorMotorista = null;
    var marcadorCliente = null;
    var marcadorDestino = null;
    
    // Sistema de Sons (usando Web Audio API)
    var audioContext = null;
    
    function inicializarAudio() {
      if (!audioContext) {
        audioContext = new (window.AudioContext || window.webkitAudioContext)();
      }
    }
    
    function tocarSom(tipo) {
      if (somMudo) return;
      inicializarAudio();
      
      var osc = audioContext.createOscillator();
      var gain = audioContext.createGain();
      osc.connect(gain);
      gain.connect(audioContext.destination);
      
      if (tipo === 'corrida') {
        // Som de nova corrida - apito urgente
        osc.frequency.value = 800;
        gain.gain.value = 0.3;
        osc.start();
        setTimeout(function() { osc.frequency.value = 1000; }, 150);
        setTimeout(function() { osc.frequency.value = 800; }, 300);
        setTimeout(function() { osc.frequency.value = 1000; }, 450);
        setTimeout(function() { osc.frequency.value = 800; }, 600);
        setTimeout(function() { osc.stop(); }, 800);
      } 
      else if (tipo === 'finalizada') {
        // Som de corrida finalizada - sucesso
        osc.frequency.value = 523;
        gain.gain.value = 0.2;
        osc.start();
        setTimeout(function() { osc.frequency.value = 659; }, 150);
        setTimeout(function() { osc.frequency.value = 784; }, 300);
        setTimeout(function() { osc.stop(); }, 500);
      }
      else if (tipo === 'dinheiro') {
        // Som de dinheiro - moedas
        osc.type = 'sine';
        osc.frequency.value = 1200;
        gain.gain.value = 0.15;
        osc.start();
        setTimeout(function() { osc.frequency.value = 1400; }, 80);
        setTimeout(function() { osc.frequency.value = 1600; }, 160);
        setTimeout(function() { osc.frequency.value = 1800; }, 240);
        setTimeout(function() { osc.stop(); }, 350);
      }
      else if (tipo === 'mensagem') {
        // Som de nova mensagem
        osc.type = 'sine';
        osc.frequency.value = 600;
        gain.gain.value = 0.15;
        osc.start();
        setTimeout(function() { osc.frequency.value = 800; }, 100);
        setTimeout(function() { osc.stop(); }, 200);
      }
      else if (tipo === 'urgente') {
        // Som de PRIORIDADE/URG√äNCIA - alarme intenso
        osc.type = 'square';
        osc.frequency.value = 880;
        gain.gain.value = 0.4;
        osc.start();
        // Padr√£o de alarme: alto-baixo-alto-baixo
        setTimeout(function() { osc.frequency.value = 660; }, 200);
        setTimeout(function() { osc.frequency.value = 880; }, 400);
        setTimeout(function() { osc.frequency.value = 660; }, 600);
        setTimeout(function() { osc.frequency.value = 880; }, 800);
        setTimeout(function() { osc.frequency.value = 660; }, 1000);
        setTimeout(function() { osc.frequency.value = 1100; }, 1200);
        setTimeout(function() { osc.stop(); }, 1500);
      }
    }
    
    function toggleMudo() {
      somMudo = !somMudo;
      var btn = document.getElementById('btn-mudo');
      if (somMudo) {
        btn.innerHTML = 'üîá';
        btn.title = 'Som desativado';
        mostrarToast('Sons desativados', 'info');
      } else {
        btn.innerHTML = 'üîä';
        btn.title = 'Som ativado';
        mostrarToast('Sons ativados', 'success');
      }
    }
    
    // Vari√°veis de tempo
    var tempoInicioCorrida = null;
    var tempoChegouCliente = null;
    var tempoInicioViagem = null;
    var cronometroInterval = null;
    var historicoCount = 128;
    var historicoCorridas = [];

    // Coordenadas de exemplo (S√£o Paulo)
    var coordMotorista = { lat: -23.5505, lng: -46.6333 };
    var coordCliente = { lat: -23.5605, lng: -46.6433 };
    var coordDestino = { lat: -23.5705, lng: -46.6533 };
    var enderecoCliente = "Rua das Flores, 123 - Centro, S√£o Paulo";
    
    // Fun√ß√µes de cron√¥metro
    function iniciarCronometro() {
      cronometroInterval = setInterval(function() {
        if (tempoInicioCorrida) {
          var agora = new Date();
          var diff = Math.floor((agora - tempoInicioCorrida) / 1000);
          var min = Math.floor(diff / 60);
          var seg = diff % 60;
          document.getElementById('tempo-valor').textContent = 
            (min < 10 ? '0' : '') + min + ':' + (seg < 10 ? '0' : '') + seg;
        }
      }, 1000);
    }
    
    function pararCronometro() {
      if (cronometroInterval) {
        clearInterval(cronometroInterval);
        cronometroInterval = null;
      }
    }

    // ========================================
    // VARI√ÅVEIS GLOBAIS DO MOTORISTA
    // ========================================
    var motoristaLogado = null;
    var tokenSessao = null;
    var dadosFrota = {
      nome: 'UBMAX',
      whatsapp: '5514999990001'
    };

    // ========================================
    // VERIFICAR TOKEN NA URL (Link do ADM)
    // ========================================
    async function verificarTokenURL() {
      var urlParams = new URLSearchParams(window.location.search);
      var tokenAcesso = urlParams.get('token');
      
      if (tokenAcesso) {
        console.log('üîó Token de acesso encontrado na URL');
        
        try {
          var response = await fetch('/api/auth/motorista/acesso', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ token_acesso: tokenAcesso })
          });
          
          var result = await response.json();
          
          if (result.success) {
            console.log('‚úÖ Login via link autorizado:', result.data.nome);
            
            // Salvar dados
            motoristaLogado = result.data;
            tokenSessao = result.data.token;
            dadosFrota = result.data.frota || dadosFrota;
            
            // Salvar no localStorage
            salvarLocal('motorista', motoristaLogado);
            salvarLocal('tokenSessao', tokenSessao);
            
            // Fazer login
            fazerLoginComDados(motoristaLogado);
            
            // Limpar token da URL (seguran√ßa)
            window.history.replaceState({}, document.title, '/motorista');
            
            return true;
          } else {
            mostrarErroAcesso(result.error || 'Link inv√°lido');
            return false;
          }
        } catch (error) {
          console.error('Erro ao verificar token:', error);
          mostrarErroAcesso('Erro ao conectar. Tente novamente.');
          return false;
        }
      }
      
      // Verificar se tem sess√£o salva
      var sessaoSalva = carregarLocal('tokenSessao');
      if (sessaoSalva) {
        return await verificarSessaoSalva(sessaoSalva);
      }
      
      // Sem token e sem sess√£o - mostrar tela de login
      return false;
    }

    // Verificar sess√£o salva
    async function verificarSessaoSalva(token) {
      try {
        var response = await fetch('/api/auth/motorista/verificar', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ token: token })
        });
        
        var result = await response.json();
        
        if (result.success) {
          motoristaLogado = result.data;
          tokenSessao = token;
          fazerLoginComDados(motoristaLogado);
          return true;
        }
      } catch (error) {
        console.error('Sess√£o inv√°lida');
      }
      
      // Limpar sess√£o inv√°lida
      removerLocal('tokenSessao');
      return false;
    }

    // Mostrar erro de acesso
    function mostrarErroAcesso(mensagem) {
      document.getElementById('tela-login').innerHTML = `
        <div class="login-header">
          <span class="logo-icon">üö´</span>
          <h1>Acesso Negado</h1>
          <p style="color: var(--danger); margin-top: 16px;">${mensagem}</p>
          <p style="margin-top: 24px; color: var(--text-muted);">
            Solicite um novo link de acesso ao administrador da frota.
          </p>
          <div style="margin-top: 32px; padding: 20px; background: var(--bg-body); border-radius: var(--radius); text-align: left;">
            <p style="font-weight: 600; margin-bottom: 8px;">üìû Contato da Frota:</p>
            <p style="color: var(--text-secondary);">WhatsApp: ${dadosFrota.whatsapp}</p>
          </div>
        </div>
      `;
    }

    // Fazer login com dados do motorista
    function fazerLoginComDados(motorista) {
      // Salvar empresa_id para White Label
      if (motorista.empresa_id) {
        localStorage.setItem('empresa_id', motorista.empresa_id);
      }
      
      // Recarregar nome da empresa (White Label)
      EMPRESA_CONFIG = carregarNomeEmpresa();
      
      // Atualizar header com nome
      document.getElementById('motorista-nome').textContent = motorista.nome;
      
      // Atualizar info da frota no painel
      atualizarInfoFrota();
      
      // Mostrar tela principal
      document.getElementById('tela-login').style.display = 'none';
      document.getElementById('tela-principal').style.display = 'block';
      document.getElementById('fab-container').style.display = 'flex';
      
      // AUTO-INICIAR GPS (j√° verifica permiss√£o anterior)
      // Se j√° foi permitido antes, inicia automaticamente
      // Se n√£o, apenas prepara para quando o usu√°rio clicar
      autoIniciarGPS();
      
      // Conectar WebSocket
      conectarWebSocket();
      
      // Verificar mensalidade do motorista
      verificarMinhaMensalidade(motorista);
      
      // Atualizar hist√≥rico de manuten√ß√µes
      atualizarHistoricoManutencoes();
      
      mostrarToast('Bem-vindo, ' + motorista.nome + '!', 'success');
    }
    
    // Verificar mensalidade do motorista
    function verificarMinhaMensalidade(motorista) {
      var alertaEl = document.getElementById('alerta-mensalidade');
      var cardEl = document.getElementById('card-mensalidade');
      var iconEl = document.getElementById('icon-mensalidade');
      var tituloEl = document.getElementById('titulo-mensalidade');
      var textoEl = document.getElementById('texto-mensalidade');
      var valorEl = document.getElementById('valor-mensalidade');
      var dataEl = document.getElementById('data-mensalidade');
      
      // Dados de mensalidade (pode vir do servidor ou localStorage)
      var valor = motorista.valorMensalidade || 150;
      var tipoRecorrencia = motorista.tipoRecorrencia || 'mensal';
      var diaVencimento = motorista.diaVencimento || 10;
      var diaSemana = motorista.diaSemana || 5;
      var statusMensalidade = motorista.mensalidadeStatus || 'pendente';
      
      var diasSemana = ['Domingo', 'Segunda', 'Ter√ßa', 'Quarta', 'Quinta', 'Sexta', 'S√°bado'];
      var hoje = new Date();
      var diaSemanaHoje = hoje.getDay();
      var diaHoje = hoje.getDate();
      
      // Calcular pr√≥ximo vencimento
      var diasAteVencimento = 0;
      var textoVencimento = '';
      
      if (tipoRecorrencia === 'semanal') {
        diasAteVencimento = (diaSemana - diaSemanaHoje + 7) % 7;
        if (diasAteVencimento === 0 && statusMensalidade !== 'pago') diasAteVencimento = 0; // Vence hoje
        textoVencimento = diasSemana[diaSemana];
      } else if (tipoRecorrencia === 'quinzenal') {
        diasAteVencimento = (diaSemana - diaSemanaHoje + 14) % 14;
        textoVencimento = 'Quinzenal - ' + diasSemana[diaSemana];
      } else {
        diasAteVencimento = diaVencimento - diaHoje;
        if (diasAteVencimento < 0) diasAteVencimento += 30;
        textoVencimento = 'Dia ' + diaVencimento;
      }
      
      // Definir estilo baseado no status
      if (statusMensalidade === 'pago') {
        // Pago - verde
        cardEl.style.background = 'linear-gradient(135deg, #dcfce7, #bbf7d0)';
        cardEl.style.border = '2px solid #10b981';
        iconEl.style.background = '#10b981';
        iconEl.textContent = '‚úÖ';
        tituloEl.textContent = 'Mensalidade em Dia';
        tituloEl.style.color = '#166534';
        textoEl.textContent = 'Obrigado pelo pagamento!';
        textoEl.style.color = '#15803d';
        valorEl.style.color = '#166534';
        dataEl.textContent = 'Pr√≥x: ' + textoVencimento;
        dataEl.style.color = '#15803d';
        alertaEl.classList.remove('hidden');
      } else if (diasAteVencimento <= 0) {
        // Vence hoje ou atrasado - vermelho
        cardEl.style.background = 'linear-gradient(135deg, #fef2f2, #fecaca)';
        cardEl.style.border = '2px solid #ef4444';
        iconEl.style.background = '#ef4444';
        iconEl.textContent = '‚ö†Ô∏è';
        tituloEl.textContent = diasAteVencimento === 0 ? 'üîî Vence HOJE!' : '‚ùå ATRASADO';
        tituloEl.style.color = '#dc2626';
        textoEl.textContent = diasAteVencimento === 0 
          ? 'Sua mensalidade vence hoje. Efetue o pagamento!'
          : 'Sua mensalidade est√° atrasada. Regularize para continuar!';
        textoEl.style.color = '#b91c1c';
        valorEl.style.color = '#dc2626';
        dataEl.textContent = textoVencimento;
        dataEl.style.color = '#b91c1c';
        alertaEl.classList.remove('hidden');
      } else if (diasAteVencimento <= 3) {
        // Vence em breve - amarelo
        cardEl.style.background = 'linear-gradient(135deg, #fefce8, #fef08a)';
        cardEl.style.border = '2px solid #f59e0b';
        iconEl.style.background = '#f59e0b';
        iconEl.textContent = '‚è∞';
        tituloEl.textContent = 'Mensalidade Pr√≥xima';
        tituloEl.style.color = '#92400e';
        textoEl.textContent = 'Vence em ' + diasAteVencimento + ' dia(s)';
        textoEl.style.color = '#a16207';
        valorEl.style.color = '#92400e';
        dataEl.textContent = textoVencimento;
        dataEl.style.color = '#a16207';
        alertaEl.classList.remove('hidden');
      } else {
        // Muito tempo at√© vencer - esconder ou mostrar discreto
        alertaEl.classList.add('hidden');
      }
      
      valorEl.textContent = 'R$ ' + valor.toFixed(0);
    }

    // Atualizar informa√ß√µes da frota no painel
    function atualizarInfoFrota() {
      // Adicionar banner com n√∫mero da Rebeca se n√£o existir
      var headerEl = document.querySelector('.header');
      if (headerEl && !document.getElementById('info-rebeca')) {
        var infoRebeca = document.createElement('div');
        infoRebeca.id = 'info-rebeca';
        infoRebeca.style.cssText = 'width: 100%; padding: 10px 20px; background: linear-gradient(135deg, #10b981, #059669); color: white; text-align: center; font-size: 13px;';
        infoRebeca.innerHTML = 'üì± WhatsApp da Rebeca: <strong><a href="https://wa.me/' + dadosFrota.whatsapp + '" style="color: white;">' + formatarTelefone(dadosFrota.whatsapp) + '</a></strong>';
        headerEl.parentNode.insertBefore(infoRebeca, headerEl);
      }
    }

    // Formatar telefone para exibi√ß√£o
    function formatarTelefone(tel) {
      if (!tel) return '';
      tel = tel.replace(/\D/g, '');
      if (tel.startsWith('55')) tel = tel.substring(2);
      if (tel.length === 11) {
        return '(' + tel.substring(0,2) + ') ' + tel.substring(2,7) + '-' + tel.substring(7);
      }
      return tel;
    }

    // Conectar WebSocket com autentica√ß√£o
    function conectarWebSocket() {
      if (!motoristaLogado) return;
      
      if (typeof io !== 'undefined') {
        socket = io({
          query: {
            tipo: 'motorista',
            motorista_id: motoristaLogado.id,
            token: tokenSessao
          }
        });
        
        socket.on('connect', function() {
          console.log('üîå WebSocket conectado');
        });
        
        socket.on('nova-corrida', function(corrida) {
          console.log('üöó Nova corrida recebida:', corrida);
          receberNovaCorrida(corrida);
        });
      }
    }

    function fazerLogin() {
      // Login manual (telefone + senha)
      var telefone = document.getElementById('login-telefone').value.replace(/\D/g, '');
      var senha = document.getElementById('login-senha').value;
      
      if (!telefone || !senha) {
        mostrarToast('Preencha telefone e senha', 'error');
        return;
      }
      
      fetch('/api/auth/motorista/login', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ telefone: telefone, senha: senha })
      })
      .then(function(r) {
        // Verificar se √© JSON v√°lido
        var contentType = r.headers.get('content-type');
        if (!contentType || contentType.indexOf('application/json') === -1) {
          throw new Error('Servidor n√£o dispon√≠vel');
        }
        return r.json();
      })
      .then(function(result) {
        if (result.success) {
          motoristaLogado = result.data;
          dadosMotorista = result.data;
          tokenSessao = result.data.token;
          salvarLocal('motorista', motoristaLogado);
          salvarLocal('tokenSessao', tokenSessao);
          fazerLoginComDados(motoristaLogado);
        } else {
          mostrarToast(result.error || 'Telefone ou senha incorretos', 'error');
        }
      })
      .catch(function(err) {
        console.error('Erro:', err);
        mostrarToast('Telefone ou senha incorretos', 'error');
      });
    }

    function fazerLogout() {
      // Notificar servidor
      if (tokenSessao) {
        fetch('/api/auth/motorista/logout', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ token: tokenSessao })
        });
      }
      
      // Limpar dados
      motoristaLogado = null;
      tokenSessao = null;
      removerLocal('motorista');
      removerLocal('tokenSessao');
      
      document.getElementById('tela-principal').style.display = 'none';
      document.getElementById('tela-login').style.display = 'flex';
      document.getElementById('fab-container').style.display = 'none';
      
      // PARAR GPS AO FAZER LOGOUT
      pararGPS();
      
      online = false;
      document.getElementById('toggle-status').checked = false;
      atualizarStatusUI();
      esconderMapa();
      
      // Recarregar p√°gina para limpar tudo
      window.location.href = '/motorista';
    }

    function alternarStatus() {
      online = document.getElementById('toggle-status').checked;
      atualizarStatusUI();
      
      // INTEGRA√á√ÉO COM ADM - Atualizar status online/offline
      enviarLocalizacaoParaADM();
      
      if (online) {
        // Verificar se GPS est√° ativo
        if (!gpsAtivo) {
          iniciarGPS();
        }
        mostrarToast('Voc√™ est√° online!', 'success');
        setTimeout(function() { if (online && estadoCorrida === 'nenhuma') receberNovaCorrida(); }, 3000);
        
        // INICIAR MONITORAMENTO DE SEGUNDO PLANO
        iniciarMonitoramentoSegundoPlano();
      } else {
        mostrarToast('Voc√™ est√° offline', 'info');
        esconderMapa();
        
        // PARAR MONITORAMENTO
        pararMonitoramentoSegundoPlano();
      }
    }
    
    // ========================================
    // ALERTA DE SEGUNDO PLANO
    // Lembra o motorista de voltar ao app
    // ========================================
    var intervaloAlertaSegundoPlano = null;
    var appEmSegundoPlano = false;
    var INTERVALO_ALERTA_MS = 2 * 60 * 1000; // 2 minutos
    
    function iniciarMonitoramentoSegundoPlano() {
      console.log('üëÅÔ∏è Iniciando monitoramento de segundo plano...');
      
      // Listener para detectar quando app vai para segundo plano
      document.addEventListener('visibilitychange', onVisibilityChange);
      
      // Verificar estado inicial
      if (document.hidden) {
        appEmSegundoPlano = true;
        iniciarAlertasSegundoPlano();
      }
    }
    
    function pararMonitoramentoSegundoPlano() {
      console.log('üëÅÔ∏è Parando monitoramento de segundo plano');
      
      document.removeEventListener('visibilitychange', onVisibilityChange);
      pararAlertasSegundoPlano();
      appEmSegundoPlano = false;
    }
    
    function onVisibilityChange() {
      if (document.hidden) {
        // App foi para segundo plano
        console.log('üì± App em SEGUNDO PLANO');
        appEmSegundoPlano = true;
        
        // S√≥ alertar se estiver ONLINE
        if (online) {
          iniciarAlertasSegundoPlano();
        }
      } else {
        // App voltou para primeiro plano
        console.log('üì± App em PRIMEIRO PLANO');
        appEmSegundoPlano = false;
        pararAlertasSegundoPlano();
      }
    }
    
    function iniciarAlertasSegundoPlano() {
      // Limpar intervalo anterior se existir
      pararAlertasSegundoPlano();
      
      console.log('‚è∞ Iniciando alertas a cada 2 minutos');
      
      // Primeiro alerta ap√≥s 2 minutos
      intervaloAlertaSegundoPlano = setInterval(function() {
        // S√≥ alertar se AINDA estiver online E em segundo plano
        if (online && appEmSegundoPlano) {
          enviarAlertaVoltarTrabalho();
        } else {
          // Se ficou offline ou voltou ao app, parar alertas
          pararAlertasSegundoPlano();
        }
      }, INTERVALO_ALERTA_MS);
    }
    
    function pararAlertasSegundoPlano() {
      if (intervaloAlertaSegundoPlano) {
        clearInterval(intervaloAlertaSegundoPlano);
        intervaloAlertaSegundoPlano = null;
        console.log('‚è∞ Alertas de segundo plano parados');
      }
    }
    
    function enviarAlertaVoltarTrabalho() {
      console.log('üîî Enviando alerta: Voltar √† √°rea de trabalho');
      
      // 1. Vibrar dispositivo
      if (navigator.vibrate) {
        navigator.vibrate([200, 100, 200]);
      }
      
      // 2. Enviar notifica√ß√£o via Service Worker
      if (serviceWorkerRegistration && serviceWorkerRegistration.active) {
        serviceWorkerRegistration.active.postMessage({
          tipo: 'ALERTA_VOLTAR_TRABALHO'
        });
      }
      
      // 3. Notifica√ß√£o local (fallback)
      if ('Notification' in window && Notification.permission === 'granted') {
        var notificacao = new Notification('üìç Volte √† √°rea de trabalho', {
          body: 'Voc√™ est√° ONLINE mas o app est√° minimizado. Volte para n√£o perder corridas!',
          icon: 'üöó',
          tag: 'alerta-trabalho-' + Date.now(),
          vibrate: [200, 100, 200],
          requireInteraction: false, // Pode desaparecer
          silent: false
        });
        
        notificacao.onclick = function() {
          window.focus();
          notificacao.close();
        };
        
        // Fechar ap√≥s 10 segundos
        setTimeout(function() {
          notificacao.close();
        }, 10000);
      }
    }

    function atualizarStatusUI() {
      var el = document.getElementById('status-texto');
      el.textContent = online ? 'Online' : 'Offline';
      el.className = 'status-value ' + (online ? 'online' : 'offline');
      document.getElementById('sem-corrida-titulo').textContent = online ? 'Aguardando corridas...' : 'Voc√™ est√° offline';
      document.getElementById('sem-corrida-texto').textContent = online ? 'Voc√™ receber√° notifica√ß√µes' : 'Fique online para receber corridas';
    }

    function alternarModoEndereco() {
      var m = document.getElementById('modo-endereco').value;
      document.getElementById('endereco-manual-container').classList.add('hidden');
      document.getElementById('endereco-base-info').classList.add('hidden');
      if (m === 'manual') document.getElementById('endereco-manual-container').classList.remove('hidden');
      if (m === 'base') document.getElementById('endereco-base-info').classList.remove('hidden');
    }

    function abrirConfiguracoes() { document.getElementById('modal-configuracoes').classList.add('active'); }
    function fecharModalConfiguracoes() { aplicarBlurTransicao(); document.getElementById('modal-configuracoes').classList.remove('active'); }
    function salvarConfiguracoesModal() { mostrarToast('Configura√ß√µes salvas!', 'success'); fecharModalConfiguracoes(); }

    // ========================================
    // MAPA E ROTA
    // ========================================
    function inicializarMapa() {
      if (mapa) return;
      
      // Usar GPS real se dispon√≠vel, sen√£o usar padr√£o
      var lat = minhaLocalizacao.lat || coordMotorista.lat;
      var lng = minhaLocalizacao.lng || coordMotorista.lng;
      
      mapa = L.map('mapa').setView([lat, lng], 15);
      
      L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
        attribution: '¬© OpenStreetMap'
      }).addTo(mapa);
      
      // Criar marcador do motorista
      var iconMotorista = L.divIcon({
        html: '<div style="background:#3b82f6;color:white;width:36px;height:36px;border-radius:50%;display:flex;align-items:center;justify-content:center;font-size:18px;border:3px solid white;box-shadow:0 2px 10px rgba(0,0,0,0.3);">üöó</div>',
        iconSize: [36, 36],
        iconAnchor: [18, 18]
      });
      marcadorMotorista = L.marker([lat, lng], { icon: iconMotorista }).addTo(mapa);
    }

    function mostrarRota(destLat, destLng, endereco, isCliente) {
      document.getElementById('mapa-section').classList.remove('hidden');
      
      // Inicializar mapa se necess√°rio
      if (!mapa) {
        setTimeout(function() {
          inicializarMapa();
          desenharRota(destLat, destLng, endereco, isCliente);
        }, 100);
      } else {
        desenharRota(destLat, destLng, endereco, isCliente);
      }
    }

    function desenharRota(destLat, destLng, endereco, isCliente) {
      // Usar GPS real se dispon√≠vel
      var meuLat = minhaLocalizacao.lat || coordMotorista.lat;
      var meuLng = minhaLocalizacao.lng || coordMotorista.lng;
      
      // Limpar rota anterior
      if (rotaLayer) {
        mapa.removeLayer(rotaLayer);
      }
      mapa.eachLayer(function(layer) {
        if (layer instanceof L.Marker || layer instanceof L.Polyline) {
          mapa.removeLayer(layer);
        }
      });

      // Re-adicionar tile layer
      L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
        attribution: '¬© OpenStreetMap'
      }).addTo(mapa);

      // Marcador do motorista (voc√™) - com GPS real
      var iconMotorista = L.divIcon({
        html: '<div style="background:#3b82f6;color:white;width:36px;height:36px;border-radius:50%;display:flex;align-items:center;justify-content:center;font-size:18px;border:3px solid white;box-shadow:0 2px 10px rgba(0,0,0,0.3);">üöó</div>',
        iconSize: [36, 36],
        iconAnchor: [18, 18]
      });
      marcadorMotorista = L.marker([meuLat, meuLng], { icon: iconMotorista })
        .addTo(mapa)
        .bindPopup('üìç Voc√™ est√° aqui');

      // Marcador do destino (cliente ou destino final)
      var iconDestino = L.divIcon({
        html: '<div style="background:' + (isCliente ? '#10b981' : '#ef4444') + ';color:white;width:36px;height:36px;border-radius:50%;display:flex;align-items:center;justify-content:center;font-size:18px;border:3px solid white;box-shadow:0 2px 10px rgba(0,0,0,0.3);">' + (isCliente ? 'üë§' : 'üèÅ') + '</div>',
        iconSize: [36, 36],
        iconAnchor: [18, 18]
      });
      L.marker([destLat, destLng], { icon: iconDestino })
        .addTo(mapa)
        .bindPopup(isCliente ? 'üë§ Cliente aqui' : 'üèÅ Destino');

      // Desenhar linha da rota usando GPS real
      var rota = [
        [meuLat, meuLng],
        [meuLat + (destLat - meuLat) * 0.3, meuLng + (destLng - meuLng) * 0.5],
        [meuLat + (destLat - meuLat) * 0.7, meuLng + (destLng - meuLng) * 0.8],
        [destLat, destLng]
      ];
      
      rotaLayer = L.polyline(rota, {
        color: '#3b82f6',
        weight: 5,
        opacity: 0.8,
        dashArray: '10, 10'
      }).addTo(mapa);

      // Ajustar visualiza√ß√£o
      var bounds = L.latLngBounds([
        [meuLat, meuLng],
        [destLat, destLng]
      ]);
      mapa.fitBounds(bounds, { padding: [50, 50] });

      // Atualizar informa√ß√µes com GPS real
      var distancia = calcularDistancia(meuLat, meuLng, destLat, destLng);
      var tempo = Math.ceil(distancia * 2.5);
      
      document.getElementById('mapa-distancia').textContent = distancia.toFixed(1) + ' km de dist√¢ncia';
      document.getElementById('mapa-tempo').textContent = '~' + tempo + ' min';
      document.getElementById('mapa-endereco-cliente').textContent = endereco;
    }

    function esconderMapa() {
      document.getElementById('mapa-section').classList.add('hidden');
    }

    function calcularDistancia(lat1, lon1, lat2, lon2) {
      var R = 6371;
      var dLat = (lat2 - lat1) * Math.PI / 180;
      var dLon = (lon2 - lon1) * Math.PI / 180;
      var a = Math.sin(dLat/2) * Math.sin(dLat/2) +
              Math.cos(lat1 * Math.PI / 180) * Math.cos(lat2 * Math.PI / 180) *
              Math.sin(dLon/2) * Math.sin(dLon/2);
      var c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
      return R * c;
    }

    function abrirWaze() {
      var destino = estadoCorrida === 'em_andamento' ? coordDestino : coordCliente;
      var url = 'https://waze.com/ul?ll=' + destino.lat + ',' + destino.lng + '&navigate=yes';
      window.open(url, '_blank');
    }

    function abrirGoogleMaps() {
      var destino = estadoCorrida === 'em_andamento' ? coordDestino : coordCliente;
      var url = 'https://www.google.com/maps/dir/?api=1&destination=' + destino.lat + ',' + destino.lng + '&travelmode=driving';
      window.open(url, '_blank');
    }

    function abrirNavegacao() {
      var destino = estadoCorrida === 'em_andamento' ? coordDestino : coordCliente;
      
      // URLs para Waze e Google Maps
      var urlWaze = 'https://waze.com/ul?ll=' + destino.lat + ',' + destino.lng + '&navigate=yes';
      var urlGoogleMaps = 'https://www.google.com/maps/dir/?api=1&destination=' + destino.lat + ',' + destino.lng + '&travelmode=driving';
      
      // Perguntar qual app usar
      var escolha = confirm('Escolha o aplicativo de navega√ß√£o:\n\n‚úì OK = Waze\n‚úï Cancelar = Google Maps');
      
      if (escolha) {
        window.open(urlWaze, '_blank');
      } else {
        window.open(urlGoogleMaps, '_blank');
      }
    }

    // ========================================
    // TIMER DE 30 SEGUNDOS PARA ACEITAR
    // ========================================
    var timerCorridaInterval = null;
    var segundosRestantes = 30;
    
    function iniciarTimer30s() {
      segundosRestantes = 30;
      atualizarTimerUI();
      
      if (timerCorridaInterval) clearInterval(timerCorridaInterval);
      
      timerCorridaInterval = setInterval(function() {
        segundosRestantes--;
        atualizarTimerUI();
        
        if (segundosRestantes <= 0) {
          clearInterval(timerCorridaInterval);
          timerCorridaInterval = null;
          timeoutCorrida();
        }
      }, 1000);
    }
    
    function pararTimer30s() {
      if (timerCorridaInterval) {
        clearInterval(timerCorridaInterval);
        timerCorridaInterval = null;
      }
      var timerEl = document.getElementById('timer-aceitar');
      if (timerEl) timerEl.classList.add('hidden');
    }
    
    function atualizarTimerUI() {
      var timerEl = document.getElementById('timer-aceitar');
      var barraEl = document.getElementById('timer-barra-progresso');
      var textoEl = document.getElementById('timer-texto');
      
      if (timerEl) timerEl.classList.remove('hidden');
      if (textoEl) textoEl.textContent = segundosRestantes + 's';
      if (barraEl) barraEl.style.width = (segundosRestantes / 30 * 100) + '%';
      
      if (barraEl) {
        if (segundosRestantes <= 10) {
          barraEl.style.background = '#ef4444';
        } else if (segundosRestantes <= 20) {
          barraEl.style.background = '#f59e0b';
        } else {
          barraEl.style.background = '#10b981';
        }
      }
    }
    
    function timeoutCorrida() {
      pararAlerta();
      estadoCorrida = 'nenhuma';
      document.getElementById('corrida-section').classList.add('hidden');
      document.getElementById('sem-corrida').classList.remove('hidden');
      document.getElementById('rota-section').classList.add('hidden');
      
      var perdidasEl = document.getElementById('corridas-perdidas');
      if (perdidasEl) {
        var atual = parseInt(perdidasEl.textContent) || 0;
        perdidasEl.textContent = atual + 1;
      }
      
      mostrarToast('‚è∞ Tempo esgotado! Corrida passou para outro motorista.', 'error');
    }

    // ========================================
    // CORRIDAS
    // ========================================
    function receberNovaCorrida(dadosCorrida) {
      estadoCorrida = 'enviada';
      document.getElementById('corrida-section').classList.remove('hidden');
      document.getElementById('sem-corrida').classList.add('hidden');
      document.getElementById('corrida-badge').textContent = 'üÜï Nova Corrida';
      document.getElementById('corrida-badge').className = 'corrida-badge';
      document.getElementById('acoes-container').innerHTML = '<button class="btn btn-danger" onclick="recusarCorrida()">Recusar</button><button class="btn btn-success" onclick="aceitarCorrida()">Aceitar</button>';
      document.getElementById('opcao-finalizar-direto').classList.add('hidden');
      document.getElementById('rota-section').classList.add('hidden');
      
      // INICIAR TIMER 30 SEGUNDOS
      iniciarTimer30s();
      
      // NOTIFICA√á√ÉO EM SEGUNDO PLANO
      enviarNotificacaoNovaCorrida(dadosCorrida || {
        origem_endereco: 'Nova solicita√ß√£o de corrida',
        valor: 0
      });
      
      mostrarToast('Nova corrida recebida!', 'success');
    }

    function aceitarCorrida() {
      // PARAR TIMER E ALERTA
      pararTimer30s();
      pararAlerta();
      
      estadoCorrida = 'aceita';
      tempoInicioCorrida = new Date();
      
      document.getElementById('corrida-badge').textContent = 'üöó A Caminho';
      document.getElementById('corrida-badge').className = 'corrida-badge aceita';
      document.getElementById('acoes-container').innerHTML = '<button class="btn btn-primary btn-block" onclick="chegarNoLocal()">üìç Cheguei no Cliente</button>';
      document.getElementById('opcao-finalizar-direto').classList.remove('hidden');
      
      // MOSTRAR SE√á√ÉO DE ROTA
      document.getElementById('rota-section').classList.remove('hidden');
      document.getElementById('rota-label').textContent = 'üìç Rota at√© o cliente';
      var distancia = calcularDistancia(coordMotorista.lat, coordMotorista.lng, coordCliente.lat, coordCliente.lng);
      var tempo = Math.ceil(distancia * 2.5);
      document.getElementById('rota-distancia').textContent = distancia.toFixed(1) + ' km ‚Ä¢ ~' + tempo + ' min';
      
      // Mostrar tempo da corrida
      document.getElementById('tempo-corrida').classList.remove('hidden');
      iniciarCronometro();
      
      mostrarToast('Corrida aceita!', 'success');
      
      // Mostrar fila ap√≥s 8 segundos
      setTimeout(function() { 
        if (estadoCorrida !== 'nenhuma') { 
          document.getElementById('fila-section').classList.remove('hidden'); 
          mostrarToast('üì• Pr√≥xima corrida!', 'info'); 
        } 
      }, 8000);
    }

    function recusarCorrida() {
      // PARAR TIMER E ALERTA
      pararTimer30s();
      pararAlerta();
      
      estadoCorrida = 'nenhuma';
      document.getElementById('corrida-section').classList.add('hidden');
      document.getElementById('sem-corrida').classList.remove('hidden');
      document.getElementById('rota-section').classList.add('hidden');
      mostrarToast('Corrida recusada', 'info');
    }

    function chegarNoLocal() {
      estadoCorrida = 'aguardando_cliente';
      tempoChegouCliente = new Date();
      
      document.getElementById('corrida-badge').textContent = '‚è≥ Aguardando Cliente';
      document.getElementById('corrida-badge').className = 'corrida-badge aguardando';
      document.getElementById('acoes-container').innerHTML = '<button class="btn btn-success btn-block" onclick="iniciarCorrida()">üöô Iniciar Corrida</button>';
      document.getElementById('opcao-finalizar-direto').classList.add('hidden');
      
      // ATUALIZAR ROTA PARA DESTINO
      document.getElementById('rota-label').textContent = 'üèÅ Rota at√© o destino';
      var distancia = calcularDistancia(coordCliente.lat, coordCliente.lng, coordDestino.lat, coordDestino.lng);
      var tempo = Math.ceil(distancia * 2.5);
      document.getElementById('rota-distancia').textContent = distancia.toFixed(1) + ' km ‚Ä¢ ~' + tempo + ' min';
      
      // NOTIFICAR CLIENTE QUE CHEGOU (via API)
      notificarClienteChegada();
      
      mostrarToast('Cliente sendo notificado...', 'info');
    }
    
    // Notificar cliente que motorista chegou
    async function notificarClienteChegada() {
      try {
        var sessao = JSON.parse(localStorage.getItem('sessao_motorista') || '{}');
        if (!sessao.token) {
          console.log('Sem token para notificar');
          return;
        }
        
        var response = await fetch('/api/motorista/chegou', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            'Authorization': 'Bearer ' + sessao.token
          },
          body: JSON.stringify({})
        });
        
        var data = await response.json();
        if (data.success) {
          mostrarToast('‚úÖ Cliente notificado que voc√™ chegou!', 'success');
        }
      } catch (error) {
        console.log('Erro ao notificar cliente:', error);
        // Continua normalmente mesmo se falhar
        mostrarToast('Aguardando cliente embarcar...', 'info');
      }
    }
    
    function iniciarCorrida() {
      estadoCorrida = 'em_andamento';
      tempoInicioViagem = new Date();
      
      document.getElementById('corrida-badge').textContent = 'üöô Em Andamento';
      document.getElementById('corrida-badge').className = 'corrida-badge andamento';
      document.getElementById('acoes-container').innerHTML = '<button class="btn btn-success btn-block" onclick="finalizarCorrida()">‚úì Finalizar Corrida</button>';
      
      // BLOQUEAR CVS
      bloquearCVS();
      
      mostrarToast('Corrida iniciada! Boa viagem!', 'success');
    }

    function finalizarCorrida() {
      // TOCAR SOM DE FINALIZA√á√ÉO
      tocarSom('finalizada');
      
      // Mostrar modal de recebimento
      mostrarModalRecebimento();
    }
    
    function mostrarModalRecebimento() {
      var modal = document.getElementById('modal-recebimento');
      if (!modal) {
        modal = document.createElement('div');
        modal.id = 'modal-recebimento';
        modal.style.cssText = 'position:fixed;top:0;left:0;right:0;bottom:0;background:rgba(0,0,0,0.85);display:flex;align-items:center;justify-content:center;z-index:9999;padding:20px;';
        modal.innerHTML = '<div style="background:#1e293b;border-radius:20px;width:100%;max-width:360px;overflow:hidden;">' +
          '<div style="background:linear-gradient(135deg,#10b981,#059669);padding:24px;text-align:center;">' +
            '<span style="font-size:48px;display:block;margin-bottom:8px;">üí∞</span>' +
            '<h2 style="color:white;font-size:20px;margin:0;">Receber Pagamento</h2>' +
          '</div>' +
          '<div style="padding:24px;">' +
            '<label style="display:block;color:#94a3b8;font-size:14px;margin-bottom:8px;">Valor da corrida</label>' +
            '<div style="display:flex;align-items:center;background:#0f172a;border-radius:12px;padding:4px;">' +
              '<span style="color:#10b981;font-size:24px;font-weight:700;padding:12px 8px 12px 16px;">R$</span>' +
              '<input type="number" id="valor-recebimento" placeholder="0,00" step="0.50" min="0" style="flex:1;background:transparent;border:none;color:white;font-size:32px;font-weight:700;padding:12px;outline:none;width:100%;">' +
            '</div>' +
            '<p style="color:#64748b;font-size:12px;margin-top:8px;text-align:center;">Digite o valor combinado com o cliente</p>' +
          '</div>' +
          '<div style="display:flex;gap:12px;padding:0 24px 24px;">' +
            '<button onclick="fecharModalRecebimento()" style="flex:1;padding:14px;background:#334155;color:white;border:none;border-radius:12px;font-size:15px;font-weight:600;cursor:pointer;">Cancelar</button>' +
            '<button onclick="confirmarRecebimento()" style="flex:2;padding:14px;background:#10b981;color:white;border:none;border-radius:12px;font-size:15px;font-weight:600;cursor:pointer;">‚úì Receber</button>' +
          '</div>' +
        '</div>';
        document.body.appendChild(modal);
      }
      modal.style.display = 'flex';
      document.getElementById('valor-recebimento').value = '24.50';
      document.getElementById('valor-recebimento').focus();
    }
    
    function fecharModalRecebimento() {
      var modal = document.getElementById('modal-recebimento');
      if (modal) modal.style.display = 'none';
    }
    
    function confirmarRecebimento() {
      var valor = parseFloat(document.getElementById('valor-recebimento').value) || 0;
      if (valor <= 0) {
        document.getElementById('valor-recebimento').style.border = '2px solid #ef4444';
        return;
      }
      
      var tempoFim = new Date();
      var tempoTotal = Math.floor((tempoFim - tempoInicioCorrida) / 1000);
      var minutos = Math.floor(tempoTotal / 60);
      var segundos = tempoTotal % 60;
      var tempoFormatado = minutos + 'min ' + segundos + 's';
      
      pararCronometro();
      
      // TOCAR SOM DE DINHEIRO
      tocarSom('dinheiro');
      
      // Mostrar sucesso
      var modal = document.getElementById('modal-recebimento');
      modal.innerHTML = '<div style="background:#1e293b;border-radius:20px;width:100%;max-width:360px;text-align:center;padding:40px 24px;">' +
        '<span style="font-size:64px;display:block;margin-bottom:16px;">‚úÖ</span>' +
        '<div style="font-size:36px;font-weight:700;color:#10b981;margin-bottom:8px;">R$ ' + valor.toFixed(2).replace('.', ',') + '</div>' +
        '<p style="color:#94a3b8;font-size:14px;">Adicionado ao seu caixa!</p>' +
      '</div>';
      
      // Salvar no hist√≥rico
      var corrida = {
        id: historicoCount++,
        cliente: document.getElementById('corrida-cliente').textContent,
        origem: document.getElementById('corrida-origem').textContent,
        destino: document.getElementById('corrida-destino').textContent,
        valor: 'R$ ' + valor.toFixed(2).replace('.', ','),
        tempoTotal: tempoFormatado,
        tempoAteCliente: tempoChegouCliente ? Math.floor((tempoChegouCliente - tempoInicioCorrida) / 1000) : 0,
        tempoViagem: tempoInicioViagem ? Math.floor((tempoFim - tempoInicioViagem) / 1000) : 0,
        data: new Date().toLocaleString('pt-BR')
      };
      historicoCorridas.push(corrida);
      
      // Fechar ap√≥s 2 segundos
      setTimeout(function() {
        fecharModalRecebimento();
        estadoCorrida = 'nenhuma';
        document.getElementById('corrida-section').classList.add('hidden');
        document.getElementById('sem-corrida').classList.remove('hidden');
        document.getElementById('rota-section').classList.add('hidden');
        document.getElementById('tempo-corrida').classList.add('hidden');
        
        tempoInicioCorrida = null;
        tempoChegouCliente = null;
        tempoInicioViagem = null;
        
        if (!document.getElementById('fila-section').classList.contains('hidden')) setTimeout(aceitarFila, 1000);
      }, 2000);
    }

    function toggleFinalizarDireto() {
      var checked = document.getElementById('check-finalizar-direto').checked;
      if (checked) {
        document.getElementById('acoes-container').innerHTML = '<button class="btn btn-success btn-block" onclick="finalizarCorridaDireto()">‚úì Finalizar Direto</button>';
      } else {
        document.getElementById('acoes-container').innerHTML = '<button class="btn btn-primary btn-block" onclick="chegarNoLocal()">üìç Cheguei no cliente</button>';
      }
    }

    function finalizarCorridaDireto() {
      var tempoFim = new Date();
      var tempoTotal = Math.floor((tempoFim - tempoInicioCorrida) / 1000);
      var minutos = Math.floor(tempoTotal / 60);
      var segundos = tempoTotal % 60;
      var tempoFormatado = minutos + 'min ' + segundos + 's';
      
      pararCronometro();
      
      // TOCAR SOM DE FINALIZA√á√ÉO
      tocarSom('finalizada');
      
      // Salvar no hist√≥rico
      var corrida = {
        id: historicoCount++,
        cliente: document.getElementById('corrida-cliente').textContent,
        origem: document.getElementById('corrida-origem').textContent,
        destino: document.getElementById('corrida-destino').textContent,
        valor: document.getElementById('corrida-valor').textContent,
        tempoTotal: tempoFormatado,
        tempoAteCliente: 0,
        tempoViagem: tempoTotal,
        data: new Date().toLocaleString('pt-BR'),
        finalizadoDireto: true
      };
      historicoCorridas.push(corrida);
      
      estadoCorrida = 'nenhuma';
      document.getElementById('corrida-section').classList.add('hidden');
      document.getElementById('sem-corrida').classList.remove('hidden');
      document.getElementById('check-finalizar-direto').checked = false;
      document.getElementById('rota-section').classList.add('hidden');
      document.getElementById('tempo-corrida').classList.add('hidden');
      
      tempoInicioCorrida = null;
      tempoChegouCliente = null;
      tempoInicioViagem = null;
      
      mostrarToast('‚úÖ Finalizada direto! Tempo: ' + tempoFormatado, 'success');
      if (!document.getElementById('fila-section').classList.contains('hidden')) setTimeout(aceitarFila, 1000);
    }

    function aceitarFila() {
      document.getElementById('fila-section').classList.add('hidden');
      document.getElementById('corrida-cliente').textContent = 'Ana Costa';
      document.getElementById('corrida-origem').textContent = 'Shopping Center';
      document.getElementById('corrida-destino').textContent = 'Rua Principal, 789';
      document.getElementById('corrida-valor').textContent = 'R$ 18,00';
      
      // Atualizar coordenadas
      coordCliente = { lat: -23.5550, lng: -46.6380 };
      coordDestino = { lat: -23.5650, lng: -46.6480 };
      enderecoCliente = "Shopping Center - Entrada Principal, S√£o Paulo";
      
      estadoCorrida = 'aceita';
      tempoInicioCorrida = new Date();
      
      document.getElementById('corrida-section').classList.remove('hidden');
      document.getElementById('corrida-badge').textContent = 'üöó A Caminho';
      document.getElementById('corrida-badge').className = 'corrida-badge aceita';
      document.getElementById('acoes-container').innerHTML = '<button class="btn btn-primary btn-block" onclick="chegarNoLocal()">üìç Cheguei no Cliente</button>';
      document.getElementById('opcao-finalizar-direto').classList.remove('hidden');
      
      // MOSTRAR SE√á√ÉO DE ROTA
      document.getElementById('rota-section').classList.remove('hidden');
      document.getElementById('rota-label').textContent = 'üìç Rota at√© o cliente';
      var distancia = calcularDistancia(coordMotorista.lat, coordMotorista.lng, coordCliente.lat, coordCliente.lng);
      var tempo = Math.ceil(distancia * 2.5);
      document.getElementById('rota-distancia').textContent = distancia.toFixed(1) + ' km ‚Ä¢ ~' + tempo + ' min';
      
      // Mostrar tempo
      document.getElementById('tempo-corrida').classList.remove('hidden');
      document.getElementById('tempo-valor').textContent = '00:00';
      iniciarCronometro();
      
      mostrarToast('Fila aceita!', 'success');
    }

    function recusarFila() {
      document.getElementById('fila-section').classList.add('hidden');
      mostrarToast('Corrida recusada', 'info');
    }

    // ========================================
    // PAGAMENTOS
    // ========================================
    function abrirModalPagamento(tipo) {
      document.getElementById('pagamento-tipo').value = tipo;
      document.getElementById('modal-pagamento-titulo').textContent = tipo === 'entrada' ? 'üì• Entrada' : 'üì§ Sa√≠da';
      document.getElementById('modal-pagamento').classList.add('active');
    }

    function fecharModalPagamento() { aplicarBlurTransicao(); document.getElementById('modal-pagamento').classList.remove('active'); }

    function salvarPagamento() {
      var tipo = document.getElementById('pagamento-tipo').value;
      mostrarToast(tipo === 'entrada' ? 'Entrada registrada!' : 'Sa√≠da registrada!', 'success');
      fecharModalPagamento();
    }

    function mostrarToast(msg, tipo) {
      var t = document.createElement('div');
      t.className = 'toast ' + tipo;
      t.textContent = msg;
      document.body.appendChild(t);
      setTimeout(function() { t.style.opacity = '0'; t.style.transition = 'opacity 0.3s'; setTimeout(function() { t.remove(); }, 300); }, 2500);
    }

    // ========================================
    // CVS - Central de Atendimento
    // ========================================
    function abrirCVS() {
      if (estadoCorrida === 'em_andamento') {
        mostrarToast('CVS indispon√≠vel durante a corrida', 'error');
        return;
      }
      document.getElementById('cvs-cliente-nome').textContent = 'Cliente: ' + document.getElementById('corrida-cliente').textContent.charAt(0) + '.';
      document.getElementById('cvs-cliente-endereco').textContent = document.getElementById('corrida-origem').textContent;
      document.getElementById('modal-cvs').classList.add('active');
    }

    function fecharCVS() { aplicarBlurTransicao();
      document.getElementById('modal-cvs').classList.remove('active');
    }

    function ligarCVS() {
      fecharCVS();
      ligarViaCVS('cliente');
    }

    function bloquearCVS() {
      var cvs = document.getElementById('cvs-section');
      cvs.classList.add('disabled');
      document.getElementById('btn-cvs').disabled = true;
      document.getElementById('cvs-aviso').textContent = 'üîí Indispon√≠vel durante a corrida';
    }

    function desbloquearCVS() {
      var cvs = document.getElementById('cvs-section');
      cvs.classList.remove('disabled');
      document.getElementById('btn-cvs').disabled = false;
      document.getElementById('cvs-aviso').textContent = '‚ö†Ô∏è Dispon√≠vel at√© iniciar a corrida';
    }

    // ========================================
    // ASSIST√äNCIA (BOT√ÉO FLUTUANTE)
    // ========================================
    async function abrirAssistencia() {
      fecharFabMenu();
      document.getElementById('modal-assistencia').classList.add('active');
      
      // Carregar contatos do banco
      const lista = document.getElementById('assistencia-lista');
      lista.innerHTML = '<div style="text-align: center; padding: 20px; color: #64748b;"><div class="spinner" style="margin: 0 auto 10px;"></div>Carregando contatos...</div>';
      
      try {
        const resp = await fetch('/api/motorista/assistencia', {
          headers: { 'Authorization': 'Bearer ' + lerLocal('token') }
        });
        const data = await resp.json();
        
        if (data.success && data.contatos.length > 0) {
          let html = '';
          const icones = {
            guincho: 'üöõ', mecanico: 'üîß', borracheiro: 'üõû', 
            eletricista: '‚ö°', seguro: 'üõ°Ô∏è', outros: 'üìû'
          };
          const cores = {
            guincho: '#fef3c7', mecanico: '#dbeafe', borracheiro: '#fce7f3',
            eletricista: '#fef9c3', seguro: '#d1fae5', outros: '#f3f4f6'
          };
          
          data.contatos.forEach(c => {
            html += `
              <a href="tel:${c.telefone}" style="display: flex; align-items: center; gap: 16px; padding: 14px; background: ${cores[c.tipo] || '#f3f4f6'}; border-radius: 14px; text-decoration: none; color: var(--text-primary); margin-bottom: 10px;">
                <div style="width: 48px; height: 48px; background: white; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 24px; box-shadow: 0 2px 6px rgba(0,0,0,0.1);">
                  ${icones[c.tipo] || 'üìû'}
                </div>
                <div style="flex: 1;">
                  <div style="font-weight: 600; font-size: 15px; color: #1e293b;">${c.nome}</div>
                  <div style="color: #64748b; font-size: 13px;">${c.telefone}${c.telefone2 ? ' / ' + c.telefone2 : ''}</div>
                  <div style="color: #94a3b8; font-size: 12px; text-transform: capitalize;">${c.tipo}</div>
                </div>
                <div style="color: #10b981; font-size: 24px;">üìû</div>
              </a>
            `;
          });
          lista.innerHTML = html;
        } else {
          lista.innerHTML = `
            <div style="text-align: center; padding: 30px; color: #64748b;">
              <div style="font-size: 48px; margin-bottom: 10px;">üì≠</div>
              <div>Nenhum contato de assist√™ncia cadastrado</div>
              <div style="font-size: 13px; margin-top: 5px;">Pe√ßa ao administrador para adicionar</div>
            </div>
          `;
        }
      } catch (err) {
        lista.innerHTML = `
          <div style="text-align: center; padding: 30px; color: #ef4444;">
            <div style="font-size: 48px; margin-bottom: 10px;">‚ö†Ô∏è</div>
            <div>Erro ao carregar contatos</div>
          </div>
        `;
      }
    }

    // ========================================
    // EFEITO BLUR NA TRANSI√á√ÉO
    // ========================================
    function aplicarBlurTransicao() {
      var telaPrincipal = document.getElementById("tela-principal") || document.body;
      if (telaPrincipal) {
        telaPrincipal.classList.add("blur-transition");
        setTimeout(function() {
          telaPrincipal.classList.remove("blur-transition");
          telaPrincipal.classList.add("blur-transition-out");
          setTimeout(function() {
            telaPrincipal.classList.remove("blur-transition-out");
          }, 200);
        }, 150);
      }
    }

    function fecharAssistencia() { aplicarBlurTransicao();
      document.getElementById('modal-assistencia').classList.remove('active');
    }
    
    // ========================================
    // REGISTRO DE AVARIA
    // ========================================
    function abrirRegistroAvaria() {
      fecharFabMenu();
      document.getElementById('modal-registro-avaria').classList.add('active');
      // Definir data atual
      const now = new Date();
      now.setMinutes(now.getMinutes() - now.getTimezoneOffset());
      document.getElementById('avaria-data').value = now.toISOString().slice(0, 16);
    }
    
    function fecharRegistroAvaria() { aplicarBlurTransicao();
      document.getElementById('modal-registro-avaria').classList.remove('active');
      document.getElementById('form-avaria').reset();
      document.getElementById('avaria-fotos-preview').innerHTML = '';
      document.getElementById('avaria-endereco').innerHTML = '';
    }
    
    function capturarLocalizacaoAvaria() {
      if (navigator.geolocation) {
        navigator.geolocation.getCurrentPosition(pos => {
          document.getElementById('avaria-lat').value = pos.coords.latitude;
          document.getElementById('avaria-lng').value = pos.coords.longitude;
          document.getElementById('avaria-endereco').innerHTML = 'üìç Localiza√ß√£o capturada: ' + pos.coords.latitude.toFixed(6) + ', ' + pos.coords.longitude.toFixed(6);
        }, err => {
          alert('N√£o foi poss√≠vel obter sua localiza√ß√£o');
        });
      }
    }
    
    var fotosAvariaBase64 = [];
    function previewFotosAvaria(input) {
      const preview = document.getElementById('avaria-fotos-preview');
      fotosAvariaBase64 = [];
      
      Array.from(input.files).forEach((file, i) => {
        const reader = new FileReader();
        reader.onload = e => {
          fotosAvariaBase64.push(e.target.result);
          preview.innerHTML += `
            <div style="position: relative; width: 70px; height: 70px;">
              <img src="${e.target.result}" style="width: 70px; height: 70px; object-fit: cover; border-radius: 10px;">
              <span style="position: absolute; top: -5px; right: -5px; background: #ef4444; color: white; width: 20px; height: 20px; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 12px; cursor: pointer;" onclick="this.parentElement.remove()">√ó</span>
            </div>
          `;
        };
        reader.readAsDataURL(file);
      });
    }
    
    async function enviarAvaria(e) {
      e.preventDefault();
      
      const dados = {
        tipo: document.getElementById('avaria-tipo').value,
        descricao: document.getElementById('avaria-descricao').value,
        data_ocorrencia: document.getElementById('avaria-data').value,
        latitude: document.getElementById('avaria-lat').value || null,
        longitude: document.getElementById('avaria-lng').value || null,
        envolvidos_nome: document.getElementById('avaria-envolvido-nome').value,
        envolvidos_telefone: document.getElementById('avaria-envolvido-telefone').value,
        envolvidos_placa: document.getElementById('avaria-envolvido-placa').value,
        envolvidos_seguro: document.getElementById('avaria-envolvido-seguro').value,
        fotos: fotosAvariaBase64
      };
      
      try {
        const resp = await fetch('/api/motorista/avarias', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            'Authorization': 'Bearer ' + lerLocal('token')
          },
          body: JSON.stringify(dados)
        });
        
        const result = await resp.json();
        
        if (result.success) {
          alert('‚úÖ Avaria registrada com sucesso!\n\nO administrador foi notificado.');
          fecharRegistroAvaria();
        } else {
          alert('Erro: ' + (result.error || 'Falha ao registrar'));
        }
      } catch (err) {
        alert('Erro de conex√£o. Tente novamente.');
      }
    }
    
    // ========================================
    // CHAT DA FROTA
    // ========================================
    async function abrirChatFrota() {
      document.getElementById('modal-chat-frota').classList.add('active');
      await carregarMensagensChat();
    }
    
    function fecharChatFrota() { aplicarBlurTransicao();
      document.getElementById('modal-chat-frota').classList.remove('active');
    }
    
    async function carregarMensagensChat() {
      const container = document.getElementById('chat-mensagens');
      
      try {
        const resp = await fetch('/api/motorista/chat?limite=50', {
          headers: { 'Authorization': 'Bearer ' + lerLocal('token') }
        });
        const data = await resp.json();
        
        if (data.success && data.mensagens.length > 0) {
          let html = '';
          data.mensagens.forEach(m => {
            const isAdmin = m.remetente_tipo === 'admin';
            html += `
              <div style="display: flex; justify-content: ${isAdmin ? 'flex-start' : 'flex-end'}; margin-bottom: 10px;">
                <div style="max-width: 80%; padding: 12px 16px; border-radius: 16px; background: ${isAdmin ? 'white' : '#6366f1'}; color: ${isAdmin ? '#1e293b' : 'white'}; box-shadow: 0 1px 3px rgba(0,0,0,0.1);">
                  <div style="font-size: 11px; opacity: 0.7; margin-bottom: 4px;">${isAdmin ? 'üë§ ' + m.remetente_nome : 'Voc√™'}</div>
                  <div style="font-size: 14px;">${m.mensagem}</div>
                  <div style="font-size: 10px; opacity: 0.6; margin-top: 4px; text-align: right;">
                    ${new Date(m.criado_em).toLocaleTimeString('pt-BR', {hour: '2-digit', minute: '2-digit'})}
                  </div>
                </div>
              </div>
            `;
          });
          container.innerHTML = html;
          container.scrollTop = container.scrollHeight;
        } else {
          container.innerHTML = '<div style="text-align: center; color: #64748b; padding: 40px;"><div style="font-size: 48px; margin-bottom: 10px;">üí¨</div>Nenhuma mensagem ainda<br><span style="font-size: 13px;">Inicie uma conversa com o administrador</span></div>';
        }
        
        // Atualizar badge
        document.getElementById('chat-badge').textContent = data.nao_lidas || 0;
        document.getElementById('chat-badge').style.display = data.nao_lidas > 0 ? 'flex' : 'none';
        
      } catch (err) {
        container.innerHTML = '<div style="text-align: center; color: #ef4444; padding: 40px;">Erro ao carregar mensagens</div>';
      }
    }
    
    async function enviarMensagemChat() {
      const input = document.getElementById('chat-input');
      const mensagem = input.value.trim();
      
      if (!mensagem) return;
      
      try {
        const resp = await fetch('/api/motorista/chat', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            'Authorization': 'Bearer ' + lerLocal('token')
          },
          body: JSON.stringify({ mensagem })
        });
        
        const result = await resp.json();
        
        if (result.success) {
          input.value = '';
          await carregarMensagensChat();
        }
      } catch (err) {
        alert('Erro ao enviar mensagem');
      }
    }

    // ========================================
    // SUPORTE
    // ========================================
    var problemasSelecionados = [];
    
    // ==========================================
    // WHITE LABEL - NOME PERSONALIZADO
    // ==========================================
    // Fun√ß√£o para carregar nome da empresa (White Label)
    function carregarNomeEmpresa() {
      // Padr√£o √© UBMAX (cliente n√£o pagou white label)
      var nomePadrao = 'UBMAX';
      var nomeExibido = nomePadrao;
      
      // 1. Primeiro tenta pegar do motorista logado (vem do servidor)
      var motoristaLocal = lerLocal('motorista');
      if (motoristaLocal && motoristaLocal.white_label && motoristaLocal.nome_exibido) {
        nomeExibido = motoristaLocal.nome_exibido;
      } else {
        // 2. Sen√£o, tenta pegar do localStorage (configura√ß√£o local do Master)
        var empresaId = localStorage.getItem('empresa_id') || 'UBMAX';
        var empresasConfig = JSON.parse(localStorage.getItem('empresas_config') || '{}');
        var config = empresasConfig[empresaId];
        
        if (config && config.whiteLabel && config.nomeExibido) {
          nomeExibido = config.nomeExibido;
        }
      }
      
      // Atualizar nome em todos os lugares
      var loginNome = document.getElementById('login-empresa-nome');
      if (loginNome) loginNome.textContent = nomeExibido;
      
      var nomeTopo = document.getElementById('empresa-nome-topo');
      if (nomeTopo) nomeTopo.textContent = nomeExibido;
      
      // Atualizar title da p√°gina
      document.title = 'Painel Motorista - ' + nomeExibido;
      
      // Retornar configura√ß√£o completa
      return {
        nome: nomeExibido,
        nomeReal: motoristaLocal ? motoristaLocal.empresa_nome : 'Empresa',
        whiteLabel: motoristaLocal ? motoristaLocal.white_label : false,
        telefone: '14999990001',
        whatsapp: '5514999990001',
        cidade: 'Lins - SP'
      };
    }
    
    // Carregar nome ao iniciar
    var EMPRESA_CONFIG = carregarNomeEmpresa();

    // ==========================================
    // MENU FAB EXPANS√çVEL
    // ==========================================
    
    var fabMenuAberto = false;
    
    function toggleFabMenu() {
      fabMenuAberto = !fabMenuAberto;
      var btn = document.getElementById('fab-menu-btn');
      var submenu = document.getElementById('fab-submenu');
      
      if (fabMenuAberto) {
        btn.classList.add('open');
        submenu.classList.add('open');
      } else {
        btn.classList.remove('open');
        submenu.classList.remove('open');
      }
      
      // Esconder item PWA se j√° fechou pra sempre
      if (localStorage.getItem('pwa_nunca_mostrar') || pwaInstalado) {
        var pwaItem = document.getElementById('fab-pwa-item');
        if (pwaItem) pwaItem.style.display = 'none';
      }
    }
    
    function fecharFabMenu() {
      fabMenuAberto = false;
      var btn = document.getElementById('fab-menu-btn');
      var submenu = document.getElementById('fab-submenu');
      btn.classList.remove('open');
      submenu.classList.remove('open');
    }
    

    function abrirSuporte() {
      fecharFabMenu();
      var modal = document.getElementById('modal-suporte');
      if (modal) {
        modal.style.display = 'flex';
        modal.classList.add('active');
        // Resetar para tela inicial (op√ß√µes)
        voltarOpcoesSuporte();
      }
    }

    function fecharSuporte() { aplicarBlurTransicao();
      var modal = document.getElementById('modal-suporte');
      if (modal) {
        modal.style.display = 'none';
        modal.classList.remove('active');
      }
    }
    
    function mostrarFormSuporte() {
      document.getElementById('form-suporte-container').style.display = 'block';
      var nomeEmpresa = EMPRESA_CONFIG ? EMPRESA_CONFIG.nome : 'Suporte';
      document.getElementById('suporte-empresa-nome').textContent = nomeEmpresa;
    }
    
    function voltarOpcoesSuporte() {
      document.getElementById('form-suporte-container').style.display = 'none';
      document.getElementById('suporte-mensagem').value = '';
    }

    function abrirSuporteRapido() {
      abrirSuporte();
      mostrarFormSuporte();
    }

    function enviarSuporte() {
      var mensagem = document.getElementById('suporte-mensagem').value;
      if (!mensagem.trim()) {
        mostrarToast('Descreva o problema', 'error');
        return;
      }
      
      // Dados do ticket de suporte - ENVIADO DIRETO PARA ADM
      var motorista = dadosMotorista || { nome: 'Motorista', telefone: '' };
      var ticket = {
        empresaId: 'empresa_001',
        empresaNome: EMPRESA_CONFIG ? EMPRESA_CONFIG.nome : 'Empresa',
        motoristaId: motorista.id || 'motorista_001',
        motoristaNome: motorista.nome,
        motoristaTelefone: motorista.telefone,
        assunto: 'Solicita√ß√£o de suporte',
        mensagem: mensagem,
        localizacao: minhaLocalizacao,
        estadoCorrida: estadoCorrida,
        prioridade: 'normal',
        timestamp: new Date().toISOString()
      };
      
      // Enviar via WebSocket se conectado
      if (typeof socket !== 'undefined' && socket && socketConectado) {
        socket.emit('suporte:ticket', ticket);
      }
      
      // TAMB√âM ENVIAR VIA API (Chat direto com ADM)
      enviarMensagemADMAPI(mensagem);
      
      console.log('üé´ Ticket de suporte:', ticket);
      mostrarToast('Mensagem enviada para o ADM!', 'success');
      document.getElementById('suporte-mensagem').value = '';
      
      fecharSuporte();
    }
    
    // Enviar mensagem para ADM via API
    async function enviarMensagemADMAPI(mensagem) {
      try {
        var sessao = JSON.parse(localStorage.getItem('sessao_motorista') || '{}');
        if (!sessao.token) {
          console.log('Sem token para enviar mensagem');
          return;
        }
        
        var response = await fetch('/api/motorista/mensagem-adm', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            'Authorization': 'Bearer ' + sessao.token
          },
          body: JSON.stringify({ mensagem: mensagem })
        });
        
        var data = await response.json();
        if (data.success) {
          console.log('‚úÖ Mensagem salva no sistema');
        }
      } catch (error) {
        console.log('Erro ao enviar mensagem API:', error);
        // Continua normalmente - WebSocket j√° enviou
      }
    }

    // ========================================
    // CHAT DA FROTA
    // ========================================
    var chatPrivadoAtual = null;

    function abrirChatFrota() {
      fecharFabMenu();
      document.getElementById('modal-chat-frota').classList.add('active');
      document.getElementById('chat-badge').style.display = 'none';
    }

    function fecharChatFrota() { aplicarBlurTransicao();
      document.getElementById('modal-chat-frota').classList.remove('active');
    }

    function enviarMsgFrota() {
      var input = document.getElementById('chat-input');
      var msg = input.value.trim();
      
      if (!msg) return;
      
      var container = document.getElementById('chat-mensagens');
      var hora = new Date().toLocaleTimeString('pt-BR', {hour: '2-digit', minute: '2-digit'});
      
      // Adicionar mensagem na tela
      var msgEl = document.createElement('div');
      msgEl.className = 'chat-msg enviada';
      msgEl.innerHTML = '<span class="chat-msg-nome">Voc√™</span>' +
                        '<span class="chat-msg-texto">' + msg + '</span>' +
                        '<span class="chat-msg-hora">' + hora + '</span>';
      
      container.appendChild(msgEl);
      container.scrollTop = container.scrollHeight;
      input.value = '';
      
      // Enviar via WebSocket
      if (socket && socketConectado) {
        socket.emit('chat:mensagem', {
          tipo: 'grupo',
          motoristaNome: 'Jo√£o Santos',
          mensagem: msg,
          hora: hora
        });
      }
      
      /*
      // Enviar via API REST
      fetch('/api/chat/enviar', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({
          tipo: 'grupo',
          motoristaId: 'motorista_001',
          mensagem: msg
        })
      });
      */
    }

    function abrirChatPrivado(nome) {
      chatPrivadoAtual = nome;
      document.getElementById('chat-privado-nome').textContent = 'üí¨ ' + nome;
      document.getElementById('modal-chat-frota').classList.remove('active');
      document.getElementById('modal-chat-privado').classList.add('active');
    }

    function fecharChatPrivado() {
      document.getElementById('modal-chat-privado').classList.remove('active');
      chatPrivadoAtual = null;
    }

    function enviarMsgPrivada() {
      var input = document.getElementById('chat-privado-input');
      var msg = input.value.trim();
      
      if (!msg) return;
      
      var container = document.getElementById('chat-privado-mensagens');
      var hora = new Date().toLocaleTimeString('pt-BR', {hour: '2-digit', minute: '2-digit'});
      
      var msgEl = document.createElement('div');
      msgEl.className = 'chat-msg enviada';
      msgEl.innerHTML = '<span class="chat-msg-nome">Voc√™</span>' +
                        '<span class="chat-msg-texto">' + msg + '</span>' +
                        '<span class="chat-msg-hora">' + hora + '</span>';
      
      container.appendChild(msgEl);
      container.scrollTop = container.scrollHeight;
      input.value = '';
    }

    // Enter para enviar
    document.addEventListener('DOMContentLoaded', function() {
      var chatInput = document.getElementById('chat-input');
      if (chatInput) {
        chatInput.addEventListener('keypress', function(e) {
          if (e.key === 'Enter') enviarMsgFrota();
        });
      }
      var chatPrivadoInput = document.getElementById('chat-privado-input');
      if (chatPrivadoInput) {
        chatPrivadoInput.addEventListener('keypress', function(e) {
          if (e.key === 'Enter') enviarMsgPrivada();
        });
      }
    });

    // ==========================================
    // MANUTEN√á√ÉO E AVARIA
    // ==========================================
    
    var gravidadeSelecionada = 'leve';
    
    // Fun√ß√£o para abrir modal de manuten√ß√£o
    window.abrirModalManutencao = function() {
      console.log('>>> Abrindo modal manuten√ß√£o...');
      // Fechar menu FAB primeiro
      fecharFabMenu();
      
      var modal = document.getElementById('modal-manutencao');
      if (modal) {
        modal.style.display = 'flex';
        modal.classList.add('active');
        // Preencher data de hoje
        var hoje = new Date().toISOString().split('T')[0];
        var inputData = document.getElementById('manut-data');
        if (inputData) inputData.value = hoje;
        // Limpar campos
        var tipo = document.getElementById('manut-tipo');
        var empresa = document.getElementById('manut-empresa');
        var valor = document.getElementById('manut-valor');
        if (tipo) tipo.value = '';
        if (empresa) empresa.value = '';
        if (valor) valor.value = '';
      } else {
        console.error('Modal manuten√ß√£o n√£o encontrado!');
        alert('Erro: Modal de manuten√ß√£o n√£o encontrado');
      }
    };
    
    // Fun√ß√£o para fechar modal de manuten√ß√£o
    window.fecharModalManutencao = function() {
      var modal = document.getElementById('modal-manutencao');
      if (modal) {
        modal.style.display = 'none';
        modal.classList.remove('active');
      }
    };
    
    // Fun√ß√£o para abrir modal de avaria
    window.abrirModalAvaria = function() {
      console.log('>>> Abrindo modal avaria...');
      // Fechar menu FAB primeiro
      fecharFabMenu();
      
      var modal = document.getElementById('modal-avaria');
      if (modal) {
        modal.style.display = 'flex';
        modal.classList.add('active');
        // Limpar campos
        var tipo = document.getElementById('avaria-tipo');
        var local = document.getElementById('avaria-local');
        var desc = document.getElementById('avaria-descricao');
        if (tipo) tipo.value = '';
        if (local) local.value = 'frente';
        if (desc) desc.value = '';
        gravidadeSelecionada = 'leve';
      } else {
        console.error('Modal avaria n√£o encontrado!');
        alert('Erro: Modal de avaria n√£o encontrado');
      }
    };
    
    // Fun√ß√£o para fechar modal de avaria
    window.fecharModalAvaria = function() {
      var modal = document.getElementById('modal-avaria');
      if (modal) {
        modal.style.display = 'none';
        modal.classList.remove('active');
      }
    };
    
    function selecionarGravidade(nivel) {
      gravidadeSelecionada = nivel;
      // Visual feedback
      document.querySelectorAll('[name="gravidade"]').forEach(function(radio) {
        radio.parentElement.style.borderColor = radio.value === nivel ? '#3b82f6' : 'transparent';
      });
    }
    
    async function salvarManutencao() {
      var tipo = document.getElementById('manut-tipo').value;
      var empresa = document.getElementById('manut-empresa').value.trim();
      var valor = parseFloat(document.getElementById('manut-valor').value) || 0;
      var dias = parseInt(document.getElementById('manut-dias').value) || 1;
      var data = document.getElementById('manut-data').value;
      var descricao = document.getElementById('manut-descricao').value.trim();
      var iniciarAgora = document.getElementById('manut-iniciar-agora').checked;
      
      if (!tipo) {
        alert('‚ö†Ô∏è Selecione o tipo de manuten√ß√£o');
        return;
      }
      if (!empresa) {
        alert('‚ö†Ô∏è Informe a empresa/oficina');
        return;
      }
      if (!data) {
        alert('‚ö†Ô∏è Selecione a data');
        return;
      }
      
      // Mapear tipos
      var tiposTexto = {
        'troca_oleo': 'üõ¢Ô∏è Troca de √ìleo',
        'revisao': 'üîç Revis√£o Completa',
        'freios': 'üõë Revis√£o de Freios',
        'pneus': 'üõû Troca/Rod√≠zio de Pneus',
        'suspensao': 'üîß Suspens√£o',
        'eletrica': '‚ö° Parte El√©trica',
        'ar_condicionado': '‚ùÑÔ∏è Ar Condicionado',
        'alinhamento': '‚ÜîÔ∏è Alinhamento/Balanceamento',
        'embreagem': '‚öôÔ∏è Embreagem',
        'motor': 'üöó Motor',
        'funilaria': 'üî® Funilaria/Pintura',
        'outros': 'üìù Outros'
      };
      
      var motorista = dadosMotorista || { nome: 'Motorista', telefone: '', veiculo: '', placa: '' };
      
      var manutencao = {
        id: Date.now(),
        motoristaId: motorista.id,
        motoristaNome: motorista.nome,
        veiculo: motorista.veiculo + ' - ' + motorista.placa,
        tipo: tiposTexto[tipo] || tipo,
        tipoCodigo: tipo,
        empresa: empresa,
        valor: valor,
        dias: dias,
        data: data,
        descricao: descricao,
        status: iniciarAgora ? 'em_manutencao' : 'programada',
        criadoEm: new Date().toISOString()
      };
      
      // Salvar no localStorage
      var manutencoes = JSON.parse(localStorage.getItem('manutencoes') || '[]');
      manutencoes.push(manutencao);
      localStorage.setItem('manutencoes', JSON.stringify(manutencoes));
      
      // Se iniciar agora, ficar offline
      if (iniciarAgora && online) {
        document.getElementById('toggle-status').checked = false;
        alternarStatus();
        atualizarStatusVeiculo('manutencao');
      }
      
      // Montar mensagem para WhatsApp do dono
      var dataFormatada = new Date(data).toLocaleDateString('pt-BR');
      var msgWhatsApp = `üîß *MANUTEN√á√ÉO ${iniciarAgora ? 'INICIADA' : 'PROGRAMADA'}*

üë§ *Motorista:* ${motorista.nome}
üöó *Ve√≠culo:* ${motorista.veiculo || 'N/I'} - ${motorista.placa || 'N/I'}

üìã *Tipo:* ${tiposTexto[tipo]}
üè¢ *Empresa:* ${empresa}
üí∞ *Valor:* R$ ${valor.toFixed(2)}
üìÖ *Data:* ${dataFormatada}
‚è±Ô∏è *Dura√ß√£o:* ${dias} dia(s)

üìù *Descri√ß√£o:* ${descricao || 'Sem descri√ß√£o'}

${iniciarAgora ? '‚ö†Ô∏è Motorista OFFLINE - N√£o dispon√≠vel para corridas' : 'üìå Manuten√ß√£o agendada'}

_Sistema REBECA_`;
      
      // Enviar notifica√ß√£o ao dono
      var telefoneDono = localStorage.getItem('config_telefone_adm');
      if (telefoneDono) {
        try {
          await fetch('/api/admin/notificacoes/teste', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ telefone: telefoneDono, mensagem: msgWhatsApp })
          });
        } catch (e) {
          console.log('Notifica√ß√£o pendente - servidor offline');
        }
      }
      
      fecharModalManutencao();
      atualizarHistoricoManutencoes();
      mostrarToast('‚úÖ Manuten√ß√£o ' + (iniciarAgora ? 'iniciada' : 'programada') + '!', 'success');
    }
    
    async function salvarAvaria() {
      var tipo = document.getElementById('avaria-tipo').value;
      var local = document.getElementById('avaria-local').value;
      var descricao = document.getElementById('avaria-descricao').value.trim();
      var impede = document.getElementById('avaria-impede').checked;
      
      if (!tipo) {
        alert('‚ö†Ô∏è Selecione o tipo de avaria');
        return;
      }
      if (!descricao) {
        alert('‚ö†Ô∏è Descreva a avaria');
        return;
      }
      
      var tiposTexto = {
        'amassado': 'üî® Amassado',
        'arranhao': '‚úèÔ∏è Arranh√£o',
        'vidro': 'ü™ü Vidro Quebrado/Trincado',
        'retrovisor': 'üî≤ Retrovisor Danificado',
        'farol': 'üí° Farol/Lanterna',
        'pneu': 'üõû Pneu Furado',
        'mecanica': 'üîß Problema Mec√¢nico',
        'eletrica': '‚ö° Problema El√©trico',
        'acidente': 'üöó Acidente',
        'outros': 'üìù Outros'
      };
      
      var locaisTexto = {
        'frente': 'Frente',
        'traseira': 'Traseira',
        'lateral_esq': 'Lateral Esquerda',
        'lateral_dir': 'Lateral Direita',
        'teto': 'Teto',
        'interior': 'Interior',
        'motor': 'Motor'
      };
      
      var gravidadeTexto = {
        'leve': 'üü¢ Leve',
        'media': 'üü° M√©dia',
        'grave': 'üî¥ Grave'
      };
      
      var motorista = dadosMotorista || { nome: 'Motorista', telefone: '', veiculo: '', placa: '' };
      
      var avaria = {
        id: Date.now(),
        motoristaId: motorista.id,
        motoristaNome: motorista.nome,
        veiculo: motorista.veiculo + ' - ' + motorista.placa,
        tipo: tiposTexto[tipo] || tipo,
        tipoCodigo: tipo,
        local: locaisTexto[local],
        localCodigo: local,
        gravidade: gravidadeSelecionada,
        descricao: descricao,
        impedeTrabalho: impede,
        criadoEm: new Date().toISOString(),
        status: 'pendente'
      };
      
      // Salvar no localStorage
      var avarias = JSON.parse(localStorage.getItem('avarias') || '[]');
      avarias.push(avaria);
      localStorage.setItem('avarias', JSON.stringify(avarias));
      
      // Se impede trabalhar, ficar offline
      if (impede && online) {
        document.getElementById('toggle-status').checked = false;
        alternarStatus();
        atualizarStatusVeiculo('avaria');
      }
      
      // Montar mensagem para WhatsApp do dono
      var msgWhatsApp = `‚ö†Ô∏è *AVARIA REGISTRADA*

üë§ *Motorista:* ${motorista.nome}
üöó *Ve√≠culo:* ${motorista.veiculo || 'N/I'} - ${motorista.placa || 'N/I'}

üî¥ *Tipo:* ${tiposTexto[tipo]}
üìç *Local:* ${locaisTexto[local]}
‚ö° *Gravidade:* ${gravidadeTexto[gravidadeSelecionada]}

üìù *Descri√ß√£o:* ${descricao}

${impede ? 'üö´ MOTORISTA OFFLINE - Ve√≠culo impossibilitado de trabalhar' : '‚úÖ Motorista continua dispon√≠vel'}

_Sistema REBECA_`;
      
      // Enviar notifica√ß√£o ao dono
      var telefoneDono = localStorage.getItem('config_telefone_adm');
      if (telefoneDono) {
        try {
          await fetch('/api/admin/notificacoes/teste', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ telefone: telefoneDono, mensagem: msgWhatsApp })
          });
        } catch (e) {
          console.log('Notifica√ß√£o pendente - servidor offline');
        }
      }
      
      fecharModalAvaria();
      atualizarHistoricoManutencoes();
      mostrarToast('‚ö†Ô∏è Avaria registrada e enviada ao ADM!', 'warning');
    }
    
    function atualizarStatusVeiculo(status) {
      var card = document.getElementById('status-veiculo-card');
      if (!card) return;
      
      if (status === 'manutencao') {
        card.style.background = 'linear-gradient(135deg, #fef3c7, #fde68a)';
        card.style.borderColor = '#f59e0b';
        card.innerHTML = `
          <div style="width: 44px; height: 44px; background: #f59e0b; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 22px;">üîß</div>
          <div>
            <div style="font-weight: 600; color: #92400e;">Em Manuten√ß√£o</div>
            <div style="font-size: 13px; color: #a16207;">Voc√™ est√° offline</div>
          </div>
        `;
      } else if (status === 'avaria') {
        card.style.background = 'linear-gradient(135deg, #fee2e2, #fecaca)';
        card.style.borderColor = '#ef4444';
        card.innerHTML = `
          <div style="width: 44px; height: 44px; background: #ef4444; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 22px;">‚ö†Ô∏è</div>
          <div>
            <div style="font-weight: 600; color: #991b1b;">Avaria Registrada</div>
            <div style="font-size: 13px; color: #b91c1c;">Ve√≠culo com problema</div>
          </div>
        `;
      } else {
        card.style.background = 'linear-gradient(135deg, #dcfce7, #bbf7d0)';
        card.style.borderColor = '#10b981';
        card.innerHTML = `
          <div style="width: 44px; height: 44px; background: #10b981; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 22px;">‚úÖ</div>
          <div>
            <div style="font-weight: 600; color: #166534;">Ve√≠culo OK</div>
            <div style="font-size: 13px; color: #15803d;">Pronto para trabalhar</div>
          </div>
        `;
      }
    }
    
    function atualizarHistoricoManutencoes() {
      var container = document.getElementById('historico-manutencoes');
      if (!container) return;
      
      var manutencoes = JSON.parse(localStorage.getItem('manutencoes') || '[]');
      var avarias = JSON.parse(localStorage.getItem('avarias') || '[]');
      
      // Combinar e ordenar por data
      var registros = [...manutencoes, ...avarias].sort((a, b) => new Date(b.criadoEm || b.data) - new Date(a.criadoEm || a.data));
      
      if (registros.length === 0) {
        container.innerHTML = '<div style="text-align: center; color: var(--text-muted); padding: 20px;">Nenhum registro ainda</div>';
        return;
      }
      
      container.innerHTML = registros.slice(0, 5).map(function(r) {
        var isAvaria = r.gravidade !== undefined;
        var statusBadge = r.status === 'em_manutencao' 
          ? '<span style="color: #f59e0b; font-size: 13px; font-weight: 500;">üîß Em andamento</span>'
          : r.status === 'programada'
            ? '<span style="color: #3b82f6; font-size: 13px; font-weight: 500;">üìÖ Programada</span>'
            : r.status === 'pendente'
              ? '<span style="color: #ef4444; font-size: 13px; font-weight: 500;">‚ö†Ô∏è Pendente</span>'
              : '<span style="color: #10b981; font-size: 13px; font-weight: 500;">‚úÖ Conclu√≠da</span>';
        
        var data = new Date(r.criadoEm || r.data).toLocaleDateString('pt-BR');
        var info = isAvaria ? r.local : (r.empresa || '-');
        
        return `<div style="padding: 12px; background: var(--bg-body); border-radius: 8px; display: flex; justify-content: space-between; align-items: center;">
          <div>
            <div style="font-weight: 500; font-size: 14px;">${r.tipo}</div>
            <div style="font-size: 12px; color: var(--text-muted);">${data} ‚Ä¢ ${info}</div>
          </div>
          ${statusBadge}
        </div>`;
      }).join('');
    }
    
    // ==========================================
    // PWA - INSTALA√á√ÉO AUTOM√ÅTICA
    // ==========================================
    
    var deferredPrompt = null;
    var pwaInstalado = false;
    
    // Detectar se j√° est√° instalado como PWA
    if (window.matchMedia('(display-mode: standalone)').matches || window.navigator.standalone === true) {
      pwaInstalado = true;
      console.log('‚úÖ App j√° est√° instalado como PWA');
    }
    
    // Interceptar evento de instala√ß√£o
    window.addEventListener('beforeinstallprompt', function(e) {
      e.preventDefault();
      deferredPrompt = e;
      console.log('üì≤ PWA dispon√≠vel para instala√ß√£o');
      
      // Mostrar banner automaticamente ap√≥s 2 segundos
      if (!pwaInstalado && !localStorage.getItem('pwa_banner_fechado')) {
        setTimeout(mostrarBannerPWA, 2000);
      }
    });
    
    // Detectar quando foi instalado
    window.addEventListener('appinstalled', function() {
      pwaInstalado = true;
      deferredPrompt = null;
      fecharPWAParaSempre();
      mostrarToast('‚úÖ App instalado com sucesso!', 'success');
      console.log('‚úÖ PWA instalado!');
    });
    
    function mostrarBannerPWA() {
      // N√£o mostrar se usu√°rio fechou para sempre
      if (localStorage.getItem('pwa_nunca_mostrar')) return;
      
      // PWA agora est√° no menu FAB, n√£o precisa mostrar banner separado
    }
    
    function fecharBannerPWA() {
      // PWA agora est√° no menu FAB
    }
    
    function fecharPWAParaSempre() {
      // Nunca mais mostrar item PWA no menu
      localStorage.setItem('pwa_nunca_mostrar', 'true');
      var pwaItem = document.getElementById('fab-pwa-item');
      if (pwaItem) pwaItem.style.display = 'none';
    }
    
    function instalarPWA() {
      fecharFabMenu();
      
      if (deferredPrompt) {
        // Android/Chrome - usar prompt nativo
        deferredPrompt.prompt();
        deferredPrompt.userChoice.then(function(result) {
          if (result.outcome === 'accepted') {
            mostrarToast('‚úÖ App instalado!', 'success');
            fecharPWAParaSempre();
          }
          deferredPrompt = null;
        });
      } else {
        // iOS ou navegador sem suporte
        var isIOS = /iPad|iPhone|iPod/.test(navigator.userAgent) && !window.MSStream;
        if (isIOS) {
          mostrarInstrucoesIOS();
        } else {
          mostrarInstrucoesAndroid();
        }
      }
    }
    
    function mostrarInstrucoesIOS() {
      // Criar modal de instru√ß√µes iOS
      var modal = document.createElement('div');
      modal.id = 'modal-ios-install';
      modal.className = 'modal active';
      modal.innerHTML = `
        <div class="modal-content" style="max-width: 340px;">
          <div class="modal-header" style="background: linear-gradient(135deg, #6366f1, #4f46e5); color: white;">
            <h3>üì± Instalar no iPhone</h3>
            <button class="modal-close" onclick="this.closest('.modal').remove(); fecharPWAParaSempre();" style="color: white;">√ó</button>
          </div>
          <div class="modal-body" style="text-align: center;">
            <div style="font-size: 48px; margin-bottom: 16px;">üì≤</div>
            <p style="font-size: 15px; margin-bottom: 20px;">Siga os passos abaixo:</p>
            
            <div style="text-align: left; background: var(--bg-body); border-radius: 12px; padding: 16px;">
              <div style="display: flex; align-items: center; gap: 12px; margin-bottom: 12px;">
                <span style="background: #6366f1; color: white; width: 28px; height: 28px; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-weight: 700;">1</span>
                <span>Toque em <strong>Compartilhar</strong> ‚¨ÜÔ∏è</span>
              </div>
              <div style="display: flex; align-items: center; gap: 12px; margin-bottom: 12px;">
                <span style="background: #6366f1; color: white; width: 28px; height: 28px; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-weight: 700;">2</span>
                <span>Role para baixo</span>
              </div>
              <div style="display: flex; align-items: center; gap: 12px;">
                <span style="background: #6366f1; color: white; width: 28px; height: 28px; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-weight: 700;">3</span>
                <span>Toque em <strong>"Adicionar √† Tela de In√≠cio"</strong></span>
              </div>
            </div>
            
            <button onclick="this.closest('.modal').remove()" style="margin-top: 20px; background: linear-gradient(135deg, #6366f1, #4f46e5); color: white; border: none; padding: 14px 32px; border-radius: 10px; font-weight: 600; cursor: pointer; width: 100%;">
              Entendi!
            </button>
          </div>
        </div>
      `;
      document.body.appendChild(modal);
    }
    
    function mostrarInstrucoesAndroid() {
      fecharBannerPWA();
      
      var modal = document.createElement('div');
      modal.id = 'modal-android-install';
      modal.className = 'modal active';
      modal.innerHTML = `
        <div class="modal-content" style="max-width: 340px;">
          <div class="modal-header" style="background: linear-gradient(135deg, #10b981, #059669); color: white;">
            <h3>üì± Instalar no Android</h3>
            <button class="modal-close" onclick="this.closest('.modal').remove()" style="color: white;">√ó</button>
          </div>
          <div class="modal-body" style="text-align: center;">
            <div style="font-size: 48px; margin-bottom: 16px;">üì≤</div>
            <p style="font-size: 15px; margin-bottom: 20px;">Siga os passos abaixo:</p>
            
            <div style="text-align: left; background: var(--bg-body); border-radius: 12px; padding: 16px;">
              <div style="display: flex; align-items: center; gap: 12px; margin-bottom: 12px;">
                <span style="background: #10b981; color: white; width: 28px; height: 28px; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-weight: 700;">1</span>
                <span>Toque no menu <strong>‚ãÆ</strong> (3 pontinhos)</span>
              </div>
              <div style="display: flex; align-items: center; gap: 12px; margin-bottom: 12px;">
                <span style="background: #10b981; color: white; width: 28px; height: 28px; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-weight: 700;">2</span>
                <span>Toque em <strong>"Instalar app"</strong></span>
              </div>
              <div style="display: flex; align-items: center; gap: 12px;">
                <span style="background: #10b981; color: white; width: 28px; height: 28px; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-weight: 700;">3</span>
                <span>Confirme tocando em <strong>"Instalar"</strong></span>
              </div>
            </div>
            
            <button onclick="this.closest('.modal').remove()" style="margin-top: 20px; background: linear-gradient(135deg, #10b981, #059669); color: white; border: none; padding: 14px 32px; border-radius: 10px; font-weight: 600; cursor: pointer; width: 100%;">
              Entendi!
            </button>
          </div>
        </div>
      `;
      document.body.appendChild(modal);
    }
    
    // Verificar e mostrar banner ap√≥s carregar p√°gina
    setTimeout(function() {
      if (!pwaInstalado && !localStorage.getItem('pwa_banner_fechado')) {
        var isIOS = /iPad|iPhone|iPod/.test(navigator.userAgent) && !window.MSStream;
        if (isIOS) {
          // iOS n√£o suporta beforeinstallprompt, mostrar instru√ß√µes
          setTimeout(mostrarInstrucoesIOS, 3000);
        }
      }
    }, 3000);
    
    // Carregar hist√≥rico ao iniciar
    setTimeout(atualizarHistoricoManutencoes, 1000);
    
    // Registrar Service Worker
    if ('serviceWorker' in navigator) {
      window.addEventListener('load', function() {
        navigator.serviceWorker.register('/motorista/sw.js')
          .then(function(reg) {
            console.log('‚úÖ Service Worker registrado:', reg.scope);
          })
          .catch(function(err) {
            console.log('Service Worker n√£o registrado:', err);
          });
      });
    }
    
    // Log de finaliza√ß√£o
    console.log('‚úÖ Script motorista carregado!');
    console.log('üìã Fun√ß√µes dispon√≠veis:', {
      abrirModalManutencao: typeof window.abrirModalManutencao,
      abrirModalAvaria: typeof window.abrirModalAvaria
    });
    
    // Fun√ß√£o de teste - pode chamar do console: testarModais()
    window.testarModais = function() {
      console.log('Testando modais...');
      console.log('modal-manutencao:', document.getElementById('modal-manutencao'));
      console.log('modal-avaria:', document.getElementById('modal-avaria'));
      window.abrirModalManutencao();
    };
  </script>
</body>
</html>
